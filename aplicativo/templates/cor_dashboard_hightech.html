{% extends 'base_hightech.html' %}
{% load static %}

{% block title %}IntegraCity - Command Center Dashboard{% endblock %}

{% block monitoring_cards %}
<!-- ============================================
     CARDS COMPACTOS RETRÁTEIS
     ============================================ -->

<!-- Card 1: Estágio Operacional -->
<div class="compact-card" onclick="toggleCard(this)">
    <div class="card-header">
        <div class="card-header-left">
            <div class="card-icon {% if estagio <= 1 %}green{% elif estagio <= 3 %}orange{% else %}red{% endif %}">
                <i class="fas fa-shield-alt"></i>
            </div>
            <div class="card-main-info">
                <div class="card-value {% if estagio <= 1 %}green{% elif estagio <= 3 %}orange{% else %}red{% endif %}">
                    E{{ estagio|default:"1" }}
                </div>
                <div class="card-label">Estagio<br>Operacional</div>
            </div>
        </div>
        <div class="card-header-right">
            <div class="status-badge {% if estagio <= 1 %}normal{% elif estagio <= 3 %}warning{% else %}critical{% endif %}">
                <div class="status-dot"></div>
                {% if estagio <= 1 %}NORMAL{% elif estagio <= 3 %}ATENCAO{% else %}CRITICO{% endif %}
            </div>
            <i class="fas fa-chevron-down expand-icon"></i>
        </div>
    </div>
    <div class="card-body">
        <div class="card-content">
            <div class="card-detail-row">
                <span class="detail-label">Nivel</span>
                <span class="detail-value">{{ estagio|default:"1" }} - {{ estagio_label|default:"Normalidade" }}</span>
            </div>
            <div class="card-detail-row">
                <span class="detail-label">Regiao</span>
                <span class="detail-value">Toda a cidade</span>
            </div>
            <div class="live-indicator">
                <div class="live-dot"></div>
                Dados em tempo real
            </div>
        </div>
    </div>
</div>

<!-- Card 2: Mobilidade -->
<div class="compact-card" onclick="toggleCard(this)">
    <div class="card-header">
        <div class="card-header-left">
            <div class="card-icon green">
                <i class="fas fa-car"></i>
            </div>
            <div class="card-main-info">
                <div class="card-value green">{{ mobilidade_nivel|default:"N1" }}</div>
                <div class="card-label">Mobilidade<br>Urbana</div>
            </div>
        </div>
        <div class="card-header-right">
            <div class="status-badge normal">
                <div class="status-dot"></div>
                {{ mobilidade_status|default:"NORMAL" }}
            </div>
            <i class="fas fa-chevron-down expand-icon"></i>
        </div>
    </div>
    <div class="card-body">
        <div class="card-content">
            <div class="card-detail-row">
                <span class="detail-label">Alertas Waze</span>
                <span class="detail-value">{{ waze_alerts|default:"0" }}</span>
            </div>
            <div class="card-detail-row">
                <span class="detail-label">Vias impactadas</span>
                <span class="detail-value">{{ vias_impactadas|default:"0" }}</span>
            </div>
            <div class="card-detail-row">
                <span class="detail-label">Status</span>
                <span class="detail-value">{{ mobilidade_desc|default:"Transito Normal" }}</span>
            </div>
            <div class="live-indicator">
                <div class="live-dot"></div>
                Dados Waze em tempo real
            </div>
        </div>
    </div>
</div>

<!-- Card 4: Meteorologia -->
<div class="compact-card" onclick="toggleCard(this)">
    <div class="card-header">
        <div class="card-header-left">
            <div class="card-icon cyan">
                <i class="fas fa-cloud-sun"></i>
            </div>
            <div class="card-main-info">
                <div class="card-value cyan">{{ meteo_nivel|default:"N0" }}</div>
                <div class="card-label">Meteorologia</div>
            </div>
        </div>
        <div class="card-header-right">
            <div class="status-badge stable">
                <div class="status-dot"></div>
                {{ meteo_status|default:"ESTAVEL" }}
            </div>
            <i class="fas fa-chevron-down expand-icon"></i>
        </div>
    </div>
    <div class="card-body">
        <div class="card-content">
            <div class="card-detail-row">
                <span class="detail-label">Temperatura</span>
                <span class="detail-value">{{ temperatura|default:"--" }}C</span>
            </div>
            <div class="card-detail-row">
                <span class="detail-label">Umidade</span>
                <span class="detail-value">{{ umidade|default:"--" }}%</span>
            </div>
            <div class="card-detail-row">
                <span class="detail-label">Precipitacao</span>
                <span class="detail-value">{{ precipitacao|default:"0" }} mm</span>
            </div>
            <div class="live-indicator">
                <div class="live-dot"></div>
                Dados meteorologicos
            </div>
        </div>
    </div>
</div>

<!-- Card 5: Índice de Calor -->
<div class="compact-card" onclick="toggleCard(this)">
    <div class="card-header">
        <div class="card-header-left">
            <div class="card-icon {% if calor_index > 2 %}orange{% else %}cyan{% endif %}">
                <i class="fas fa-temperature-high"></i>
            </div>
            <div class="card-main-info">
                <div class="card-value {% if calor_index > 2 %}orange{% else %}cyan{% endif %}">
                    IC{{ calor_index|default:"1" }}
                </div>
                <div class="card-label">Indice de<br>Calor</div>
            </div>
        </div>
        <div class="card-header-right">
            <div class="status-badge {% if calor_index > 2 %}warning{% else %}normal{% endif %}">
                <div class="status-dot"></div>
                {{ calor_status|default:"NORMAL" }}
            </div>
            <i class="fas fa-chevron-down expand-icon"></i>
        </div>
    </div>
    <div class="card-body">
        <div class="card-content">
            <div class="card-detail-row">
                <span class="detail-label">Status</span>
                <span class="detail-value">{{ calor_label|default:"Normal" }}</span>
            </div>
            <div class="card-detail-row">
                <span class="detail-label">Temperatura</span>
                <span class="detail-value">{{ temperatura|default:"--" }}C</span>
            </div>
            <div class="card-detail-row">
                <span class="detail-label">Umidade</span>
                <span class="detail-value">{{ umidade|default:"--" }}%</span>
            </div>
            <div class="live-indicator">
                <div class="live-dot"></div>
                Monitoramento ativo
            </div>
        </div>
    </div>
</div>

<!-- Card 6: Câmeras -->
<div class="compact-card" onclick="toggleCard(this)">
    <div class="card-header">
        <div class="card-header-left">
            <div class="card-icon purple">
                <i class="fas fa-video"></i>
            </div>
            <div class="card-main-info">
                <div class="card-value cyan">{{ cameras_online|default:"0" }}</div>
                <div class="card-label">Cameras<br>Ativas</div>
            </div>
        </div>
        <div class="card-header-right">
            <div class="status-badge normal">
                <div class="status-dot"></div>
                ONLINE
            </div>
            <i class="fas fa-chevron-down expand-icon"></i>
        </div>
    </div>
    <div class="card-body">
        <div class="card-content">
            <div class="card-detail-row">
                <span class="detail-label">Online</span>
                <span class="detail-value" style="color: var(--green-neon);">{{ cameras_online|default:"0" }}</span>
            </div>
            <div class="card-detail-row">
                <span class="detail-label">Offline</span>
                <span class="detail-value" style="color: var(--red-alert);">{{ cameras_offline|default:"0" }}</span>
            </div>
            <div class="card-detail-row">
                <span class="detail-label">Total</span>
                <span class="detail-value">{{ cameras_total|default:"0" }}</span>
            </div>
            <div class="live-indicator">
                <div class="live-dot"></div>
                Streaming ativo
            </div>
        </div>
    </div>
</div>

<!-- Card 7: Eventos -->
<div class="compact-card" onclick="toggleCard(this)">
    <div class="card-header">
        <div class="card-header-left">
            <div class="card-icon cyan">
                <i class="fas fa-calendar-alt"></i>
            </div>
            <div class="card-main-info">
                <div class="card-value cyan">{{ eventos_count|default:"0" }}</div>
                <div class="card-label">Eventos<br>Hoje</div>
            </div>
        </div>
        <div class="card-header-right">
            <div class="status-badge stable">
                <div class="status-dot"></div>
                HOJE
            </div>
            <i class="fas fa-chevron-down expand-icon"></i>
        </div>
    </div>
    <div class="card-body">
        <div class="card-content">
            <div class="card-detail-row">
                <span class="detail-label">Grande porte</span>
                <span class="detail-value">{{ eventos_grandes|default:"0" }}</span>
            </div>
            <div class="card-detail-row">
                <span class="detail-label">Esta semana</span>
                <span class="detail-value">{{ eventos_semana|default:"0" }}</span>
            </div>
            <div class="live-indicator">
                <div class="live-dot"></div>
                Agenda atualizada
            </div>
        </div>
    </div>
</div>

<!-- Card 8: Sirenes -->
<div class="compact-card" onclick="toggleCard(this)">
    <div class="card-header">
        <div class="card-header-left">
            <div class="card-icon {% if sirenes_acionadas > 0 %}red{% else %}green{% endif %}">
                <i class="fas fa-bullhorn"></i>
            </div>
            <div class="card-main-info">
                <div class="card-value {% if sirenes_acionadas > 0 %}red{% else %}green{% endif %}">
                    {{ sirenes_acionadas|default:"0" }}
                </div>
                <div class="card-label">Sirenes<br>Acionadas</div>
            </div>
        </div>
        <div class="card-header-right">
            <div class="status-badge {% if sirenes_acionadas > 0 %}critical{% else %}normal{% endif %}">
                <div class="status-dot"></div>
                {% if sirenes_acionadas > 0 %}ACIONADAS{% else %}STAND-BY{% endif %}
            </div>
            <i class="fas fa-chevron-down expand-icon"></i>
        </div>
    </div>
    <div class="card-body">
        <div class="card-content">
            <div class="card-detail-row">
                <span class="detail-label">Total de sirenes</span>
                <span class="detail-value">{{ sirenes_total|default:"0" }}</span>
            </div>
            <div class="card-detail-row">
                <span class="detail-label">Operantes</span>
                <span class="detail-value" style="color: var(--green-neon);">{{ sirenes_operantes|default:"0" }}</span>
            </div>
            <div class="live-indicator">
                <div class="live-dot"></div>
                Sistema de alerta
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block content %}
<div class="map-container" id="mapContainer">
    <!-- ============================================
         FLOATING INFO (TOP LEFT)
         ============================================ -->
    <div class="floating-info">
        <div class="info-card">
            <div class="info-card-title">Temperatura</div>
            <div class="info-card-value">{{ temperatura|default:"--" }}C</div>
        </div>
        <div class="info-card">
            <div class="info-card-title">Umidade</div>
            <div class="info-card-value">{{ umidade|default:"--" }}%</div>
        </div>
        <div class="info-card">
            <div class="info-card-title">Precipitacao</div>
            <div class="info-card-value">{{ precipitacao|default:"0" }}mm</div>
        </div>
    </div>

    <!-- ============================================
         MAPA LEAFLET
         ============================================ -->
    <div id="leafletMap" style="height: 100%; width: 100%;"></div>

    <!-- ============================================
         MAP CONTROLS (TOP RIGHT)
         ============================================ -->
    <div class="map-controls">
        <button class="map-control-btn" onclick="zoomIn()" title="Zoom In">
            <i class="fas fa-plus"></i>
        </button>
        <button class="map-control-btn" onclick="zoomOut()" title="Zoom Out">
            <i class="fas fa-minus"></i>
        </button>
        <button class="map-control-btn" onclick="resetView()" title="Resetar Visualizacao">
            <i class="fas fa-crosshairs"></i>
        </button>
        <button class="map-control-btn" onclick="locateUser()" title="Minha Localizacao">
            <i class="fas fa-location-arrow"></i>
        </button>
        <button class="map-control-btn" onclick="toggleFullscreen()" title="Tela Cheia">
            <i class="fas fa-expand"></i>
        </button>
        <button class="map-control-btn" id="layersToggleBtn" onclick="toggleLayersSidebar()" title="Camadas do Mapa">
            <i class="fas fa-layer-group"></i>
        </button>
        <button class="map-control-btn ocorrencias-btn" onclick="window.open('{% url 'ocorrencias_dashboard' %}', '_blank')" title="Gerenciar Ocorrencias">
            <i class="fas fa-clipboard-list"></i>
        </button>
        <button class="map-control-btn nova-ocorrencia-btn" onclick="window.open('{% url 'ocorrencia_criar' %}', '_blank')" title="Nova Ocorrencia">
            <i class="fas fa-plus-circle"></i>
        </button>
    </div>

    <!-- ============================================
         LAYER SELECTOR (BOTTOM RIGHT)
         ============================================ -->
    <div class="layer-selector">
        <button class="layer-btn active" onclick="switchLayer(this, 'dark')">Dark</button>
        <button class="layer-btn" onclick="switchLayer(this, 'street')">Ruas</button>
        <button class="layer-btn" onclick="switchLayer(this, 'satellite')">Satelite</button>
        <button class="layer-btn" onclick="switchLayer(this, 'terrain')">Terreno</button>
    </div>

    <!-- ============================================
         SIDEBAR DIREITA - CAMADAS DO MAPA
         ============================================ -->
    <div class="layers-sidebar" id="layersSidebar">
        <div class="layers-content">
            <div class="layers-header">
                <i class="fas fa-layer-group"></i>
                <span>CAMADAS</span>
                <button class="layers-close" onclick="toggleLayersSidebar()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="layers-list">
                <!-- Escolas -->
                <div class="layer-item">
                    <label class="layer-checkbox">
                        <input type="checkbox" id="layerEscolas" onchange="toggleMapLayer('escolas')">
                        <span class="checkmark"></span>
                    </label>
                    <div class="layer-icon" style="background: rgba(76, 175, 80, 0.2); color: #4CAF50;">
                        <i class="fas fa-school"></i>
                    </div>
                    <div class="layer-info">
                        <span class="layer-name">Escolas</span>
                        <span class="layer-count" id="countEscolas">--</span>
                    </div>
                </div>

                <!-- Hospitais -->
                <div class="layer-item">
                    <label class="layer-checkbox">
                        <input type="checkbox" id="layerHospitais" onchange="toggleMapLayer('hospitais')">
                        <span class="checkmark"></span>
                    </label>
                    <div class="layer-icon" style="background: rgba(244, 67, 54, 0.2); color: #F44336;">
                        <i class="fas fa-hospital"></i>
                    </div>
                    <div class="layer-info">
                        <span class="layer-name">Hospitais</span>
                        <span class="layer-count" id="countHospitais">--</span>
                    </div>
                </div>

                <!-- Pluviometros -->
                <div class="layer-item">
                    <label class="layer-checkbox">
                        <input type="checkbox" id="layerPluviometros" onchange="toggleMapLayer('pluviometros')">
                        <span class="checkmark"></span>
                    </label>
                    <div class="layer-icon" style="background: rgba(33, 150, 243, 0.2); color: #2196F3;">
                        <i class="fas fa-cloud-rain"></i>
                    </div>
                    <div class="layer-info">
                        <span class="layer-name">Pluviometros</span>
                        <span class="layer-count" id="countPluviometros">--</span>
                    </div>
                </div>

                <!-- Sirenes -->
                <div class="layer-item">
                    <label class="layer-checkbox">
                        <input type="checkbox" id="layerSirenes" onchange="toggleMapLayer('sirenes')">
                        <span class="checkmark"></span>
                    </label>
                    <div class="layer-icon" style="background: rgba(255, 152, 0, 0.2); color: #FF9800;">
                        <i class="fas fa-bullhorn"></i>
                    </div>
                    <div class="layer-info">
                        <span class="layer-name">Sirenes</span>
                        <span class="layer-count" id="countSirenes">--</span>
                    </div>
                </div>

                <!-- Cameras - Com Submenu -->
                <div class="layer-item-group">
                    <div class="layer-item has-submenu" onclick="toggleCameraSubmenu(event)">
                        <label class="layer-checkbox" onclick="event.stopPropagation()">
                            <input type="checkbox" id="layerCameras" onchange="toggleAllCameras()">
                            <span class="checkmark"></span>
                        </label>
                        <div class="layer-icon" style="background: rgba(156, 39, 176, 0.2); color: #9C27B0;">
                            <i class="fas fa-video"></i>
                        </div>
                        <div class="layer-info">
                            <span class="layer-name">Cameras</span>
                            <span class="layer-count" id="countCameras">--</span>
                        </div>
                        <div class="submenu-toggle">
                            <i class="fas fa-chevron-down"></i>
                        </div>
                    </div>

                    <!-- Submenu de Cameras -->
                    <div class="layer-submenu" id="cameraSubmenu">
                        <!-- Filtro Cameras Fixas -->
                        <div class="submenu-item" onclick="event.stopPropagation()">
                            <label class="submenu-checkbox">
                                <input type="checkbox" id="layerCamerasFixas" onchange="toggleCameraType('fixas')" checked>
                                <span class="submenu-checkmark"></span>
                            </label>
                            <div class="submenu-icon fixas">
                                <i class="fas fa-video"></i>
                            </div>
                            <span class="submenu-label">Fixas</span>
                            <span class="submenu-badge" id="countCamerasFixas">--</span>
                        </div>

                        <!-- Filtro Cameras Moveis -->
                        <div class="submenu-item" onclick="event.stopPropagation()">
                            <label class="submenu-checkbox">
                                <input type="checkbox" id="layerCamerasMoveis" onchange="toggleCameraType('moveis')" checked>
                                <span class="submenu-checkmark"></span>
                            </label>
                            <div class="submenu-icon moveis">
                                <i class="fas fa-video"></i>
                            </div>
                            <span class="submenu-label">Moveis</span>
                            <span class="submenu-badge" id="countCamerasMoveis">--</span>
                        </div>

                        <!-- Separador -->
                        <div class="submenu-divider"></div>

                        <!-- Botao Mosaico -->
                        <div class="submenu-item submenu-action" onclick="openMosaicModal()">
                            <div class="submenu-icon mosaico">
                                <i class="fas fa-th-large"></i>
                            </div>
                            <span class="submenu-label">Mosaico de Cameras</span>
                            <i class="fas fa-external-link-alt submenu-arrow-icon"></i>
                        </div>
                    </div>
                </div>

                <!-- Metro -->
                <div class="layer-item">
                    <label class="layer-checkbox">
                        <input type="checkbox" id="layerMetro" onchange="toggleMapLayer('metro')">
                        <span class="checkmark"></span>
                    </label>
                    <div class="layer-icon" style="background: rgba(255, 87, 34, 0.2); color: #FF5722;">
                        <i class="fas fa-subway"></i>
                    </div>
                    <div class="layer-info">
                        <span class="layer-name">Metro</span>
                        <span class="layer-count" id="countMetro">--</span>
                    </div>
                </div>

                <!-- BRT -->
                <div class="layer-item">
                    <label class="layer-checkbox">
                        <input type="checkbox" id="layerBRT" onchange="toggleMapLayer('brt')">
                        <span class="checkmark"></span>
                    </label>
                    <div class="layer-icon" style="background: rgba(0, 150, 136, 0.2); color: #009688;">
                        <i class="fas fa-bus"></i>
                    </div>
                    <div class="layer-info">
                        <span class="layer-name">BRT</span>
                        <span class="layer-count" id="countBRT">--</span>
                    </div>
                </div>

                <!-- Waze -->
                <div class="layer-item">
                    <label class="layer-checkbox">
                        <input type="checkbox" id="layerWaze" onchange="toggleMapLayer('waze')">
                        <span class="checkmark"></span>
                    </label>
                    <div class="layer-icon" style="background: rgba(0, 212, 255, 0.2); color: #00d4ff;">
                        <i class="fab fa-waze"></i>
                    </div>
                    <div class="layer-info">
                        <span class="layer-name">Waze</span>
                        <span class="layer-count" id="countWaze">--</span>
                    </div>
                </div>

                <!-- Bolsoes de Alagamento -->
                <div class="layer-item">
                    <label class="layer-checkbox">
                        <input type="checkbox" id="layerBolsoes" onchange="toggleMapLayer('bolsoes')">
                        <span class="checkmark"></span>
                    </label>
                    <div class="layer-icon" style="background: rgba(6, 182, 212, 0.2); color: #06b6d4;">
                        <i class="fas fa-water"></i>
                    </div>
                    <div class="layer-info">
                        <span class="layer-name">Bolsoes</span>
                        <span class="layer-count" id="countBolsoes">--</span>
                    </div>
                </div>

                <!-- Ocorrencias -->
                <div class="layer-item">
                    <label class="layer-checkbox">
                        <input type="checkbox" id="layerOcorrencias" onchange="toggleMapLayer('ocorrencias')" checked>
                        <span class="checkmark"></span>
                    </label>
                    <div class="layer-icon" style="background: rgba(255, 0, 85, 0.2); color: #FF0055;">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="layer-info">
                        <span class="layer-name">Ocorrencias</span>
                        <span class="layer-count" id="countOcorrencias">--</span>
                    </div>
                </div>
            </div>

            <!-- Acoes rapidas -->
            <div class="layers-actions">
                <button class="layer-action-btn" onclick="selectAllLayers()">
                    <i class="fas fa-check-double"></i> Todos
                </button>
                <button class="layer-action-btn" onclick="clearAllLayers()">
                    <i class="fas fa-times"></i> Limpar
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // ============================================
    // INICIALIZACAO DO MAPA LEAFLET
    // ============================================

    // Centro do Município do Rio de Janeiro
    var map = L.map('leafletMap', {
        center: [-22.92, -43.45],
        zoom: 11,
        zoomControl: false,
        attributionControl: false
    });

    // Definir camadas de tiles
    var layers = {
        dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            maxZoom: 19
        }),
        street: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19
        }),
        satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 19
        }),
        terrain: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
            maxZoom: 17
        })
    };

    // Adicionar camada dark como padrao
    layers.dark.addTo(map);

    // ============================================
    // FUNCAO SWITCH LAYER (SOBRESCREVER)
    // ============================================
    function switchLayer(btn, layerName) {
        // Remover todas as camadas
        Object.values(layers).forEach(layer => {
            if (map.hasLayer(layer)) {
                map.removeLayer(layer);
            }
        });

        // Adicionar nova camada
        if (layers[layerName]) {
            layers[layerName].addTo(map);
        }

        // Atualizar botoes
        document.querySelectorAll('.layer-btn').forEach(b => {
            b.classList.remove('active');
        });
        if (btn) {
            btn.classList.add('active');
        }

        showToast('Camada: ' + layerName.toUpperCase(), 'success');
    }

    // ============================================
    // ZOOM CONTROLS
    // ============================================
    function zoomIn() {
        map.zoomIn();
    }

    function zoomOut() {
        map.zoomOut();
    }

    function resetView() {
        map.setView([-22.9068, -43.1729], 11);
        showToast('Visualizacao resetada', 'info');
    }

    // ============================================
    // MARCADORES DE SIRENES
    // ============================================
    {% if sirenes %}
    var sirenesLayer = L.layerGroup().addTo(map);

    {% for sirene in sirenes %}
    {% if sirene.latitude and sirene.longitude %}
    (function() {
        var icon = L.divIcon({
            className: 'custom-marker',
            html: '<div style="background: {% if sirene.acionada %}#ff0055{% else %}#00ff88{% endif %}; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.3);"><i class="fas fa-bullhorn" style="color: white; font-size: 10px;"></i></div>',
            iconSize: [24, 24],
            iconAnchor: [12, 12]
        });

        var marker = L.marker([{{ sirene.latitude }}, {{ sirene.longitude }}], { icon: icon });

        marker.bindPopup(`
            <div style="font-family: 'Rajdhani', sans-serif;">
                <h4 style="margin: 0 0 8px 0; color: #00d4ff;">{{ sirene.nome|default:"Sirene" }}</h4>
                <p style="margin: 0;">{{ sirene.bairro|default:"--" }}</p>
            </div>
        `);

        sirenesLayer.addLayer(marker);
    })();
    {% endif %}
    {% endfor %}
    {% endif %}

    // ============================================
    // REFRESH DATA (API)
    // ============================================
    function refreshData() {
        showLoading('ATUALIZANDO DADOS...');

        fetch('/integracity/api/dashboard/status/')
            .then(response => response.json())
            .then(data => {
                // Atualizar valores no header
                if (data.eventos_count !== undefined) {
                    document.getElementById('headerEventos').textContent = data.eventos_count;
                }

                hideLoading();
                showToast('Dados atualizados com sucesso', 'success');
            })
            .catch(error => {
                hideLoading();
                showToast('Dados atualizados (offline)', 'warning');
                console.log('API indisponivel, usando cache');
            });
    }

    // ============================================
    // AUTO-REFRESH A CADA 5 MINUTOS
    // ============================================
    setInterval(function() {
        console.log('Auto-refresh...');
        // refreshData(); // Descomente para ativar auto-refresh
    }, 300000);

    // ============================================
    // SISTEMA DE CAMADAS DO MAPA
    // ============================================

    // Layer Groups para cada tipo de dado
    var mapLayers = {
        escolas: L.layerGroup(),
        hospitais: L.layerGroup(),
        pluviometros: L.layerGroup(),
        sirenes: L.layerGroup(),
        cameras: L.layerGroup(),
        camerasFixas: L.layerGroup(),
        camerasMoveis: L.layerGroup(),
        metro: L.layerGroup(),
        brt: L.layerGroup(),
        waze: L.layerGroup(),
        bolsoes: L.layerGroup(),
        ocorrencias: L.layerGroup()
    };

    // Cache dos dados carregados
    var layerDataCache = {
        escolas: null,
        hospitais: null,
        pluviometros: null,
        sirenes: null,
        cameras: null,
        metro: null,
        brt: null,
        waze: null,
        bolsoes: null,
        ocorrencias: null
    };

    // Estado dos filtros de cameras
    var cameraFilters = {
        fixas: true,
        moveis: true
    };

    // Icones customizados para cada tipo
    var layerIcons = {
        escolas: { icon: 'fa-school', color: '#4CAF50' },
        hospitais: { icon: 'fa-hospital', color: '#F44336' },
        pluviometros: { icon: 'fa-cloud-rain', color: '#2196F3' },
        sirenes: { icon: 'fa-bullhorn', color: '#FF9800' },
        cameras: { icon: 'fa-video', color: '#9C27B0' },
        camerasFixas: { icon: 'fa-video', color: '#2196F3' },     // Azul para fixas
        camerasMoveis: { icon: 'fa-video', color: '#4CAF50' },    // Verde para moveis
        metro: { icon: 'fa-subway', color: '#FF5722' },
        brt: { icon: 'fa-bus', color: '#009688' },
        waze: { icon: 'fa-car', color: '#00d4ff' },
        bolsoes: { icon: 'fa-water', color: '#06b6d4' },
        ocorrencias: { icon: 'fa-exclamation-triangle', color: '#FF0055' }
    };

    // Cores por prioridade de ocorrencia
    var coresPrioridade = {
        baixa: '#4CAF50',
        media: '#00D4FF',
        alta: '#FFB800',
        critica: '#FF0055'
    };

    // ============================================
    // SUBMENU DE CAMERAS
    // ============================================

    // Toggle do submenu de cameras
    function toggleCameraSubmenu(event) {
        if (event) event.stopPropagation();

        var layerItem = document.querySelector('.layer-item.has-submenu');
        var submenu = document.getElementById('cameraSubmenu');

        if (layerItem && submenu) {
            layerItem.classList.toggle('expanded');
            submenu.classList.toggle('expanded');
        }
    }

    // Toggle todas as cameras (checkbox principal)
    function toggleAllCameras() {
        var mainCheckbox = document.getElementById('layerCameras');
        var isChecked = mainCheckbox ? mainCheckbox.checked : false;
        var layerItem = mainCheckbox ? mainCheckbox.closest('.layer-item') : null;

        // Atualizar checkboxes filhos
        var fixasCheckbox = document.getElementById('layerCamerasFixas');
        var moveisCheckbox = document.getElementById('layerCamerasMoveis');

        if (fixasCheckbox) fixasCheckbox.checked = isChecked;
        if (moveisCheckbox) moveisCheckbox.checked = isChecked;

        cameraFilters.fixas = isChecked;
        cameraFilters.moveis = isChecked;

        if (isChecked) {
            if (layerItem) layerItem.classList.add('active');

            // Carregar dados se ainda nao carregou
            if (!layerDataCache.cameras) {
                loadLayerData('cameras');
            } else {
                renderCamerasByType();
            }

            // Adicionar camadas ao mapa
            mapLayers.camerasFixas.addTo(map);
            mapLayers.camerasMoveis.addTo(map);
        } else {
            if (layerItem) layerItem.classList.remove('active');
            map.removeLayer(mapLayers.camerasFixas);
            map.removeLayer(mapLayers.camerasMoveis);
        }
    }

    // Toggle tipo de camera (fixas ou moveis)
    function toggleCameraType(type) {
        var checkbox = document.getElementById('layerCameras' + type.charAt(0).toUpperCase() + type.slice(1));
        var isChecked = checkbox ? checkbox.checked : false;

        cameraFilters[type] = isChecked;

        // Atualizar checkbox principal baseado nos filhos
        var mainCheckbox = document.getElementById('layerCameras');
        if (mainCheckbox) {
            mainCheckbox.checked = cameraFilters.fixas || cameraFilters.moveis;
        }

        if (type === 'fixas') {
            if (isChecked) {
                mapLayers.camerasFixas.addTo(map);
            } else {
                map.removeLayer(mapLayers.camerasFixas);
            }
        } else if (type === 'moveis') {
            if (isChecked) {
                mapLayers.camerasMoveis.addTo(map);
            } else {
                map.removeLayer(mapLayers.camerasMoveis);
            }
        }

        // Se nao tem dados carregados, carregar
        if (!layerDataCache.cameras && isChecked) {
            loadLayerData('cameras');
        }
    }

    // Renderizar cameras por tipo (fixas/moveis)
    function renderCamerasByType() {
        // Limpar camadas existentes
        mapLayers.camerasFixas.clearLayers();
        mapLayers.camerasMoveis.clearLayers();
        mapLayers.cameras.clearLayers();

        var data = layerDataCache.cameras;
        if (!data) {
            console.log('Sem dados de câmeras no cache');
            return;
        }

        var items = [];

        // Normalizar dados - a API retorna em data.data
        if (Array.isArray(data)) {
            items = data;
        } else if (data.data && Array.isArray(data.data)) {
            items = data.data;
        } else if (data.cameras) {
            items = data.cameras;
        }

        console.log('Processando ' + items.length + ' cameras');

        var countFixas = 0;
        var countMoveis = 0;
        var countTotal = 0;

        items.forEach(function(item) {
            var lat = item.latitude || item.lat || item.y;
            var lng = item.longitude || item.lng || item.lon || item.x;

            // Determinar se a camera eh fixa ou movel
            // Verifica campos comuns da API: tipo, type, mobile, movel, fixa
            var isMovel = false;

            if (item.tipo) {
                isMovel = item.tipo.toLowerCase().includes('movel') ||
                          item.tipo.toLowerCase().includes('móvel') ||
                          item.tipo.toLowerCase().includes('mobile');
            }
            if (item.type) {
                isMovel = isMovel || item.type.toLowerCase().includes('mobile') ||
                          item.type.toLowerCase().includes('movel');
            }
            if (item.mobile !== undefined) {
                isMovel = item.mobile === true || item.mobile === 1 || item.mobile === '1';
            }
            if (item.movel !== undefined) {
                isMovel = item.movel === true || item.movel === 1 || item.movel === '1';
            }
            if (item.fixa !== undefined) {
                isMovel = !(item.fixa === true || item.fixa === 1 || item.fixa === '1');
            }

            countTotal++;
            if (isMovel) {
                countMoveis++;
            } else {
                countFixas++;
            }

            if (lat && lng) {

                var cameraType = isMovel ? 'camerasMoveis' : 'camerasFixas';
                var marker = L.marker([lat, lng], {
                    icon: createLayerIcon(cameraType)
                });

                // Abrir video direto no clique
                if (item.url_stream || item.url) {
                    marker.on('click', function() {
                        openCameraPlayer(item.url_stream || item.url, item.nome || 'Camera', item.id_c || item.id || '');
                    });
                }

                // Tooltip com indicacao do tipo
                var tooltipText = (item.nome || 'Camera') + ' (' + (isMovel ? 'Móvel' : 'Fixa') + ')';
                marker.bindTooltip(tooltipText, {
                    permanent: false,
                    direction: 'top',
                    className: 'camera-tooltip'
                });

                // Adicionar a camada apropriada
                if (isMovel) {
                    mapLayers.camerasMoveis.addLayer(marker);
                } else {
                    mapLayers.camerasFixas.addLayer(marker);
                }

                // Tambem adiciona na camada geral para compatibilidade
                mapLayers.cameras.addLayer(marker);
            }
        });

        // Atualizar contadores
        var totalRaw = data.total_raw || countTotal;
        if (data.total_raw_fixas !== undefined && data.total_raw_moveis !== undefined) {
            countFixas = data.total_raw_fixas;
            countMoveis = data.total_raw_moveis;
        }

        updateElement('countCameras', totalRaw);
        updateElement('countCamerasFixas', countFixas);
        updateElement('countCamerasMoveis', countMoveis);

        console.log('Cameras carregadas: ' + totalRaw + ' total (' + countFixas + ' fixas, ' + countMoveis + ' moveis)');
    }

    // Funcao auxiliar para atualizar elementos
    function updateElement(id, value) {
        var el = document.getElementById(id);
        if (el) el.textContent = value;
    }

    // Toggle da sidebar de camadas
    function toggleLayersSidebar() {
        var sidebar = document.getElementById('layersSidebar');
        var toggleBtn = document.getElementById('layersToggleBtn');
        if (sidebar) {
            sidebar.classList.toggle('expanded');
            if (toggleBtn) {
                toggleBtn.classList.toggle('active', sidebar.classList.contains('expanded'));
            }
        }
    }

    // Criar icone de marcador
    function createLayerIcon(type) {
        var config = layerIcons[type] || { icon: 'fa-map-marker', color: '#00d4ff' };
        return L.divIcon({
            className: 'custom-layer-marker',
            html: '<div style="background: ' + config.color + '; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.4);"><i class="fas ' + config.icon + '" style="color: white; font-size: 12px;"></i></div>',
            iconSize: [28, 28],
            iconAnchor: [14, 14],
            popupAnchor: [0, -14]
        });
    }

    // Toggle de camada individual
    function toggleMapLayer(layerName) {
        var checkbox = document.getElementById('layer' + layerName.charAt(0).toUpperCase() + layerName.slice(1));
        var isChecked = checkbox ? checkbox.checked : false;
        var layerItem = checkbox ? checkbox.closest('.layer-item') : null;

        if (isChecked) {
            // Adicionar camada ao mapa
            if (!map.hasLayer(mapLayers[layerName])) {
                mapLayers[layerName].addTo(map);
            }
            if (layerItem) layerItem.classList.add('active');

            // Carregar dados se ainda nao carregou
            if (!layerDataCache[layerName]) {
                loadLayerData(layerName);
            }

            showToast('Camada ' + layerName + ' ativada', 'success');
        } else {
            // Remover camada do mapa
            if (map.hasLayer(mapLayers[layerName])) {
                map.removeLayer(mapLayers[layerName]);
            }
            if (layerItem) layerItem.classList.remove('active');

            showToast('Camada ' + layerName + ' desativada', 'info');
        }
    }

    // Carregar dados de uma camada especifica
    // Detectar base URL automaticamente - usar origin para garantir URL absoluta
    var baseUrl = window.location.origin + '/';
    console.log('Base URL para APIs:', baseUrl);

    function loadLayerData(layerName) {
        var apiUrls = {
            escolas: baseUrl + 'integracity/api/escolas/',
            hospitais: baseUrl + 'integracity/api/hospitais/',
            pluviometros: baseUrl + 'integracity/api/pluviometros/',
            sirenes: baseUrl + 'integracity/api/sirenes/',
            cameras: baseUrl + 'integracity/api/cameras/',
            metro: baseUrl + 'integracity/api/metro/',
            brt: baseUrl + 'integracity/api/brt/',
            waze: baseUrl + 'integracity/api/waze/',
            bolsoes: baseUrl + 'integracity/api/bolsoes/',
            ocorrencias: baseUrl + 'integracity/api/ocorrencias/mapa/'
        };

        var url = apiUrls[layerName];
        if (!url) return;

        showToast('Carregando ' + layerName + '...', 'info');
        console.log('Carregando camada ' + layerName + ' de:', url);

        fetch(url)
            .then(function(response) {
                console.log('Resposta da API ' + layerName + ':', response.status);
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status);
                }
                return response.json();
            })
            .then(function(data) {
                console.log('Dados recebidos para ' + layerName + ':', data);
                layerDataCache[layerName] = data;

                // Cameras usa renderização especial com tipos (fixas/moveis)
                if (layerName === 'cameras') {
                    renderCamerasByType();
                    // Adicionar camadas baseado nos filtros atuais
                    if (cameraFilters.fixas) mapLayers.camerasFixas.addTo(map);
                    if (cameraFilters.moveis) mapLayers.camerasMoveis.addTo(map);
                    showToast('Cameras carregadas com sucesso', 'success');
                } else if (layerName === 'ocorrencias') {
                    renderOcorrenciasMarkers(data);
                    updateLayerCount(layerName, data);
                    showToast('Ocorrencias carregadas com sucesso', 'success');
                } else {
                    renderLayerMarkers(layerName, data);
                    updateLayerCount(layerName, data);
                }
            })
            .catch(function(error) {
                console.error('Erro ao carregar ' + layerName + ':', error);
                showToast('Erro ao carregar ' + layerName + ': ' + error.message, 'error');
            });
    }

    // Renderizar marcadores de uma camada
    function renderLayerMarkers(layerName, data) {
        // Limpar camada existente
        mapLayers[layerName].clearLayers();

        var items = [];

        // Normalizar dados conforme o tipo de API
        if (Array.isArray(data)) {
            items = data;
        } else if (data.features) {
            // GeoJSON format
            items = data.features.map(f => ({
                ...f.properties,
                latitude: f.geometry?.coordinates?.[1],
                longitude: f.geometry?.coordinates?.[0]
            }));
        } else if (data.data) {
            items = Array.isArray(data.data) ? data.data : [];
        } else if (data.results) {
            items = data.results;
        } else if (data.alerts) {
            items = data.alerts;
        } else if (data.escolas) {
            items = data.escolas;
        } else if (data.hospitais) {
            items = data.hospitais;
        } else if (data.sirenes) {
            items = data.sirenes;
        } else if (data.cameras) {
            items = data.cameras;
        } else if (data.estacoes) {
            items = data.estacoes;
        } else if (data.linhas) {
            items = data.linhas;
        }

        items.forEach(function(item) {
            // Tentar diferentes campos de coordenadas
            var lat = item.latitude || item.lat || item.y || (item.location && item.location.lat);
            var lng = item.longitude || item.lng || item.lon || item.x || (item.location && item.location.lng);

            if (lat && lng) {
                var marker = L.marker([lat, lng], {
                    icon: createLayerIcon(layerName)
                });

                // Para cameras, abrir video direto no clique
                if (layerName === 'cameras' && item.url) {
                    marker.on('click', function() {
                        openCameraPlayer(item.url_stream || item.url, item.nome || 'Camera', item.id_c || item.id || '');
                    });
                    // Tooltip simples no hover
                    marker.bindTooltip(item.nome || 'Camera', {
                        permanent: false,
                        direction: 'top',
                        className: 'camera-tooltip'
                    });
                } else {
                    // Criar popup com informacoes para outras camadas
                    var popupContent = createPopupContent(layerName, item);
                    marker.bindPopup(popupContent);
                }

                mapLayers[layerName].addLayer(marker);
            }
        });

        console.log('Camada ' + layerName + ': ' + mapLayers[layerName].getLayers().length + ' marcadores');
    }

    // Criar conteudo do popup
    function createPopupContent(layerName, item) {
        var config = layerIcons[layerName];
        var title = item.nome || item.name || item.titulo || item.title || item.tipo || item.type || layerName;
        var details = '';

        switch(layerName) {
            case 'escolas':
                details = '<p>' + (item.endereco || item.bairro || '--') + '</p>';
                if (item.telefone) details += '<p>Tel: ' + item.telefone + '</p>';
                if (item.tipo) details += '<p>Tipo: ' + item.tipo + '</p>';
                break;
            case 'hospitais':
                details = '<p>' + (item.endereco || item.bairro || '--') + '</p>';
                if (item.telefone) details += '<p>Tel: ' + item.telefone + '</p>';
                break;
            case 'pluviometros':
                details = '<p>Bairro: ' + (item.bairro || '--') + '</p>';
                if (item.acumulado_15min !== undefined) details += '<p>15min: ' + item.acumulado_15min + 'mm</p>';
                if (item.acumulado_1h !== undefined) details += '<p>1h: ' + item.acumulado_1h + 'mm</p>';
                if (item.chuva_1h !== undefined) details += '<p>1h: ' + item.chuva_1h + 'mm</p>';
                if (item.chuva_24h !== undefined) details += '<p>24h: ' + item.chuva_24h + 'mm</p>';
                break;
            case 'sirenes':
                details = '<p>Bairro: ' + (item.bairro || '--') + '</p>';
                details += '<p>Status: ' + (item.acionada ? '<span style="color:#ff0055">ACIONADA</span>' : '<span style="color:#00ff88">Stand-by</span>') + '</p>';
                break;
            case 'cameras':
                details = '<p>' + (item.zona || item.localizacao || item.bairro || '--') + '</p>';
                if (item.bairro) details += '<p>Bairro: ' + item.bairro + '</p>';
                if (item.url_stream || item.url) {
                    var cameraUrl = item.url_stream || item.url; var cameraName = (item.nome || 'Camera').replace(/'/g, "\'"); var cameraId = item.id_c || item.id || ''; details += '<button onclick="openCameraPlayer(&quot;' + cameraUrl + '&quot;, &quot;' + cameraName + '&quot;, &quot;' + cameraId + '&quot;)" style="margin-top: 10px; padding: 8px 16px; background: linear-gradient(135deg, #9C27B0, #7B1FA2); color: white; border: none; border-radius: 8px; cursor: pointer; font-family: Rajdhani, sans-serif; font-weight: 600; display: flex; align-items: center; gap: 6px;"><i class="fas fa-play"></i> Assistir ao Vivo</button>';
                }
                break;
            case 'metro':
                details = '<p>Linha: ' + (item.linha || '--') + '</p>';
                details += '<p>Status: ' + (item.status || 'Normal') + '</p>';
                break;
            case 'brt':
                details = '<p>Corredor: ' + (item.corredor || '--') + '</p>';
                details += '<p>Status: ' + (item.status || 'Normal') + '</p>';
                break;
            case 'waze':
                details = '<p>Tipo: ' + (item.type || item.subtype || '--') + '</p>';
                if (item.street) details += '<p>' + item.street + '</p>';
                break;
            case 'bolsoes':
                details = '<p>Local: ' + (item.local || '--') + '</p>';
                if (item.referencia) details += '<p>Ref: ' + item.referencia + '</p>';
                if (item.bairro) details += '<p>Bairro: ' + item.bairro + '</p>';
                if (item.zona) details += '<p>Zona: ' + item.zona + '</p>';
                break;
            default:
                details = '<p>' + (item.descricao || item.description || '--') + '</p>';
        }

        return '<div style="font-family: Rajdhani, sans-serif; min-width: 180px;">' +
            '<h4 style="margin: 0 0 8px 0; color: ' + config.color + '; font-family: Orbitron, monospace; font-size: 0.9rem;">' +
            '<i class="fas ' + config.icon + '"></i> ' + title.substring(0, 30) + '</h4>' +
            '<div style="font-size: 0.85rem; color: #ccc;">' + details + '</div>' +
            '</div>';
    }

    // Renderizar marcadores de ocorrencias com cores por prioridade
    function renderOcorrenciasMarkers(data) {
        // Limpar camada existente
        mapLayers.ocorrencias.clearLayers();

        var items = [];
        if (data.data && Array.isArray(data.data)) {
            items = data.data;
        } else if (Array.isArray(data)) {
            items = data;
        }

        console.log('Renderizando ' + items.length + ' ocorrencias no mapa');

        items.forEach(function(oc) {
            if (oc.latitude && oc.longitude) {
                // Cor baseada na prioridade
                var cor = coresPrioridade[oc.prioridade] || '#00D4FF';
                var icone = oc.categoria_icone || 'fa-exclamation-triangle';

                var icon = L.divIcon({
                    className: 'custom-marker ocorrencia-marker',
                    html: '<div style="background: ' + cor + '; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 3px solid white; box-shadow: 0 0 15px rgba(0,0,0,0.4), 0 0 20px ' + cor + '50;"><i class="fas ' + icone + '" style="color: white; font-size: 14px;"></i></div>',
                    iconSize: [32, 32],
                    iconAnchor: [16, 16]
                });

                var marker = L.marker([oc.latitude, oc.longitude], { icon: icon });

                // Popup com informacoes da ocorrencia
                var popupContent = '<div style="font-family: Rajdhani, sans-serif; min-width: 250px;">' +
                    '<div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">' +
                    '<div style="background: ' + cor + '30; color: ' + cor + '; padding: 8px; border-radius: 8px;">' +
                    '<i class="fas ' + icone + '"></i></div>' +
                    '<div>' +
                    '<h4 style="margin: 0; color: #00d4ff; font-size: 1rem;">' + oc.protocolo + '</h4>' +
                    '<span style="font-size: 0.75rem; color: #888;">' + oc.categoria + '</span>' +
                    '</div></div>' +
                    '<div style="font-size: 0.9rem; color: #fff; margin-bottom: 8px;">' + oc.titulo + '</div>' +
                    '<div style="display: flex; gap: 8px; margin-bottom: 8px;">' +
                    '<span style="background: ' + cor + '30; color: ' + cor + '; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem;">' + oc.prioridade_display + '</span>' +
                    '<span style="background: rgba(0,212,255,0.2); color: #00d4ff; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem;">' + oc.status_display + '</span>' +
                    '</div>' +
                    '<div style="font-size: 0.8rem; color: #aaa;">' +
                    '<i class="fas fa-map-marker-alt"></i> ' + (oc.endereco || '--') + (oc.bairro ? ', ' + oc.bairro : '') +
                    '</div>' +
                    '<div style="font-size: 0.75rem; color: #666; margin-top: 5px;">' +
                    '<i class="fas fa-clock"></i> ' + oc.data_abertura +
                    '</div>' +
                    '<div style="margin-top: 10px;">' +
                    '<a href="/integracity/ocorrencias/' + oc.id + '/" target="_blank" style="display: inline-block; background: #00d4ff; color: #000; padding: 6px 15px; border-radius: 6px; text-decoration: none; font-size: 0.8rem; font-weight: bold;">' +
                    '<i class="fas fa-eye"></i> Ver Detalhes</a>' +
                    '</div></div>';

                marker.bindPopup(popupContent, {
                    maxWidth: 350,
                    className: 'ocorrencia-popup'
                });

                mapLayers.ocorrencias.addLayer(marker);
            }
        });

        // Atualizar contador
        var countEl = document.getElementById('countOcorrencias');
        if (countEl) {
            countEl.textContent = items.length;
        }
    }

    // Atualizar contador de itens da camada
    function updateLayerCount(layerName, data) {
        var countEl = document.getElementById('count' + layerName.charAt(0).toUpperCase() + layerName.slice(1));
        if (!countEl) return;

        var count = 0;
        if (Array.isArray(data)) {
            count = data.length;
        } else if (data.count !== undefined) {
            count = data.count;
        } else if (data.total !== undefined) {
            count = data.total;
        } else {
            // Tentar contar de diferentes estruturas
            var lists = ['data', 'results', 'features', 'alerts', 'escolas', 'hospitais',
                         'sirenes', 'cameras', 'estacoes', 'linhas'];
            for (var i = 0; i < lists.length; i++) {
                if (data[lists[i]] && Array.isArray(data[lists[i]])) {
                    count = data[lists[i]].length;
                    break;
                }
            }
        }

        countEl.textContent = count;
    }

    // Selecionar todas as camadas
    function selectAllLayers() {
        var layerNames = Object.keys(mapLayers);
        layerNames.forEach(function(layerName) {
            var checkbox = document.getElementById('layer' + layerName.charAt(0).toUpperCase() + layerName.slice(1));
            if (checkbox && !checkbox.checked) {
                checkbox.checked = true;
                toggleMapLayer(layerName);
            }
        });
        showToast('Todas as camadas ativadas', 'success');
    }

    // Limpar todas as camadas
    function clearAllLayers() {
        var layerNames = Object.keys(mapLayers);
        layerNames.forEach(function(layerName) {
            var checkbox = document.getElementById('layer' + layerName.charAt(0).toUpperCase() + layerName.slice(1));
            if (checkbox && checkbox.checked) {
                checkbox.checked = false;
                toggleMapLayer(layerName);
            }
        });
        showToast('Todas as camadas desativadas', 'info');
    }

    // ============================================
    // PLAYER DE CAMERAS - JANELA FLUTUANTE RESPONSIVA
    // ============================================

    // Modo de visualizacao atual
    var currentViewMode = 'contain';

    function openCameraPlayer(url, nome, cameraId) {
        // Fechar modal existente se houver
        closeCameraPlayer();

        // Formatar nome da câmera
        var displayName = 'CAMERA ' + (cameraId || '') + ' - ' + nome.toUpperCase();

        var playerUrl = url;
        var resolvedId = cameraId;
        if (!resolvedId && url) {
            var matchId = url.match(/\/api\/camera\/(\d+)/);
            if (matchId && matchId[1]) resolvedId = matchId[1];
        }
        if (!resolvedId && url) {
            var matchCode = url.match(/[?&]CODE=(\\d+)/i);
            if (matchCode && matchCode[1]) resolvedId = matchCode[1];
        }
        if (resolvedId) {
            playerUrl = window.location.origin + '/integracity/api/camera/' + resolvedId + '/stream/?embed=1';
        } else if (url && url.indexOf('/info/') !== -1) {
            playerUrl = url.replace('/info/', '/stream/?embed=1');
        }

        var modalHtml = `
            <div id="cameraPlayerModal" class="camera-player-modal" style="
                top: 100px;
                left: 150px;
                width: 70vw;
                height: 60vh;
                max-width: 960px;
                max-height: 720px;
                min-width: 360px;
                min-height: 240px;
            ">
                <!-- Cabecalho arrastavel -->
                <div id="cameraPlayerHeader" class="camera-player-header">
                    <span class="camera-player-title">${displayName}</span>
                </div>

                <!-- Container do Video - RESPONSIVO -->
                <div class="camera-video-container">
                    <!-- Loading indicator -->
                    <div id="cameraLoading" class="camera-loading">
                        <div class="camera-loading-spinner"></div>
                        <span>Carregando video...</span>
                    </div>

                    <!-- Video Wrapper - RESPONSIVO SEM CORTES -->
                    <div class="video-wrapper">
                        <iframe
                            id="cameraIframe"
                            src="${playerUrl}"
                            allowfullscreen
                            allow="autoplay; encrypted-media"
                            scrolling="no"
                            onload="hideCameraLoading();"
                            onerror="showCameraOffline()"
                        ></iframe>
                    </div>
                </div>

                <!-- Rodape com controles e botao fechar -->
                <div class="camera-player-footer">

                    <button onclick="closeCameraPlayer()" class="camera-close-btn">
                        <i class="fas fa-times"></i> FECHAR
                    </button>
                </div>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHtml);

        // Tornar arrastavel
        makeDraggable(document.getElementById('cameraPlayerModal'), document.getElementById('cameraPlayerHeader'));

        // Fechar com ESC
        document.addEventListener('keydown', handleCameraEsc);

        // Esconder loading depois de um tempo se iframe nao disparar onload
        setTimeout(function() {
            var loading = document.getElementById('cameraLoading');
            if (loading) loading.style.display = 'none';
        }, 5000);
    }

    // Esconder loading quando iframe carregar
    function hideCameraLoading() {
        var loading = document.getElementById('cameraLoading');
        if (loading) loading.style.display = 'none';
    }

    // Mostrar estado offline
    function showCameraOffline() {
        var loading = document.getElementById('cameraLoading');
        if (loading) {
            loading.innerHTML = '<i class="fas fa-video-slash" style="font-size: 48px; opacity: 0.7;"></i><span>Camera offline</span>';
        }
    }

    // Placeholder - o iframe do Tixxi controla seu próprio conteúdo
    // Não temos controle sobre o CSS da página externa
    function setViewMode(mode, btn) {
        currentViewMode = mode;
        console.log('Modo:', mode, '(controle limitado - conteúdo externo)');

        // Atualizar botoes ativos
        document.querySelectorAll('.camera-view-btn').forEach(function(b) {
            b.classList.remove('active');
        });
        if (btn) {
            btn.classList.add('active');
        }
    }

    function closeCameraPlayer() {
        var modal = document.getElementById('cameraPlayerModal');
        if (modal) {
            modal.remove();
        }
        document.removeEventListener('keydown', handleCameraEsc);
    }

    function handleCameraEsc(e) {
        if (e.key === 'Escape') {
            closeCameraPlayer();
        }
    }

    // Funcao para tornar elemento arrastavel
    function makeDraggable(element, handle) {
        var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;

        handle.onmousedown = dragMouseDown;

        function dragMouseDown(e) {
            e.preventDefault();
            pos3 = e.clientX;
            pos4 = e.clientY;
            document.onmouseup = closeDragElement;
            document.onmousemove = elementDrag;
        }

        function elementDrag(e) {
            e.preventDefault();
            pos1 = pos3 - e.clientX;
            pos2 = pos4 - e.clientY;
            pos3 = e.clientX;
            pos4 = e.clientY;
            element.style.top = (element.offsetTop - pos2) + "px";
            element.style.left = (element.offsetLeft - pos1) + "px";
        }

        function closeDragElement() {
            document.onmouseup = null;
            document.onmousemove = null;
        }
    }

    // ============================================
    // MOSAICO DE CÂMERAS
    // ============================================

    var allCameras = []; // Armazena todas as câmeras
    var mosaicCameras = []; // Câmeras selecionadas para o mosaico
    var currentMosaicLayout = 4; // Layout atual (4, 8, 16, 24, 48)

    // Abrir modal do mosaico
    function openMosaicModal() {
        // Carregar câmeras se ainda não carregou
        if (allCameras.length === 0) {
            loadCamerasForMosaic();
        }

        var modal = document.getElementById('mosaicModal');
        if (modal) {
            modal.style.display = 'flex';
            renderCameraList();
        }
    }

    // Fechar modal do mosaico
    function closeMosaicModal() {
        var modal = document.getElementById('mosaicModal');
        if (modal) {
            modal.style.display = 'none';
        }
    }

    // Carregar câmeras da API
    function loadCamerasForMosaic() {
        var mosaicApiUrl = window.location.origin + '/integracity/api/cameras/';
        console.log('Carregando cameras para mosaico de:', mosaicApiUrl);

        fetch(mosaicApiUrl)
            .then(function(response) {
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status);
                }
                return response.json();
            })
            .then(function(data) {
                console.log('Dados do mosaico recebidos:', data);

                // A API retorna em data.data
                if (data.data && Array.isArray(data.data)) {
                    allCameras = data.data;
                } else if (data.cameras) {
                    allCameras = data.cameras;
                } else if (Array.isArray(data)) {
                    allCameras = data;
                } else {
                    allCameras = [];
                }
                console.log('Câmeras carregadas para mosaico:', allCameras.length);
                renderCameraList();
            })
            .catch(function(err) {
                console.error('Erro ao carregar câmeras:', err);
            });
    }

    // Renderizar lista de câmeras com filtro
    function renderCameraList() {
        var container = document.getElementById('cameraListContainer');
        var searchTerm = document.getElementById('cameraSearch')?.value?.toLowerCase() || '';

        if (!container) return;

        var filtered = allCameras.filter(function(cam) {
            var id = (cam.id || cam.codigo || '').toString().toLowerCase();
            var nome = (cam.nome || cam.name || '').toLowerCase();
            return id.includes(searchTerm) || nome.includes(searchTerm);
        });

        var html = '';
        filtered.forEach(function(cam, index) {
            var camId = cam.id || cam.codigo || index;
            var camNome = cam.nome || cam.name || 'Camera ' + camId;
            var isSelected = mosaicCameras.some(function(c) { return c.id === camId; });

            html += '<div class="camera-list-item ' + (isSelected ? 'selected' : '') + '" onclick="toggleCameraSelection(\'' + camId + '\')">';
            html += '  <div class="camera-checkbox">' + (isSelected ? '<i class="fas fa-check"></i>' : '') + '</div>';
            html += '  <div class="camera-info">';
            html += '    <span class="camera-id">' + camId + '</span>';
            html += '    <span class="camera-name">' + camNome + '</span>';
            html += '  </div>';
            html += '</div>';
        });

        container.innerHTML = html || '<div class="no-cameras">Nenhuma câmera encontrada</div>';

        // Atualizar contador
        var counter = document.getElementById('selectedCount');
        if (counter) {
            counter.textContent = mosaicCameras.length + ' / ' + currentMosaicLayout;
        }
    }

    // Toggle seleção de câmera
    function toggleCameraSelection(camId) {
        var cam = allCameras.find(function(c) {
            return (c.id || c.codigo) == camId;
        });

        if (!cam) return;

        var index = mosaicCameras.findIndex(function(c) {
            return (c.id || c.codigo) == camId;
        });

        if (index >= 0) {
            // Remover
            mosaicCameras.splice(index, 1);
        } else {
            // Adicionar (se não exceder limite)
            if (mosaicCameras.length < currentMosaicLayout) {
                mosaicCameras.push(cam);
            } else {
                showToast('Limite de ' + currentMosaicLayout + ' câmeras atingido!', 'warning');
                return;
            }
        }

        renderCameraList();
    }

    // Mudar layout do mosaico
    function setMosaicLayout(layout) {
        currentMosaicLayout = layout;

        // Se tem mais câmeras selecionadas que o novo limite, remover excesso
        while (mosaicCameras.length > layout) {
            mosaicCameras.pop();
        }

        // Atualizar botões
        document.querySelectorAll('.layout-btn').forEach(function(btn) {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');

        renderCameraList();
    }

    // Iniciar mosaico
    function startMosaic() {
        if (mosaicCameras.length === 0) {
            showToast('Selecione pelo menos uma câmera!', 'warning');
            return;
        }

        closeMosaicModal();
        openMosaicView();
    }

    // Abrir visualização do mosaico
    function openMosaicView() {
        // Pegar IDs das câmeras selecionadas
        var cameraIds = mosaicCameras.map(function(c) { return c.id; }).join(',');
        
        // Construir URL com parâmetros
        var url = window.location.origin + window.location.pathname;
        url += '?mosaic=true&cameras=' + encodeURIComponent(cameraIds) + '&layout=' + currentMosaicLayout;
        
        // Abrir em nova aba
        window.open(url, '_blank');
    }

    // Criar overlay do mosaico
    function createMosaicOverlay() {
        var html = `
            <div id="mosaicOverlay" class="mosaic-overlay">
                <div class="mosaic-header">
                    <div class="mosaic-title">
                        <i class="fas fa-th"></i>
                        MOSAICO DE CÂMERAS
                        <span id="mosaicInfo"></span>
                    </div>
                    <div class="mosaic-controls">
                        <button class="mosaic-btn" onclick="setMosaicLayout(4); renderMosaicGrid();">2x2</button>
                        <button class="mosaic-btn" onclick="setMosaicLayout(8); renderMosaicGrid();">2x4</button>
                        <button class="mosaic-btn" onclick="setMosaicLayout(16); renderMosaicGrid();">4x4</button>
                        <button class="mosaic-btn" onclick="setMosaicLayout(24); renderMosaicGrid();">4x6</button>
                        <button class="mosaic-btn" onclick="setMosaicLayout(48); renderMosaicGrid();">6x8</button>
                        <button class="mosaic-btn" onclick="openMosaicModal()"><i class="fas fa-plus"></i> Editar</button>
                        <button class="mosaic-btn close" onclick="closeMosaicView()"><i class="fas fa-times"></i></button>
                    </div>
                </div>
                <div id="mosaicGrid" class="mosaic-grid grid-4"></div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', html);
    }

    // Renderizar grid do mosaico
    function renderMosaicGrid() {
        var grid = document.getElementById('mosaicGrid');
        var info = document.getElementById('mosaicInfo');

        if (!grid) return;

        // Definir classe do grid baseado no layout
        grid.className = 'mosaic-grid grid-' + currentMosaicLayout;

        // Atualizar info
        if (info) {
            info.textContent = '(' + mosaicCameras.length + ' câmeras)';
        }

        var html = '';

        // Renderizar câmeras selecionadas
        mosaicCameras.forEach(function(cam, index) {
            var camId = cam.id || cam.codigo;
            var camNome = cam.nome || cam.name || 'Camera';
            var camUrl = cam.url || '';

            html += '<div class="mosaic-cell">';
            html += '  <div class="mosaic-cell-header">' + camId + ' - ' + camNome + '</div>';
            if (camUrl) {
                html += '  <iframe src="' + camUrl + '" allowfullscreen></iframe>';
            } else {
                html += '  <div class="mosaic-no-stream"><i class="fas fa-video-slash"></i></div>';
            }
            html += '</div>';
        });

        // Preencher células vazias
        for (var i = mosaicCameras.length; i < currentMosaicLayout; i++) {
            html += '<div class="mosaic-cell empty">';
            html += '  <div class="mosaic-empty-cell"><i class="fas fa-plus"></i><br>Vazio</div>';
            html += '</div>';
        }

        grid.innerHTML = html;
    }

    // Fechar visualização do mosaico
    function closeMosaicView() {
        var overlay = document.getElementById('mosaicOverlay');
        if (overlay) {
            overlay.style.display = 'none';
        }
    }

    // Filtrar câmeras (chamado no input)
    function filterCameras() {
        renderCameraList();
    }

    // Selecionar todas as câmeras filtradas
    function selectAllFiltered() {
        var searchTerm = document.getElementById('cameraSearch')?.value?.toLowerCase() || '';

        var filtered = allCameras.filter(function(cam) {
            var id = (cam.id || cam.codigo || '').toString().toLowerCase();
            var nome = (cam.nome || cam.name || '').toLowerCase();
            return id.includes(searchTerm) || nome.includes(searchTerm);
        });

        filtered.forEach(function(cam) {
            var camId = cam.id || cam.codigo;
            var alreadySelected = mosaicCameras.some(function(c) {
                return (c.id || c.codigo) == camId;
            });

            if (!alreadySelected && mosaicCameras.length < currentMosaicLayout) {
                mosaicCameras.push(cam);
            }
        });

        renderCameraList();
    }

    // Limpar seleção
    function clearSelection() {
        mosaicCameras = [];
        renderCameraList();
    }

    // ============================================
    // EXPORT FUNCTIONS TO GLOBAL SCOPE
    // ============================================
    // Necessário para que onclick="" funcione corretamente
    window.toggleLayersSidebar = toggleLayersSidebar;
    window.toggleMapLayer = toggleMapLayer;
    window.toggleCameraSubmenu = toggleCameraSubmenu;
    window.toggleAllCameras = toggleAllCameras;
    window.toggleCameraType = toggleCameraType;
    window.openMosaicModal = openMosaicModal;
    window.closeMosaicModal = closeMosaicModal;
    window.setMosaicLayout = setMosaicLayout;
    window.filterCameras = filterCameras;
    window.selectAllFiltered = selectAllFiltered;
    window.clearSelection = clearSelection;
    window.toggleCameraSelection = toggleCameraSelection;
    window.createMosaicOverlay = createMosaicOverlay;
    window.closeMosaicView = closeMosaicView;
    window.renderMosaicGrid = renderMosaicGrid;
    window.openMosaicView = openMosaicView;
    window.switchLayer = switchLayer;
    window.zoomIn = zoomIn;
    window.zoomOut = zoomOut;
    window.resetView = resetView;

    // ============================================
    // INICIALIZACAO
    // ============================================
    console.log('IntegraCity High-Tech Dashboard initialized');
    console.log('Mapa centrado no Rio de Janeiro');
    console.log('Sistema de camadas carregado');

    // ===== DETECTOR DE MOSAICO NA URL =====
    window.addEventListener('DOMContentLoaded', function() {
        var urlParams = new URLSearchParams(window.location.search);
        
        if (urlParams.get('mosaic') === 'true') {
            var cameraIds = urlParams.get('cameras');
            var layout = parseInt(urlParams.get('layout')) || 4;
            
            console.log('Modo mosaico detectado! IDs:', cameraIds, 'Layout:', layout);
            
            // Configurar layout
            currentMosaicLayout = layout;
            
            // Carregar câmeras da API e depois abrir overlay
            fetch(window.location.origin + '/integracity/api/cameras/')
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    // Parsear dados da API
                    if (data.data && Array.isArray(data.data)) {
                        allCameras = data.data;
                    } else if (Array.isArray(data)) {
                        allCameras = data;
                    }
                    
                    // Selecionar câmeras pelos IDs
                    if (cameraIds) {
                        var ids = cameraIds.split(',');
                        mosaicCameras = allCameras.filter(function(cam) {
                            return ids.includes(String(cam.id));
                        });
                        console.log('Câmeras selecionadas:', mosaicCameras.length);
                    } else {
                        // Se não tem IDs, pegar as primeiras N câmeras
                        mosaicCameras = allCameras.slice(0, layout);
                    }
                    
                    // Criar e abrir overlay
                    createMosaicOverlay();
                    var overlay = document.getElementById('mosaicOverlay');
                    if (overlay) {
                        overlay.style.display = 'flex';
                        renderMosaicGrid();
                    }
                })
                .catch(function(err) {
                    console.error('Erro ao carregar câmeras para mosaico:', err);
                });
        }

        // Carregar camada de ocorrencias automaticamente (checkbox marcado por padrao)
        var ocorrenciasCheckbox = document.getElementById('layerOcorrencias');
        if (ocorrenciasCheckbox && ocorrenciasCheckbox.checked) {
            console.log('Carregando ocorrencias automaticamente...');
            mapLayers.ocorrencias.addTo(map);
            loadLayerData('ocorrencias');
        }
    });

    // Atualizar ocorrencias a cada 2 minutos
    setInterval(function() {
        var ocorrenciasCheckbox = document.getElementById('layerOcorrencias');
        if (ocorrenciasCheckbox && ocorrenciasCheckbox.checked) {
            console.log('Atualizando ocorrencias...');
            loadLayerData('ocorrencias');
        }
    }, 120000);

</script>

<!-- ============================================
     MODAL DE SELEÇÃO DO MOSAICO
     ============================================ -->
<div id="mosaicModal" class="mosaic-modal" style="display: none;">
    <div class="mosaic-modal-content">
        <div class="mosaic-modal-header">
            <h2><i class="fas fa-th"></i> Configurar Mosaico</h2>
            <button class="mosaic-close-btn" onclick="closeMosaicModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="mosaic-modal-body">
            <!-- Layout Selection -->
            <div class="layout-section">
                <label>Layout:</label>
                <div class="layout-buttons">
                    <button class="layout-btn active" onclick="setMosaicLayout(4)">2x2 (4)</button>
                    <button class="layout-btn" onclick="setMosaicLayout(8)">2x4 (8)</button>
                    <button class="layout-btn" onclick="setMosaicLayout(16)">4x4 (16)</button>
                    <button class="layout-btn" onclick="setMosaicLayout(24)">4x6 (24)</button>
                    <button class="layout-btn" onclick="setMosaicLayout(48)">6x8 (48)</button>
                </div>
            </div>

            <!-- Search -->
            <div class="search-section">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="cameraSearch" placeholder="Buscar por ID ou nome..." oninput="filterCameras()">
                </div>
                <div class="search-actions">
                    <button class="action-btn" onclick="selectAllFiltered()">
                        <i class="fas fa-check-double"></i> Selecionar Filtrados
                    </button>
                    <button class="action-btn" onclick="clearSelection()">
                        <i class="fas fa-trash"></i> Limpar
                    </button>
                </div>
            </div>

            <!-- Counter -->
            <div class="selection-counter">
                Selecionadas: <span id="selectedCount">0 / 4</span>
            </div>

            <!-- Camera List -->
            <div id="cameraListContainer" class="camera-list-container">
                <div class="loading-cameras">
                    <i class="fas fa-spinner fa-spin"></i> Carregando câmeras...
                </div>
            </div>
        </div>

        <div class="mosaic-modal-footer">
            <button class="cancel-btn" onclick="closeMosaicModal()">Cancelar</button>
            <button class="start-btn" onclick="startMosaic()">
                <i class="fas fa-play"></i> Iniciar Mosaico
            </button>
        </div>
    </div>
</div>

{% endblock %}
