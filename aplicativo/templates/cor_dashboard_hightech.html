{% extends 'base_hightech.html' %}
{% load static %}

{% block sidebar_class %}{% endblock %}
{% block toggle_class %}{% endblock %}
{% block wrapper_class %}{% endblock %}

{% block title %}IntegraCity - Command Center Dashboard{% endblock %}

{% block monitoring_cards %}
<!-- ============================================
     CARDS COMPACTOS RETRÁTEIS
     ============================================ -->

<!-- Card 1: Estágio Operacional (Integrado com Matriz Decisória) -->
<div class="compact-card" onclick="toggleCard(this)">
    <div class="card-header">
        <div class="card-header-left">
            <div class="card-icon" style="background: {{ estagio_cor|default:'#00ff88' }}20; color: {{ estagio_cor|default:'#00ff88' }};">
                <i class="fas fa-shield-alt"></i>
            </div>
            <div class="card-main-info">
                <div class="card-value" style="color: {{ estagio_cor|default:'#00ff88' }};">
                    E{{ estagio|default:"1" }}
                </div>
                <div class="card-label">Estagio<br>Operacional</div>
            </div>
        </div>
        <div class="card-header-right">
            <div class="status-badge" style="background: {{ estagio_cor|default:'#00ff88' }}20; color: {{ estagio_cor|default:'#00ff88' }}; border-color: {{ estagio_cor|default:'#00ff88' }};">
                <div class="status-dot" style="background: {{ estagio_cor|default:'#00ff88' }};"></div>
                {{ estagio_status|default:"NORMAL" }}
            </div>
            <i class="fas fa-chevron-down expand-icon"></i>
        </div>
    </div>
    <div class="card-body">
        <div class="card-content">
            <div class="card-detail-row">
                <span class="detail-label">Nivel</span>
                <span class="detail-value" style="color: {{ estagio_cor|default:'#00ff88' }};">{{ estagio|default:"1" }} - {{ estagio_label|default:"Normal" }}</span>
            </div>
            <div class="card-detail-row">
                <span class="detail-label">Regiao</span>
                <span class="detail-value">Toda a cidade</span>
            </div>
            <div class="live-indicator">
                <div class="live-dot"></div>
                Matriz Decisoria
            </div>
        </div>
    </div>
</div>

<!-- Card 2: Mobilidade -->
<div class="compact-card" onclick="toggleCard(this)">
    <div class="card-header">
        <div class="card-header-left">
            <div class="card-icon green">
                <i class="fas fa-car"></i>
            </div>
            <div class="card-main-info">
                <div class="card-value green">{{ mobilidade_nivel|default:"N1" }}</div>
                <div class="card-label">Mobilidade<br>Urbana</div>
            </div>
        </div>
        <div class="card-header-right">
            <div class="status-badge normal">
                <div class="status-dot"></div>
                {{ mobilidade_status|default:"NORMAL" }}
            </div>
            <i class="fas fa-chevron-down expand-icon"></i>
        </div>
    </div>
    <div class="card-body">
        <div class="card-content">
            <div class="card-detail-row">
                <span class="detail-label">Alertas Waze</span>
                <span class="detail-value">{{ waze_alerts|default:"0" }}</span>
            </div>
            <div class="card-detail-row">
                <span class="detail-label">Vias impactadas</span>
                <span class="detail-value">{{ vias_impactadas|default:"0" }}</span>
            </div>
            <div class="card-detail-row">
                <span class="detail-label">Status</span>
                <span class="detail-value">{{ mobilidade_desc|default:"Transito Normal" }}</span>
            </div>
            <div class="live-indicator">
                <div class="live-dot"></div>
                Dados Waze em tempo real
            </div>
        </div>
    </div>
</div>

<!-- Card 4: Meteorologia -->
<div class="compact-card" onclick="toggleCard(this)">
    <div class="card-header">
        <div class="card-header-left">
            <div class="card-icon green">
                <i class="fas fa-cloud-sun"></i>
            </div>
            <div class="card-main-info">
                <div class="card-value green">E{{ meteo_nivel|default:"1" }}</div>
                <div class="card-label">Meteorologia</div>
            </div>
        </div>
        <div class="card-header-right">
            <div class="status-badge normal">
                <div class="status-dot"></div>
                {{ meteo_status|default:"NORMAL" }}
            </div>
            <i class="fas fa-chevron-down expand-icon"></i>
        </div>
    </div>
    <div class="card-body">
        <div class="card-content">
            <div class="card-detail-row">
                <span class="detail-label">Temperatura</span>
                <span class="detail-value">{{ temperatura|default:"--" }}C</span>
            </div>
            <div class="card-detail-row">
                <span class="detail-label">Umidade</span>
                <span class="detail-value">{{ umidade|default:"--" }}%</span>
            </div>
            <div class="card-detail-row">
                <span class="detail-label">Precipitacao</span>
                <span class="detail-value">{{ precipitacao|default:"0" }} mm</span>
            </div>
            <div class="live-indicator">
                <div class="live-dot"></div>
                Dados meteorologicos
            </div>
        </div>
    </div>
</div>

<!-- Card 5: Nível de Calor (NC1-NC5) -->
<div class="compact-card" onclick="toggleCard(this)">
    <div class="card-header">
        <div class="card-header-left">
            <div class="card-icon" style="background: {{ calor_cor|default:'#00ff88' }}20; color: {{ calor_cor|default:'#00ff88' }};">
                <i class="fas fa-temperature-high"></i>
            </div>
            <div class="card-main-info">
                <div class="card-value" style="color: {{ calor_cor|default:'#00ff88' }};">
                    NC{{ calor_nivel|default:"1" }}
                </div>
                <div class="card-label">Indice de<br>Calor</div>
            </div>
        </div>
        <div class="card-header-right">
            <div class="status-badge" style="background: {{ calor_cor|default:'#00ff88' }}20; color: {{ calor_cor|default:'#00ff88' }}; border-color: {{ calor_cor|default:'#00ff88' }};">
                <div class="status-dot" style="background: {{ calor_cor|default:'#00ff88' }};"></div>
                {{ calor_status|default:"NORMAL" }}
            </div>
            <i class="fas fa-chevron-down expand-icon"></i>
        </div>
    </div>
    <div class="card-body">
        <div class="card-content">
            <div class="card-detail-row">
                <span class="detail-label">Status</span>
                <span class="detail-value">{{ calor_label|default:"Normal" }}</span>
            </div>
            <div class="card-detail-row">
                <span class="detail-label">Heat Index</span>
                <span class="detail-value">{{ heat_index|default:"--" }}C</span>
            </div>
            <div class="card-detail-row">
                <span class="detail-label">Temperatura</span>
                <span class="detail-value">{{ temperatura|default:"--" }}C</span>
            </div>
            <div class="card-detail-row">
                <span class="detail-label">Umidade</span>
                <span class="detail-value">{{ umidade|default:"--" }}%</span>
            </div>
            <div class="live-indicator">
                <div class="live-dot"></div>
                Monitoramento ativo
            </div>
        </div>
    </div>
</div>

<!-- Card 6: Câmeras -->
<div class="compact-card" onclick="toggleCard(this)">
    <div class="card-header">
        <div class="card-header-left">
            <div class="card-icon green">
                <i class="fas fa-video"></i>
            </div>
            <div class="card-main-info">
                <div class="card-value green">{{ cameras_total|default:"0" }}</div>
                <div class="card-label">Cameras<br>Ativas</div>
            </div>
        </div>
        <div class="card-header-right">
            <div class="status-badge normal">
                <div class="status-dot"></div>
                ATIVAS
            </div>
            <i class="fas fa-chevron-down expand-icon"></i>
        </div>
    </div>
    <div class="card-body">
        <div class="card-content">
            <div class="card-detail-row">
                <span class="detail-label">Fixas</span>
                <span class="detail-value" style="color: var(--cyan);">{{ cameras_fixas|default:"0" }}</span>
            </div>
            <div class="card-detail-row">
                <span class="detail-label">Moveis</span>
                <span class="detail-value" style="color: var(--green-neon);">{{ cameras_moveis|default:"0" }}</span>
            </div>
            <div class="card-detail-row">
                <span class="detail-label">Total</span>
                <span class="detail-value" style="color: var(--purple-neon);">{{ cameras_total|default:"0" }}</span>
            </div>
            <div class="live-indicator">
                <div class="live-dot"></div>
                Fonte: TIXXI
            </div>
        </div>
    </div>
</div>

<!-- Card 7: Eventos -->
<div class="compact-card" onclick="toggleCard(this)">
    <div class="card-header">
        <div class="card-header-left">
            <div class="card-icon green">
                <i class="fas fa-calendar-alt"></i>
            </div>
            <div class="card-main-info">
                <div class="card-value green">{{ eventos_count|default:"0" }}</div>
                <div class="card-label">Eventos<br>Hoje</div>
            </div>
        </div>
        <div class="card-header-right">
            <div class="status-badge normal">
                <div class="status-dot"></div>
                HOJE
            </div>
            <i class="fas fa-chevron-down expand-icon"></i>
        </div>
    </div>
    <div class="card-body">
        <div class="card-content">
            <div class="card-detail-row">
                <span class="detail-label">Grande porte</span>
                <span class="detail-value">{{ eventos_grandes|default:"0" }}</span>
            </div>
            <div class="card-detail-row">
                <span class="detail-label">Esta semana</span>
                <span class="detail-value">{{ eventos_semana|default:"0" }}</span>
            </div>
            <div class="live-indicator">
                <div class="live-dot"></div>
                Agenda atualizada
            </div>
        </div>
    </div>
</div>

<!-- Card 8: Sirenes -->
<div class="compact-card" onclick="toggleCard(this)">
    <div class="card-header">
        <div class="card-header-left">
            <div class="card-icon {% if sirenes_acionadas > 0 %}red{% else %}green{% endif %}">
                <i class="fas fa-bullhorn"></i>
            </div>
            <div class="card-main-info">
                <div class="card-value {% if sirenes_acionadas > 0 %}red{% else %}green{% endif %}">
                    {{ sirenes_acionadas|default:"0" }}
                </div>
                <div class="card-label">Sirenes<br>Acionadas</div>
            </div>
        </div>
        <div class="card-header-right">
            <div class="status-badge {% if sirenes_acionadas > 0 %}critical{% else %}normal{% endif %}">
                <div class="status-dot"></div>
                {% if sirenes_acionadas > 0 %}ACIONADAS{% else %}STAND-BY{% endif %}
            </div>
            <i class="fas fa-chevron-down expand-icon"></i>
        </div>
    </div>
    <div class="card-body">
        <div class="card-content">
            <div class="card-detail-row">
                <span class="detail-label">Total de sirenes</span>
                <span class="detail-value">{{ sirenes_total|default:"0" }}</span>
            </div>
            <div class="card-detail-row">
                <span class="detail-label">Operantes</span>
                <span class="detail-value" style="color: var(--green-neon);">{{ sirenes_operantes|default:"0" }}</span>
            </div>
            <div class="live-indicator">
                <div class="live-dot"></div>
                Sistema de alerta
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block content %}
<div class="map-container" id="mapContainer">
    <!-- ============================================
         FLOATING INFO (TOP LEFT)
         ============================================ -->
    <div class="floating-info">
        <div class="info-card">
            <div class="info-card-title">Temperatura</div>
            <div class="info-card-value">{{ temperatura|default:"--" }}C</div>
        </div>
        <div class="info-card">
            <div class="info-card-title">Umidade</div>
            <div class="info-card-value">{{ umidade|default:"--" }}%</div>
        </div>
        <div class="info-card">
            <div class="info-card-title">Precipitacao</div>
            <div class="info-card-value">{{ precipitacao|default:"0" }}mm</div>
        </div>
    </div>

    <!-- ============================================
         MAPA LEAFLET
         ============================================ -->
    <div id="leafletMap" style="height: 100%; width: 100%;"></div>

    <!-- ============================================
         MAP CONTROLS (TOP RIGHT)
         ============================================ -->
    <div class="map-controls">
        <button class="map-control-btn" onclick="zoomIn()" title="Zoom In">
            <i class="fas fa-plus"></i>
        </button>
        <button class="map-control-btn" onclick="zoomOut()" title="Zoom Out">
            <i class="fas fa-minus"></i>
        </button>
        <button class="map-control-btn" onclick="resetView()" title="Resetar Visualizacao">
            <i class="fas fa-crosshairs"></i>
        </button>
        <button class="map-control-btn" onclick="locateUser()" title="Minha Localizacao">
            <i class="fas fa-location-arrow"></i>
        </button>
        <button class="map-control-btn" onclick="toggleFullscreen()" title="Tela Cheia">
            <i class="fas fa-expand"></i>
        </button>
        <button class="map-control-btn" id="layersToggleBtn" onclick="toggleLayersSidebar()" title="Camadas do Mapa">
            <i class="fas fa-layer-group"></i>
        </button>
        <button class="map-control-btn tour-btn" id="tourControlBtn" onclick="toggleTourOcorrencias()" title="Tour Automatico de Ocorrencias">
            <i class="fas fa-route" id="tourIcon"></i>
        </button>
        <button class="map-control-btn ocorrencias-btn" onclick="window.open('{% url 'ocorrencias_dashboard' %}', '_blank')" title="Gerenciar Ocorrencias">
            <i class="fas fa-clipboard-list"></i>
        </button>
        <button class="map-control-btn nova-ocorrencia-btn" onclick="window.open('{% url 'ocorrencia_criar' %}', '_blank')" title="Nova Ocorrencia">
            <i class="fas fa-plus-circle"></i>
        </button>
        <button class="map-control-btn areas-btn" id="btnCriarArea" onclick="iniciarDesenhoArea()" title="Criar Area de Observacao">
            <i class="fas fa-draw-polygon"></i>
        </button>
    </div>

    <!-- ============================================
         LAYER SELECTOR (BOTTOM RIGHT)
         ============================================ -->
    <div class="layer-selector">
        <button class="layer-btn active" onclick="switchLayer(this, 'dark')">Dark</button>
        <button class="layer-btn" onclick="switchLayer(this, 'street')">Ruas</button>
        <button class="layer-btn" onclick="switchLayer(this, 'satellite')">Satelite</button>
        <button class="layer-btn" onclick="switchLayer(this, 'terrain')">Terreno</button>
    </div>

    <!-- ============================================
         SIDEBAR DIREITA - CAMADAS DO MAPA
         ============================================ -->
    <div class="layers-sidebar" id="layersSidebar">
        <div class="layers-content">
            <div class="layers-header">
                <i class="fas fa-layer-group"></i>
                <span>CAMADAS</span>
                <button class="layers-close" onclick="toggleLayersSidebar()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="layers-list">
                <!-- Escolas -->
                <div class="layer-item" onclick="toggleLayerByClick('escolas', event)">
                    <label class="layer-checkbox" onclick="event.stopPropagation()">
                        <input type="checkbox" id="layerEscolas" onchange="toggleMapLayer('escolas')">
                        <span class="checkmark"></span>
                    </label>
                    <div class="layer-icon" style="background: rgba(76, 175, 80, 0.2); color: #4CAF50;">
                        <i class="fas fa-school"></i>
                    </div>
                    <div class="layer-info">
                        <span class="layer-name">Escolas</span>
                        <span class="layer-count" id="countEscolas">--</span>
                    </div>
                </div>
                <!-- Campo de busca de escolas -->
                <div class="escola-search-container" id="escolaSearchContainer" style="display: none;">
                    <div class="escola-search-wrapper">
                        <i class="fas fa-search escola-search-icon"></i>
                        <input type="text"
                               id="escolaSearchInput"
                               class="escola-search-input"
                               placeholder="Buscar escola por nome..."
                               autocomplete="off">
                        <button class="escola-search-clear" id="escolaSearchClear" style="display: none;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="escola-autocomplete-list" id="escolaAutocompleteList"></div>
                </div>

                <!-- Hospitais -->
                <div class="layer-item" onclick="toggleLayerByClick('hospitais', event)">
                    <label class="layer-checkbox" onclick="event.stopPropagation()">
                        <input type="checkbox" id="layerHospitais" onchange="toggleMapLayer('hospitais')">
                        <span class="checkmark"></span>
                    </label>
                    <div class="layer-icon" style="background: rgba(244, 67, 54, 0.2); color: #F44336;">
                        <i class="fas fa-hospital"></i>
                    </div>
                    <div class="layer-info">
                        <span class="layer-name">Hospitais</span>
                        <span class="layer-count" id="countHospitais">--</span>
                    </div>
                </div>

                <!-- Pluviometros -->
                <div class="layer-item" onclick="toggleLayerByClick('pluviometros', event)">
                    <label class="layer-checkbox" onclick="event.stopPropagation()">
                        <input type="checkbox" id="layerPluviometros" onchange="toggleMapLayer('pluviometros')">
                        <span class="checkmark"></span>
                    </label>
                    <div class="layer-icon" style="background: rgba(33, 150, 243, 0.2); color: #2196F3;">
                        <i class="fas fa-cloud-rain"></i>
                    </div>
                    <div class="layer-info">
                        <span class="layer-name">Pluviometros</span>
                        <span class="layer-count" id="countPluviometros">--</span>
                    </div>
                </div>

                <!-- Sirenes -->
                <div class="layer-item" onclick="toggleLayerByClick('sirenes', event)">
                    <label class="layer-checkbox" onclick="event.stopPropagation()">
                        <input type="checkbox" id="layerSirenes" onchange="toggleMapLayer('sirenes')">
                        <span class="checkmark"></span>
                    </label>
                    <div class="layer-icon" style="background: rgba(255, 152, 0, 0.2); color: #FF9800;">
                        <i class="fas fa-bullhorn"></i>
                    </div>
                    <div class="layer-info">
                        <span class="layer-name">Sirenes</span>
                        <span class="layer-count" id="countSirenes">--</span>
                    </div>
                </div>

                <!-- Cameras - Com Submenu -->
                <div class="layer-item-group">
                    <div class="layer-item has-submenu" onclick="toggleCameraSubmenu(event)">
                        <label class="layer-checkbox" onclick="event.stopPropagation()">
                            <input type="checkbox" id="layerCameras" onchange="toggleAllCameras()">
                            <span class="checkmark"></span>
                        </label>
                        <div class="layer-icon" style="background: rgba(156, 39, 176, 0.2); color: #9C27B0;">
                            <i class="fas fa-video"></i>
                        </div>
                        <div class="layer-info">
                            <span class="layer-name">Cameras</span>
                            <span class="layer-count" id="countCameras">--</span>
                        </div>
                        <div class="submenu-toggle">
                            <i class="fas fa-chevron-down"></i>
                        </div>
                    </div>

                    <!-- Submenu de Cameras -->
                    <div class="layer-submenu" id="cameraSubmenu">
                        <!-- Filtro Cameras Fixas -->
                        <div class="submenu-item" onclick="event.stopPropagation()">
                            <label class="submenu-checkbox">
                                <input type="checkbox" id="layerCamerasFixas" onchange="toggleCameraType('fixas')" checked>
                                <span class="submenu-checkmark"></span>
                            </label>
                            <div class="submenu-icon fixas">
                                <i class="fas fa-video"></i>
                            </div>
                            <span class="submenu-label">Fixas</span>
                            <span class="submenu-badge" id="countCamerasFixas">--</span>
                        </div>

                        <!-- Filtro Cameras Moveis -->
                        <div class="submenu-item" onclick="event.stopPropagation()">
                            <label class="submenu-checkbox">
                                <input type="checkbox" id="layerCamerasMoveis" onchange="toggleCameraType('moveis')" checked>
                                <span class="submenu-checkmark"></span>
                            </label>
                            <div class="submenu-icon moveis">
                                <i class="fas fa-video"></i>
                            </div>
                            <span class="submenu-label">Moveis</span>
                            <span class="submenu-badge" id="countCamerasMoveis">--</span>
                        </div>

                        <!-- Separador -->
                        <div class="submenu-divider"></div>

                        <!-- Botao Mosaico -->
                        <div class="submenu-item submenu-action" onclick="openMosaicModal()">
                            <div class="submenu-icon mosaico">
                                <i class="fas fa-th-large"></i>
                            </div>
                            <span class="submenu-label">Mosaico de Cameras</span>
                            <i class="fas fa-external-link-alt submenu-arrow-icon"></i>
                        </div>

                        <!-- Separador -->
                        <div class="submenu-divider"></div>

                        <!-- Campo de busca de câmeras -->
                        <div class="camera-search-container" id="cameraSearchContainer">
                            <div class="camera-search-wrapper">
                                <i class="fas fa-search camera-search-icon"></i>
                                <input type="text"
                                       id="cameraSearchInput"
                                       class="camera-search-input"
                                       placeholder="Buscar camera por nome..."
                                       autocomplete="off"
                                       onclick="event.stopPropagation()">
                                <button class="camera-search-clear" id="cameraSearchClear" style="display: none;" onclick="event.stopPropagation()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="camera-autocomplete-list" id="cameraAutocompleteList"></div>
                        </div>
                    </div>
                </div>

                <!-- Metro -->
                <div class="layer-item" onclick="toggleLayerByClick('metro', event)">
                    <label class="layer-checkbox" onclick="event.stopPropagation()">
                        <input type="checkbox" id="layerMetro" onchange="toggleMapLayer('metro')">
                        <span class="checkmark"></span>
                    </label>
                    <div class="layer-icon" style="background: rgba(255, 87, 34, 0.2); color: #FF5722;">
                        <i class="fas fa-subway"></i>
                    </div>
                    <div class="layer-info">
                        <span class="layer-name">Metro</span>
                        <span class="layer-count" id="countMetro">--</span>
                    </div>
                </div>

                <!-- BRT -->
                <div class="layer-item" onclick="toggleLayerByClick('brt', event)">
                    <label class="layer-checkbox" onclick="event.stopPropagation()">
                        <input type="checkbox" id="layerBRT" onchange="toggleMapLayer('brt')">
                        <span class="checkmark"></span>
                    </label>
                    <div class="layer-icon" style="background: rgba(0, 150, 136, 0.2); color: #009688;">
                        <i class="fas fa-bus"></i>
                    </div>
                    <div class="layer-info">
                        <span class="layer-name">BRT</span>
                        <span class="layer-count" id="countBRT">--</span>
                    </div>
                </div>

                <!-- Waze - Com Submenu de Filtros -->
                <div class="layer-item-group">
                    <div class="layer-item has-submenu" onclick="toggleWazeSubmenu(event)">
                        <label class="layer-checkbox" onclick="event.stopPropagation()">
                            <input type="checkbox" id="layerWaze" onchange="toggleAllWaze()">
                            <span class="checkmark"></span>
                        </label>
                        <div class="layer-icon" style="background: rgba(0, 212, 255, 0.2); color: #00d4ff;">
                            <i class="fab fa-waze"></i>
                        </div>
                        <div class="layer-info">
                            <span class="layer-name">Waze</span>
                            <span class="layer-count" id="countWaze">--</span>
                        </div>
                        <div class="submenu-toggle">
                            <i class="fas fa-chevron-down"></i>
                        </div>
                    </div>

                    <!-- Submenu Waze -->
                    <div class="layer-submenu" id="wazeSubmenu">
                        <!-- Congestionamentos -->
                        <div class="submenu-item" onclick="event.stopPropagation()">
                            <label class="submenu-checkbox">
                                <input type="checkbox" id="layerWazeCongestionamentos" onchange="toggleWazeFilter('congestionamentos')" checked>
                                <span class="submenu-checkmark"></span>
                            </label>
                            <div class="submenu-icon" style="background: rgba(255, 165, 0, 0.2); color: #ffa500; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-traffic-light" style="font-size: 12px;"></i>
                            </div>
                            <span class="submenu-label">Congestionamentos</span>
                            <span class="submenu-badge" id="countWazeCongestionamentos">--</span>
                        </div>

                        <!-- Vias Interditadas -->
                        <div class="submenu-item" onclick="event.stopPropagation()">
                            <label class="submenu-checkbox">
                                <input type="checkbox" id="layerWazeInterdicoes" onchange="toggleWazeFilter('interdicoes')" checked>
                                <span class="submenu-checkmark"></span>
                            </label>
                            <div class="submenu-icon" style="background: rgba(255, 0, 85, 0.2); color: #FF0055; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-ban" style="font-size: 12px;"></i>
                            </div>
                            <span class="submenu-label">Vias Interditadas</span>
                            <span class="submenu-badge" id="countWazeInterdicoes">--</span>
                        </div>

                        <!-- Eventos Especiais -->
                        <div class="submenu-item" onclick="event.stopPropagation()">
                            <label class="submenu-checkbox">
                                <input type="checkbox" id="layerWazeEventos" onchange="toggleWazeFilter('eventos')" checked>
                                <span class="submenu-checkmark"></span>
                            </label>
                            <div class="submenu-icon" style="background: rgba(156, 39, 176, 0.2); color: #9C27B0; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-calendar-alt" style="font-size: 12px;"></i>
                            </div>
                            <span class="submenu-label">Eventos</span>
                            <span class="submenu-badge" id="countWazeEventos">--</span>
                        </div>

                        <!-- Acidentes -->
                        <div class="submenu-item" onclick="event.stopPropagation()">
                            <label class="submenu-checkbox">
                                <input type="checkbox" id="layerWazeAcidentes" onchange="toggleWazeFilter('acidentes')" checked>
                                <span class="submenu-checkmark"></span>
                            </label>
                            <div class="submenu-icon" style="background: rgba(255, 0, 85, 0.2); color: #FF0055; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-car-crash" style="font-size: 12px;"></i>
                            </div>
                            <span class="submenu-label">Acidentes</span>
                            <span class="submenu-badge" id="countWazeAcidentes">--</span>
                        </div>

                        <!-- Buracos -->
                        <div class="submenu-item" onclick="event.stopPropagation()">
                            <label class="submenu-checkbox">
                                <input type="checkbox" id="layerWazeBuracos" onchange="toggleWazeFilter('buracos')" checked>
                                <span class="submenu-checkmark"></span>
                            </label>
                            <div class="submenu-icon" style="background: rgba(139, 69, 19, 0.2); color: #8B4513; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-road-circle-exclamation" style="font-size: 12px;"></i>
                            </div>
                            <span class="submenu-label">Buracos</span>
                            <span class="submenu-badge" id="countWazeBuracos">--</span>
                        </div>

                        <!-- Perigos na Via -->
                        <div class="submenu-item" onclick="event.stopPropagation()">
                            <label class="submenu-checkbox">
                                <input type="checkbox" id="layerWazePerigos" onchange="toggleWazeFilter('perigos')" checked>
                                <span class="submenu-checkmark"></span>
                            </label>
                            <div class="submenu-icon" style="background: rgba(255, 193, 7, 0.2); color: #FFC107; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-triangle-exclamation" style="font-size: 12px;"></i>
                            </div>
                            <span class="submenu-label">Perigos</span>
                            <span class="submenu-badge" id="countWazePerigos">--</span>
                        </div>

                        <!-- Carro Parado -->
                        <div class="submenu-item" onclick="event.stopPropagation()">
                            <label class="submenu-checkbox">
                                <input type="checkbox" id="layerWazeCarroParado" onchange="toggleWazeFilter('carroParado')" checked>
                                <span class="submenu-checkmark"></span>
                            </label>
                            <div class="submenu-icon" style="background: rgba(100, 100, 100, 0.2); color: #888; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-car-on" style="font-size: 12px;"></i>
                            </div>
                            <span class="submenu-label">Carro Parado</span>
                            <span class="submenu-badge" id="countWazeCarroParado">--</span>
                        </div>

                        <!-- Policia -->
                        <div class="submenu-item" onclick="event.stopPropagation()">
                            <label class="submenu-checkbox">
                                <input type="checkbox" id="layerWazePolicia" onchange="toggleWazeFilter('policia')" checked>
                                <span class="submenu-checkmark"></span>
                            </label>
                            <div class="submenu-icon" style="background: rgba(0, 123, 255, 0.2); color: #007bff; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-user-shield" style="font-size: 12px;"></i>
                            </div>
                            <span class="submenu-label">Policia</span>
                            <span class="submenu-badge" id="countWazePolicia">--</span>
                        </div>

                        <!-- Outros Alertas -->
                        <div class="submenu-item" onclick="event.stopPropagation()">
                            <label class="submenu-checkbox">
                                <input type="checkbox" id="layerWazeOutros" onchange="toggleWazeFilter('outros')" checked>
                                <span class="submenu-checkmark"></span>
                            </label>
                            <div class="submenu-icon" style="background: rgba(128, 128, 128, 0.2); color: #808080; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-circle-info" style="font-size: 12px;"></i>
                            </div>
                            <span class="submenu-label">Outros</span>
                            <span class="submenu-badge" id="countWazeOutros">--</span>
                        </div>
                    </div>
                </div>

                <!-- Bolsoes de Alagamento -->
                <div class="layer-item" onclick="toggleLayerByClick('bolsoes', event)">
                    <label class="layer-checkbox" onclick="event.stopPropagation()">
                        <input type="checkbox" id="layerBolsoes" onchange="toggleMapLayer('bolsoes')">
                        <span class="checkmark"></span>
                    </label>
                    <div class="layer-icon" style="background: rgba(6, 182, 212, 0.2); color: #06b6d4;">
                        <i class="fas fa-water"></i>
                    </div>
                    <div class="layer-info">
                        <span class="layer-name">Bolsoes</span>
                        <span class="layer-count" id="countBolsoes">--</span>
                    </div>
                </div>

                <!-- Ocorrencias -->
                <div class="layer-item" onclick="toggleLayerByClick('ocorrencias', event)">
                    <label class="layer-checkbox" onclick="event.stopPropagation()">
                        <input type="checkbox" id="layerOcorrencias" onchange="toggleMapLayer('ocorrencias')" checked>
                        <span class="checkmark"></span>
                    </label>
                    <div class="layer-icon" style="background: rgba(255, 0, 85, 0.2); color: #FF0055;">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="layer-info">
                        <span class="layer-name">Ocorrencias</span>
                        <span class="layer-count" id="countOcorrencias">--</span>
                    </div>
                </div>

                <!-- Areas de Observacao - Com Submenu -->
                <div class="layer-item-group">
                    <div class="layer-item has-submenu" onclick="toggleAreasSubmenu(event)">
                        <label class="layer-checkbox" onclick="event.stopPropagation()">
                            <input type="checkbox" id="layerAreasObservacao" onchange="toggleMapLayer('areasObservacao')" checked>
                            <span class="checkmark"></span>
                        </label>
                        <div class="layer-icon" style="background: rgba(0, 212, 255, 0.2); color: #00D4FF;">
                            <i class="fas fa-draw-polygon"></i>
                        </div>
                        <div class="layer-info">
                            <span class="layer-name">Areas de Observacao</span>
                            <span class="layer-count" id="countAreasObservacao">--</span>
                        </div>
                        <div class="submenu-toggle">
                            <i class="fas fa-chevron-down"></i>
                        </div>
                    </div>

                    <!-- Submenu de Areas -->
                    <div class="layer-submenu" id="areasSubmenu">
                        <!-- Desenhar Nova Area -->
                        <div class="submenu-item submenu-action" onclick="iniciarDesenhoArea(); event.stopPropagation();">
                            <div class="submenu-icon" style="background: rgba(0, 212, 255, 0.2); color: #00D4FF;">
                                <i class="fas fa-pencil-alt"></i>
                            </div>
                            <span class="submenu-label">Desenhar Nova Area</span>
                            <i class="fas fa-pencil-alt submenu-arrow-icon"></i>
                        </div>

                        <!-- Importar KML/KMZ -->
                        <div class="submenu-item submenu-action" onclick="abrirModalImportarKML(); event.stopPropagation();">
                            <div class="submenu-icon" style="background: rgba(76, 175, 80, 0.2); color: #4CAF50;">
                                <i class="fas fa-file-import"></i>
                            </div>
                            <span class="submenu-label">Importar KML/KMZ</span>
                            <i class="fas fa-upload submenu-arrow-icon"></i>
                        </div>

                        <!-- Gerenciar Importacoes -->
                        <div class="submenu-item submenu-action" onclick="abrirModalGerenciarImportacoes(); event.stopPropagation();">
                            <div class="submenu-icon" style="background: rgba(156, 39, 176, 0.2); color: #9C27B0;">
                                <i class="fas fa-folder-open"></i>
                            </div>
                            <span class="submenu-label">Gerenciar Importacoes</span>
                            <i class="fas fa-cog submenu-arrow-icon"></i>
                        </div>

                        <!-- Separador -->
                        <div class="submenu-divider"></div>

                        <!-- Ver Todas as Areas -->
                        <div class="submenu-item submenu-action" onclick="window.open('/integracity/areas/', '_blank'); event.stopPropagation();">
                            <div class="submenu-icon" style="background: rgba(255, 152, 0, 0.2); color: #FF9800;">
                                <i class="fas fa-list"></i>
                            </div>
                            <span class="submenu-label">Gerenciar Areas</span>
                            <i class="fas fa-external-link-alt submenu-arrow-icon"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Acoes rapidas -->
            <div class="layers-actions">
                <button class="layer-action-btn" onclick="selectAllLayers()">
                    <i class="fas fa-check-double"></i> Todos
                </button>
                <button class="layer-action-btn" onclick="clearAllLayers()">
                    <i class="fas fa-times"></i> Limpar
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<!-- Leaflet.draw CSS para desenho de áreas -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
<style>
    /* Estilo para botao de criar area */
    .map-control-btn.areas-btn {
        background: rgba(0, 212, 255, 0.2);
        border-color: #00D4FF;
        color: #00D4FF;
    }
    .map-control-btn.areas-btn:hover {
        background: #00D4FF;
        color: #000;
        box-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
    }
    .map-control-btn.areas-btn.active {
        background: #00D4FF;
        color: #000;
        animation: pulse-glow 1.5s infinite;
    }
    @keyframes pulse-glow {
        0%, 100% { box-shadow: 0 0 10px rgba(0, 212, 255, 0.5); }
        50% { box-shadow: 0 0 25px rgba(0, 212, 255, 0.8); }
    }
    /* Esconder toolbar padrao do Leaflet.draw */
    .leaflet-draw-toolbar {
        display: none !important;
    }
    /* Popup de area */
    .area-popup {
        min-width: 200px;
    }
    .area-popup h6 {
        margin: 0 0 8px 0;
        font-family: 'Orbitron', monospace;
    }
    .area-popup .area-nivel {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: 600;
    }
    .area-popup .btn-area-dashboard {
        margin-top: 10px;
        padding: 6px 12px;
        font-size: 0.85rem;
    }
</style>
{% endblock %}

{% block extra_js %}
<!-- Leaflet.draw JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
<script>
    // ============================================
    // INICIALIZACAO DO MAPA LEAFLET
    // ============================================

    // Centro do Município do Rio de Janeiro
    var map = L.map('leafletMap', {
        center: [-22.92, -43.45],
        zoom: 11,
        zoomControl: false,
        attributionControl: false
    });

    // Definir camadas de tiles
    var layers = {
        dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            maxZoom: 19
        }),
        street: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19
        }),
        satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 19
        }),
        terrain: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
            maxZoom: 17
        })
    };

    // Adicionar camada baseada no tema salvo
    var savedTheme = 'dark';
    try {
        var savedSettingsInit = localStorage.getItem('integracity_settings');
        if (savedSettingsInit) {
            var parsedSettings = JSON.parse(savedSettingsInit);
            savedTheme = parsedSettings.theme || 'dark';
        }
    } catch(e) {}

    // Aplicar layer inicial: street para tema claro, dark para tema escuro
    var initialLayer = (savedTheme === 'light') ? 'street' : 'dark';
    layers[initialLayer].addTo(map);

    // Variavel global para rastrear o layer atual baseado no tema
    var currentThemeLayer = initialLayer;

    // ============================================
    // FUNCAO SWITCH LAYER (SOBRESCREVER)
    // ============================================
    function switchLayer(btn, layerName) {
        // Remover todas as camadas
        Object.values(layers).forEach(layer => {
            if (map.hasLayer(layer)) {
                map.removeLayer(layer);
            }
        });

        // Adicionar nova camada
        if (layers[layerName]) {
            layers[layerName].addTo(map);
        }

        // Atualizar botoes
        document.querySelectorAll('.layer-btn').forEach(b => {
            b.classList.remove('active');
        });
        if (btn) {
            btn.classList.add('active');
        }

        showToast('Camada: ' + layerName.toUpperCase(), 'success');
    }

    // ============================================
    // ZOOM CONTROLS
    // ============================================
    function zoomIn() {
        map.zoomIn();
    }

    function zoomOut() {
        map.zoomOut();
    }

    function resetView() {
        map.setView([-22.9068, -43.1729], 11);
        showToast('Visualizacao resetada', 'info');
    }

    // ============================================
    // MARCADORES DE SIRENES
    // ============================================
    {% if sirenes %}
    var sirenesLayer = L.layerGroup().addTo(map);

    {% for sirene in sirenes %}
    {% if sirene.latitude and sirene.longitude %}
    (function() {
        var icon = L.divIcon({
            className: 'custom-marker',
            html: '<div style="background: {% if sirene.acionada %}#ff0055{% else %}#00ff88{% endif %}; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.3);"><i class="fas fa-bullhorn" style="color: white; font-size: 10px;"></i></div>',
            iconSize: [24, 24],
            iconAnchor: [12, 12]
        });

        var marker = L.marker([{{ sirene.latitude }}, {{ sirene.longitude }}], { icon: icon });

        marker.bindPopup(`
            <div style="font-family: 'Rajdhani', sans-serif;">
                <h4 style="margin: 0 0 8px 0; color: #00d4ff;">{{ sirene.nome|default:"Sirene" }}</h4>
                <p style="margin: 0;">{{ sirene.bairro|default:"--" }}</p>
            </div>
        `);

        sirenesLayer.addLayer(marker);
    })();
    {% endif %}
    {% endfor %}
    {% endif %}

    // ============================================
    // ÁREAS DE OBSERVAÇÃO
    // ============================================
    // NOTA: Áreas são carregadas via API no sistema de camadas (mapLayers.areasObservacao)
    // Ver função initAreasDraw() e carregarAreasExistentes() no final do script

    // ============================================
    // REFRESH DATA (API)
    // ============================================
    function refreshData() {
        showLoading('ATUALIZANDO DADOS...');

        fetch('/integracity/api/dashboard/status/')
            .then(response => response.json())
            .then(data => {
                // Atualizar valores no header
                if (data.eventos_count !== undefined) {
                    document.getElementById('headerEventos').textContent = data.eventos_count;
                }

                hideLoading();
                showToast('Dados atualizados com sucesso', 'success');
            })
            .catch(error => {
                hideLoading();
                showToast('Dados atualizados (offline)', 'warning');
                console.log('API indisponivel, usando cache');
            });
    }

    // ============================================
    // AUTO-REFRESH A CADA 5 MINUTOS
    // ============================================
    setInterval(function() {
        console.log('Auto-refresh...');
        // refreshData(); // Descomente para ativar auto-refresh
    }, 300000);

    // ============================================
    // SISTEMA DE CAMADAS DO MAPA
    // ============================================

    // Layer Groups para cada tipo de dado
    var mapLayers = {
        escolas: L.layerGroup(),
        hospitais: L.layerGroup(),
        pluviometros: L.layerGroup(),
        sirenes: L.layerGroup(),
        cameras: L.layerGroup(),
        camerasFixas: L.layerGroup(),
        camerasMoveis: L.layerGroup(),
        metro: L.layerGroup(),
        brt: L.layerGroup(),
        waze: L.layerGroup(),
        wazeCongestionamentos: L.layerGroup(),
        wazeInterdicoes: L.layerGroup(),
        wazeEventos: L.layerGroup(),
        wazeAcidentes: L.layerGroup(),
        wazeBuracos: L.layerGroup(),
        wazePerigos: L.layerGroup(),
        wazeCarroParado: L.layerGroup(),
        wazePolicia: L.layerGroup(),
        wazeOutros: L.layerGroup(),
        bolsoes: L.layerGroup(),
        ocorrencias: L.layerGroup(),
        areasObservacao: L.featureGroup()  // FeatureGroup para Leaflet.draw
    };

    // Cache dos dados carregados
    var layerDataCache = {
        escolas: null,
        hospitais: null,
        pluviometros: null,
        sirenes: null,
        cameras: null,
        metro: null,
        brt: null,
        waze: null,
        bolsoes: null,
        ocorrencias: null,
        areasObservacao: null
    };

    // Estado dos filtros de cameras
    var cameraFilters = {
        fixas: true,
        moveis: true
    };

    // Estado dos filtros de Waze
    var wazeFilters = {
        congestionamentos: true,
        interdicoes: true,
        eventos: true,
        acidentes: true,
        buracos: true,
        perigos: true,
        carroParado: true,
        policia: true,
        outros: true
    };

    // Icones customizados para cada tipo
    var layerIcons = {
        escolas: { icon: 'fa-school', color: '#4CAF50' },
        hospitais: { icon: 'fa-hospital', color: '#F44336' },
        pluviometros: { icon: 'fa-cloud-rain', color: '#2196F3' },
        sirenes: { icon: 'fa-bullhorn', color: '#FF9800' },
        cameras: { icon: 'fa-video', color: '#9C27B0' },
        camerasFixas: { icon: 'fa-video', color: '#2196F3' },     // Azul para fixas
        camerasMoveis: { icon: 'fa-video', color: '#4CAF50' },    // Verde para moveis
        metro: { icon: 'fa-subway', color: '#FF5722' },
        brt: { icon: 'fa-bus', color: '#009688' },
        waze: { icon: 'fa-car', color: '#00d4ff' },
        bolsoes: { icon: 'fa-water', color: '#06b6d4' },
        ocorrencias: { icon: 'fa-exclamation-triangle', color: '#FF0055' },
        areasObservacao: { icon: 'fa-draw-polygon', color: '#00D4FF' }
    };

    // Cores por prioridade de ocorrencia
    var coresPrioridade = {
        baixa: '#4CAF50',
        media: '#00D4FF',
        alta: '#FFB800',
        critica: '#FF0055'
    };

    // ============================================
    // SUBMENU DE CAMERAS
    // ============================================

    // Toggle do submenu de cameras
    function toggleCameraSubmenu(event) {
        if (event) event.stopPropagation();

        var layerItem = document.querySelector('.layer-item.has-submenu');
        var submenu = document.getElementById('cameraSubmenu');

        if (layerItem && submenu) {
            var isExpanding = !submenu.classList.contains('expanded');
            layerItem.classList.toggle('expanded');
            submenu.classList.toggle('expanded');

            // Se estiver abrindo o submenu e as cameras nao estao ativas, ativar
            if (isExpanding) {
                var mainCheckbox = document.getElementById('layerCameras');
                if (mainCheckbox && !mainCheckbox.checked) {
                    mainCheckbox.checked = true;
                    toggleAllCameras();
                }
            }
        }
    }

    // Toggle todas as cameras (checkbox principal)
    function toggleAllCameras() {
        var mainCheckbox = document.getElementById('layerCameras');
        var isChecked = mainCheckbox ? mainCheckbox.checked : false;
        var layerItem = mainCheckbox ? mainCheckbox.closest('.layer-item') : null;

        // Atualizar checkboxes filhos
        var fixasCheckbox = document.getElementById('layerCamerasFixas');
        var moveisCheckbox = document.getElementById('layerCamerasMoveis');

        if (fixasCheckbox) fixasCheckbox.checked = isChecked;
        if (moveisCheckbox) moveisCheckbox.checked = isChecked;

        cameraFilters.fixas = isChecked;
        cameraFilters.moveis = isChecked;

        if (isChecked) {
            if (layerItem) layerItem.classList.add('active');

            // Carregar dados se ainda nao carregou
            if (!layerDataCache.cameras) {
                loadLayerData('cameras');
            } else {
                renderCamerasByType();
            }

            // Adicionar camadas ao mapa
            mapLayers.camerasFixas.addTo(map);
            mapLayers.camerasMoveis.addTo(map);
        } else {
            if (layerItem) layerItem.classList.remove('active');
            map.removeLayer(mapLayers.camerasFixas);
            map.removeLayer(mapLayers.camerasMoveis);
        }
    }

    // Toggle tipo de camera (fixas ou moveis)
    function toggleCameraType(type) {
        var checkbox = document.getElementById('layerCameras' + type.charAt(0).toUpperCase() + type.slice(1));
        var isChecked = checkbox ? checkbox.checked : false;

        cameraFilters[type] = isChecked;

        // Atualizar checkbox principal baseado nos filhos
        var mainCheckbox = document.getElementById('layerCameras');
        if (mainCheckbox) {
            mainCheckbox.checked = cameraFilters.fixas || cameraFilters.moveis;
        }

        if (type === 'fixas') {
            if (isChecked) {
                mapLayers.camerasFixas.addTo(map);
            } else {
                map.removeLayer(mapLayers.camerasFixas);
            }
        } else if (type === 'moveis') {
            if (isChecked) {
                mapLayers.camerasMoveis.addTo(map);
            } else {
                map.removeLayer(mapLayers.camerasMoveis);
            }
        }

        // Se nao tem dados carregados, carregar
        if (!layerDataCache.cameras && isChecked) {
            loadLayerData('cameras');
        }
    }

    // Renderizar cameras por tipo (fixas/moveis)
    function renderCamerasByType() {
        // Limpar camadas existentes
        mapLayers.camerasFixas.clearLayers();
        mapLayers.camerasMoveis.clearLayers();
        mapLayers.cameras.clearLayers();

        var data = layerDataCache.cameras;
        if (!data) {
            console.log('Sem dados de câmeras no cache');
            return;
        }

        var items = [];

        // Normalizar dados - a API retorna em data.data
        if (Array.isArray(data)) {
            items = data;
        } else if (data.data && Array.isArray(data.data)) {
            items = data.data;
        } else if (data.cameras) {
            items = data.cameras;
        }

        console.log('Processando ' + items.length + ' cameras');

        var countFixas = 0;
        var countMoveis = 0;
        var countTotal = 0;

        items.forEach(function(item) {
            var lat = item.latitude || item.lat || item.y;
            var lng = item.longitude || item.lng || item.lon || item.x;

            // Determinar se a camera eh fixa ou movel
            // Verifica campos comuns da API: tipo, type, mobile, movel, fixa
            var isMovel = false;

            if (item.tipo) {
                isMovel = item.tipo.toLowerCase().includes('movel') ||
                          item.tipo.toLowerCase().includes('móvel') ||
                          item.tipo.toLowerCase().includes('mobile');
            }
            if (item.type) {
                isMovel = isMovel || item.type.toLowerCase().includes('mobile') ||
                          item.type.toLowerCase().includes('movel');
            }
            if (item.mobile !== undefined) {
                isMovel = item.mobile === true || item.mobile === 1 || item.mobile === '1';
            }
            if (item.movel !== undefined) {
                isMovel = item.movel === true || item.movel === 1 || item.movel === '1';
            }
            if (item.fixa !== undefined) {
                isMovel = !(item.fixa === true || item.fixa === 1 || item.fixa === '1');
            }

            countTotal++;
            if (isMovel) {
                countMoveis++;
            } else {
                countFixas++;
            }

            if (lat && lng) {

                var cameraType = isMovel ? 'camerasMoveis' : 'camerasFixas';
                var marker = L.marker([lat, lng], {
                    icon: createLayerIcon(cameraType)
                });

                // Abrir video direto no clique
                if (item.url_stream || item.url) {
                    marker.on('click', function() {
                        openCameraPlayer(item.url_stream || item.url, item.nome || 'Camera', item.id_c || item.id || '');
                    });
                }

                // Tooltip com indicacao do tipo
                var tooltipText = (item.nome || 'Camera') + ' (' + (isMovel ? 'Móvel' : 'Fixa') + ')';
                marker.bindTooltip(tooltipText, {
                    permanent: false,
                    direction: 'top',
                    className: 'camera-tooltip'
                });

                // Adicionar a camada apropriada
                if (isMovel) {
                    mapLayers.camerasMoveis.addLayer(marker);
                } else {
                    mapLayers.camerasFixas.addLayer(marker);
                }

                // Tambem adiciona na camada geral para compatibilidade
                mapLayers.cameras.addLayer(marker);
            }
        });

        // Atualizar contadores
        var totalRaw = data.total_raw || countTotal;
        if (data.total_raw_fixas !== undefined && data.total_raw_moveis !== undefined) {
            countFixas = data.total_raw_fixas;
            countMoveis = data.total_raw_moveis;
        }

        updateElement('countCameras', totalRaw);
        updateElement('countCamerasFixas', countFixas);
        updateElement('countCamerasMoveis', countMoveis);

        console.log('Cameras carregadas: ' + totalRaw + ' total (' + countFixas + ' fixas, ' + countMoveis + ' moveis)');
    }

    // Funcao auxiliar para atualizar elementos
    function updateElement(id, value) {
        var el = document.getElementById(id);
        if (el) el.textContent = value;
    }

    // ============================================
    // SUBMENU DE WAZE
    // ============================================

    // Toggle do submenu de Waze
    function toggleWazeSubmenu(event) {
        if (event) event.stopPropagation();

        var layerItems = document.querySelectorAll('.layer-item.has-submenu');
        var submenu = document.getElementById('wazeSubmenu');
        var wazeLayerItem = null;

        // Encontrar o item correto do Waze
        layerItems.forEach(function(item) {
            if (item.querySelector('#layerWaze')) {
                wazeLayerItem = item;
            }
        });

        if (wazeLayerItem && submenu) {
            var isExpanding = !submenu.classList.contains('expanded');
            wazeLayerItem.classList.toggle('expanded');
            submenu.classList.toggle('expanded');

            // Se estiver abrindo o submenu e o Waze nao esta ativo, ativar
            if (isExpanding) {
                var mainCheckbox = document.getElementById('layerWaze');
                if (mainCheckbox && !mainCheckbox.checked) {
                    mainCheckbox.checked = true;
                    toggleAllWaze();
                }
            }
        }
    }

    // Toggle todas as camadas Waze (checkbox principal)
    function toggleAllWaze() {
        var mainCheckbox = document.getElementById('layerWaze');
        var isChecked = mainCheckbox ? mainCheckbox.checked : false;
        var layerItem = mainCheckbox ? mainCheckbox.closest('.layer-item') : null;

        // Atualizar todos os checkboxes filhos
        var tipos = ['Congestionamentos', 'Interdicoes', 'Eventos', 'Acidentes', 'Buracos', 'Perigos', 'CarroParado', 'Policia', 'Outros'];
        tipos.forEach(function(tipo) {
            var checkbox = document.getElementById('layerWaze' + tipo);
            if (checkbox) checkbox.checked = isChecked;
            // Converter para camelCase para o filtro
            var filterKey = tipo.charAt(0).toLowerCase() + tipo.slice(1);
            wazeFilters[filterKey] = isChecked;
        });

        if (isChecked) {
            if (layerItem) layerItem.classList.add('active');

            // Carregar dados se nao tiver
            if (!layerDataCache.waze) {
                loadWazeCompleto();
            } else {
                // Renderizar com filtros atuais
                renderWazeCompleto(layerDataCache.waze);
            }

            // Adicionar camadas ao mapa
            if (wazeFilters.congestionamentos) mapLayers.wazeCongestionamentos.addTo(map);
            if (wazeFilters.interdicoes) mapLayers.wazeInterdicoes.addTo(map);
            if (wazeFilters.eventos) mapLayers.wazeEventos.addTo(map);
            if (wazeFilters.acidentes) mapLayers.wazeAcidentes.addTo(map);
            if (wazeFilters.buracos) mapLayers.wazeBuracos.addTo(map);
            if (wazeFilters.perigos) mapLayers.wazePerigos.addTo(map);
            if (wazeFilters.carroParado) mapLayers.wazeCarroParado.addTo(map);
            if (wazeFilters.policia) mapLayers.wazePolicia.addTo(map);
            if (wazeFilters.outros) mapLayers.wazeOutros.addTo(map);

            showToast('Camada Waze ativada', 'success');
        } else {
            if (layerItem) layerItem.classList.remove('active');
            map.removeLayer(mapLayers.wazeCongestionamentos);
            map.removeLayer(mapLayers.wazeInterdicoes);
            map.removeLayer(mapLayers.wazeEventos);
            map.removeLayer(mapLayers.wazeAcidentes);
            map.removeLayer(mapLayers.wazeBuracos);
            map.removeLayer(mapLayers.wazePerigos);
            map.removeLayer(mapLayers.wazeCarroParado);
            map.removeLayer(mapLayers.wazePolicia);
            map.removeLayer(mapLayers.wazeOutros);

            showToast('Camada Waze desativada', 'info');
        }
    }

    // Toggle de filtro individual do Waze
    function toggleWazeFilter(tipo) {
        var tipoCapitalized = tipo.charAt(0).toUpperCase() + tipo.slice(1);
        var checkbox = document.getElementById('layerWaze' + tipoCapitalized);
        var isChecked = checkbox ? checkbox.checked : false;

        wazeFilters[tipo] = isChecked;

        // Atualizar checkbox principal
        var mainCheckbox = document.getElementById('layerWaze');
        if (mainCheckbox) {
            mainCheckbox.checked = wazeFilters.congestionamentos || wazeFilters.interdicoes ||
                                   wazeFilters.eventos || wazeFilters.acidentes || wazeFilters.buracos ||
                                   wazeFilters.perigos || wazeFilters.carroParado || wazeFilters.policia ||
                                   wazeFilters.outros;
        }

        // Adicionar/remover camada do mapa
        var layerName = 'waze' + tipoCapitalized;
        if (isChecked) {
            if (!map.hasLayer(mapLayers[layerName])) {
                mapLayers[layerName].addTo(map);
            }
        } else {
            if (map.hasLayer(mapLayers[layerName])) {
                map.removeLayer(mapLayers[layerName]);
            }
        }

        // Se nao tem dados, carregar
        if (!layerDataCache.waze && isChecked) {
            loadWazeCompleto();
        }
    }

    // Carregar dados completos do Waze
    function loadWazeCompleto() {
        var url = baseUrl + 'integracity/api/mob/waze-completo/';
        showToast('Carregando dados Waze...', 'info');
        console.log('Carregando Waze completo de:', url);

        fetch(url)
            .then(function(response) {
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status);
                }
                return response.json();
            })
            .then(function(data) {
                console.log('Dados Waze recebidos:', data);
                layerDataCache.waze = data;
                renderWazeCompleto(data);
                showToast('Dados Waze carregados', 'success');
            })
            .catch(function(error) {
                console.error('Erro ao carregar Waze:', error);
                showToast('Erro ao carregar Waze: ' + error.message, 'error');
            });
    }

    // Renderizar todos os dados do Waze
    function renderWazeCompleto(data) {
        // Limpar camadas existentes
        mapLayers.wazeCongestionamentos.clearLayers();
        mapLayers.wazeInterdicoes.clearLayers();
        mapLayers.wazeEventos.clearLayers();
        mapLayers.wazeAcidentes.clearLayers();
        mapLayers.wazeBuracos.clearLayers();
        mapLayers.wazePerigos.clearLayers();
        mapLayers.wazeCarroParado.clearLayers();
        mapLayers.wazePolicia.clearLayers();
        mapLayers.wazeOutros.clearLayers();
        mapLayers.waze.clearLayers();

        // Cores por nivel de congestionamento
        var jamColors = {
            1: '#ffff00',  // Amarelo - leve
            2: '#ffa500',  // Laranja - moderado
            3: '#ff6600',  // Laranja escuro - medio
            4: '#ff0000',  // Vermelho - severo
            5: '#990000'   // Vermelho escuro - parado
        };

        // 1. CONGESTIONAMENTOS
        var congestionamentos = data.congestionamentos || [];
        congestionamentos.forEach(function(jam) {
            if (!jam.coordinates || jam.coordinates.length < 2) return;

            var latlngs = jam.coordinates.map(function(c) {
                return [c[1], c[0]];  // [lat, lng] formato Leaflet
            });

            var color = jamColors[jam.level] || '#ffa500';

            // Polyline para mostrar extensao
            var polyline = L.polyline(latlngs, {
                color: color,
                weight: 6,
                opacity: 0.8
            });

            var popupContent = '<div style="font-family: Rajdhani, sans-serif;">' +
                '<div style="font-weight: 600; color: ' + color + '; margin-bottom: 5px;">' +
                '<i class="fas fa-car-side"></i> Congestionamento</div>' +
                '<div><strong>Via:</strong> ' + (jam.street || 'Via nao identificada') + '</div>' +
                '<div><strong>Nivel:</strong> ' + jam.level + '/5</div>' +
                '<div><strong>Velocidade:</strong> ' + jam.speed + ' km/h</div>' +
                '<div><strong>Extensao:</strong> ' + Math.round(jam.length / 1000 * 10) / 10 + ' km</div>' +
                '</div>';

            polyline.bindPopup(popupContent);
            mapLayers.wazeCongestionamentos.addLayer(polyline);
            mapLayers.waze.addLayer(polyline);

            // Marcador circular no ponto medio da linha
            var midIndex = Math.floor(latlngs.length / 2);
            var midPoint = latlngs[midIndex];
            var marker = L.marker(midPoint, {
                icon: L.divIcon({
                    className: 'waze-congestionamento-marker',
                    html: '<div style="background: ' + color + '; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.4);"><i class="fas fa-car-side" style="color: white; font-size: 12px;"></i></div>',
                    iconSize: [28, 28],
                    iconAnchor: [14, 14]
                })
            });
            marker.bindPopup(popupContent);
            mapLayers.wazeCongestionamentos.addLayer(marker);
            mapLayers.waze.addLayer(marker);
        });

        // 2. INTERDICOES
        var interdicoes = data.interdicoes || [];
        interdicoes.forEach(function(item) {
            if (!item.coordinates || item.coordinates.length < 2) return;

            var latlngs = item.coordinates.map(function(c) {
                return [c[1], c[0]];
            });

            var colorInterdicao = '#FF0055';

            // Polyline para mostrar extensao
            var polyline = L.polyline(latlngs, {
                color: colorInterdicao,
                weight: 8,
                opacity: 0.9,
                dashArray: '10, 10'
            });

            var popupContent = '<div style="font-family: Rajdhani, sans-serif;">' +
                '<div style="font-weight: 600; color: ' + colorInterdicao + '; margin-bottom: 5px;">' +
                '<i class="fas fa-road-barrier"></i> Via Interditada</div>' +
                '<div><strong>Motivo:</strong> ' + (item.reason || item.street || 'Nao informado') + '</div>' +
                '<div><strong>Extensao:</strong> ' + Math.round(item.length / 1000 * 10) / 10 + ' km</div>' +
                '</div>';

            polyline.bindPopup(popupContent);
            mapLayers.wazeInterdicoes.addLayer(polyline);
            mapLayers.waze.addLayer(polyline);

            // Marcador circular no ponto medio da linha
            var midIndex = Math.floor(latlngs.length / 2);
            var midPoint = latlngs[midIndex];
            var marker = L.marker(midPoint, {
                icon: L.divIcon({
                    className: 'waze-interdicao-marker',
                    html: '<div style="background: ' + colorInterdicao + '; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.4);"><i class="fas fa-road-barrier" style="color: white; font-size: 12px;"></i></div>',
                    iconSize: [28, 28],
                    iconAnchor: [14, 14]
                })
            });
            marker.bindPopup(popupContent);
            mapLayers.wazeInterdicoes.addLayer(marker);
            mapLayers.waze.addLayer(marker);
        });

        // 3. EVENTOS
        var eventos = data.eventos || [];
        eventos.forEach(function(item) {
            if (!item.coordinates || item.coordinates.length < 2) return;

            var latlngs = item.coordinates.map(function(c) {
                return [c[1], c[0]];
            });

            var colorEvento = '#9C27B0';

            // Polyline para mostrar extensao
            var polyline = L.polyline(latlngs, {
                color: colorEvento,
                weight: 6,
                opacity: 0.8,
                dashArray: '5, 10'
            });

            var popupContent = '<div style="font-family: Rajdhani, sans-serif;">' +
                '<div style="font-weight: 600; color: ' + colorEvento + '; margin-bottom: 5px;">' +
                '<i class="fas fa-calendar-alt"></i> Evento</div>' +
                '<div><strong>Descricao:</strong> ' + (item.street || 'Evento especial') + '</div>' +
                '<div><strong>Extensao:</strong> ' + Math.round(item.length / 1000 * 10) / 10 + ' km</div>' +
                '</div>';

            polyline.bindPopup(popupContent);
            mapLayers.wazeEventos.addLayer(polyline);
            mapLayers.waze.addLayer(polyline);

            // Marcador circular no ponto medio da linha
            var midIndex = Math.floor(latlngs.length / 2);
            var midPoint = latlngs[midIndex];
            var marker = L.marker(midPoint, {
                icon: L.divIcon({
                    className: 'waze-evento-marker',
                    html: '<div style="background: ' + colorEvento + '; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.4);"><i class="fas fa-calendar-alt" style="color: white; font-size: 12px;"></i></div>',
                    iconSize: [28, 28],
                    iconAnchor: [14, 14]
                })
            });
            marker.bindPopup(popupContent);
            mapLayers.wazeEventos.addLayer(marker);
            mapLayers.waze.addLayer(marker);
        });

        // 4. ALERTAS (pontos) - separados por tipo
        var alertas = data.alertas || [];
        var alertIcons = {
            'ACCIDENT': { icon: 'fa-car-crash', color: '#FF0055', layer: 'wazeAcidentes' },
            'HAZARD': { icon: 'fa-exclamation-triangle', color: '#FFC107', layer: 'wazePerigos' },
            'ROAD_CLOSED': { icon: 'fa-road-barrier', color: '#FF5722', layer: 'wazeInterdicoes' },
            'JAM': { icon: 'fa-traffic-light', color: '#ff6600', layer: 'wazeCongestionamentos' },
            'POLICE': { icon: 'fa-shield-halved', color: '#007bff', layer: 'wazePolicia' },
            'CONSTRUCTION': { icon: 'fa-hard-hat', color: '#FF9800', layer: 'wazeOutros' }
        };

        // Contadores por tipo
        var contadores = {
            acidentes: 0,
            buracos: 0,
            perigos: 0,
            carroParado: 0,
            policia: 0,
            outros: 0
        };

        alertas.forEach(function(alerta) {
            if (!alerta.lat || !alerta.lon) return;

            // Determinar tipo e camada
            var tipo = alerta.type || '';
            var subtipo = alerta.subtype || '';
            var layerName = 'wazeOutros';
            var config = { icon: 'fa-info-circle', color: '#808080' };
            var tipoTraduzido = 'Alerta';

            // Classificar por tipo
            if (tipo === 'ACCIDENT') {
                layerName = 'wazeAcidentes';
                config = { icon: 'fa-car-crash', color: '#FF0055' };
                tipoTraduzido = 'Acidente';
                contadores.acidentes++;
            } else if (tipo === 'HAZARD') {
                // Sub-classificar hazards
                if (subtipo.includes('POT_HOLE') || subtipo.includes('POTHOLE')) {
                    layerName = 'wazeBuracos';
                    config = { icon: 'fa-circle-exclamation', color: '#8B4513' };
                    tipoTraduzido = 'Buraco';
                    contadores.buracos++;
                } else if (subtipo.includes('CAR_STOPPED') || subtipo.includes('VEHICLE')) {
                    layerName = 'wazeCarroParado';
                    config = { icon: 'fa-car', color: '#888888' };
                    tipoTraduzido = 'Carro Parado';
                    contadores.carroParado++;
                } else {
                    layerName = 'wazePerigos';
                    config = { icon: 'fa-exclamation-triangle', color: '#FFC107' };
                    tipoTraduzido = 'Perigo';
                    contadores.perigos++;
                }
            } else if (tipo === 'POLICE') {
                layerName = 'wazePolicia';
                config = { icon: 'fa-shield-halved', color: '#007bff' };
                tipoTraduzido = 'Policia';
                contadores.policia++;
            } else {
                contadores.outros++;
            }

            var marker = L.marker([alerta.lat, alerta.lon], {
                icon: L.divIcon({
                    className: 'waze-alert-marker',
                    html: '<div style="background: ' + config.color + '; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.4);"><i class="fas ' + config.icon + '" style="color: white; font-size: 12px;"></i></div>',
                    iconSize: [28, 28],
                    iconAnchor: [14, 14]
                })
            });

            var popupContent = '<div style="font-family: Rajdhani, sans-serif;">' +
                '<div style="font-weight: 600; color: ' + config.color + '; margin-bottom: 5px;">' +
                '<i class="fas ' + config.icon + '"></i> ' + tipoTraduzido + '</div>' +
                '<div><strong>Local:</strong> ' + (alerta.street || 'Nao identificado') + '</div>' +
                (subtipo ? '<div><strong>Detalhe:</strong> ' + subtipo.replace(/_/g, ' ') + '</div>' : '') +
                '<div><strong>Confiabilidade:</strong> ' + (alerta.reliability || 0) + '%</div>' +
                '</div>';

            marker.bindPopup(popupContent);
            mapLayers[layerName].addLayer(marker);
            mapLayers.waze.addLayer(marker);
        });

        // Atualizar contadores
        var stats = data.estatisticas || {};
        var totalAlertas = contadores.acidentes + contadores.buracos + contadores.perigos +
                          contadores.carroParado + contadores.policia + contadores.outros;

        updateElement('countWaze', (stats.total_congestionamentos || 0) + (stats.total_interdicoes || 0) +
                                   (stats.total_eventos || 0) + totalAlertas);
        updateElement('countWazeCongestionamentos', stats.total_congestionamentos || 0);
        updateElement('countWazeInterdicoes', stats.total_interdicoes || 0);
        updateElement('countWazeEventos', stats.total_eventos || 0);
        updateElement('countWazeAcidentes', contadores.acidentes);
        updateElement('countWazeBuracos', contadores.buracos);
        updateElement('countWazePerigos', contadores.perigos);
        updateElement('countWazeCarroParado', contadores.carroParado);
        updateElement('countWazePolicia', contadores.policia);
        updateElement('countWazeOutros', contadores.outros);

        console.log('Waze renderizado - Cong: ' + (stats.total_congestionamentos || 0) +
                    ', Inter: ' + (stats.total_interdicoes || 0) +
                    ', Eventos: ' + (stats.total_eventos || 0) +
                    ', Acidentes: ' + contadores.acidentes +
                    ', Buracos: ' + contadores.buracos +
                    ', Perigos: ' + contadores.perigos);
    }

    // Toggle da sidebar de camadas
    function toggleLayersSidebar() {
        var sidebar = document.getElementById('layersSidebar');
        var toggleBtn = document.getElementById('layersToggleBtn');
        if (sidebar) {
            sidebar.classList.toggle('expanded');
            if (toggleBtn) {
                toggleBtn.classList.toggle('active', sidebar.classList.contains('expanded'));
            }
        }
    }

    // Criar icone de marcador
    function createLayerIcon(type) {
        var config = layerIcons[type] || { icon: 'fa-map-marker', color: '#00d4ff' };
        return L.divIcon({
            className: 'custom-layer-marker',
            html: '<div style="background: ' + config.color + '; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.4);"><i class="fas ' + config.icon + '" style="color: white; font-size: 12px;"></i></div>',
            iconSize: [28, 28],
            iconAnchor: [14, 14],
            popupAnchor: [0, -14]
        });
    }

    // Toggle de camada ao clicar na linha (nao apenas no checkbox)
    function toggleLayerByClick(layerName, event) {
        if (event) event.stopPropagation();

        // Encontrar o checkbox correspondente
        var checkboxId = 'layer' + layerName.charAt(0).toUpperCase() + layerName.slice(1);
        var checkbox = document.getElementById(checkboxId);

        if (checkbox) {
            // Inverter o estado do checkbox
            checkbox.checked = !checkbox.checked;
            // Disparar o evento onchange para ativar a logica da camada
            toggleMapLayer(layerName);
        }
    }

    // Toggle de camada individual
    function toggleMapLayer(layerName) {
        var checkbox = document.getElementById('layer' + layerName.charAt(0).toUpperCase() + layerName.slice(1));
        var isChecked = checkbox ? checkbox.checked : false;
        var layerItem = checkbox ? checkbox.closest('.layer-item') : null;

        if (isChecked) {
            // Adicionar camada ao mapa
            if (!map.hasLayer(mapLayers[layerName])) {
                mapLayers[layerName].addTo(map);
            }
            if (layerItem) layerItem.classList.add('active');

            // Carregar dados se ainda nao carregou
            if (!layerDataCache[layerName]) {
                loadLayerData(layerName);
            }

            // Mostrar campo de busca para escolas
            if (layerName === 'escolas') {
                var searchContainer = document.getElementById('escolaSearchContainer');
                if (searchContainer) {
                    searchContainer.style.display = 'block';
                }
            }

            showToast('Camada ' + layerName + ' ativada', 'success');
        } else {
            // Remover camada do mapa
            if (map.hasLayer(mapLayers[layerName])) {
                map.removeLayer(mapLayers[layerName]);
            }
            if (layerItem) layerItem.classList.remove('active');

            // Esconder campo de busca para escolas
            if (layerName === 'escolas') {
                var searchContainer = document.getElementById('escolaSearchContainer');
                if (searchContainer) {
                    searchContainer.style.display = 'none';
                    // Limpar busca
                    var input = document.getElementById('escolaSearchInput');
                    if (input) input.value = '';
                    var list = document.getElementById('escolaAutocompleteList');
                    if (list) {
                        list.innerHTML = '';
                        list.classList.remove('active');
                    }
                }
            }

            showToast('Camada ' + layerName + ' desativada', 'info');
        }
    }

    // Carregar dados de uma camada especifica
    // Detectar base URL automaticamente - usar origin para garantir URL absoluta
    var baseUrl = window.location.origin + '/';
    console.log('Base URL para APIs:', baseUrl);

    function loadLayerData(layerName) {
        // Waze usa API e renderizacao especiais (via loadWazeCompleto)
        if (layerName === 'waze') {
            loadWazeCompleto();
            return;
        }

        var apiUrls = {
            escolas: baseUrl + 'integracity/api/escolas/',
            hospitais: baseUrl + 'integracity/api/hospitais/',
            pluviometros: baseUrl + 'integracity/api/pluviometros/',
            sirenes: baseUrl + 'integracity/api/sirenes/',
            cameras: baseUrl + 'integracity/api/cameras/',
            metro: baseUrl + 'integracity/api/metro/',
            brt: baseUrl + 'integracity/api/brt/',
            bolsoes: baseUrl + 'integracity/api/bolsoes/',
            ocorrencias: baseUrl + 'integracity/api/ocorrencias/mapa/'
        };

        var url = apiUrls[layerName];
        if (!url) return;

        showToast('Carregando ' + layerName + '...', 'info');
        console.log('Carregando camada ' + layerName + ' de:', url);

        fetch(url)
            .then(function(response) {
                console.log('Resposta da API ' + layerName + ':', response.status);
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status);
                }
                return response.json();
            })
            .then(function(data) {
                console.log('Dados recebidos para ' + layerName + ':', data);
                layerDataCache[layerName] = data;

                // Cameras usa renderização especial com tipos (fixas/moveis)
                if (layerName === 'cameras') {
                    renderCamerasByType();
                    // Adicionar camadas baseado nos filtros atuais
                    if (cameraFilters.fixas) mapLayers.camerasFixas.addTo(map);
                    if (cameraFilters.moveis) mapLayers.camerasMoveis.addTo(map);
                    showToast('Cameras carregadas com sucesso', 'success');
                } else if (layerName === 'ocorrencias') {
                    renderOcorrenciasMarkers(data);
                    updateLayerCount(layerName, data);
                    showToast('Ocorrencias carregadas com sucesso', 'success');
                } else {
                    renderLayerMarkers(layerName, data);
                    updateLayerCount(layerName, data);
                }
            })
            .catch(function(error) {
                console.error('Erro ao carregar ' + layerName + ':', error);
                showToast('Erro ao carregar ' + layerName + ': ' + error.message, 'error');
            });
    }

    // Renderizar marcadores de uma camada
    function renderLayerMarkers(layerName, data) {
        // Limpar camada existente
        mapLayers[layerName].clearLayers();

        var items = [];

        // Normalizar dados conforme o tipo de API
        if (Array.isArray(data)) {
            items = data;
        } else if (data.features) {
            // GeoJSON format
            items = data.features.map(f => ({
                ...f.properties,
                latitude: f.geometry?.coordinates?.[1],
                longitude: f.geometry?.coordinates?.[0]
            }));
        } else if (data.data) {
            items = Array.isArray(data.data) ? data.data : [];
        } else if (data.results) {
            items = data.results;
        } else if (data.alerts) {
            items = data.alerts;
        } else if (data.escolas) {
            items = data.escolas;
        } else if (data.hospitais) {
            items = data.hospitais;
        } else if (data.sirenes) {
            items = data.sirenes;
        } else if (data.cameras) {
            items = data.cameras;
        } else if (data.estacoes) {
            items = data.estacoes;
        } else if (data.linhas) {
            items = data.linhas;
        }

        items.forEach(function(item) {
            // Tentar diferentes campos de coordenadas
            var lat = item.latitude || item.lat || item.y || (item.location && item.location.lat);
            var lng = item.longitude || item.lng || item.lon || item.x || (item.location && item.location.lng);

            if (lat && lng) {
                var marker = L.marker([lat, lng], {
                    icon: createLayerIcon(layerName)
                });

                // Para cameras, abrir video direto no clique
                if (layerName === 'cameras' && item.url) {
                    marker.on('click', function() {
                        openCameraPlayer(item.url_stream || item.url, item.nome || 'Camera', item.id_c || item.id || '');
                    });
                    // Tooltip simples no hover
                    marker.bindTooltip(item.nome || 'Camera', {
                        permanent: false,
                        direction: 'top',
                        className: 'camera-tooltip'
                    });
                } else {
                    // Criar popup com informacoes para outras camadas
                    var popupContent = createPopupContent(layerName, item);
                    marker.bindPopup(popupContent);
                }

                mapLayers[layerName].addLayer(marker);
            }
        });

        console.log('Camada ' + layerName + ': ' + mapLayers[layerName].getLayers().length + ' marcadores');
    }

    // Criar conteudo do popup
    function createPopupContent(layerName, item) {
        var config = layerIcons[layerName];
        var title = item.nome || item.name || item.titulo || item.title || item.tipo || item.type || layerName;
        var details = '';

        switch(layerName) {
            case 'escolas':
                details = '<p>' + (item.endereco || item.bairro || '--') + '</p>';
                if (item.telefone) details += '<p>Tel: ' + item.telefone + '</p>';
                if (item.tipo) details += '<p>Tipo: ' + item.tipo + '</p>';
                break;
            case 'hospitais':
                details = '<p>' + (item.endereco || item.bairro || '--') + '</p>';
                if (item.telefone) details += '<p>Tel: ' + item.telefone + '</p>';
                break;
            case 'pluviometros':
                details = '<p>Bairro: ' + (item.bairro || '--') + '</p>';
                if (item.acumulado_15min !== undefined) details += '<p>15min: ' + item.acumulado_15min + 'mm</p>';
                if (item.acumulado_1h !== undefined) details += '<p>1h: ' + item.acumulado_1h + 'mm</p>';
                if (item.chuva_1h !== undefined) details += '<p>1h: ' + item.chuva_1h + 'mm</p>';
                if (item.chuva_24h !== undefined) details += '<p>24h: ' + item.chuva_24h + 'mm</p>';
                break;
            case 'sirenes':
                details = '<p>Bairro: ' + (item.bairro || '--') + '</p>';
                details += '<p>Status: ' + (item.acionada ? '<span style="color:#ff0055">ACIONADA</span>' : '<span style="color:#00ff88">Stand-by</span>') + '</p>';
                break;
            case 'cameras':
                details = '<p>' + (item.zona || item.localizacao || item.bairro || '--') + '</p>';
                if (item.bairro) details += '<p>Bairro: ' + item.bairro + '</p>';
                if (item.url_stream || item.url) {
                    var cameraUrl = item.url_stream || item.url; var cameraName = (item.nome || 'Camera').replace(/'/g, "\'"); var cameraId = item.id_c || item.id || ''; details += '<button onclick="openCameraPlayer(&quot;' + cameraUrl + '&quot;, &quot;' + cameraName + '&quot;, &quot;' + cameraId + '&quot;)" style="margin-top: 10px; padding: 8px 16px; background: linear-gradient(135deg, #9C27B0, #7B1FA2); color: white; border: none; border-radius: 8px; cursor: pointer; font-family: Rajdhani, sans-serif; font-weight: 600; display: flex; align-items: center; gap: 6px;"><i class="fas fa-play"></i> Assistir ao Vivo</button>';
                }
                break;
            case 'metro':
                details = '<p>Linha: ' + (item.linha || '--') + '</p>';
                details += '<p>Status: ' + (item.status || 'Normal') + '</p>';
                break;
            case 'brt':
                details = '<p>Corredor: ' + (item.corredor || '--') + '</p>';
                details += '<p>Status: ' + (item.status || 'Normal') + '</p>';
                break;
            case 'waze':
                details = '<p>Tipo: ' + (item.type || item.subtype || '--') + '</p>';
                if (item.street) details += '<p>' + item.street + '</p>';
                break;
            case 'bolsoes':
                details = '<p>Local: ' + (item.local || '--') + '</p>';
                if (item.referencia) details += '<p>Ref: ' + item.referencia + '</p>';
                if (item.bairro) details += '<p>Bairro: ' + item.bairro + '</p>';
                if (item.zona) details += '<p>Zona: ' + item.zona + '</p>';
                break;
            default:
                details = '<p>' + (item.descricao || item.description || '--') + '</p>';
        }

        return '<div style="font-family: Rajdhani, sans-serif; min-width: 180px;">' +
            '<h4 style="margin: 0 0 8px 0; color: ' + config.color + '; font-family: Orbitron, monospace; font-size: 0.9rem;">' +
            '<i class="fas ' + config.icon + '"></i> ' + title.substring(0, 30) + '</h4>' +
            '<div style="font-size: 0.85rem; color: #ccc;">' + details + '</div>' +
            '</div>';
    }

    // Renderizar congestionamentos do Waze como polylines
    function renderWazeJams(data) {
        // Limpar camada existente
        mapLayers.waze.clearLayers();

        var jams = data.jams || data.data || data;
        if (!Array.isArray(jams)) {
            console.warn('Dados Waze invalidos:', data);
            return;
        }

        console.log('Renderizando ' + jams.length + ' congestionamentos Waze');

        // Cores por nivel de congestionamento
        var jamColors = {
            1: '#ffff00',  // Amarelo - leve
            2: '#ffa500',  // Laranja - moderado
            3: '#ff6600',  // Laranja escuro - medio
            4: '#ff0000',  // Vermelho - severo
            5: '#990000'   // Vermelho escuro - parado
        };

        jams.forEach(function(jam) {
            if (!jam.coordinates || jam.coordinates.length < 2) {
                return;
            }

            // Converter coordenadas de [x, y] para [lat, lng]
            var latlngs = jam.coordinates.map(function(coord) {
                return [coord[1], coord[0]]; // Waze usa [lon, lat], Leaflet usa [lat, lng]
            });

            var level = jam.level || 3;
            var color = jamColors[level] || '#ff6600';
            var weight = level >= 4 ? 6 : 4;

            var polyline = L.polyline(latlngs, {
                color: color,
                weight: weight,
                opacity: 0.8,
                lineCap: 'round',
                lineJoin: 'round'
            });

            // Popup com informacoes do congestionamento
            var popupContent = '<div style="font-family: Rajdhani, sans-serif; min-width: 200px;">' +
                '<h4 style="margin: 0 0 8px 0; color: ' + color + '; font-family: Orbitron, monospace;">' +
                '<i class="fab fa-waze"></i> Congestionamento</h4>' +
                '<p><strong>Via:</strong> ' + (jam.street || 'Via nao identificada') + '</p>' +
                '<p><strong>Nivel:</strong> ' + level + '/5</p>' +
                '<p><strong>Velocidade:</strong> ' + (jam.speed ? jam.speed.toFixed(1) + ' km/h' : '--') + '</p>' +
                '<p><strong>Extensao:</strong> ' + (jam.length ? (jam.length/1000).toFixed(1) + ' km' : '--') + '</p>' +
                '<p><strong>Atraso:</strong> ' + (jam.delay ? Math.round(jam.delay/60) + ' min' : '--') + '</p>' +
                '</div>';

            polyline.bindPopup(popupContent);
            mapLayers.waze.addLayer(polyline);
        });

        console.log('Waze: ' + mapLayers.waze.getLayers().length + ' polylines renderizadas');
    }

    // Animação de pulso para ocorrências via JavaScript (funciona melhor com Leaflet)
    var ocPulseInterval = null;
    function startOcorrenciaPulse() {
        if (ocPulseInterval) clearInterval(ocPulseInterval);
        var pulseState = true;
        ocPulseInterval = setInterval(function() {
            var dots = document.querySelectorAll('.oc-marker-dot');
            dots.forEach(function(dot) {
                if (pulseState) {
                    dot.style.boxShadow = '0 0 20px 8px ' + (dot.dataset.cor || '#00D4FF');
                    dot.style.opacity = '1';
                } else {
                    dot.style.boxShadow = '0 0 5px 2px ' + (dot.dataset.cor || '#00D4FF');
                    dot.style.opacity = '0.7';
                }
            });
            pulseState = !pulseState;
        }, 600);
    }
    // Iniciar pulso após um pequeno delay para garantir que os markers foram renderizados
    setTimeout(startOcorrenciaPulse, 2000);

    // Renderizar marcadores de ocorrencias com cores por prioridade
    function renderOcorrenciasMarkers(data) {
        // Limpar camada existente
        mapLayers.ocorrencias.clearLayers();

        var items = [];
        if (data.data && Array.isArray(data.data)) {
            items = data.data;
        } else if (Array.isArray(data)) {
            items = data;
        }

        console.log('Renderizando ' + items.length + ' ocorrencias no mapa');

        items.forEach(function(oc) {
            if (oc.latitude && oc.longitude) {
                // Cor baseada na prioridade
                var cor = coresPrioridade[oc.prioridade] || '#00D4FF';
                var icone = oc.categoria_icone || 'fa-exclamation-triangle';

                var icon = L.divIcon({
                    className: 'custom-marker ocorrencia-marker',
                    html: '<div class="oc-marker-dot" data-cor="' + cor + '" style="background: ' + cor + '; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 3px solid white; transition: box-shadow 0.3s, opacity 0.3s;"><i class="fas ' + icone + '" style="color: white; font-size: 14px;"></i></div>',
                    iconSize: [32, 32],
                    iconAnchor: [16, 16]
                });

                var marker = L.marker([oc.latitude, oc.longitude], { icon: icon });

                // Popup com informacoes da ocorrencia
                var popupContent = '<div style="font-family: Rajdhani, sans-serif; min-width: 250px;">' +
                    '<div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">' +
                    '<div style="background: ' + cor + '30; color: ' + cor + '; padding: 8px; border-radius: 8px;">' +
                    '<i class="fas ' + icone + '"></i></div>' +
                    '<div>' +
                    '<h4 style="margin: 0; color: #00d4ff; font-size: 1rem;">' + oc.protocolo + '</h4>' +
                    '<span style="font-size: 0.75rem; color: #888;">' + oc.categoria + '</span>' +
                    '</div></div>' +
                    '<div style="font-size: 0.9rem; color: #fff; margin-bottom: 8px;">' + oc.titulo + '</div>' +
                    '<div style="display: flex; gap: 8px; margin-bottom: 8px;">' +
                    '<span style="background: ' + cor + '30; color: ' + cor + '; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem;">' + oc.prioridade_display + '</span>' +
                    '<span style="background: rgba(0,212,255,0.2); color: #00d4ff; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem;">' + oc.status_display + '</span>' +
                    '</div>' +
                    '<div style="font-size: 0.8rem; color: #aaa;">' +
                    '<i class="fas fa-map-marker-alt"></i> ' + (oc.endereco || '--') + (oc.bairro ? ', ' + oc.bairro : '') +
                    '</div>' +
                    '<div style="font-size: 0.75rem; color: #666; margin-top: 5px;">' +
                    '<i class="fas fa-clock"></i> ' + oc.data_abertura +
                    '</div>' +
                    '<div style="margin-top: 10px;">' +
                    '<a href="/integracity/ocorrencias/' + oc.id + '/" target="_blank" style="display: inline-block; background: #00d4ff; color: #000; padding: 6px 15px; border-radius: 6px; text-decoration: none; font-size: 0.8rem; font-weight: bold;">' +
                    '<i class="fas fa-eye"></i> Ver Detalhes</a>' +
                    '</div></div>';

                marker.bindPopup(popupContent, {
                    maxWidth: 350,
                    className: 'ocorrencia-popup'
                });

                mapLayers.ocorrencias.addLayer(marker);
            }
        });

        // Atualizar contador
        var countEl = document.getElementById('countOcorrencias');
        if (countEl) {
            countEl.textContent = items.length;
        }

        // Reiniciar animação de pulso
        setTimeout(startOcorrenciaPulse, 500);

        // Reiniciar tour automático se estiver ativo
        if (tourAtivo && items.length > 0) {
            setTimeout(function() {
                ocorrenciasTour = items.filter(function(oc) {
                    return oc.latitude && oc.longitude;
                });
                if (!tourEmExecucao) {
                    iniciarTourOcorrencias();
                }
            }, 1000);
        }
    }

    // ========================================
    // TOUR AUTOMÁTICO POR OCORRÊNCIAS
    // ========================================

    // Carregar configurações salvas
    var savedSettings = {};
    try {
        var savedStr = localStorage.getItem('integracity_settings');
        if (savedStr) savedSettings = JSON.parse(savedStr);
    } catch (e) { console.log('Erro ao carregar settings:', e); }

    var tourAtivo = savedSettings.tourAutoStart !== false; // Liga/desliga o tour automático
    var tourEmExecucao = false;
    var tourNavegando = false; // Flag para indicar que o tour está navegando (evita pausar por eventos do mapa)
    var tourTimeoutId = null;
    var ocorrenciasTour = [];
    var posicaoOriginal = {
        lat: savedSettings.mapLat || -22.92,
        lng: savedSettings.mapLng || -43.45,
        zoom: savedSettings.mapZoom || 11
    };
    var TEMPO_EM_OCORRENCIA = (savedSettings.tourTimeOcorrencia || 6) * 1000; // segundos em cada ocorrência
    var TEMPO_NA_POSICAO_ORIGINAL = (savedSettings.tourTimeOriginal || 6) * 1000; // segundos na posição original
    var ZOOM_OCORRENCIA = savedSettings.tourZoom || 16; // Zoom aproximado para cada ocorrência

    // Listener para mudanças de configurações
    window.addEventListener('settingsChanged', function(e) {
        var s = e.detail;
        TEMPO_EM_OCORRENCIA = (s.tourTimeOcorrencia || 6) * 1000;
        TEMPO_NA_POSICAO_ORIGINAL = (s.tourTimeOriginal || 6) * 1000;
        ZOOM_OCORRENCIA = s.tourZoom || 16;
        posicaoOriginal = {
            lat: s.mapLat || -22.92,
            lng: s.mapLng || -43.45,
            zoom: s.mapZoom || 11
        };

        // Trocar layer do mapa baseado no tema
        var newThemeLayer = (s.theme === 'light') ? 'street' : 'dark';
        if (newThemeLayer !== currentThemeLayer) {
            // Remover layer atual do tema
            if (layers[currentThemeLayer] && map.hasLayer(layers[currentThemeLayer])) {
                map.removeLayer(layers[currentThemeLayer]);
            }
            // Adicionar novo layer
            layers[newThemeLayer].addTo(map);
            currentThemeLayer = newThemeLayer;
            console.log('🗺️ Mapa alterado para: ' + newThemeLayer);
        }

        console.log('⚙️ Configurações do tour atualizadas');
    });

    function iniciarTourOcorrencias() {
        if (tourEmExecucao || ocorrenciasTour.length === 0) return;

        tourEmExecucao = true;
        console.log('🚀 Iniciando tour por ' + ocorrenciasTour.length + ' ocorrências');

        // Atualizar visual do botão
        var btn = document.getElementById('tourControlBtn');
        var icon = document.getElementById('tourIcon');
        if (btn && icon) {
            btn.classList.add('active');
            icon.className = 'fas fa-pause';
        }

        // Iniciar o ciclo do tour
        executarCicloTour(0);
    }

    function executarCicloTour(indice) {
        if (!tourAtivo) {
            tourEmExecucao = false;
            tourNavegando = false;
            return;
        }

        // Se percorreu todas as ocorrências, voltar para posição original
        if (indice >= ocorrenciasTour.length) {
            console.log('📍 Voltando para posição original...');
            tourNavegando = true; // Marcar que o tour está navegando
            map.flyTo([posicaoOriginal.lat, posicaoOriginal.lng], posicaoOriginal.zoom, {
                duration: 2
            });

            // Esperar 5 segundos na posição original e reiniciar o tour
            tourTimeoutId = setTimeout(function() {
                tourNavegando = false;
                if (tourAtivo && ocorrenciasTour.length > 0) {
                    console.log('🔄 Reiniciando tour...');
                    executarCicloTour(0);
                }
            }, TEMPO_NA_POSICAO_ORIGINAL + 2000); // +2s da animação flyTo
            return;
        }

        var oc = ocorrenciasTour[indice];
        console.log('🎯 Voando para ocorrência ' + (indice + 1) + '/' + ocorrenciasTour.length + ': ' + (oc.protocolo || oc.titulo || 'Ocorrência'));

        // Voar para a ocorrência
        tourNavegando = true; // Marcar que o tour está navegando
        map.flyTo([oc.latitude, oc.longitude], ZOOM_OCORRENCIA, {
            duration: 1.5
        });

        // Aguardar tempo na ocorrência e ir para a próxima
        tourTimeoutId = setTimeout(function() {
            tourNavegando = false;
            executarCicloTour(indice + 1);
        }, TEMPO_EM_OCORRENCIA + 1500); // +1.5s da animação flyTo
    }

    function pararTour() {
        tourAtivo = false;
        tourEmExecucao = false;
        tourNavegando = false;
        if (tourTimeoutId) {
            clearTimeout(tourTimeoutId);
            tourTimeoutId = null;
        }
        console.log('⏹️ Tour parado');

        // Voltar para posição original ao pausar
        map.flyTo([posicaoOriginal.lat, posicaoOriginal.lng], posicaoOriginal.zoom, {
            duration: 1.5
        });
    }

    function retomarTour() {
        if (tourEmExecucao) return;
        tourAtivo = true;

        // Buscar ocorrências atuais do mapa
        var markers = mapLayers.ocorrencias.getLayers();
        if (markers.length === 0) {
            console.log('Nenhuma ocorrência para fazer tour');
            return;
        }

        // Reconstruir lista de ocorrências a partir dos markers
        // Como não temos os dados originais, vamos usar as coordenadas dos markers
        ocorrenciasTour = markers.map(function(marker) {
            var latlng = marker.getLatLng();
            return {
                latitude: latlng.lat,
                longitude: latlng.lng,
                protocolo: 'Ocorrência'
            };
        });

        console.log('▶️ Retomando tour com ' + ocorrenciasTour.length + ' ocorrências');
        iniciarTourOcorrencias();
    }

    // Pausar tour quando usuário interage com o mapa (mas não quando o tour está navegando)
    map.on('dragstart', function() {
        if (tourEmExecucao && !tourNavegando) {
            pararTour();
            atualizarBotaoTour();
            showToast('Tour pausado - Clique no botão de rota para retomar', 'info');
        }
    });

    map.on('zoomstart', function() {
        if (tourEmExecucao && !tourNavegando) {
            pararTour();
            atualizarBotaoTour();
            showToast('Tour pausado - Clique no botão de rota para retomar', 'info');
        }
    });

    // Toggle do tour (botão na interface)
    function toggleTourOcorrencias() {
        var btn = document.getElementById('tourControlBtn');
        var icon = document.getElementById('tourIcon');

        if (tourEmExecucao) {
            // Parar tour
            pararTour();
            btn.classList.remove('active');
            icon.className = 'fas fa-route';
            showToast('Tour automático desativado', 'info');
        } else {
            // Iniciar tour
            retomarTour();
            btn.classList.add('active');
            icon.className = 'fas fa-pause';
            showToast('Tour automático ativado - Voando por ' + ocorrenciasTour.length + ' ocorrências', 'success');
        }
    }

    // Atualizar visual do botão quando tour é pausado por interação
    function atualizarBotaoTour() {
        var btn = document.getElementById('tourControlBtn');
        var icon = document.getElementById('tourIcon');
        if (!tourEmExecucao) {
            btn.classList.remove('active');
            icon.className = 'fas fa-route';
        }
    }

    // Expor funções globalmente
    window.pararTour = pararTour;
    window.retomarTour = retomarTour;
    window.toggleTourOcorrencias = toggleTourOcorrencias;

    // Atualizar contador de itens da camada
    function updateLayerCount(layerName, data) {
        var countEl = document.getElementById('count' + layerName.charAt(0).toUpperCase() + layerName.slice(1));
        if (!countEl) return;

        var count = 0;
        if (Array.isArray(data)) {
            count = data.length;
        } else if (data.count !== undefined) {
            count = data.count;
        } else if (data.total !== undefined) {
            count = data.total;
        } else {
            // Tentar contar de diferentes estruturas
            var lists = ['data', 'results', 'features', 'alerts', 'jams', 'escolas', 'hospitais',
                         'sirenes', 'cameras', 'estacoes', 'linhas'];
            for (var i = 0; i < lists.length; i++) {
                if (data[lists[i]] && Array.isArray(data[lists[i]])) {
                    count = data[lists[i]].length;
                    break;
                }
            }
        }

        countEl.textContent = count;
    }

    // Selecionar todas as camadas
    function selectAllLayers() {
        var layerNames = Object.keys(mapLayers);
        layerNames.forEach(function(layerName) {
            var checkbox = document.getElementById('layer' + layerName.charAt(0).toUpperCase() + layerName.slice(1));
            if (checkbox && !checkbox.checked) {
                checkbox.checked = true;
                toggleMapLayer(layerName);
            }
        });
        showToast('Todas as camadas ativadas', 'success');
    }

    // Limpar todas as camadas
    function clearAllLayers() {
        var layerNames = Object.keys(mapLayers);
        layerNames.forEach(function(layerName) {
            var checkbox = document.getElementById('layer' + layerName.charAt(0).toUpperCase() + layerName.slice(1));
            if (checkbox && checkbox.checked) {
                checkbox.checked = false;
                toggleMapLayer(layerName);
            }
        });
        showToast('Todas as camadas desativadas', 'info');
    }

    // ============================================
    // PLAYER DE CAMERAS - JANELA FLUTUANTE RESPONSIVA
    // ============================================

    // Modo de visualizacao atual
    var currentViewMode = 'contain';

    function openCameraPlayer(url, nome, cameraId) {
        // Fechar modal existente se houver
        closeCameraPlayer();

        // Formatar nome da câmera
        var displayName = 'CAMERA ' + (cameraId || '') + ' - ' + nome.toUpperCase();

        var playerUrl = url;
        var resolvedId = cameraId;
        if (!resolvedId && url) {
            var matchId = url.match(/\/api\/camera\/(\d+)/);
            if (matchId && matchId[1]) resolvedId = matchId[1];
        }
        if (!resolvedId && url) {
            var matchCode = url.match(/[?&]CODE=(\\d+)/i);
            if (matchCode && matchCode[1]) resolvedId = matchCode[1];
        }
        if (resolvedId) {
            playerUrl = window.location.origin + '/integracity/api/camera/' + resolvedId + '/stream/?embed=1';
        } else if (url && url.indexOf('/info/') !== -1) {
            playerUrl = url.replace('/info/', '/stream/?embed=1');
        }

        var modalHtml = `
            <div id="cameraPlayerModal" class="camera-player-modal" style="
                top: 100px;
                left: 150px;
                width: 70vw;
                height: 60vh;
                max-width: 960px;
                max-height: 720px;
                min-width: 360px;
                min-height: 240px;
            ">
                <!-- Cabecalho arrastavel -->
                <div id="cameraPlayerHeader" class="camera-player-header">
                    <span class="camera-player-title">${displayName}</span>
                </div>

                <!-- Container do Video - RESPONSIVO -->
                <div class="camera-video-container">
                    <!-- Loading indicator -->
                    <div id="cameraLoading" class="camera-loading">
                        <div class="camera-loading-spinner"></div>
                        <span>Carregando video...</span>
                    </div>

                    <!-- Video Wrapper - RESPONSIVO SEM CORTES -->
                    <div class="video-wrapper">
                        <iframe
                            id="cameraIframe"
                            src="${playerUrl}"
                            allowfullscreen
                            allow="autoplay; encrypted-media"
                            scrolling="no"
                            onload="hideCameraLoading();"
                            onerror="showCameraOffline()"
                        ></iframe>
                    </div>
                </div>

                <!-- Rodape com controles e botao fechar -->
                <div class="camera-player-footer">

                    <button onclick="closeCameraPlayer()" class="camera-close-btn">
                        <i class="fas fa-times"></i> FECHAR
                    </button>
                </div>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHtml);

        // Tornar arrastavel
        makeDraggable(document.getElementById('cameraPlayerModal'), document.getElementById('cameraPlayerHeader'));

        // Fechar com ESC
        document.addEventListener('keydown', handleCameraEsc);

        // Esconder loading depois de um tempo se iframe nao disparar onload
        setTimeout(function() {
            var loading = document.getElementById('cameraLoading');
            if (loading) loading.style.display = 'none';
        }, 5000);
    }

    // Esconder loading quando iframe carregar
    function hideCameraLoading() {
        var loading = document.getElementById('cameraLoading');
        if (loading) loading.style.display = 'none';
    }

    // Mostrar estado offline
    function showCameraOffline() {
        var loading = document.getElementById('cameraLoading');
        if (loading) {
            loading.innerHTML = '<i class="fas fa-video-slash" style="font-size: 48px; opacity: 0.7;"></i><span>Camera offline</span>';
        }
    }

    // Placeholder - o iframe do Tixxi controla seu próprio conteúdo
    // Não temos controle sobre o CSS da página externa
    function setViewMode(mode, btn) {
        currentViewMode = mode;
        console.log('Modo:', mode, '(controle limitado - conteúdo externo)');

        // Atualizar botoes ativos
        document.querySelectorAll('.camera-view-btn').forEach(function(b) {
            b.classList.remove('active');
        });
        if (btn) {
            btn.classList.add('active');
        }
    }

    function closeCameraPlayer() {
        var modal = document.getElementById('cameraPlayerModal');
        if (modal) {
            modal.remove();
        }
        document.removeEventListener('keydown', handleCameraEsc);
    }

    function handleCameraEsc(e) {
        if (e.key === 'Escape') {
            closeCameraPlayer();
        }
    }

    // Funcao para tornar elemento arrastavel
    function makeDraggable(element, handle) {
        var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;

        handle.onmousedown = dragMouseDown;

        function dragMouseDown(e) {
            e.preventDefault();
            pos3 = e.clientX;
            pos4 = e.clientY;
            document.onmouseup = closeDragElement;
            document.onmousemove = elementDrag;
        }

        function elementDrag(e) {
            e.preventDefault();
            pos1 = pos3 - e.clientX;
            pos2 = pos4 - e.clientY;
            pos3 = e.clientX;
            pos4 = e.clientY;
            element.style.top = (element.offsetTop - pos2) + "px";
            element.style.left = (element.offsetLeft - pos1) + "px";
        }

        function closeDragElement() {
            document.onmouseup = null;
            document.onmousemove = null;
        }
    }

    // ============================================
    // MOSAICO DE CÂMERAS
    // ============================================

    var allCameras = []; // Armazena todas as câmeras
    var mosaicCameras = []; // Câmeras selecionadas para o mosaico
    var currentMosaicLayout = 4; // Layout atual (4, 8, 16, 24, 48)

    // Abrir modal do mosaico
    function openMosaicModal() {
        // Carregar câmeras se ainda não carregou
        if (allCameras.length === 0) {
            loadCamerasForMosaic();
        }

        var modal = document.getElementById('mosaicModal');
        if (modal) {
            modal.style.display = 'flex';
            renderCameraList();
        }
    }

    // Fechar modal do mosaico
    function closeMosaicModal() {
        var modal = document.getElementById('mosaicModal');
        if (modal) {
            modal.style.display = 'none';
        }
    }

    // Carregar câmeras da API
    function loadCamerasForMosaic() {
        var mosaicApiUrl = window.location.origin + '/integracity/api/cameras/';
        console.log('Carregando cameras para mosaico de:', mosaicApiUrl);

        fetch(mosaicApiUrl)
            .then(function(response) {
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status);
                }
                return response.json();
            })
            .then(function(data) {
                console.log('Dados do mosaico recebidos:', data);

                // A API retorna em data.data
                if (data.data && Array.isArray(data.data)) {
                    allCameras = data.data;
                } else if (data.cameras) {
                    allCameras = data.cameras;
                } else if (Array.isArray(data)) {
                    allCameras = data;
                } else {
                    allCameras = [];
                }
                console.log('Câmeras carregadas para mosaico:', allCameras.length);
                renderCameraList();
            })
            .catch(function(err) {
                console.error('Erro ao carregar câmeras:', err);
            });
    }

    // Renderizar lista de câmeras com filtro
    function renderCameraList() {
        var container = document.getElementById('cameraListContainer');
        var searchTerm = document.getElementById('cameraSearch')?.value?.toLowerCase() || '';

        if (!container) return;

        var filtered = allCameras.filter(function(cam) {
            var id = (cam.id || cam.codigo || '').toString().toLowerCase();
            var nome = (cam.nome || cam.name || '').toLowerCase();
            return id.includes(searchTerm) || nome.includes(searchTerm);
        });

        var html = '';
        filtered.forEach(function(cam, index) {
            var camId = cam.id || cam.codigo || index;
            var camNome = cam.nome || cam.name || 'Camera ' + camId;
            var isSelected = mosaicCameras.some(function(c) { return c.id === camId; });

            html += '<div class="camera-list-item ' + (isSelected ? 'selected' : '') + '" onclick="toggleCameraSelection(\'' + camId + '\')">';
            html += '  <div class="camera-checkbox">' + (isSelected ? '<i class="fas fa-check"></i>' : '') + '</div>';
            html += '  <div class="camera-info">';
            html += '    <span class="camera-id">' + camId + '</span>';
            html += '    <span class="camera-name">' + camNome + '</span>';
            html += '  </div>';
            html += '</div>';
        });

        container.innerHTML = html || '<div class="no-cameras">Nenhuma câmera encontrada</div>';

        // Atualizar contador
        var counter = document.getElementById('selectedCount');
        if (counter) {
            counter.textContent = mosaicCameras.length + ' / ' + currentMosaicLayout;
        }
    }

    // Toggle seleção de câmera
    function toggleCameraSelection(camId) {
        var cam = allCameras.find(function(c) {
            return (c.id || c.codigo) == camId;
        });

        if (!cam) return;

        var index = mosaicCameras.findIndex(function(c) {
            return (c.id || c.codigo) == camId;
        });

        if (index >= 0) {
            // Remover
            mosaicCameras.splice(index, 1);
        } else {
            // Adicionar (se não exceder limite)
            if (mosaicCameras.length < currentMosaicLayout) {
                mosaicCameras.push(cam);
            } else {
                showToast('Limite de ' + currentMosaicLayout + ' câmeras atingido!', 'warning');
                return;
            }
        }

        renderCameraList();
    }

    // Mudar layout do mosaico
    function setMosaicLayout(layout) {
        currentMosaicLayout = layout;

        // Se tem mais câmeras selecionadas que o novo limite, remover excesso
        while (mosaicCameras.length > layout) {
            mosaicCameras.pop();
        }

        // Atualizar botões
        document.querySelectorAll('.layout-btn').forEach(function(btn) {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');

        renderCameraList();
    }

    // Iniciar mosaico
    function startMosaic() {
        if (mosaicCameras.length === 0) {
            showToast('Selecione pelo menos uma câmera!', 'warning');
            return;
        }

        closeMosaicModal();
        openMosaicView();
    }

    // Abrir visualização do mosaico
    function openMosaicView() {
        // Pegar IDs das câmeras selecionadas
        var cameraIds = mosaicCameras.map(function(c) { return c.id; }).join(',');
        
        // Construir URL com parâmetros
        var url = window.location.origin + window.location.pathname;
        url += '?mosaic=true&cameras=' + encodeURIComponent(cameraIds) + '&layout=' + currentMosaicLayout;
        
        // Abrir em nova aba
        window.open(url, '_blank');
    }

    // Criar overlay do mosaico
    function createMosaicOverlay() {
        var html = `
            <div id="mosaicOverlay" class="mosaic-overlay">
                <div class="mosaic-header">
                    <div class="mosaic-title">
                        <i class="fas fa-th"></i>
                        MOSAICO DE CÂMERAS
                        <span id="mosaicInfo"></span>
                    </div>
                    <div class="mosaic-controls">
                        <button class="mosaic-btn" onclick="setMosaicLayout(4); renderMosaicGrid();">2x2</button>
                        <button class="mosaic-btn" onclick="setMosaicLayout(8); renderMosaicGrid();">2x4</button>
                        <button class="mosaic-btn" onclick="setMosaicLayout(16); renderMosaicGrid();">4x4</button>
                        <button class="mosaic-btn" onclick="setMosaicLayout(24); renderMosaicGrid();">4x6</button>
                        <button class="mosaic-btn" onclick="setMosaicLayout(48); renderMosaicGrid();">6x8</button>
                        <button class="mosaic-btn" onclick="openMosaicModal()"><i class="fas fa-plus"></i> Editar</button>
                        <button class="mosaic-btn close" onclick="closeMosaicView()"><i class="fas fa-times"></i></button>
                    </div>
                </div>
                <div id="mosaicGrid" class="mosaic-grid grid-4"></div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', html);
    }

    // Renderizar grid do mosaico
    function renderMosaicGrid() {
        var grid = document.getElementById('mosaicGrid');
        var info = document.getElementById('mosaicInfo');

        if (!grid) return;

        // Definir classe do grid baseado no layout
        grid.className = 'mosaic-grid grid-' + currentMosaicLayout;

        // Atualizar info
        if (info) {
            info.textContent = '(' + mosaicCameras.length + ' câmeras)';
        }

        var html = '';

        // Renderizar câmeras selecionadas
        mosaicCameras.forEach(function(cam, index) {
            var camId = cam.id || cam.codigo;
            var camNome = cam.nome || cam.name || 'Camera';
            var camUrl = cam.url || '';

            html += '<div class="mosaic-cell">';
            html += '  <div class="mosaic-cell-header">' + camId + ' - ' + camNome + '</div>';
            if (camUrl) {
                html += '  <iframe src="' + camUrl + '" allowfullscreen></iframe>';
            } else {
                html += '  <div class="mosaic-no-stream"><i class="fas fa-video-slash"></i></div>';
            }
            html += '</div>';
        });

        // Preencher células vazias
        for (var i = mosaicCameras.length; i < currentMosaicLayout; i++) {
            html += '<div class="mosaic-cell empty">';
            html += '  <div class="mosaic-empty-cell"><i class="fas fa-plus"></i><br>Vazio</div>';
            html += '</div>';
        }

        grid.innerHTML = html;
    }

    // Fechar visualização do mosaico
    function closeMosaicView() {
        var overlay = document.getElementById('mosaicOverlay');
        if (overlay) {
            overlay.style.display = 'none';
        }
    }

    // Filtrar câmeras (chamado no input)
    function filterCameras() {
        renderCameraList();
    }

    // Selecionar todas as câmeras filtradas
    function selectAllFiltered() {
        var searchTerm = document.getElementById('cameraSearch')?.value?.toLowerCase() || '';

        var filtered = allCameras.filter(function(cam) {
            var id = (cam.id || cam.codigo || '').toString().toLowerCase();
            var nome = (cam.nome || cam.name || '').toLowerCase();
            return id.includes(searchTerm) || nome.includes(searchTerm);
        });

        filtered.forEach(function(cam) {
            var camId = cam.id || cam.codigo;
            var alreadySelected = mosaicCameras.some(function(c) {
                return (c.id || c.codigo) == camId;
            });

            if (!alreadySelected && mosaicCameras.length < currentMosaicLayout) {
                mosaicCameras.push(cam);
            }
        });

        renderCameraList();
    }

    // Limpar seleção
    function clearSelection() {
        mosaicCameras = [];
        renderCameraList();
    }

    // ============================================
    // EXPORT FUNCTIONS TO GLOBAL SCOPE
    // ============================================
    // Necessário para que onclick="" funcione corretamente
    window.toggleLayersSidebar = toggleLayersSidebar;
    window.toggleMapLayer = toggleMapLayer;
    window.toggleCameraSubmenu = toggleCameraSubmenu;
    window.toggleAllCameras = toggleAllCameras;
    window.toggleCameraType = toggleCameraType;
    window.openMosaicModal = openMosaicModal;
    window.closeMosaicModal = closeMosaicModal;
    window.setMosaicLayout = setMosaicLayout;
    window.filterCameras = filterCameras;
    window.selectAllFiltered = selectAllFiltered;
    window.clearSelection = clearSelection;
    window.toggleCameraSelection = toggleCameraSelection;
    window.createMosaicOverlay = createMosaicOverlay;
    window.closeMosaicView = closeMosaicView;
    window.renderMosaicGrid = renderMosaicGrid;
    window.openMosaicView = openMosaicView;
    window.switchLayer = switchLayer;
    window.zoomIn = zoomIn;
    window.zoomOut = zoomOut;
    window.resetView = resetView;

    // ============================================
    // INICIALIZACAO
    // ============================================
    console.log('IntegraCity High-Tech Dashboard initialized');
    console.log('Mapa centrado no Rio de Janeiro');
    console.log('Sistema de camadas carregado');

    // ===== DETECTOR DE MOSAICO NA URL =====
    window.addEventListener('DOMContentLoaded', function() {
        var urlParams = new URLSearchParams(window.location.search);
        
        if (urlParams.get('mosaic') === 'true') {
            var cameraIds = urlParams.get('cameras');
            var layout = parseInt(urlParams.get('layout')) || 4;
            
            console.log('Modo mosaico detectado! IDs:', cameraIds, 'Layout:', layout);
            
            // Configurar layout
            currentMosaicLayout = layout;
            
            // Carregar câmeras da API e depois abrir overlay
            fetch(window.location.origin + '/integracity/api/cameras/')
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    // Parsear dados da API
                    if (data.data && Array.isArray(data.data)) {
                        allCameras = data.data;
                    } else if (Array.isArray(data)) {
                        allCameras = data;
                    }
                    
                    // Selecionar câmeras pelos IDs
                    if (cameraIds) {
                        var ids = cameraIds.split(',');
                        mosaicCameras = allCameras.filter(function(cam) {
                            return ids.includes(String(cam.id));
                        });
                        console.log('Câmeras selecionadas:', mosaicCameras.length);
                    } else {
                        // Se não tem IDs, pegar as primeiras N câmeras
                        mosaicCameras = allCameras.slice(0, layout);
                    }
                    
                    // Criar e abrir overlay
                    createMosaicOverlay();
                    var overlay = document.getElementById('mosaicOverlay');
                    if (overlay) {
                        overlay.style.display = 'flex';
                        renderMosaicGrid();
                    }
                })
                .catch(function(err) {
                    console.error('Erro ao carregar câmeras para mosaico:', err);
                });
        }

        // Carregar camada de ocorrencias automaticamente (checkbox marcado por padrao)
        var ocorrenciasCheckbox = document.getElementById('layerOcorrencias');
        if (ocorrenciasCheckbox && ocorrenciasCheckbox.checked) {
            console.log('Carregando ocorrencias automaticamente...');
            mapLayers.ocorrencias.addTo(map);
            loadLayerData('ocorrencias');
        }
    });

    // Atualizar ocorrencias a cada 2 minutos
    setInterval(function() {
        var ocorrenciasCheckbox = document.getElementById('layerOcorrencias');
        if (ocorrenciasCheckbox && ocorrenciasCheckbox.checked) {
            console.log('Atualizando ocorrencias...');
            loadLayerData('ocorrencias');
        }
    }, 120000);

    // ===== BUSCA DE ESCOLAS COM AUTOCOMPLETE =====
    (function() {
        var escolaSearchInput = document.getElementById('escolaSearchInput');
        var escolaAutocompleteList = document.getElementById('escolaAutocompleteList');
        var escolaSearchClear = document.getElementById('escolaSearchClear');
        var escolasData = [];
        var selectedIndex = -1;
        var debounceTimer = null;

        // Carregar dados das escolas quando a camada for ativada
        function loadEscolasData() {
            if (escolasData.length > 0) return Promise.resolve(escolasData);

            return fetch(window.location.origin + '/integracity/api/escolas/')
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    if (data.success && data.data) {
                        escolasData = data.data;
                        console.log('Escolas carregadas para busca:', escolasData.length);
                    }
                    return escolasData;
                })
                .catch(function(err) {
                    console.error('Erro ao carregar escolas:', err);
                    return [];
                });
        }

        // Destacar texto encontrado
        function highlightMatch(text, query) {
            if (!query || !text) return text;
            var regex = new RegExp('(' + query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi');
            return text.replace(regex, '<mark>$1</mark>');
        }

        // Filtrar escolas pelo nome
        function filterEscolas(query) {
            if (!query || query.length < 2) return [];

            var queryLower = query.toLowerCase();
            return escolasData.filter(function(escola) {
                return escola.nome && escola.nome.toLowerCase().includes(queryLower);
            }).slice(0, 15); // Limitar a 15 resultados
        }

        // Renderizar lista de autocomplete
        function renderAutocomplete(results, query) {
            selectedIndex = -1;
            escolaAutocompleteList.innerHTML = '';

            if (results.length === 0) {
                escolaAutocompleteList.innerHTML = '<div class="escola-no-results"><i class="fas fa-search"></i> Nenhuma escola encontrada</div>';
                escolaAutocompleteList.classList.add('active');
                return;
            }

            results.forEach(function(escola, index) {
                var item = document.createElement('div');
                item.className = 'escola-autocomplete-item';
                item.setAttribute('data-index', index);
                item.innerHTML =
                    '<div class="escola-nome">' + highlightMatch(escola.nome, query) + '</div>' +
                    '<div class="escola-tipo"><i class="fas fa-map-marker-alt"></i> ' + (escola.tipo || 'Escola Municipal') + ' - CRE ' + (escola.cre || 'N/A') + '</div>';

                item.addEventListener('click', function() {
                    selectEscola(escola);
                });

                item.addEventListener('mouseenter', function() {
                    selectedIndex = index;
                    updateSelectedItem();
                });

                escolaAutocompleteList.appendChild(item);
            });

            escolaAutocompleteList.classList.add('active');
        }

        // Atualizar item selecionado (navegação por teclado)
        function updateSelectedItem() {
            var items = escolaAutocompleteList.querySelectorAll('.escola-autocomplete-item');
            items.forEach(function(item, i) {
                if (i === selectedIndex) {
                    item.classList.add('selected');
                    item.scrollIntoView({ block: 'nearest' });
                } else {
                    item.classList.remove('selected');
                }
            });
        }

        // Selecionar escola e georreferenciar no mapa
        function selectEscola(escola) {
            console.log('Escola selecionada:', escola.nome, escola.lat, escola.lng);

            // Limpar busca
            escolaSearchInput.value = escola.nome;
            escolaAutocompleteList.innerHTML = '';
            escolaAutocompleteList.classList.remove('active');
            escolaSearchClear.style.display = 'flex';

            // Centralizar mapa na escola com zoom alto
            if (escola.lat && escola.lng) {
                map.flyTo([escola.lat, escola.lng], 18, {
                    duration: 1.5
                });

                // Encontrar e abrir popup do marcador
                mapLayers.escolas.eachLayer(function(layer) {
                    var latLng = layer.getLatLng();
                    if (Math.abs(latLng.lat - escola.lat) < 0.0001 &&
                        Math.abs(latLng.lng - escola.lng) < 0.0001) {
                        setTimeout(function() {
                            layer.openPopup();
                        }, 1600);
                    }
                });

                showToast('Escola localizada: ' + escola.nome, 'success');
            }
        }

        // Event listeners
        if (escolaSearchInput) {
            // Input com debounce
            escolaSearchInput.addEventListener('input', function(e) {
                var query = e.target.value.trim();

                // Mostrar/esconder botão de limpar
                escolaSearchClear.style.display = query ? 'flex' : 'none';

                // Debounce para não fazer muitas buscas
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(function() {
                    if (query.length >= 2) {
                        loadEscolasData().then(function() {
                            var results = filterEscolas(query);
                            renderAutocomplete(results, query);
                        });
                    } else {
                        escolaAutocompleteList.innerHTML = '';
                        escolaAutocompleteList.classList.remove('active');
                    }
                }, 200);
            });

            // Navegação por teclado
            escolaSearchInput.addEventListener('keydown', function(e) {
                var items = escolaAutocompleteList.querySelectorAll('.escola-autocomplete-item');
                if (items.length === 0) return;

                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                    updateSelectedItem();
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedIndex = Math.max(selectedIndex - 1, 0);
                    updateSelectedItem();
                } else if (e.key === 'Enter' && selectedIndex >= 0) {
                    e.preventDefault();
                    var query = escolaSearchInput.value.trim();
                    var results = filterEscolas(query);
                    if (results[selectedIndex]) {
                        selectEscola(results[selectedIndex]);
                    }
                } else if (e.key === 'Escape') {
                    escolaAutocompleteList.innerHTML = '';
                    escolaAutocompleteList.classList.remove('active');
                    escolaSearchInput.blur();
                }
            });

            // Fechar ao clicar fora
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.escola-search-container')) {
                    escolaAutocompleteList.innerHTML = '';
                    escolaAutocompleteList.classList.remove('active');
                }
            });
        }

        // Botão de limpar
        if (escolaSearchClear) {
            escolaSearchClear.addEventListener('click', function() {
                escolaSearchInput.value = '';
                escolaAutocompleteList.innerHTML = '';
                escolaAutocompleteList.classList.remove('active');
                escolaSearchClear.style.display = 'none';
                escolaSearchInput.focus();
            });
        }

        console.log('Sistema de busca de escolas inicializado');
    })();

    // ===== BUSCA DE CÂMERAS COM AUTOCOMPLETE =====
    (function() {
        var cameraSearchInput = document.getElementById('cameraSearchInput');
        var cameraAutocompleteList = document.getElementById('cameraAutocompleteList');
        var cameraSearchClear = document.getElementById('cameraSearchClear');
        var camerasData = [];
        var selectedIndex = -1;
        var debounceTimer = null;

        // Carregar dados das câmeras
        function loadCamerasData() {
            if (camerasData.length > 0) return Promise.resolve(camerasData);

            return fetch(window.location.origin + '/integracity/api/cameras/')
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    if (data.data && Array.isArray(data.data)) {
                        camerasData = data.data;
                    } else if (Array.isArray(data)) {
                        camerasData = data;
                    }
                    console.log('Câmeras carregadas para busca:', camerasData.length);
                    return camerasData;
                })
                .catch(function(err) {
                    console.error('Erro ao carregar câmeras:', err);
                    return [];
                });
        }

        // Destacar texto encontrado
        function highlightMatch(text, query) {
            if (!query || !text) return text;
            var regex = new RegExp('(' + query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi');
            return text.replace(regex, '<mark>$1</mark>');
        }

        // Filtrar câmeras pelo nome
        function filterCameras(query) {
            if (!query || query.length < 2) return [];

            var queryLower = query.toLowerCase();
            return camerasData.filter(function(camera) {
                var nome = camera.nome || camera.name || camera.denominacao || '';
                return nome.toLowerCase().includes(queryLower);
            }).slice(0, 15); // Limitar a 15 resultados
        }

        // Renderizar lista de autocomplete
        function renderAutocomplete(results, query) {
            selectedIndex = -1;
            cameraAutocompleteList.innerHTML = '';

            if (results.length === 0) {
                cameraAutocompleteList.innerHTML = '<div class="camera-no-results"><i class="fas fa-search"></i> Nenhuma camera encontrada</div>';
                cameraAutocompleteList.classList.add('active');
                return;
            }

            results.forEach(function(camera, index) {
                var nome = camera.nome || camera.name || camera.denominacao || 'Sem nome';
                var tipo = camera.tipo || camera.type || 'N/A';
                var isMovel = tipo.toLowerCase().includes('movel') || tipo.toLowerCase().includes('móvel');

                var item = document.createElement('div');
                item.className = 'camera-autocomplete-item';
                item.setAttribute('data-index', index);
                item.innerHTML =
                    '<div class="camera-nome">' + highlightMatch(nome, query) + '</div>' +
                    '<div class="camera-tipo"><i class="fas fa-video"></i> <span class="' + (isMovel ? 'tipo-movel' : 'tipo-fixa') + '">' + tipo + '</span></div>';

                item.addEventListener('click', function(e) {
                    e.stopPropagation();
                    selectCamera(camera);
                });

                item.addEventListener('mouseenter', function() {
                    selectedIndex = index;
                    updateSelectedItem();
                });

                cameraAutocompleteList.appendChild(item);
            });

            cameraAutocompleteList.classList.add('active');
        }

        // Atualizar item selecionado (navegação por teclado)
        function updateSelectedItem() {
            var items = cameraAutocompleteList.querySelectorAll('.camera-autocomplete-item');
            items.forEach(function(item, i) {
                if (i === selectedIndex) {
                    item.classList.add('selected');
                    item.scrollIntoView({ block: 'nearest' });
                } else {
                    item.classList.remove('selected');
                }
            });
        }

        // Selecionar câmera e georreferenciar no mapa
        function selectCamera(camera) {
            var nome = camera.nome || camera.name || camera.denominacao || 'Sem nome';
            var lat = camera.lat || camera.latitude;
            var lng = camera.lng || camera.longitude;

            console.log('Câmera selecionada:', nome, lat, lng);

            // Limpar busca
            cameraSearchInput.value = nome;
            cameraAutocompleteList.innerHTML = '';
            cameraAutocompleteList.classList.remove('active');
            cameraSearchClear.style.display = 'flex';

            // Centralizar mapa na câmera com zoom alto
            if (lat && lng) {
                map.flyTo([lat, lng], 18, {
                    duration: 1.5
                });

                // Encontrar e abrir popup do marcador (verificar nas duas camadas)
                var found = false;
                ['camerasFixas', 'camerasMoveis'].forEach(function(layerName) {
                    if (found || !mapLayers[layerName]) return;
                    mapLayers[layerName].eachLayer(function(layer) {
                        if (found) return;
                        var latLng = layer.getLatLng();
                        if (Math.abs(latLng.lat - lat) < 0.0001 &&
                            Math.abs(latLng.lng - lng) < 0.0001) {
                            found = true;
                            setTimeout(function() {
                                layer.openPopup();
                            }, 1600);
                        }
                    });
                });

                showToast('Câmera localizada: ' + nome, 'success');
            }
        }

        // Event listeners
        if (cameraSearchInput) {
            // Input com debounce
            cameraSearchInput.addEventListener('input', function(e) {
                var query = e.target.value.trim();

                // Mostrar/esconder botão de limpar
                cameraSearchClear.style.display = query ? 'flex' : 'none';

                // Debounce para não fazer muitas buscas
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(function() {
                    if (query.length >= 2) {
                        loadCamerasData().then(function() {
                            var results = filterCameras(query);
                            renderAutocomplete(results, query);
                        });
                    } else {
                        cameraAutocompleteList.innerHTML = '';
                        cameraAutocompleteList.classList.remove('active');
                    }
                }, 200);
            });

            // Navegação por teclado
            cameraSearchInput.addEventListener('keydown', function(e) {
                var items = cameraAutocompleteList.querySelectorAll('.camera-autocomplete-item');
                if (items.length === 0) return;

                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                    updateSelectedItem();
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedIndex = Math.max(selectedIndex - 1, 0);
                    updateSelectedItem();
                } else if (e.key === 'Enter' && selectedIndex >= 0) {
                    e.preventDefault();
                    var query = cameraSearchInput.value.trim();
                    var results = filterCameras(query);
                    if (results[selectedIndex]) {
                        selectCamera(results[selectedIndex]);
                    }
                } else if (e.key === 'Escape') {
                    cameraAutocompleteList.innerHTML = '';
                    cameraAutocompleteList.classList.remove('active');
                    cameraSearchInput.blur();
                }
            });

            // Fechar ao clicar fora
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.camera-search-container')) {
                    cameraAutocompleteList.innerHTML = '';
                    cameraAutocompleteList.classList.remove('active');
                }
            });
        }

        // Botão de limpar
        if (cameraSearchClear) {
            cameraSearchClear.addEventListener('click', function(e) {
                e.stopPropagation();
                cameraSearchInput.value = '';
                cameraAutocompleteList.innerHTML = '';
                cameraAutocompleteList.classList.remove('active');
                cameraSearchClear.style.display = 'none';
                cameraSearchInput.focus();
            });
        }

        console.log('Sistema de busca de câmeras inicializado');
    })();

    // ============================================
    // SISTEMA DE ÁREAS DE OBSERVAÇÃO
    // ============================================

    var areaDrawer = null;
    var isDrawingArea = false;
    var drawControl = null;

    // Inicializar Leaflet.draw
    function initAreasDraw() {
        console.log('=== Inicializando sistema de áreas v2 ===');
        console.log('CODIGO ATUALIZADO - URLs absolutas');
        console.log('Map disponível:', !!map);
        console.log('mapLayers.areasObservacao:', !!mapLayers.areasObservacao);

        // Adicionar layer de áreas ao mapa primeiro
        mapLayers.areasObservacao.addTo(map);
        console.log('Layer areasObservacao adicionado ao mapa');

        // Carregar áreas existentes sempre (independente de L.Draw)
        carregarAreasExistentes();

        if (!L.Draw) {
            console.warn('Leaflet.draw não carregado - modo de desenho desabilitado');
            return;
        }

        // Configurar controle de desenho (oculto, usaremos nosso botão)
        drawControl = new L.Control.Draw({
            position: 'topright',
            draw: {
                polyline: false,
                circle: false,
                circlemarker: false,
                marker: false,
                polygon: {
                    allowIntersection: false,
                    showArea: true,
                    shapeOptions: {
                        color: '#00D4FF',
                        fillColor: '#00D4FF',
                        fillOpacity: 0.2,
                        weight: 2
                    }
                },
                rectangle: {
                    shapeOptions: {
                        color: '#00D4FF',
                        fillColor: '#00D4FF',
                        fillOpacity: 0.2,
                        weight: 2
                    }
                }
            },
            edit: {
                featureGroup: mapLayers.areasObservacao,
                remove: true
            }
        });

        // Não adiciona ao mapa (usamos botão customizado)

        // Evento quando desenho é criado
        map.on(L.Draw.Event.CREATED, function(e) {
            var layer = e.layer;
            var type = e.layerType;

            console.log('Área desenhada:', type);

            // Adicionar ao layer temporariamente
            mapLayers.areasObservacao.addLayer(layer);

            // Abrir prompt para nomear
            abrirModalNomearArea(layer, type);

            // Desativar modo de desenho
            setDrawingAreaMode(false);
        });

        console.log('Sistema de áreas de observação inicializado (com desenho)');
    }

    // Iniciar desenho de área
    function iniciarDesenhoArea() {
        if (!drawControl) {
            initAreasDraw();
        }

        if (isDrawingArea) {
            cancelarDesenhoArea();
            return;
        }

        // Ativar modo polígono
        areaDrawer = new L.Draw.Polygon(map, drawControl.options.draw.polygon);
        areaDrawer.enable();

        setDrawingAreaMode(true);
        showToast('Clique no mapa para desenhar a área. Clique no primeiro ponto para fechar.', 'info');
    }

    // Cancelar desenho
    function cancelarDesenhoArea() {
        if (areaDrawer) {
            areaDrawer.disable();
            areaDrawer = null;
        }
        setDrawingAreaMode(false);
        showToast('Desenho cancelado', 'info');
    }

    // Definir modo de desenho
    function setDrawingAreaMode(active) {
        isDrawingArea = active;
        var btn = document.getElementById('btnCriarArea');
        if (btn) {
            btn.classList.toggle('active', active);
        }
    }

    // Modal para nomear área
    function abrirModalNomearArea(layer, type) {
        var nome = prompt('Digite o nome da área de observação:', '');

        if (!nome || nome.trim() === '') {
            mapLayers.areasObservacao.removeLayer(layer);
            showToast('Criação de área cancelada', 'warning');
            return;
        }

        var descricao = prompt('Digite uma descrição (opcional):', '') || '';

        // Salvar área
        salvarArea(layer, nome.trim(), descricao.trim(), '#00D4FF', type);
    }

    // Salvar área no backend
    async function salvarArea(layer, nome, descricao, cor, tipo) {
        var geojson = layer.toGeoJSON();

        var dados = {
            nome: nome,
            descricao: descricao,
            cor: cor,
            geojson: geojson.geometry,
            tipo_desenho: tipo === 'rectangle' ? 'rectangle' : 'polygon'
        };

        try {
            showToast('Salvando área...', 'info');

            var response = await fetch('/integracity/api/areas/criar/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify(dados)
            });

            if (response.ok) {
                var resultado = await response.json();
                console.log('Área salva:', resultado);

                // Atualizar layer com ID
                layer.areaId = resultado.area_id;
                layer.areaNome = nome;

                // Adicionar popup
                adicionarPopupArea(layer, {
                    id: resultado.area_id,
                    nome: nome,
                    descricao: descricao,
                    cor: cor,
                    nivel_operacional: 'E1'
                });

                // Atualizar contagem
                updateLayerCount('areasObservacao', mapLayers.areasObservacao.getLayers());

                showToast('Área "' + nome + '" criada com sucesso!', 'success');

            } else {
                var erro = await response.json();
                alert('Erro ao salvar: ' + (erro.error || 'Erro desconhecido'));
                mapLayers.areasObservacao.removeLayer(layer);
            }
        } catch (error) {
            console.error('Erro ao salvar área:', error);
            alert('Erro de conexão ao salvar área');
            mapLayers.areasObservacao.removeLayer(layer);
        }
    }

    // Adicionar popup à área
    function adicionarPopupArea(layer, area) {
        var nivelCor = {
            'E1': '#00C853',
            'E2': '#00BCD4',
            'E3': '#FFC107',
            'E4': '#FF5722',
            'E5': '#212121'
        };

        var html = '<div class="area-popup">' +
            '<h6 style="color: ' + (area.cor || '#00D4FF') + ';">' +
            '<i class="fas fa-draw-polygon"></i> ' + area.nome + '</h6>' +
            '<p style="margin: 5px 0; color: #aaa; font-size: 0.85rem;">' + (area.descricao || 'Sem descrição') + '</p>' +
            '<span class="area-nivel" style="background: ' + (nivelCor[area.nivel_operacional] || '#00C853') + '; color: #fff;">' +
            area.nivel_operacional + '</span>' +
            '<br><button class="btn btn-sm btn-primary btn-area-dashboard" ' +
            'onclick="window.open(\'/integracity/areas/' + area.id + '/\', \'_blank\')">' +
            '<i class="fas fa-external-link-alt"></i> Abrir Dashboard</button>' +
            '</div>';

        layer.bindPopup(html);
    }

    // Carregar áreas existentes do backend
    async function carregarAreasExistentes() {
        // Usar caminho absoluto para evitar problemas de cache/concatenação
        var url = '/integracity/api/areas/listar/';
        console.log('Carregando áreas de:', url);

        try {
            var response = await fetch(url);
            console.log('Response status:', response.status);

            if (!response.ok) {
                console.error('Erro HTTP ao carregar áreas:', response.status);
                return;
            }

            var data = await response.json();
            console.log('Dados recebidos:', data);
            var areas = data.areas || [];

            console.log('Áreas carregadas:', areas.length);

            areas.forEach(function(area) {
                adicionarAreaNoMapa(area);
            });

            // Atualizar contagem
            updateLayerCount('areasObservacao', areas);

            // Marcar checkbox se há áreas
            if (areas.length > 0) {
                var checkbox = document.getElementById('layerAreasObservacao');
                if (checkbox && !checkbox.checked) {
                    checkbox.checked = true;
                    var layerItem = checkbox.closest('.layer-item');
                    if (layerItem) layerItem.classList.add('active');
                }
            }

        } catch (error) {
            console.error('Erro ao carregar áreas:', error);
        }
    }

    // Adicionar área no mapa
    function adicionarAreaNoMapa(area) {
        console.log('Adicionando área:', area.nome, area.id, 'tipo:', area.tipo_desenho);

        try {
            var geojson = area.geojson;
            console.log('GeoJSON original:', geojson);

            if (typeof geojson === 'string') {
                geojson = JSON.parse(geojson);
                console.log('GeoJSON parseado');
            }

            // Verificar estrutura do GeoJSON (pode ser Feature ou geometria direta)
            var geometry = geojson;
            if (geojson.type === 'Feature') {
                geometry = geojson.geometry;
            }

            if (!geometry || !geometry.coordinates) {
                console.error('Coordenadas inválidas:', geojson);
                return;
            }

            var layer = null;
            var geometryType = geometry.type;
            var cor = area.cor || '#00D4FF';

            console.log('Tipo de geometria:', geometryType);

            if (geometryType === 'Polygon') {
                // Polígono
                var coords = geometry.coordinates[0];
                var latlngs = coords.map(function(coord) {
                    return [coord[1], coord[0]];
                });

                layer = L.polygon(latlngs, {
                    color: cor,
                    fillColor: cor,
                    fillOpacity: 0.15,
                    weight: 2,
                    dashArray: '5, 5'
                });

            } else if (geometryType === 'LineString') {
                // Linha/Rota
                var coords = geometry.coordinates;
                var latlngs = coords.map(function(coord) {
                    return [coord[1], coord[0]];
                });

                layer = L.polyline(latlngs, {
                    color: cor,
                    weight: 4,
                    opacity: 0.8,
                    dashArray: '10, 5'
                });

            } else if (geometryType === 'Point') {
                // Ponto/Marcador
                var coord = geometry.coordinates;
                layer = L.circleMarker([coord[1], coord[0]], {
                    radius: 10,
                    color: cor,
                    fillColor: cor,
                    fillOpacity: 0.6,
                    weight: 2
                });

            } else if (geometryType === 'GeometryCollection') {
                // Múltiplas geometrias - renderizar cada uma
                geometry.geometries.forEach(function(geom, idx) {
                    var subArea = Object.assign({}, area);
                    subArea.geojson = { type: 'Feature', geometry: geom };
                    subArea.nome = area.nome + ' (' + (idx + 1) + ')';
                    adicionarAreaNoMapa(subArea);
                });
                return;

            } else {
                console.warn('Tipo de geometria não suportado:', geometryType);
                return;
            }

            if (layer) {
                layer.areaId = area.id;
                layer.areaNome = area.nome;
                adicionarPopupArea(layer, area);
                mapLayers.areasObservacao.addLayer(layer);
                console.log('Área adicionada com sucesso:', area.nome, '(' + geometryType + ')');
            }

        } catch (e) {
            console.error('Erro ao adicionar área no mapa:', e, area);
        }
    }

    // Obter CSRF token
    function getCSRFToken() {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = cookies[i].trim();
            if (cookie.startsWith('csrftoken=')) {
                return cookie.substring('csrftoken='.length);
            }
        }
        return '';
    }

    // Inicializar quando o mapa estiver pronto
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(initAreasDraw, 1000);
    });

    // Expor funções globalmente
    window.iniciarDesenhoArea = iniciarDesenhoArea;
    window.cancelarDesenhoArea = cancelarDesenhoArea;

</script>

<!-- ============================================
     MODAL DE SELEÇÃO DO MOSAICO
     ============================================ -->
<div id="mosaicModal" class="mosaic-modal" style="display: none;">
    <div class="mosaic-modal-content">
        <div class="mosaic-modal-header">
            <h2><i class="fas fa-th"></i> Configurar Mosaico</h2>
            <button class="mosaic-close-btn" onclick="closeMosaicModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="mosaic-modal-body">
            <!-- Layout Selection -->
            <div class="layout-section">
                <label>Layout:</label>
                <div class="layout-buttons">
                    <button class="layout-btn active" onclick="setMosaicLayout(4)">2x2 (4)</button>
                    <button class="layout-btn" onclick="setMosaicLayout(8)">2x4 (8)</button>
                    <button class="layout-btn" onclick="setMosaicLayout(16)">4x4 (16)</button>
                    <button class="layout-btn" onclick="setMosaicLayout(24)">4x6 (24)</button>
                    <button class="layout-btn" onclick="setMosaicLayout(48)">6x8 (48)</button>
                </div>
            </div>

            <!-- Search -->
            <div class="search-section">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="cameraSearch" placeholder="Buscar por ID ou nome..." oninput="filterCameras()">
                </div>
                <div class="search-actions">
                    <button class="action-btn" onclick="selectAllFiltered()">
                        <i class="fas fa-check-double"></i> Selecionar Filtrados
                    </button>
                    <button class="action-btn" onclick="clearSelection()">
                        <i class="fas fa-trash"></i> Limpar
                    </button>
                </div>
            </div>

            <!-- Counter -->
            <div class="selection-counter">
                Selecionadas: <span id="selectedCount">0 / 4</span>
            </div>

            <!-- Camera List -->
            <div id="cameraListContainer" class="camera-list-container">
                <div class="loading-cameras">
                    <i class="fas fa-spinner fa-spin"></i> Carregando câmeras...
                </div>
            </div>
        </div>

        <div class="mosaic-modal-footer">
            <button class="cancel-btn" onclick="closeMosaicModal()">Cancelar</button>
            <button class="start-btn" onclick="startMosaic()">
                <i class="fas fa-play"></i> Iniciar Mosaico
            </button>
        </div>
    </div>
</div>

<!-- ============================================
     MODAL DE IMPORTAÇÃO KML/KMZ
     ============================================ -->
<div id="kmlImportModal" class="mosaic-modal" style="display: none;">
    <div class="mosaic-modal-content" style="max-width: 500px;">
        <div class="mosaic-modal-header" style="background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);">
            <h2><i class="fas fa-file-import"></i> Importar Planejamento</h2>
            <button class="mosaic-close-btn" onclick="fecharModalImportarKML()">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="mosaic-modal-body" style="padding: 25px;">
            <!-- Instrucoes -->
            <div style="background: rgba(76, 175, 80, 0.1); border: 1px solid rgba(76, 175, 80, 0.3); border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                <h4 style="color: #4CAF50; margin: 0 0 10px 0; font-size: 14px;">
                    <i class="fas fa-info-circle"></i> Formatos Suportados
                </h4>
                <p style="margin: 0; color: #aaa; font-size: 13px;">
                    Arquivos <strong>KML</strong> ou <strong>KMZ</strong> (Google Earth) contendo poligonos, linhas ou pontos.
                    Cada elemento sera salvo como uma Area de Observacao.
                </p>
            </div>

            <!-- Upload Area -->
            <div id="kmlDropZone" class="kml-drop-zone" onclick="document.getElementById('kmlFileInput').click();">
                <input type="file" id="kmlFileInput" accept=".kml,.kmz" style="display: none;" onchange="handleKMLFileSelect(this)">
                <div class="drop-zone-content">
                    <i class="fas fa-cloud-upload-alt" style="font-size: 48px; color: #4CAF50; margin-bottom: 15px;"></i>
                    <p style="margin: 0; font-size: 16px; color: #fff;">Clique ou arraste o arquivo aqui</p>
                    <p style="margin: 5px 0 0 0; font-size: 12px; color: #888;">.kml ou .kmz</p>
                </div>
            </div>

            <!-- Arquivo Selecionado -->
            <div id="kmlFileInfo" style="display: none; margin-top: 15px; padding: 12px; background: rgba(0, 212, 255, 0.1); border: 1px solid rgba(0, 212, 255, 0.3); border-radius: 8px;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-file-code" style="font-size: 24px; color: #00D4FF;"></i>
                    <div style="flex: 1;">
                        <p id="kmlFileName" style="margin: 0; font-weight: 600; color: #fff;">arquivo.kml</p>
                        <p id="kmlFileSize" style="margin: 2px 0 0 0; font-size: 11px; color: #888;">0 KB</p>
                    </div>
                    <button onclick="limparArquivoKML()" style="background: none; border: none; color: #ff5555; cursor: pointer; padding: 5px;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <!-- Opcoes -->
            <div style="margin-top: 20px;">
                <label style="display: block; margin-bottom: 8px; color: #aaa; font-size: 13px;">
                    <i class="fas fa-tag"></i> Prefixo para nomes (opcional)
                </label>
                <input type="text" id="kmlPrefixo" placeholder="Ex: Reveillon 2025, Carnaval..."
                       style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: #fff; font-size: 14px;">
            </div>

            <!-- Cor Padrao -->
            <div style="margin-top: 15px;">
                <label style="display: block; margin-bottom: 8px; color: #aaa; font-size: 13px;">
                    <i class="fas fa-palette"></i> Cor padrao das areas
                </label>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="color" id="kmlCorPadrao" value="#00D4FF"
                           style="width: 50px; height: 40px; border: none; border-radius: 6px; cursor: pointer;">
                    <span style="color: #888; font-size: 12px;">Usado se o arquivo nao definir cores</span>
                </div>
            </div>

            <!-- Tipo: Temporaria ou Permanente -->
            <div style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.03); border-radius: 8px;">
                <label style="display: block; margin-bottom: 12px; color: #fff; font-size: 14px; font-weight: 600;">
                    <i class="fas fa-clock"></i> Tipo de Area
                </label>
                <div style="display: flex; gap: 15px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px 15px; background: rgba(0, 212, 255, 0.1); border: 1px solid rgba(0, 212, 255, 0.3); border-radius: 6px; flex: 1;">
                        <input type="radio" name="kmlTipoArea" value="permanente" checked
                               style="accent-color: #00D4FF;" onchange="toggleAgendamentoKML()">
                        <span style="color: #fff;"><i class="fas fa-infinity"></i> Permanente</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px 15px; background: rgba(255, 152, 0, 0.1); border: 1px solid rgba(255, 152, 0, 0.3); border-radius: 6px; flex: 1;">
                        <input type="radio" name="kmlTipoArea" value="temporaria"
                               style="accent-color: #FF9800;" onchange="toggleAgendamentoKML()">
                        <span style="color: #fff;"><i class="fas fa-hourglass-half"></i> Temporaria</span>
                    </label>
                </div>
            </div>

            <!-- Agendamento (visivel apenas quando temporaria) -->
            <div id="kmlAgendamento" style="display: none; margin-top: 15px; padding: 15px; background: rgba(255, 152, 0, 0.1); border: 1px solid rgba(255, 152, 0, 0.3); border-radius: 8px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: #aaa; font-size: 13px;">
                            <i class="fas fa-play-circle"></i> Inicio (quando aparecer)
                        </label>
                        <input type="datetime-local" id="kmlEventoInicio"
                               style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: #fff; font-size: 13px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; color: #aaa; font-size: 13px;">
                            <i class="fas fa-stop-circle"></i> Fim (quando desaparecer)
                        </label>
                        <input type="datetime-local" id="kmlEventoFim"
                               style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: #fff; font-size: 13px;">
                    </div>
                </div>
                <p style="margin: 10px 0 0 0; font-size: 11px; color: #888;">
                    <i class="fas fa-info-circle"></i> As areas aparecerão automaticamente no horario de inicio e desaparecerão no horario de fim.
                </p>
            </div>

            <!-- Progress -->
            <div id="kmlProgress" style="display: none; margin-top: 20px;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <i class="fas fa-spinner fa-spin" style="color: #4CAF50;"></i>
                    <span id="kmlProgressText" style="color: #fff;">Processando arquivo...</span>
                </div>
                <div style="height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden;">
                    <div id="kmlProgressBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #4CAF50, #00D4FF); transition: width 0.3s;"></div>
                </div>
            </div>
        </div>

        <div class="mosaic-modal-footer">
            <button class="cancel-btn" onclick="fecharModalImportarKML()">Cancelar</button>
            <button id="kmlImportBtn" class="start-btn" onclick="importarKML()" disabled style="background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);">
                <i class="fas fa-file-import"></i> Importar
            </button>
        </div>
    </div>
</div>

<style>
    /* Estilos para drop zone do KML */
    .kml-drop-zone {
        border: 2px dashed rgba(76, 175, 80, 0.5);
        border-radius: 12px;
        padding: 40px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: rgba(76, 175, 80, 0.05);
    }
    .kml-drop-zone:hover {
        border-color: #4CAF50;
        background: rgba(76, 175, 80, 0.1);
    }
    .kml-drop-zone.dragover {
        border-color: #4CAF50;
        background: rgba(76, 175, 80, 0.15);
        transform: scale(1.02);
    }
    .kml-drop-zone.has-file {
        border-style: solid;
        border-color: #00D4FF;
        background: rgba(0, 212, 255, 0.05);
    }
</style>

<!-- ============================================
     MODAL DE GERENCIAMENTO DE IMPORTAÇÕES KML
     ============================================ -->
<div class="mosaic-modal-overlay" id="modalGerenciarImportacoes" style="display: none;">
    <div class="mosaic-modal" style="max-width: 700px; max-height: 80vh;">
        <div class="mosaic-modal-header">
            <div class="modal-title-area">
                <i class="fas fa-folder-open" style="color: #9C27B0;"></i>
                <h2>Gerenciar Importacoes KML/KMZ</h2>
            </div>
            <button class="modal-close-btn" onclick="fecharModalGerenciarImportacoes()">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="mosaic-modal-body" style="overflow-y: auto; max-height: 50vh;">
            <!-- Loading -->
            <div id="importacoesLoading" style="text-align: center; padding: 40px;">
                <i class="fas fa-spinner fa-spin" style="font-size: 32px; color: #9C27B0;"></i>
                <p style="margin-top: 15px; color: #888;">Carregando importacoes...</p>
            </div>

            <!-- Lista de Importacoes -->
            <div id="importacoesLista" style="display: none;">
                <!-- Será preenchido via JavaScript -->
            </div>

            <!-- Vazio -->
            <div id="importacoesVazio" style="display: none; text-align: center; padding: 40px;">
                <i class="fas fa-inbox" style="font-size: 48px; color: #555; margin-bottom: 15px;"></i>
                <p style="color: #888;">Nenhum arquivo KML/KMZ importado ainda.</p>
                <button onclick="fecharModalGerenciarImportacoes(); abrirModalImportarKML();"
                        style="margin-top: 15px; padding: 10px 20px; background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%); border: none; border-radius: 6px; color: #fff; cursor: pointer;">
                    <i class="fas fa-file-import"></i> Importar Arquivo
                </button>
            </div>
        </div>

        <div class="mosaic-modal-footer">
            <button class="cancel-btn" onclick="fecharModalGerenciarImportacoes()">Fechar</button>
            <button class="start-btn" onclick="recarregarImportacoes()" style="background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);">
                <i class="fas fa-sync-alt"></i> Atualizar
            </button>
        </div>
    </div>
</div>

<style>
    /* Estilos para itens de importação */
    .importacao-item {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 12px;
        transition: all 0.3s ease;
    }
    .importacao-item:hover {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(156, 39, 176, 0.3);
    }
    .importacao-item.temporaria {
        border-left: 3px solid #FF9800;
    }
    .importacao-item.permanente {
        border-left: 3px solid #00D4FF;
    }
    .importacao-item.inativa {
        opacity: 0.5;
    }
    .importacao-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    .importacao-nome {
        font-weight: 600;
        color: #fff;
        font-size: 14px;
    }
    .importacao-badges {
        display: flex;
        gap: 6px;
    }
    .importacao-badge {
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 10px;
        font-weight: 600;
    }
    .badge-temporaria {
        background: rgba(255, 152, 0, 0.2);
        color: #FF9800;
    }
    .badge-permanente {
        background: rgba(0, 212, 255, 0.2);
        color: #00D4FF;
    }
    .badge-areas {
        background: rgba(156, 39, 176, 0.2);
        color: #9C27B0;
    }
    .importacao-info {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        font-size: 12px;
        color: #888;
        margin-bottom: 10px;
    }
    .importacao-info span {
        display: flex;
        align-items: center;
        gap: 5px;
    }
    .importacao-acoes {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
        padding-top: 10px;
        border-top: 1px solid rgba(255, 255, 255, 0.05);
    }
    .importacao-btn {
        padding: 6px 12px;
        border: none;
        border-radius: 4px;
        font-size: 11px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
        transition: all 0.2s ease;
    }
    .btn-editar {
        background: rgba(0, 212, 255, 0.2);
        color: #00D4FF;
    }
    .btn-editar:hover {
        background: rgba(0, 212, 255, 0.3);
    }
    .btn-toggle {
        background: rgba(255, 152, 0, 0.2);
        color: #FF9800;
    }
    .btn-toggle:hover {
        background: rgba(255, 152, 0, 0.3);
    }
    .btn-excluir {
        background: rgba(244, 67, 54, 0.2);
        color: #F44336;
    }
    .btn-excluir:hover {
        background: rgba(244, 67, 54, 0.3);
    }
</style>

<!-- ============================================
     MODAL DE ALERTA - OCORRÊNCIA EM ÁREA DE OBSERVAÇÃO
     ============================================ -->
<div class="area-alert-overlay" id="areaAlertOverlay">
    <div class="area-alert-modal" id="areaAlertModal">
        <div class="area-alert-header">
            <div class="alert-icon-pulse">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h3>ALERTA DE OCORRÊNCIA</h3>
            <span class="alert-badge">ÁREA MONITORADA</span>
        </div>

        <div class="area-alert-body">
            <div class="alert-info-section">
                <div class="alert-area-info">
                    <label><i class="fas fa-draw-polygon"></i> Área de Observação</label>
                    <span id="alertAreaNome">--</span>
                </div>
                <div class="alert-ocorrencia-info">
                    <label><i class="fas fa-exclamation-circle"></i> Ocorrência</label>
                    <span id="alertOcorrenciaTitulo">--</span>
                </div>
                <div class="alert-details-grid">
                    <div class="alert-detail">
                        <label>Categoria</label>
                        <span id="alertCategoria">--</span>
                    </div>
                    <div class="alert-detail">
                        <label>Prioridade</label>
                        <span id="alertPrioridade" class="priority-badge">--</span>
                    </div>
                    <div class="alert-detail">
                        <label>Endereço</label>
                        <span id="alertEndereco">--</span>
                    </div>
                    <div class="alert-detail">
                        <label>Data/Hora</label>
                        <span id="alertDataHora">--</span>
                    </div>
                </div>
            </div>

            <!-- Campo de Justificativa (inicialmente oculto) -->
            <div class="justificativa-section" id="justificativaSection" style="display: none;">
                <label for="justificativaTexto">
                    <i class="fas fa-comment-alt"></i> <span id="justificativaLabel">Justificativa</span>
                </label>
                <textarea id="justificativaTexto" placeholder="Digite a justificativa..." rows="3"></textarea>
                <div class="justificativa-actions">
                    <button class="btn-justificativa-cancelar" onclick="cancelarJustificativa()">
                        <i class="fas fa-times"></i> Voltar
                    </button>
                    <button class="btn-justificativa-enviar" onclick="enviarJustificativa()">
                        <i class="fas fa-check"></i> Enviar
                    </button>
                </div>
            </div>
        </div>

        <div class="area-alert-footer" id="alertFooterButtons">
            <button class="btn-alert btn-apurar" onclick="apurarAlerta()">
                <i class="fas fa-clock"></i> Apurar
                <span class="btn-hint">Volta em 5 min</span>
            </button>
            <button class="btn-alert btn-cancelar" onclick="cancelarAlerta()">
                <i class="fas fa-times-circle"></i> Cancelar
            </button>
            <button class="btn-alert btn-confirmar" onclick="confirmarAlerta()">
                <i class="fas fa-check-circle"></i> Confirmar
            </button>
        </div>

        <!-- Timer de Apuração -->
        <div class="apuracao-timer" id="apuracaoTimer" style="display: none;">
            <i class="fas fa-hourglass-half"></i>
            <span>Retornando em: <strong id="timerCountdown">5:00</strong></span>
        </div>
    </div>
</div>

<style>
/* ============================================
   ESTILOS DO MODAL DE ALERTA DE ÁREA
   ============================================ */
.area-alert-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.85);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    animation: fadeIn 0.3s ease;
}

.area-alert-overlay.show {
    display: flex;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.area-alert-modal {
    background: linear-gradient(145deg, #1a1a2e, #16213e);
    border-radius: 16px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 25px 80px rgba(255, 0, 85, 0.3), 0 0 0 1px rgba(255, 0, 85, 0.5);
    animation: slideUp 0.4s ease;
    overflow: hidden;
}

@keyframes slideUp {
    from { transform: translateY(30px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.area-alert-header {
    background: linear-gradient(135deg, #ff0055, #ff3366);
    padding: 20px;
    text-align: center;
    position: relative;
}

.alert-icon-pulse {
    width: 60px;
    height: 60px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 10px;
    animation: pulse-alert 1.5s infinite;
}

.alert-icon-pulse i {
    font-size: 28px;
    color: #fff;
}

@keyframes pulse-alert {
    0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.4); }
    50% { transform: scale(1.05); box-shadow: 0 0 0 15px rgba(255, 255, 255, 0); }
}

.area-alert-header h3 {
    color: #fff;
    margin: 0;
    font-family: 'Orbitron', monospace;
    font-size: 1.3rem;
    letter-spacing: 2px;
}

.alert-badge {
    display: inline-block;
    background: rgba(0, 0, 0, 0.3);
    color: #fff;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.7rem;
    margin-top: 8px;
    letter-spacing: 1px;
}

.area-alert-body {
    padding: 25px;
}

.alert-info-section {
    background: rgba(0, 0, 0, 0.3);
    border-radius: 12px;
    padding: 20px;
}

.alert-area-info, .alert-ocorrencia-info {
    margin-bottom: 15px;
    padding-bottom: 15px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.alert-area-info label, .alert-ocorrencia-info label {
    display: block;
    color: #888;
    font-size: 0.75rem;
    text-transform: uppercase;
    margin-bottom: 5px;
}

.alert-area-info label i, .alert-ocorrencia-info label i {
    color: #00d4ff;
    margin-right: 5px;
}

.alert-area-info span, .alert-ocorrencia-info span {
    display: block;
    color: #fff;
    font-size: 1.1rem;
    font-weight: 600;
}

.alert-details-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
}

.alert-detail label {
    display: block;
    color: #666;
    font-size: 0.7rem;
    text-transform: uppercase;
    margin-bottom: 3px;
}

.alert-detail span {
    color: #ccc;
    font-size: 0.9rem;
}

.priority-badge {
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 0.75rem !important;
    font-weight: 600;
}

.priority-badge.critica { background: #ff0055; color: #fff; }
.priority-badge.alta { background: #ff6b35; color: #fff; }
.priority-badge.media { background: #ffd93d; color: #000; }
.priority-badge.baixa { background: #00c853; color: #fff; }

/* Seção de Justificativa */
.justificativa-section {
    margin-top: 20px;
    padding: 20px;
    background: rgba(0, 212, 255, 0.1);
    border-radius: 12px;
    border: 1px solid rgba(0, 212, 255, 0.3);
}

.justificativa-section label {
    display: block;
    color: #00d4ff;
    font-size: 0.85rem;
    margin-bottom: 10px;
}

.justificativa-section textarea {
    width: 100%;
    background: rgba(0, 0, 0, 0.4);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    padding: 12px;
    color: #fff;
    font-size: 0.95rem;
    resize: none;
    font-family: inherit;
}

.justificativa-section textarea:focus {
    outline: none;
    border-color: #00d4ff;
}

.justificativa-actions {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}

.btn-justificativa-cancelar, .btn-justificativa-enviar {
    flex: 1;
    padding: 10px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all 0.2s;
}

.btn-justificativa-cancelar {
    background: #444;
    color: #fff;
}

.btn-justificativa-cancelar:hover {
    background: #555;
}

.btn-justificativa-enviar {
    background: #00d4ff;
    color: #000;
    font-weight: 600;
}

.btn-justificativa-enviar:hover {
    background: #00b8e6;
}

/* Footer com botões */
.area-alert-footer {
    padding: 20px;
    display: flex;
    gap: 10px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.btn-alert {
    flex: 1;
    padding: 14px 10px;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 600;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    transition: all 0.2s;
}

.btn-alert i {
    font-size: 1.2rem;
}

.btn-hint {
    font-size: 0.65rem;
    font-weight: 400;
    opacity: 0.7;
}

.btn-apurar {
    background: linear-gradient(135deg, #ff9800, #ff6f00);
    color: #fff;
}

.btn-apurar:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 20px rgba(255, 152, 0, 0.4);
}

.btn-cancelar {
    background: linear-gradient(135deg, #607d8b, #455a64);
    color: #fff;
}

.btn-cancelar:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 20px rgba(96, 125, 139, 0.4);
}

.btn-confirmar {
    background: linear-gradient(135deg, #00c853, #00a844);
    color: #fff;
}

.btn-confirmar:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 20px rgba(0, 200, 83, 0.4);
}

/* Timer de Apuração */
.apuracao-timer {
    text-align: center;
    padding: 15px;
    background: rgba(255, 152, 0, 0.2);
    color: #ff9800;
    font-size: 0.9rem;
}

.apuracao-timer i {
    margin-right: 8px;
    animation: spin 2s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.apuracao-timer strong {
    font-family: 'Orbitron', monospace;
    font-size: 1.1rem;
}
</style>

<script>
// ============================================
// SISTEMA DE ALERTA DE OCORRÊNCIAS EM ÁREAS
// ============================================

var alertaAtual = null;
var alertasApurados = {}; // { alertaId: timestampExpiracao }
var alertasProcessados = new Set(); // IDs de ocorrências já notificadas
var alertasConfirmados = new Set(); // IDs de ocorrências confirmadas (permanente)
var tipoAcaoAtual = null; // 'cancelar' ou 'confirmar'
var intervalVerificacao = null;

// Normalizar ID para string (remove hifens e converte para minúsculas)
function normalizarId(id) {
    if (!id) return '';
    return String(id).toLowerCase().replace(/-/g, '');
}

// Carregar alertas confirmados do SERVIDOR (persistência real)
async function carregarAlertasConfirmados() {
    console.log('[LOAD] ====================================');
    console.log('[LOAD] Iniciando carregamento de alertas...');
    console.log('[LOAD] URL: /integracity/api/alertas-confirmados/');

    try {
        // Buscar do servidor primeiro (fonte de verdade)
        var response = await fetch('/integracity/api/alertas-confirmados/', {
            method: 'GET',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            credentials: 'same-origin'
        });

        console.log('[LOAD] Response status:', response.status);
        console.log('[LOAD] Response URL:', response.url);

        // Verificar se foi redirecionado (login)
        if (response.url && response.url.includes('/login')) {
            console.error('[LOAD] ERRO: Foi redirecionado para login! Sessão expirada?');
            carregarDoLocalStorage();
            return;
        }

        // Verificar Content-Type
        var contentType = response.headers.get('content-type');
        console.log('[LOAD] Content-Type:', contentType);

        if (!contentType || !contentType.includes('application/json')) {
            console.error('[LOAD] ERRO: Resposta não é JSON! Tipo:', contentType);
            // Tentar ler como texto para debug
            var textResponse = await response.text();
            console.error('[LOAD] Conteúdo (primeiros 200 chars):', textResponse.substring(0, 200));
            carregarDoLocalStorage();
            return;
        }

        // Verificar se é 401 (não autenticado)
        if (response.status === 401) {
            console.error('[LOAD] ERRO 401: Usuário não autenticado!');
            carregarDoLocalStorage();
            return;
        }

        if (response.ok) {
            var data = await response.json();
            console.log('[LOAD] Dados recebidos:', JSON.stringify(data));
            console.log('[LOAD] Usuário logado:', data.usuario || 'não informado');

            if (data.success && data.alertas_confirmados) {
                console.log('[LOAD] ✓ Alertas do servidor:', data.alertas_confirmados.length);
                data.alertas_confirmados.forEach(function(id) {
                    var idNormalizado = normalizarId(id);
                    console.log('[LOAD] Adicionando ID:', id, '->', idNormalizado);
                    alertasConfirmados.add(idNormalizado);
                    alertasProcessados.add(idNormalizado);
                });
                console.log('[LOAD] ✓ Total no Set:', alertasConfirmados.size);
                console.log('[LOAD] ✓ IDs carregados:', Array.from(alertasConfirmados));

                // Salvar no localStorage como cache (backup)
                try {
                    localStorage.setItem('integracity_alertas_confirmados', JSON.stringify(data.alertas_confirmados));
                } catch (e) {}
            } else {
                console.warn('[LOAD] Resposta sem alertas ou success=false:', data);
            }
        } else {
            console.error('[LOAD] ERRO: Status não-OK:', response.status);
            carregarDoLocalStorage();
        }
    } catch (e) {
        console.error('[LOAD] ERRO de conexão:', e.message || e);
        carregarDoLocalStorage();
    }

    console.log('[LOAD] ==================================== FIM');
}

// Fallback: carregar do localStorage (para quando servidor estiver indisponível)
function carregarDoLocalStorage() {
    try {
        var salvos = localStorage.getItem('integracity_alertas_confirmados');
        if (salvos) {
            var lista = JSON.parse(salvos);
            console.log('[INIT] Carregando do localStorage (fallback):', lista.length);
            lista.forEach(function(id) {
                var idNormalizado = normalizarId(id);
                alertasConfirmados.add(idNormalizado);
                alertasProcessados.add(idNormalizado);
            });
        }
    } catch (e) {
        console.error('[INIT] Erro ao carregar do localStorage:', e);
    }
}

// Recarregar alertas do servidor (chamado antes de cada verificação)
async function recarregarAlertasDoServidor() {
    try {
        var response = await fetch('/integracity/api/alertas-confirmados/', {
            method: 'GET',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            credentials: 'same-origin'
        });

        // Verificar se foi redirecionado para login
        if (response.url && response.url.includes('/login')) {
            console.warn('[RELOAD] Sessão expirada, redirecionado para login');
            return;
        }

        // Verificar Content-Type
        var contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            console.warn('[RELOAD] Resposta não é JSON:', contentType);
            return;
        }

        if (response.ok) {
            var data = await response.json();
            if (data.success && data.alertas_confirmados) {
                var novosAdicionados = 0;
                data.alertas_confirmados.forEach(function(id) {
                    var idNormalizado = normalizarId(id);
                    if (!alertasConfirmados.has(idNormalizado)) {
                        alertasConfirmados.add(idNormalizado);
                        alertasProcessados.add(idNormalizado);
                        novosAdicionados++;
                    }
                });
                if (novosAdicionados > 0) {
                    console.log('[RELOAD] ✓ Novos alertas do servidor:', novosAdicionados);
                    console.log('[RELOAD] Total no Set:', alertasConfirmados.size);
                }
            }
        }
    } catch (e) {
        console.warn('[RELOAD] Erro:', e.message || e);
    }
}

// Salvar alertas confirmados no localStorage
function salvarAlertasConfirmados() {
    try {
        var lista = Array.from(alertasConfirmados);
        localStorage.setItem('integracity_alertas_confirmados', JSON.stringify(lista));
        console.log('Alertas confirmados salvos:', lista.length);
    } catch (e) {
        console.error('Erro ao salvar alertas confirmados:', e);
    }
}

// Verificar se alerta está confirmado
function alertaEstaConfirmado(id) {
    var idNormalizado = normalizarId(id);
    var resultado = alertasConfirmados.has(idNormalizado);
    console.log('[CHECK] Verificando ID:', id, '-> Normalizado:', idNormalizado, '-> Confirmado?', resultado);
    return resultado;
}

// Adicionar alerta confirmado (salva no SERVIDOR e localStorage)
async function adicionarAlertaConfirmado(id, areaId) {
    var idNormalizado = normalizarId(id);
    alertasConfirmados.add(idNormalizado);
    alertasProcessados.add(idNormalizado);

    console.log('[SAVE] ====================================');
    console.log('[SAVE] Salvando alerta no SERVIDOR:', idNormalizado);
    console.log('[SAVE] Area ID:', areaId);
    console.log('[SAVE] CSRF Token:', getCSRFToken() ? 'Presente' : 'AUSENTE!');

    // Salvar no servidor (persistência real)
    try {
        var payload = {
            alerta_id: idNormalizado,
            area_id: areaId || null,
            tipo: 'confirmado'
        };
        console.log('[SAVE] Payload:', JSON.stringify(payload));

        var response = await fetch('/integracity/api/alertas-confirmados/salvar/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            credentials: 'same-origin',
            body: JSON.stringify(payload)
        });

        console.log('[SAVE] Response status:', response.status);
        console.log('[SAVE] Response ok:', response.ok);

        var responseText = await response.text();
        console.log('[SAVE] Response body:', responseText);

        if (response.ok) {
            try {
                var data = JSON.parse(responseText);
                console.log('[SAVE] ✓ Salvo no servidor com sucesso!');
                showToast('Alerta salvo no servidor', 'success');
            } catch (e) {
                console.log('[SAVE] Resposta não é JSON:', responseText);
            }
        } else {
            console.error('[SAVE] ✗ Erro ao salvar no servidor:', response.status, responseText);
            showToast('Erro ao salvar no servidor: ' + response.status, 'error');
        }
    } catch (e) {
        console.error('[SAVE] ✗ Falha ao conectar com servidor:', e);
        showToast('Falha ao conectar com servidor', 'error');
    }

    // Também salvar no localStorage como backup
    salvarAlertasConfirmados();

    console.log('[SAVE] Total de alertas confirmados agora:', alertasConfirmados.size);
    console.log('[SAVE] ====================================');
}

// Função de debug (pode ser chamada do console: debugAlertas())
window.debugAlertas = function() {
    console.log('========== DEBUG ALERTAS ==========');
    console.log('localStorage disponível:', typeof localStorage !== 'undefined');
    console.log('Valor no localStorage:', localStorage.getItem('integracity_alertas_confirmados'));
    console.log('Set alertasConfirmados:', Array.from(alertasConfirmados));
    console.log('Set alertasProcessados:', Array.from(alertasProcessados));
    console.log('Tamanho do Set:', alertasConfirmados.size);
    console.log('CSRF Token:', getCSRFToken() ? 'Presente' : 'AUSENTE');
    console.log('===================================');
    return {
        localStorage: localStorage.getItem('integracity_alertas_confirmados'),
        confirmados: Array.from(alertasConfirmados),
        processados: Array.from(alertasProcessados),
        csrfToken: getCSRFToken() ? 'presente' : 'ausente'
    };
};

// Função para testar a API de salvar (pode ser chamada do console: testarSalvarAlerta())
window.testarSalvarAlerta = async function() {
    console.log('=== TESTANDO API DE SALVAR ===');
    var testId = 'teste_' + Date.now();

    try {
        var response = await fetch('/integracity/api/alertas-confirmados/salvar/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            credentials: 'same-origin',
            body: JSON.stringify({
                alerta_id: testId,
                tipo: 'confirmado'
            })
        });

        console.log('Status:', response.status);
        var text = await response.text();
        console.log('Resposta:', text);

        if (response.ok) {
            console.log('✓ API funcionando!');
            return { success: true, status: response.status, body: text };
        } else {
            console.error('✗ Erro na API');
            return { success: false, status: response.status, body: text };
        }
    } catch (e) {
        console.error('✗ Erro de conexão:', e);
        return { success: false, error: e.message };
    }
};

// Função para listar alertas do servidor (pode ser chamada do console: listarAlertasServidor())
window.listarAlertasServidor = async function() {
    console.log('=== BUSCANDO ALERTAS DO SERVIDOR ===');
    try {
        var response = await fetch('/integracity/api/alertas-confirmados/', {
            method: 'GET',
            credentials: 'same-origin'
        });
        console.log('Status:', response.status);
        var text = await response.text();
        console.log('Resposta:', text);
        return text;
    } catch (e) {
        console.error('Erro:', e);
        return null;
    }
};

// Função para testar se um ID específico está confirmado
window.verificarIdConfirmado = function(id) {
    var idNormalizado = normalizarId(id);
    var esta = alertasConfirmados.has(idNormalizado);
    console.log('ID original:', id);
    console.log('ID normalizado:', idNormalizado);
    console.log('Está confirmado:', esta);
    console.log('Todos confirmados:', Array.from(alertasConfirmados));
    return esta;
};

// Flag para indicar se alertas foram carregados
var alertasCarregados = false;

// Carregar ao iniciar (async - busca do servidor)
console.log('========================================');
console.log('INICIANDO SISTEMA DE ALERTAS (SERVIDOR)');
console.log('========================================');

// Verificar se ponto está dentro de polígono (Ray Casting Algorithm)
function pontoEmPoligono(lat, lng, poligono) {
    var x = lng, y = lat;
    var inside = false;

    for (var i = 0, j = poligono.length - 1; i < poligono.length; j = i++) {
        var xi = poligono[i][0], yi = poligono[i][1];
        var xj = poligono[j][0], yj = poligono[j][1];

        var intersect = ((yi > y) != (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
        if (intersect) inside = !inside;
    }

    return inside;
}

// Converter GeoJSON para array de coordenadas [lng, lat]
function geojsonParaCoords(geojson) {
    if (typeof geojson === 'string') {
        geojson = JSON.parse(geojson);
    }
    if (geojson.coordinates && geojson.coordinates[0]) {
        return geojson.coordinates[0];
    }
    return [];
}

// Verificar ocorrências dentro das áreas
async function verificarOcorrenciasEmAreas() {
    try {
        // SEMPRE recarregar do SERVIDOR antes de verificar (garante dados atualizados)
        await recarregarAlertasDoServidor();

        console.log('=== VERIFICANDO OCORRÊNCIAS EM ÁREAS ===');
        console.log('Total de alertas confirmados no Set:', alertasConfirmados.size);

        // Buscar áreas de observação
        var areasResponse = await fetch('/integracity/api/areas/listar/');
        if (!areasResponse.ok) return;
        var areasData = await areasResponse.json();
        var areas = areasData.areas || [];

        if (areas.length === 0) return;

        // Buscar ocorrências
        var ocorrenciasResponse = await fetch('/integracity/api/ocorrencias/mapa/');
        if (!ocorrenciasResponse.ok) return;
        var ocorrenciasData = await ocorrenciasResponse.json();
        var ocorrencias = ocorrenciasData.data || ocorrenciasData.ocorrencias || [];

        // Verificar cada ocorrência
        for (var o of ocorrencias) {
            var ocorrenciaId = o.id;
            var idNormalizado = normalizarId(ocorrenciaId);

            // Pular se foi confirmada/cancelada permanentemente
            if (alertaEstaConfirmado(ocorrenciaId)) {
                console.log('Ocorrência já confirmada (IGNORANDO):', idNormalizado, '- Título:', o.titulo);
                continue;
            }

            // Pular se já foi processada nesta sessão
            if (alertasProcessados.has(idNormalizado)) {
                console.log('Ocorrência já processada nesta sessão (ignorando):', idNormalizado);
                continue;
            }

            // Pular se está em período de apuração
            if (alertasApurados[idNormalizado] && Date.now() < alertasApurados[idNormalizado]) continue;

            var lat = o.latitude || o.lat;
            var lng = o.longitude || o.lng;

            if (!lat || !lng) continue;

            // Verificar em cada área
            for (var area of areas) {
                var coords = geojsonParaCoords(area.geojson);
                if (coords.length === 0) continue;

                if (pontoEmPoligono(lat, lng, coords)) {
                    // Ocorrência dentro da área!
                    mostrarAlertaOcorrencia(area, o);
                    return; // Mostra um alerta por vez
                }
            }
        }

    } catch (error) {
        console.error('Erro ao verificar ocorrências em áreas:', error);
    }
}

// Mostrar modal de alerta
function mostrarAlertaOcorrencia(area, ocorrencia) {
    alertaAtual = {
        area: area,
        ocorrencia: ocorrencia,
        id: ocorrencia.id
    };

    // Preencher dados
    document.getElementById('alertAreaNome').textContent = area.nome;
    document.getElementById('alertOcorrenciaTitulo').textContent = ocorrencia.titulo || ocorrencia.tipo || 'Nova Ocorrência';
    document.getElementById('alertCategoria').textContent = ocorrencia.categoria || '--';

    var prioridadeEl = document.getElementById('alertPrioridade');
    var prioridade = (ocorrencia.prioridade || 'media').toLowerCase();
    prioridadeEl.textContent = prioridade.charAt(0).toUpperCase() + prioridade.slice(1);
    prioridadeEl.className = 'priority-badge ' + prioridade;

    document.getElementById('alertEndereco').textContent = ocorrencia.endereco || ocorrencia.bairro || '--';
    document.getElementById('alertDataHora').textContent = ocorrencia.criado_em ?
        new Date(ocorrencia.criado_em).toLocaleString('pt-BR') : '--';

    // Resetar estado do modal
    document.getElementById('justificativaSection').style.display = 'none';
    document.getElementById('alertFooterButtons').style.display = 'flex';
    document.getElementById('apuracaoTimer').style.display = 'none';
    document.getElementById('justificativaTexto').value = '';

    // Mostrar modal
    document.getElementById('areaAlertOverlay').classList.add('show');

    // Tocar som de alerta (opcional)
    tocarSomAlerta();

    console.log('Alerta: Ocorrência "' + (ocorrencia.titulo || ocorrencia.id) + '" na área "' + area.nome + '"');
}

// Som de alerta
function tocarSomAlerta() {
    try {
        var audioContext = new (window.AudioContext || window.webkitAudioContext)();
        var oscillator = audioContext.createOscillator();
        var gainNode = audioContext.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        oscillator.frequency.value = 800;
        oscillator.type = 'sine';
        gainNode.gain.value = 0.3;

        oscillator.start();

        setTimeout(function() {
            oscillator.frequency.value = 600;
        }, 150);

        setTimeout(function() {
            oscillator.frequency.value = 800;
        }, 300);

        setTimeout(function() {
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
            setTimeout(function() { oscillator.stop(); }, 100);
        }, 450);

    } catch (e) {
        console.log('Som de alerta não disponível');
    }
}

// Fechar modal
function fecharAlertaModal() {
    document.getElementById('areaAlertOverlay').classList.remove('show');
}

// Botão APURAR - Oculta por 5 minutos
function apurarAlerta() {
    if (!alertaAtual) return;

    var ocorrenciaId = alertaAtual.id;
    var cincoMinutos = 5 * 60 * 1000; // 5 minutos em ms

    alertasApurados[ocorrenciaId] = Date.now() + cincoMinutos;

    // Mostrar timer
    document.getElementById('alertFooterButtons').style.display = 'none';
    document.getElementById('apuracaoTimer').style.display = 'block';

    // Iniciar countdown
    var tempoRestante = 300; // 5 minutos em segundos
    var timerEl = document.getElementById('timerCountdown');

    var countdownInterval = setInterval(function() {
        tempoRestante--;
        var minutos = Math.floor(tempoRestante / 60);
        var segundos = tempoRestante % 60;
        timerEl.textContent = minutos + ':' + (segundos < 10 ? '0' : '') + segundos;

        if (tempoRestante <= 0) {
            clearInterval(countdownInterval);
            // Remover da lista de apurados para reaparecer
            delete alertasApurados[ocorrenciaId];
        }
    }, 1000);

    showToast('Alerta em apuração. Retornará em 5 minutos.', 'warning');

    // Fechar modal após 2 segundos
    setTimeout(function() {
        fecharAlertaModal();
    }, 2000);
}

// Botão CANCELAR - Salva imediatamente e fecha
async function cancelarAlerta() {
    console.log('[CANCELAR] Botão cancelar clicado');

    if (!alertaAtual) {
        console.error('[CANCELAR] alertaAtual é null!');
        return;
    }

    var ocorrenciaId = alertaAtual.id;
    var areaId = alertaAtual.area ? alertaAtual.area.id : null;

    console.log('[CANCELAR] Salvando ocorrência:', ocorrenciaId);

    // Salvar imediatamente no servidor
    await adicionarAlertaConfirmado(ocorrenciaId, areaId);

    showToast('Alerta cancelado! Não aparecerá novamente.', 'info');
    fecharAlertaModal();
}

// Botão CONFIRMAR - Salva imediatamente e fecha
async function confirmarAlerta() {
    console.log('[CONFIRMAR] Botão confirmar clicado');

    if (!alertaAtual) {
        console.error('[CONFIRMAR] alertaAtual é null!');
        return;
    }

    var ocorrenciaId = alertaAtual.id;
    var areaId = alertaAtual.area ? alertaAtual.area.id : null;

    console.log('[CONFIRMAR] Salvando ocorrência:', ocorrenciaId);

    // Salvar imediatamente no servidor
    await adicionarAlertaConfirmado(ocorrenciaId, areaId);

    showToast('Ocorrência confirmada! Não aparecerá novamente.', 'success');
    fecharAlertaModal();
}

// Voltar da justificativa
function cancelarJustificativa() {
    document.getElementById('justificativaSection').style.display = 'none';
    document.getElementById('alertFooterButtons').style.display = 'flex';
    document.getElementById('justificativaTexto').value = '';
    tipoAcaoAtual = null;
}

// Enviar justificativa
async function enviarJustificativa() {
    var justificativa = document.getElementById('justificativaTexto').value.trim();

    if (!justificativa) {
        showToast('Por favor, preencha a justificativa', 'warning');
        return;
    }

    if (!alertaAtual) return;

    var ocorrenciaId = alertaAtual.id;
    var areaId = alertaAtual.area ? alertaAtual.area.id : null;
    var idNormalizado = normalizarId(ocorrenciaId);

    // Marcar como processado e confirmado permanentemente no SERVIDOR
    await adicionarAlertaConfirmado(ocorrenciaId, areaId);

    // Mensagem de feedback
    if (tipoAcaoAtual === 'confirmar') {
        showToast('Ocorrência confirmada! Alerta salvo no servidor.', 'success');
        console.log('Ocorrência confirmada e salva no servidor:', idNormalizado);
    } else {
        showToast('Alerta cancelado! Salvo no servidor.', 'info');
        console.log('Ocorrência cancelada e salva no servidor:', idNormalizado);
    }

    fecharAlertaModal();
}

// Iniciar monitoramento periódico (só após alertas carregados)
function iniciarMonitoramentoAreas() {
    if (!alertasCarregados) {
        console.log('[MONITOR] Aguardando alertas serem carregados...');
        setTimeout(iniciarMonitoramentoAreas, 1000);
        return;
    }

    console.log('=== INICIANDO MONITORAMENTO ===');
    console.log('Alertas confirmados carregados:', alertasConfirmados.size);
    console.log('IDs confirmados:', Array.from(alertasConfirmados));

    // Verificar imediatamente
    setTimeout(verificarOcorrenciasEmAreas, 2000);

    // Verificar a cada 30 segundos
    intervalVerificacao = setInterval(verificarOcorrenciasEmAreas, 30000);
}

// Inicialização principal - carrega alertas PRIMEIRO, depois inicia monitoramento
async function inicializarSistemaAlertas() {
    console.log('[INIT] Carregando alertas confirmados do servidor...');

    try {
        await carregarAlertasConfirmados();
        alertasCarregados = true;
        console.log('[INIT] ✓ Alertas carregados com sucesso:', alertasConfirmados.size);
        console.log('[INIT] IDs:', Array.from(alertasConfirmados));
    } catch (e) {
        console.error('[INIT] Erro ao carregar alertas:', e);
        alertasCarregados = true; // Continua mesmo com erro
    }

    // Agora inicia o monitoramento
    iniciarMonitoramentoAreas();
}

// Inicializar quando a página carregar
document.addEventListener('DOMContentLoaded', function() {
    // Aguardar um pouco para outras inicializações do mapa
    setTimeout(inicializarSistemaAlertas, 3000);

    // Inicializar drag and drop para KML
    inicializarKMLDropZone();
});

// ============================================
// FUNÇÕES DE IMPORTAÇÃO KML/KMZ
// ============================================

var kmlArquivoSelecionado = null;

function toggleAreasSubmenu(event) {
    if (event) event.stopPropagation();
    var submenu = document.getElementById('areasSubmenu');
    var parentItem = submenu ? submenu.closest('.layer-item-group') : null;
    var toggleIcon = parentItem ? parentItem.querySelector('.submenu-toggle i') : null;

    if (submenu) {
        submenu.classList.toggle('expanded');
        if (toggleIcon) {
            toggleIcon.classList.toggle('fa-chevron-down');
            toggleIcon.classList.toggle('fa-chevron-up');
        }
    }
}

function abrirModalImportarKML() {
    console.log('abrirModalImportarKML() chamada - versao 2025-12-30 19:30');
    var modal = document.getElementById('kmlImportModal');
    if (modal) {
        modal.style.display = 'flex';
        limparArquivoKML();
        // Verificar se campos novos existem
        var tipoArea = document.querySelector('input[name="kmlTipoArea"]');
        var gerenciarBtn = document.querySelector('[onclick*="abrirModalGerenciarImportacoes"]');
        console.log('Campo Tipo Area:', tipoArea ? 'EXISTE' : 'NAO EXISTE');
        console.log('Botao Gerenciar:', gerenciarBtn ? 'EXISTE' : 'NAO EXISTE');
        if (!tipoArea) {
            alert('ATENCAO: Template desatualizado! Pressione Ctrl+Shift+R para atualizar.');
        }
    }
}

function fecharModalImportarKML() {
    var modal = document.getElementById('kmlImportModal');
    if (modal) {
        modal.style.display = 'none';
        limparArquivoKML();
    }
}

function inicializarKMLDropZone() {
    var dropZone = document.getElementById('kmlDropZone');
    if (!dropZone) return;

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(function(eventName) {
        dropZone.addEventListener(eventName, function(e) {
            e.preventDefault();
            e.stopPropagation();
        });
    });

    ['dragenter', 'dragover'].forEach(function(eventName) {
        dropZone.addEventListener(eventName, function() {
            dropZone.classList.add('dragover');
        });
    });

    ['dragleave', 'drop'].forEach(function(eventName) {
        dropZone.addEventListener(eventName, function() {
            dropZone.classList.remove('dragover');
        });
    });

    dropZone.addEventListener('drop', function(e) {
        var files = e.dataTransfer.files;
        if (files.length > 0) {
            processarArquivoKML(files[0]);
        }
    });
}

function handleKMLFileSelect(input) {
    if (input.files && input.files[0]) {
        processarArquivoKML(input.files[0]);
    }
}

function processarArquivoKML(file) {
    var fileName = file.name.toLowerCase();
    if (!fileName.endsWith('.kml') && !fileName.endsWith('.kmz')) {
        showToast('Formato invalido. Use arquivos .kml ou .kmz', 'error');
        return;
    }

    kmlArquivoSelecionado = file;

    // Atualizar UI
    document.getElementById('kmlDropZone').classList.add('has-file');
    document.getElementById('kmlFileInfo').style.display = 'block';
    document.getElementById('kmlFileName').textContent = file.name;
    document.getElementById('kmlFileSize').textContent = formatarTamanhoArquivo(file.size);
    document.getElementById('kmlImportBtn').disabled = false;
}

function limparArquivoKML() {
    kmlArquivoSelecionado = null;
    var dropZone = document.getElementById('kmlDropZone');
    var fileInfo = document.getElementById('kmlFileInfo');
    var fileInput = document.getElementById('kmlFileInput');
    var importBtn = document.getElementById('kmlImportBtn');
    var progress = document.getElementById('kmlProgress');

    if (dropZone) dropZone.classList.remove('has-file');
    if (fileInfo) fileInfo.style.display = 'none';
    if (fileInput) fileInput.value = '';
    if (importBtn) importBtn.disabled = true;
    if (progress) progress.style.display = 'none';

    // Limpar campos
    var prefixo = document.getElementById('kmlPrefixo');
    if (prefixo) prefixo.value = '';

    // Resetar tipo e agendamento
    var radioPermanente = document.querySelector('input[name="kmlTipoArea"][value="permanente"]');
    if (radioPermanente) radioPermanente.checked = true;
    var agendamento = document.getElementById('kmlAgendamento');
    if (agendamento) agendamento.style.display = 'none';
    var eventoInicio = document.getElementById('kmlEventoInicio');
    var eventoFim = document.getElementById('kmlEventoFim');
    if (eventoInicio) eventoInicio.value = '';
    if (eventoFim) eventoFim.value = '';
}

function formatarTamanhoArquivo(bytes) {
    if (bytes === 0) return '0 Bytes';
    var k = 1024;
    var sizes = ['Bytes', 'KB', 'MB', 'GB'];
    var i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Toggle exibição do agendamento
function toggleAgendamentoKML() {
    var tipoArea = document.querySelector('input[name="kmlTipoArea"]:checked').value;
    var agendamentoDiv = document.getElementById('kmlAgendamento');

    if (tipoArea === 'temporaria') {
        agendamentoDiv.style.display = 'block';
        // Definir data/hora atual como default para inicio
        var agora = new Date();
        var agoraStr = agora.toISOString().slice(0, 16);
        document.getElementById('kmlEventoInicio').value = agoraStr;
    } else {
        agendamentoDiv.style.display = 'none';
    }
}

async function importarKML() {
    if (!kmlArquivoSelecionado) {
        showToast('Selecione um arquivo primeiro', 'error');
        return;
    }

    var prefixo = document.getElementById('kmlPrefixo').value.trim();
    var cor = document.getElementById('kmlCorPadrao').value;
    var progressDiv = document.getElementById('kmlProgress');
    var progressBar = document.getElementById('kmlProgressBar');
    var progressText = document.getElementById('kmlProgressText');
    var importBtn = document.getElementById('kmlImportBtn');

    // Capturar tipo e agendamento
    var tipoArea = document.querySelector('input[name="kmlTipoArea"]:checked').value;
    var temporaria = tipoArea === 'temporaria';
    var eventoInicio = document.getElementById('kmlEventoInicio').value;
    var eventoFim = document.getElementById('kmlEventoFim').value;

    // Mostrar progresso
    progressDiv.style.display = 'block';
    progressBar.style.width = '10%';
    progressText.textContent = 'Enviando arquivo...';
    importBtn.disabled = true;

    try {
        var formData = new FormData();
        formData.append('file', kmlArquivoSelecionado);
        if (prefixo) formData.append('prefixo', prefixo);
        formData.append('cor', cor);

        // Adicionar parâmetros de agendamento
        formData.append('temporaria', temporaria);
        if (temporaria && eventoInicio) {
            formData.append('evento_inicio', eventoInicio);
        }
        if (temporaria && eventoFim) {
            formData.append('evento_fim', eventoFim);
        }

        progressBar.style.width = '30%';
        progressText.textContent = 'Processando KML...';

        var response = await fetch('/integracity/api/areas/importar-kml/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: formData
        });

        progressBar.style.width = '70%';
        progressText.textContent = 'Criando areas...';

        var data = await response.json();

        progressBar.style.width = '100%';

        if (data.success) {
            var total = data.total || 0;
            progressText.textContent = total + ' area(s) importada(s)!';

            // Mostrar toast de sucesso
            showToast(total + ' area(s) de observacao importada(s) com sucesso!', 'success');

            // Recarregar areas no mapa
            if (typeof carregarAreasExistentes === 'function') {
                setTimeout(function() {
                    carregarAreasExistentes();
                }, 500);
            }

            // Fechar modal após um momento
            setTimeout(function() {
                fecharModalImportarKML();
            }, 1500);

            // Mostrar erros se houver
            if (data.erros && data.erros.length > 0) {
                console.warn('Erros durante importacao:', data.erros);
                showToast('Alguns elementos nao puderam ser importados. Verifique o console.', 'warning');
            }
        } else {
            throw new Error(data.error || 'Erro desconhecido');
        }

    } catch (error) {
        console.error('Erro ao importar KML:', error);
        progressDiv.style.display = 'none';
        importBtn.disabled = false;
        showToast('Erro ao importar: ' + error.message, 'error');
    }
}

// ============================================
// FUNÇÕES DE GERENCIAMENTO DE IMPORTAÇÕES
// ============================================

function abrirModalGerenciarImportacoes() {
    document.getElementById('modalGerenciarImportacoes').style.display = 'flex';
    carregarImportacoes();
}

function fecharModalGerenciarImportacoes() {
    document.getElementById('modalGerenciarImportacoes').style.display = 'none';
}

async function carregarImportacoes() {
    var loading = document.getElementById('importacoesLoading');
    var lista = document.getElementById('importacoesLista');
    var vazio = document.getElementById('importacoesVazio');

    loading.style.display = 'block';
    lista.style.display = 'none';
    vazio.style.display = 'none';

    try {
        var response = await fetch('/integracity/api/areas/importacoes/', {
            headers: { 'X-CSRFToken': getCookie('csrftoken') }
        });

        var data = await response.json();
        loading.style.display = 'none';

        if (data.success && data.importacoes && data.importacoes.length > 0) {
            renderizarImportacoes(data.importacoes);
            lista.style.display = 'block';
        } else {
            vazio.style.display = 'block';
        }
    } catch (error) {
        console.error('Erro ao carregar importacoes:', error);
        loading.style.display = 'none';
        vazio.style.display = 'block';
    }
}

function recarregarImportacoes() {
    carregarImportacoes();
}

function renderizarImportacoes(importacoes) {
    var container = document.getElementById('importacoesLista');
    container.innerHTML = '';

    importacoes.forEach(function(imp) {
        var tipoClass = imp.temporaria ? 'temporaria' : 'permanente';
        var tipoBadge = imp.temporaria
            ? '<span class="importacao-badge badge-temporaria"><i class="fas fa-hourglass-half"></i> Temporaria</span>'
            : '<span class="importacao-badge badge-permanente"><i class="fas fa-infinity"></i> Permanente</span>';

        var dataImport = imp.data_importacao ? new Date(imp.data_importacao).toLocaleString('pt-BR') : '-';
        var dataInicio = imp.evento_inicio ? new Date(imp.evento_inicio).toLocaleString('pt-BR') : '-';
        var dataFim = imp.evento_fim ? new Date(imp.evento_fim).toLocaleString('pt-BR') : '-';

        var html = '<div class="importacao-item ' + tipoClass + (imp.ativa ? '' : ' inativa') + '">';
        html += '<div class="importacao-header">';
        html += '<span class="importacao-nome"><i class="fas fa-file-code"></i> ' + (imp.arquivo || 'Arquivo desconhecido') + '</span>';
        html += '<div class="importacao-badges">';
        html += tipoBadge;
        html += '<span class="importacao-badge badge-areas">' + imp.total_areas + ' areas</span>';
        if (!imp.ativa) {
            html += '<span class="importacao-badge" style="background: rgba(244,67,54,0.2); color: #F44336;"><i class="fas fa-eye-slash"></i> Inativa</span>';
        }
        html += '</div></div>';

        html += '<div class="importacao-info">';
        html += '<span><i class="fas fa-calendar-plus"></i> Importado: ' + dataImport + '</span>';
        if (imp.temporaria) {
            html += '<span><i class="fas fa-play-circle"></i> Inicio: ' + dataInicio + '</span>';
            html += '<span><i class="fas fa-stop-circle"></i> Fim: ' + dataFim + '</span>';
        }
        html += '</div>';

        html += '<div class="importacao-acoes">';
        html += '<button class="importacao-btn btn-toggle" onclick="toggleGrupoAtivo(\'' + imp.grupo_id + '\', ' + imp.ativa + ')" title="' + (imp.ativa ? 'Desativar' : 'Ativar') + '">';
        html += '<i class="fas fa-' + (imp.ativa ? 'eye-slash' : 'eye') + '"></i> ' + (imp.ativa ? 'Desativar' : 'Ativar');
        html += '</button>';
        html += '<button class="importacao-btn btn-excluir" onclick="confirmarExcluirGrupo(\'' + imp.grupo_id + '\', \'' + (imp.arquivo || 'Arquivo') + '\', ' + imp.total_areas + ')" title="Excluir todas as areas">';
        html += '<i class="fas fa-trash"></i> Excluir';
        html += '</button>';
        html += '</div>';

        html += '</div>';

        container.innerHTML += html;
    });
}

async function toggleGrupoAtivo(grupoId, atualmenteAtivo) {
    try {
        // Buscar todas as áreas do grupo
        var response = await fetch('/integracity/api/areas/listar/', {
            headers: { 'X-CSRFToken': getCookie('csrftoken') }
        });
        var data = await response.json();

        if (data.success) {
            // Filtrar áreas deste grupo
            var areasDoGrupo = data.areas.filter(function(a) {
                return a.grupo_importacao === grupoId;
            });

            // Toggle cada área
            for (var area of areasDoGrupo) {
                await fetch('/integracity/api/areas/' + area.id + '/toggle-ativa/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({ ativa: !atualmenteAtivo })
                });
            }

            showToast('Areas ' + (atualmenteAtivo ? 'desativadas' : 'ativadas') + ' com sucesso!', 'success');

            // Recarregar lista
            carregarImportacoes();

            // Recarregar áreas no mapa
            if (typeof carregarAreasExistentes === 'function') {
                carregarAreasExistentes();
            }
        }
    } catch (error) {
        console.error('Erro ao alternar estado:', error);
        showToast('Erro ao alternar estado das areas', 'error');
    }
}

function confirmarExcluirGrupo(grupoId, nomeArquivo, totalAreas) {
    if (confirm('Tem certeza que deseja EXCLUIR permanentemente ' + totalAreas + ' areas do arquivo "' + nomeArquivo + '"?\n\nEsta acao nao pode ser desfeita!')) {
        excluirGrupo(grupoId);
    }
}

async function excluirGrupo(grupoId) {
    try {
        var response = await fetch('/integracity/api/areas/grupo/' + grupoId + '/excluir/', {
            method: 'POST',
            headers: { 'X-CSRFToken': getCookie('csrftoken') }
        });

        var data = await response.json();

        if (data.success) {
            showToast(data.mensagem || 'Areas excluidas com sucesso!', 'success');

            // Recarregar lista
            carregarImportacoes();

            // Recarregar áreas no mapa
            if (typeof carregarAreasExistentes === 'function') {
                carregarAreasExistentes();
            }
        } else {
            showToast(data.error || 'Erro ao excluir', 'error');
        }
    } catch (error) {
        console.error('Erro ao excluir grupo:', error);
        showToast('Erro ao excluir areas', 'error');
    }
}

// DEBUG: Versão do template - 2025-12-30 19:25 BRT
console.log('=== TEMPLATE ATUALIZADO: 2025-12-30 19:25 BRT ===');
console.log('Funcoes disponiveis: abrirModalImportarKML, toggleAgendamentoKML, abrirModalGerenciarImportacoes');

// Expor funções globalmente
window.abrirModalImportarKML = abrirModalImportarKML;
window.fecharModalImportarKML = fecharModalImportarKML;
window.handleKMLFileSelect = handleKMLFileSelect;
window.limparArquivoKML = limparArquivoKML;
window.importarKML = importarKML;
window.toggleAreasSubmenu = toggleAreasSubmenu;
window.toggleAgendamentoKML = toggleAgendamentoKML;
window.abrirModalGerenciarImportacoes = abrirModalGerenciarImportacoes;
window.fecharModalGerenciarImportacoes = fecharModalGerenciarImportacoes;
window.carregarImportacoes = carregarImportacoes;
window.recarregarImportacoes = recarregarImportacoes;
window.toggleGrupoAtivo = toggleGrupoAtivo;
window.confirmarExcluirGrupo = confirmarExcluirGrupo;
window.excluirGrupo = excluirGrupo;

</script>

{% endblock %}
