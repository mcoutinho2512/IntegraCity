{% extends 'base_hightech.html' %}
{% load static %}

{% block title %}SISCOR - Command Center Dashboard{% endblock %}

{% block monitoring_cards %}
<!-- ============================================
     CARDS COMPACTOS RETRÁTEIS
     ============================================ -->

<!-- Card 1: Estágio Operacional -->
<div class="compact-card" onclick="toggleCard(this)">
    <div class="card-header">
        <div class="card-header-left">
            <div class="card-icon {% if estagio <= 1 %}green{% elif estagio <= 3 %}orange{% else %}red{% endif %}">
                <i class="fas fa-shield-alt"></i>
            </div>
            <div class="card-main-info">
                <div class="card-value {% if estagio <= 1 %}green{% elif estagio <= 3 %}orange{% else %}red{% endif %}">
                    E{{ estagio|default:"1" }}
                </div>
                <div class="card-label">Estagio<br>Operacional</div>
            </div>
        </div>
        <div class="card-header-right">
            <div class="status-badge {% if estagio <= 1 %}normal{% elif estagio <= 3 %}warning{% else %}critical{% endif %}">
                <div class="status-dot"></div>
                {% if estagio <= 1 %}NORMAL{% elif estagio <= 3 %}ATENCAO{% else %}CRITICO{% endif %}
            </div>
            <i class="fas fa-chevron-down expand-icon"></i>
        </div>
    </div>
    <div class="card-body">
        <div class="card-content">
            <div class="card-detail-row">
                <span class="detail-label">Nivel</span>
                <span class="detail-value">{{ estagio|default:"1" }} - {{ estagio_label|default:"Normalidade" }}</span>
            </div>
            <div class="card-detail-row">
                <span class="detail-label">Regiao</span>
                <span class="detail-value">Toda a cidade</span>
            </div>
            <div class="live-indicator">
                <div class="live-dot"></div>
                Dados em tempo real
            </div>
        </div>
    </div>
</div>

<!-- Card 2: Ocorrências -->
<div class="compact-card" onclick="toggleCard(this)">
    <div class="card-header">
        <div class="card-header-left">
            <div class="card-icon {% if ocorrencias_count > 50 %}red{% elif ocorrencias_count > 20 %}orange{% else %}green{% endif %}">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="card-main-info">
                <div class="card-value {% if ocorrencias_count > 50 %}red{% elif ocorrencias_count > 20 %}orange{% else %}green{% endif %}">
                    {{ ocorrencias_count|default:"0" }}
                </div>
                <div class="card-label">Ocorrencias<br>Abertas</div>
            </div>
        </div>
        <div class="card-header-right">
            <div class="status-badge {% if ocorrencias_count > 50 %}critical{% elif ocorrencias_count > 20 %}warning{% else %}normal{% endif %}">
                <div class="status-dot"></div>
                {% if ocorrencias_count > 50 %}CRITICO{% elif ocorrencias_count > 20 %}ATENCAO{% else %}NORMAL{% endif %}
            </div>
            <i class="fas fa-chevron-down expand-icon"></i>
        </div>
    </div>
    <div class="card-body">
        <div class="card-content">
            <div class="card-detail-row">
                <span class="detail-label">Criticas (hoje)</span>
                <span class="detail-value" style="color: var(--red-alert);">{{ ocorrencias_criticas|default:"0" }}</span>
            </div>
            <div class="card-detail-row">
                <span class="detail-label">Em andamento</span>
                <span class="detail-value" style="color: var(--orange-tech);">{{ ocorrencias_count|default:"0" }}</span>
            </div>
            <div class="card-detail-row">
                <span class="detail-label">Hoje</span>
                <span class="detail-value">{{ ocorrencias_hoje|default:"0" }}</span>
            </div>
            <div class="live-indicator">
                <div class="live-dot"></div>
                Atualizado em tempo real
            </div>
        </div>
    </div>
</div>

<!-- Card 3: Mobilidade -->
<div class="compact-card" onclick="toggleCard(this)">
    <div class="card-header">
        <div class="card-header-left">
            <div class="card-icon green">
                <i class="fas fa-car"></i>
            </div>
            <div class="card-main-info">
                <div class="card-value green">{{ mobilidade_nivel|default:"N1" }}</div>
                <div class="card-label">Mobilidade<br>Urbana</div>
            </div>
        </div>
        <div class="card-header-right">
            <div class="status-badge normal">
                <div class="status-dot"></div>
                {{ mobilidade_status|default:"NORMAL" }}
            </div>
            <i class="fas fa-chevron-down expand-icon"></i>
        </div>
    </div>
    <div class="card-body">
        <div class="card-content">
            <div class="card-detail-row">
                <span class="detail-label">Alertas Waze</span>
                <span class="detail-value">{{ waze_alerts|default:"0" }}</span>
            </div>
            <div class="card-detail-row">
                <span class="detail-label">Vias impactadas</span>
                <span class="detail-value">{{ vias_impactadas|default:"0" }}</span>
            </div>
            <div class="card-detail-row">
                <span class="detail-label">Status</span>
                <span class="detail-value">{{ mobilidade_desc|default:"Transito Normal" }}</span>
            </div>
            <div class="live-indicator">
                <div class="live-dot"></div>
                Dados Waze em tempo real
            </div>
        </div>
    </div>
</div>

<!-- Card 4: Meteorologia -->
<div class="compact-card" onclick="toggleCard(this)">
    <div class="card-header">
        <div class="card-header-left">
            <div class="card-icon cyan">
                <i class="fas fa-cloud-sun"></i>
            </div>
            <div class="card-main-info">
                <div class="card-value cyan">{{ meteo_nivel|default:"N0" }}</div>
                <div class="card-label">Meteorologia</div>
            </div>
        </div>
        <div class="card-header-right">
            <div class="status-badge stable">
                <div class="status-dot"></div>
                {{ meteo_status|default:"ESTAVEL" }}
            </div>
            <i class="fas fa-chevron-down expand-icon"></i>
        </div>
    </div>
    <div class="card-body">
        <div class="card-content">
            <div class="card-detail-row">
                <span class="detail-label">Temperatura</span>
                <span class="detail-value">{{ temperatura|default:"--" }}C</span>
            </div>
            <div class="card-detail-row">
                <span class="detail-label">Umidade</span>
                <span class="detail-value">{{ umidade|default:"--" }}%</span>
            </div>
            <div class="card-detail-row">
                <span class="detail-label">Precipitacao</span>
                <span class="detail-value">{{ precipitacao|default:"0" }} mm</span>
            </div>
            <div class="live-indicator">
                <div class="live-dot"></div>
                Dados meteorologicos
            </div>
        </div>
    </div>
</div>

<!-- Card 5: Índice de Calor -->
<div class="compact-card" onclick="toggleCard(this)">
    <div class="card-header">
        <div class="card-header-left">
            <div class="card-icon {% if calor_index > 2 %}orange{% else %}cyan{% endif %}">
                <i class="fas fa-temperature-high"></i>
            </div>
            <div class="card-main-info">
                <div class="card-value {% if calor_index > 2 %}orange{% else %}cyan{% endif %}">
                    IC{{ calor_index|default:"1" }}
                </div>
                <div class="card-label">Indice de<br>Calor</div>
            </div>
        </div>
        <div class="card-header-right">
            <div class="status-badge {% if calor_index > 2 %}warning{% else %}normal{% endif %}">
                <div class="status-dot"></div>
                {{ calor_status|default:"NORMAL" }}
            </div>
            <i class="fas fa-chevron-down expand-icon"></i>
        </div>
    </div>
    <div class="card-body">
        <div class="card-content">
            <div class="card-detail-row">
                <span class="detail-label">Status</span>
                <span class="detail-value">{{ calor_label|default:"Normal" }}</span>
            </div>
            <div class="card-detail-row">
                <span class="detail-label">Temperatura</span>
                <span class="detail-value">{{ temperatura|default:"--" }}C</span>
            </div>
            <div class="card-detail-row">
                <span class="detail-label">Umidade</span>
                <span class="detail-value">{{ umidade|default:"--" }}%</span>
            </div>
            <div class="live-indicator">
                <div class="live-dot"></div>
                Monitoramento ativo
            </div>
        </div>
    </div>
</div>

<!-- Card 6: Câmeras -->
<div class="compact-card" onclick="toggleCard(this)">
    <div class="card-header">
        <div class="card-header-left">
            <div class="card-icon purple">
                <i class="fas fa-video"></i>
            </div>
            <div class="card-main-info">
                <div class="card-value cyan">{{ cameras_online|default:"0" }}</div>
                <div class="card-label">Cameras<br>Ativas</div>
            </div>
        </div>
        <div class="card-header-right">
            <div class="status-badge normal">
                <div class="status-dot"></div>
                ONLINE
            </div>
            <i class="fas fa-chevron-down expand-icon"></i>
        </div>
    </div>
    <div class="card-body">
        <div class="card-content">
            <div class="card-detail-row">
                <span class="detail-label">Online</span>
                <span class="detail-value" style="color: var(--green-neon);">{{ cameras_online|default:"0" }}</span>
            </div>
            <div class="card-detail-row">
                <span class="detail-label">Offline</span>
                <span class="detail-value" style="color: var(--red-alert);">{{ cameras_offline|default:"0" }}</span>
            </div>
            <div class="card-detail-row">
                <span class="detail-label">Total</span>
                <span class="detail-value">{{ cameras_total|default:"0" }}</span>
            </div>
            <div class="live-indicator">
                <div class="live-dot"></div>
                Streaming ativo
            </div>
        </div>
    </div>
</div>

<!-- Card 7: Eventos -->
<div class="compact-card" onclick="toggleCard(this)">
    <div class="card-header">
        <div class="card-header-left">
            <div class="card-icon cyan">
                <i class="fas fa-calendar-alt"></i>
            </div>
            <div class="card-main-info">
                <div class="card-value cyan">{{ eventos_count|default:"0" }}</div>
                <div class="card-label">Eventos<br>Hoje</div>
            </div>
        </div>
        <div class="card-header-right">
            <div class="status-badge stable">
                <div class="status-dot"></div>
                HOJE
            </div>
            <i class="fas fa-chevron-down expand-icon"></i>
        </div>
    </div>
    <div class="card-body">
        <div class="card-content">
            <div class="card-detail-row">
                <span class="detail-label">Grande porte</span>
                <span class="detail-value">{{ eventos_grandes|default:"0" }}</span>
            </div>
            <div class="card-detail-row">
                <span class="detail-label">Esta semana</span>
                <span class="detail-value">{{ eventos_semana|default:"0" }}</span>
            </div>
            <div class="live-indicator">
                <div class="live-dot"></div>
                Agenda atualizada
            </div>
        </div>
    </div>
</div>

<!-- Card 8: Sirenes -->
<div class="compact-card" onclick="toggleCard(this)">
    <div class="card-header">
        <div class="card-header-left">
            <div class="card-icon {% if sirenes_acionadas > 0 %}red{% else %}green{% endif %}">
                <i class="fas fa-bullhorn"></i>
            </div>
            <div class="card-main-info">
                <div class="card-value {% if sirenes_acionadas > 0 %}red{% else %}green{% endif %}">
                    {{ sirenes_acionadas|default:"0" }}
                </div>
                <div class="card-label">Sirenes<br>Acionadas</div>
            </div>
        </div>
        <div class="card-header-right">
            <div class="status-badge {% if sirenes_acionadas > 0 %}critical{% else %}normal{% endif %}">
                <div class="status-dot"></div>
                {% if sirenes_acionadas > 0 %}ACIONADAS{% else %}STAND-BY{% endif %}
            </div>
            <i class="fas fa-chevron-down expand-icon"></i>
        </div>
    </div>
    <div class="card-body">
        <div class="card-content">
            <div class="card-detail-row">
                <span class="detail-label">Total de sirenes</span>
                <span class="detail-value">{{ sirenes_total|default:"0" }}</span>
            </div>
            <div class="card-detail-row">
                <span class="detail-label">Operantes</span>
                <span class="detail-value" style="color: var(--green-neon);">{{ sirenes_operantes|default:"0" }}</span>
            </div>
            <div class="live-indicator">
                <div class="live-dot"></div>
                Sistema de alerta
            </div>
        </div>
    </div>
</div>

<!-- Card 9: CSI - Severidade de Impacto -->
<div class="compact-card" id="csiCard" onclick="toggleCard(this); loadCSIDetails();">
    <div class="card-header">
        <div class="card-header-left">
            <div class="card-icon orange">
                <i class="fas fa-chart-bar"></i>
            </div>
            <div class="card-main-info">
                <div class="card-value orange" id="csiTopBairro">--</div>
                <div class="card-label">CSI<br>Severidade</div>
            </div>
        </div>
        <div class="card-header-right">
            <div class="status-badge warning">
                <div class="status-dot"></div>
                CSI
            </div>
            <i class="fas fa-chevron-down expand-icon"></i>
        </div>
    </div>
    <div class="card-body">
        <div class="card-content">
            <div class="card-detail-row">
                <span class="detail-label">Pior Bairro</span>
                <span class="detail-value" id="csiPiorBairroDetail">--</span>
            </div>
            <div class="card-detail-row">
                <span class="detail-label">Pior Zona</span>
                <span class="detail-value" id="csiPiorZona">--</span>
            </div>
            <div class="card-detail-row">
                <span class="detail-label">Severidade</span>
                <span class="detail-value" id="csiTopValor">--</span>
            </div>
            <div class="live-indicator">
                <div class="live-dot"></div>
                <span id="csiCacheStatus">Carregando...</span>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block content %}
<div class="map-container" id="mapContainer">
    <!-- ============================================
         FLOATING INFO (TOP LEFT)
         ============================================ -->
    <div class="floating-info">
        <div class="info-card">
            <div class="info-card-title">Temperatura</div>
            <div class="info-card-value">{{ temperatura|default:"--" }}C</div>
        </div>
        <div class="info-card">
            <div class="info-card-title">Umidade</div>
            <div class="info-card-value">{{ umidade|default:"--" }}%</div>
        </div>
        <div class="info-card">
            <div class="info-card-title">Precipitacao</div>
            <div class="info-card-value">{{ precipitacao|default:"0" }}mm</div>
        </div>
    </div>

    <!-- ============================================
         MAPA LEAFLET
         ============================================ -->
    <div id="leafletMap" style="height: 100%; width: 100%;"></div>

    <!-- ============================================
         MAP CONTROLS (TOP RIGHT)
         ============================================ -->
    <div class="map-controls">
        <button class="map-control-btn" onclick="zoomIn()" title="Zoom In">
            <i class="fas fa-plus"></i>
        </button>
        <button class="map-control-btn" onclick="zoomOut()" title="Zoom Out">
            <i class="fas fa-minus"></i>
        </button>
        <button class="map-control-btn" onclick="resetView()" title="Resetar Visualizacao">
            <i class="fas fa-crosshairs"></i>
        </button>
        <button class="map-control-btn" onclick="locateUser()" title="Minha Localizacao">
            <i class="fas fa-location-arrow"></i>
        </button>
        <button class="map-control-btn" onclick="toggleFullscreen()" title="Tela Cheia">
            <i class="fas fa-expand"></i>
        </button>
        <button class="map-control-btn" id="layersToggleBtn" onclick="toggleLayersSidebar()" title="Camadas do Mapa">
            <i class="fas fa-layer-group"></i>
        </button>
    </div>

    <!-- ============================================
         LAYER SELECTOR (BOTTOM RIGHT)
         ============================================ -->
    <div class="layer-selector">
        <button class="layer-btn active" onclick="switchLayer(this, 'dark')">Dark</button>
        <button class="layer-btn" onclick="switchLayer(this, 'street')">Ruas</button>
        <button class="layer-btn" onclick="switchLayer(this, 'satellite')">Satelite</button>
        <button class="layer-btn" onclick="switchLayer(this, 'terrain')">Terreno</button>
    </div>

    <!-- ============================================
         SIDEBAR DIREITA - CAMADAS DO MAPA
         ============================================ -->
    <div class="layers-sidebar" id="layersSidebar">
        <div class="layers-content">
            <div class="layers-header">
                <i class="fas fa-layer-group"></i>
                <span>CAMADAS</span>
                <button class="layers-close" onclick="toggleLayersSidebar()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="layers-list">
                <!-- Escolas -->
                <div class="layer-item">
                    <label class="layer-checkbox">
                        <input type="checkbox" id="layerEscolas" onchange="toggleMapLayer('escolas')">
                        <span class="checkmark"></span>
                    </label>
                    <div class="layer-icon" style="background: rgba(76, 175, 80, 0.2); color: #4CAF50;">
                        <i class="fas fa-school"></i>
                    </div>
                    <div class="layer-info">
                        <span class="layer-name">Escolas</span>
                        <span class="layer-count" id="countEscolas">--</span>
                    </div>
                </div>

                <!-- Hospitais -->
                <div class="layer-item">
                    <label class="layer-checkbox">
                        <input type="checkbox" id="layerHospitais" onchange="toggleMapLayer('hospitais')">
                        <span class="checkmark"></span>
                    </label>
                    <div class="layer-icon" style="background: rgba(244, 67, 54, 0.2); color: #F44336;">
                        <i class="fas fa-hospital"></i>
                    </div>
                    <div class="layer-info">
                        <span class="layer-name">Hospitais</span>
                        <span class="layer-count" id="countHospitais">--</span>
                    </div>
                </div>

                <!-- Pluviometros -->
                <div class="layer-item">
                    <label class="layer-checkbox">
                        <input type="checkbox" id="layerPluviometros" onchange="toggleMapLayer('pluviometros')">
                        <span class="checkmark"></span>
                    </label>
                    <div class="layer-icon" style="background: rgba(33, 150, 243, 0.2); color: #2196F3;">
                        <i class="fas fa-cloud-rain"></i>
                    </div>
                    <div class="layer-info">
                        <span class="layer-name">Pluviometros</span>
                        <span class="layer-count" id="countPluviometros">--</span>
                    </div>
                </div>

                <!-- Sirenes -->
                <div class="layer-item">
                    <label class="layer-checkbox">
                        <input type="checkbox" id="layerSirenes" onchange="toggleMapLayer('sirenes')">
                        <span class="checkmark"></span>
                    </label>
                    <div class="layer-icon" style="background: rgba(255, 152, 0, 0.2); color: #FF9800;">
                        <i class="fas fa-bullhorn"></i>
                    </div>
                    <div class="layer-info">
                        <span class="layer-name">Sirenes</span>
                        <span class="layer-count" id="countSirenes">--</span>
                    </div>
                </div>

                <!-- Cameras -->
                <div class="layer-item">
                    <label class="layer-checkbox">
                        <input type="checkbox" id="layerCameras" onchange="toggleMapLayer('cameras')">
                        <span class="checkmark"></span>
                    </label>
                    <div class="layer-icon" style="background: rgba(156, 39, 176, 0.2); color: #9C27B0;">
                        <i class="fas fa-video"></i>
                    </div>
                    <div class="layer-info">
                        <span class="layer-name">Cameras</span>
                        <span class="layer-count" id="countCameras">--</span>
                    </div>
                </div>

                <!-- Metro -->
                <div class="layer-item">
                    <label class="layer-checkbox">
                        <input type="checkbox" id="layerMetro" onchange="toggleMapLayer('metro')">
                        <span class="checkmark"></span>
                    </label>
                    <div class="layer-icon" style="background: rgba(255, 87, 34, 0.2); color: #FF5722;">
                        <i class="fas fa-subway"></i>
                    </div>
                    <div class="layer-info">
                        <span class="layer-name">Metro</span>
                        <span class="layer-count" id="countMetro">--</span>
                    </div>
                </div>

                <!-- BRT -->
                <div class="layer-item">
                    <label class="layer-checkbox">
                        <input type="checkbox" id="layerBRT" onchange="toggleMapLayer('brt')">
                        <span class="checkmark"></span>
                    </label>
                    <div class="layer-icon" style="background: rgba(0, 150, 136, 0.2); color: #009688;">
                        <i class="fas fa-bus"></i>
                    </div>
                    <div class="layer-info">
                        <span class="layer-name">BRT</span>
                        <span class="layer-count" id="countBRT">--</span>
                    </div>
                </div>

                <!-- Ocorrencias -->
                <div class="layer-item">
                    <label class="layer-checkbox">
                        <input type="checkbox" id="layerOcorrencias" onchange="toggleMapLayer('ocorrencias')">
                        <span class="checkmark"></span>
                    </label>
                    <div class="layer-icon" style="background: rgba(255, 0, 85, 0.2); color: #ff0055;">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="layer-info">
                        <span class="layer-name">Ocorrencias</span>
                        <span class="layer-count" id="countOcorrencias">--</span>
                    </div>
                </div>

                <!-- Waze -->
                <div class="layer-item">
                    <label class="layer-checkbox">
                        <input type="checkbox" id="layerWaze" onchange="toggleMapLayer('waze')">
                        <span class="checkmark"></span>
                    </label>
                    <div class="layer-icon" style="background: rgba(0, 212, 255, 0.2); color: #00d4ff;">
                        <i class="fab fa-waze"></i>
                    </div>
                    <div class="layer-info">
                        <span class="layer-name">Waze</span>
                        <span class="layer-count" id="countWaze">--</span>
                    </div>
                </div>
            </div>

            <!-- Acoes rapidas -->
            <div class="layers-actions">
                <button class="layer-action-btn" onclick="selectAllLayers()">
                    <i class="fas fa-check-double"></i> Todos
                </button>
                <button class="layer-action-btn" onclick="clearAllLayers()">
                    <i class="fas fa-times"></i> Limpar
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // ============================================
    // INICIALIZACAO DO MAPA LEAFLET
    // ============================================

    // Centro do Município do Rio de Janeiro
    var map = L.map('leafletMap', {
        center: [-22.92, -43.45],
        zoom: 11,
        zoomControl: false,
        attributionControl: false
    });

    // Definir camadas de tiles
    var layers = {
        dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            maxZoom: 19
        }),
        street: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19
        }),
        satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 19
        }),
        terrain: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
            maxZoom: 17
        })
    };

    // Adicionar camada dark como padrao
    layers.dark.addTo(map);

    // ============================================
    // FUNCAO SWITCH LAYER (SOBRESCREVER)
    // ============================================
    function switchLayer(btn, layerName) {
        // Remover todas as camadas
        Object.values(layers).forEach(layer => {
            if (map.hasLayer(layer)) {
                map.removeLayer(layer);
            }
        });

        // Adicionar nova camada
        if (layers[layerName]) {
            layers[layerName].addTo(map);
        }

        // Atualizar botoes
        document.querySelectorAll('.layer-btn').forEach(b => {
            b.classList.remove('active');
        });
        if (btn) {
            btn.classList.add('active');
        }

        showToast('Camada: ' + layerName.toUpperCase(), 'success');
    }

    // ============================================
    // ZOOM CONTROLS
    // ============================================
    function zoomIn() {
        map.zoomIn();
    }

    function zoomOut() {
        map.zoomOut();
    }

    function resetView() {
        map.setView([-22.9068, -43.1729], 11);
        showToast('Visualizacao resetada', 'info');
    }

    // ============================================
    // MARCADORES DE OCORRENCIAS
    // ============================================
    {% if ocorrencias %}
    var ocorrenciasLayer = L.layerGroup().addTo(map);

    {% for oc in ocorrencias %}
    {% if oc.latitude and oc.longitude %}
    (function() {
        var marker = L.circleMarker([{{ oc.latitude }}, {{ oc.longitude }}], {
            radius: 8,
            fillColor: '{% if oc.prioridade == "CRITICA" %}#ff0055{% elif oc.prioridade == "ALTA" %}#ff6b35{% else %}#00d4ff{% endif %}',
            color: '#ffffff',
            weight: 2,
            opacity: 1,
            fillOpacity: 0.8
        });

        marker.bindPopup(`
            <div style="font-family: 'Rajdhani', sans-serif; min-width: 200px;">
                <h4 style="margin: 0 0 8px 0; color: #00d4ff; font-family: 'Orbitron', monospace;">{{ oc.tipo|default:"Ocorrencia" }}</h4>
                <p style="margin: 0 0 4px 0; font-size: 0.9rem;">{{ oc.descricao|truncatewords:15|default:"Sem descricao" }}</p>
                <small style="color: #666;">{{ oc.data_hora|date:"d/m/Y H:i"|default:"--" }}</small>
            </div>
        `);

        ocorrenciasLayer.addLayer(marker);
    })();
    {% endif %}
    {% endfor %}
    {% endif %}

    // ============================================
    // MARCADORES DE SIRENES
    // ============================================
    {% if sirenes %}
    var sirenesLayer = L.layerGroup().addTo(map);

    {% for sirene in sirenes %}
    {% if sirene.latitude and sirene.longitude %}
    (function() {
        var icon = L.divIcon({
            className: 'custom-marker',
            html: '<div style="background: {% if sirene.acionada %}#ff0055{% else %}#00ff88{% endif %}; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.3);"><i class="fas fa-bullhorn" style="color: white; font-size: 10px;"></i></div>',
            iconSize: [24, 24],
            iconAnchor: [12, 12]
        });

        var marker = L.marker([{{ sirene.latitude }}, {{ sirene.longitude }}], { icon: icon });

        marker.bindPopup(`
            <div style="font-family: 'Rajdhani', sans-serif;">
                <h4 style="margin: 0 0 8px 0; color: #00d4ff;">{{ sirene.nome|default:"Sirene" }}</h4>
                <p style="margin: 0;">{{ sirene.bairro|default:"--" }}</p>
            </div>
        `);

        sirenesLayer.addLayer(marker);
    })();
    {% endif %}
    {% endfor %}
    {% endif %}

    // ============================================
    // REFRESH DATA (API)
    // ============================================
    function refreshData() {
        showLoading('ATUALIZANDO DADOS...');

        fetch('/api/dashboard/status/')
            .then(response => response.json())
            .then(data => {
                // Atualizar valores no header
                if (data.ocorrencias_count !== undefined) {
                    document.getElementById('headerOcorrencias').textContent = data.ocorrencias_count;
                }
                if (data.eventos_count !== undefined) {
                    document.getElementById('headerEventos').textContent = data.eventos_count;
                }

                hideLoading();
                showToast('Dados atualizados com sucesso', 'success');
            })
            .catch(error => {
                hideLoading();
                showToast('Dados atualizados (offline)', 'warning');
                console.log('API indisponivel, usando cache');
            });
    }

    // ============================================
    // AUTO-REFRESH A CADA 5 MINUTOS
    // ============================================
    setInterval(function() {
        console.log('Auto-refresh...');
        // refreshData(); // Descomente para ativar auto-refresh
    }, 300000);

    // ============================================
    // CSI - SEVERIDADE DE IMPACTO
    // ============================================
    var csiData = null;

    function loadCSIData() {
        fetch('/api/csi/top5/')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    csiData = data.data;
                    updateCSICard(data.data);
                    console.log('CSI data loaded:', data.data);
                } else {
                    console.error('Erro ao carregar CSI:', data.error);
                    document.getElementById('csiTopBairro').textContent = 'Erro';
                    document.getElementById('csiTopValor').textContent = 'API indisponivel';
                }
            })
            .catch(error => {
                console.error('Erro ao carregar CSI:', error);
                document.getElementById('csiTopBairro').textContent = 'Offline';
                document.getElementById('csiTopValor').textContent = 'Sem conexao';
            });
    }

    function updateCSICard(data) {
        // Top 1 bairro por severidade (valor principal do card)
        if (data.bairros_severidade && data.bairros_severidade.length > 0) {
            var top1 = data.bairros_severidade[0];
            document.getElementById('csiTopBairro').textContent = top1.Bairro || '--';
            document.getElementById('csiTopValor').textContent = top1.Valor ? top1.Valor.toFixed(3) : '--';

            // Detalhes expandidos
            var piorBairroEl = document.getElementById('csiPiorBairroDetail');
            if (piorBairroEl) {
                piorBairroEl.textContent = top1.Bairro + ' (' + (top1.Valor ? top1.Valor.toFixed(3) : '--') + ')';
            }
        }

        // Pior zona
        if (data.zonas_severidade && data.zonas_severidade.length > 0) {
            var topZona = data.zonas_severidade[0];
            var piorZonaEl = document.getElementById('csiPiorZona');
            if (piorZonaEl) {
                piorZonaEl.textContent = topZona.Zona || '--';
            }
        }

        // Status do cache
        var cacheStatusEl = document.getElementById('csiCacheStatus');
        if (cacheStatusEl) {
            cacheStatusEl.textContent = 'Cache atualizado';
        }
    }

    function loadCSIDetails() {
        // Funcao chamada ao expandir o card CSI
        // Os dados ja estao carregados pelo loadCSIData
        if (!csiData) {
            loadCSIData();
        }
    }

    function showCSIDetails() {
        if (!csiData) {
            showToast('Dados CSI ainda carregando...', 'warning');
            return;
        }

        // Criar modal com lista dos top 5 bairros
        var modalHtml = `
            <div id="csiModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 9999; display: flex; align-items: center; justify-content: center;">
                <div style="background: linear-gradient(145deg, #0a0a0a, #1a1a2e); border: 1px solid rgba(0,212,255,0.3); border-radius: 12px; padding: 30px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid rgba(0,212,255,0.2); padding-bottom: 15px;">
                        <h3 style="color: #00d4ff; margin: 0; font-family: 'Orbitron', monospace; font-size: 1.2rem;">
                            <i class="fas fa-chart-bar"></i> CSI - Severidade de Impacto
                        </h3>
                        <button onclick="document.getElementById('csiModal').remove()" style="background: none; border: none; color: #ff0055; font-size: 1.5rem; cursor: pointer;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <h4 style="color: #ff6b35; margin: 20px 0 10px 0; font-size: 0.9rem;">TOP 5 BAIRROS - SEVERIDADE</h4>
                    <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 15px;">
                        ${csiData.bairros_severidade ? csiData.bairros_severidade.map((b, i) => `
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <span style="color: ${i === 0 ? '#ff0055' : '#ccc'};">
                                    <span style="color: #00d4ff; font-weight: bold;">${i + 1}.</span> ${b.Bairro}
                                </span>
                                <span style="color: ${i === 0 ? '#ff0055' : '#ff6b35'}; font-weight: bold;">${b.Valor ? b.Valor.toFixed(3) : '--'}</span>
                            </div>
                        `).join('') : '<div style="color: #666;">Sem dados</div>'}
                    </div>

                    <h4 style="color: #00ff88; margin: 20px 0 10px 0; font-size: 0.9rem;">TOP 5 ZONAS - SEVERIDADE</h4>
                    <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 15px;">
                        ${csiData.zonas_severidade ? csiData.zonas_severidade.map((z, i) => `
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <span style="color: ${i === 0 ? '#ff0055' : '#ccc'};">
                                    <span style="color: #00d4ff; font-weight: bold;">${i + 1}.</span> ${z.Zona}
                                </span>
                                <span style="color: ${i === 0 ? '#ff0055' : '#00ff88'}; font-weight: bold;">${z.Valor ? z.Valor.toFixed(3) : '--'}</span>
                            </div>
                        `).join('') : '<div style="color: #666;">Sem dados</div>'}
                    </div>

                    <h4 style="color: #9d4edd; margin: 20px 0 10px 0; font-size: 0.9rem;">TOP 5 BAIRROS - OCORRENCIAS</h4>
                    <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 15px;">
                        ${csiData.bairros_ocorrencia ? csiData.bairros_ocorrencia.map((b, i) => `
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <span style="color: #ccc;">
                                    <span style="color: #00d4ff; font-weight: bold;">${i + 1}.</span> ${b.Bairro}
                                </span>
                                <span style="color: #9d4edd; font-weight: bold;">${b.Valor || '--'}</span>
                            </div>
                        `).join('') : '<div style="color: #666;">Sem dados</div>'}
                    </div>
                </div>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHtml);
    }

    // Carregar dados CSI ao iniciar
    loadCSIData();

    // Atualizar CSI a cada 1 minuto
    setInterval(loadCSIData, 60000);

    // ============================================
    // SISTEMA DE CAMADAS DO MAPA
    // ============================================

    // Layer Groups para cada tipo de dado
    var mapLayers = {
        escolas: L.layerGroup(),
        hospitais: L.layerGroup(),
        pluviometros: L.layerGroup(),
        sirenes: L.layerGroup(),
        cameras: L.layerGroup(),
        metro: L.layerGroup(),
        brt: L.layerGroup(),
        ocorrencias: L.layerGroup(),
        waze: L.layerGroup()
    };

    // Cache dos dados carregados
    var layerDataCache = {
        escolas: null,
        hospitais: null,
        pluviometros: null,
        sirenes: null,
        cameras: null,
        metro: null,
        brt: null,
        ocorrencias: null,
        waze: null
    };

    // Icones customizados para cada tipo
    var layerIcons = {
        escolas: { icon: 'fa-school', color: '#4CAF50' },
        hospitais: { icon: 'fa-hospital', color: '#F44336' },
        pluviometros: { icon: 'fa-cloud-rain', color: '#2196F3' },
        sirenes: { icon: 'fa-bullhorn', color: '#FF9800' },
        cameras: { icon: 'fa-video', color: '#9C27B0' },
        metro: { icon: 'fa-subway', color: '#FF5722' },
        brt: { icon: 'fa-bus', color: '#009688' },
        ocorrencias: { icon: 'fa-exclamation-triangle', color: '#ff0055' },
        waze: { icon: 'fa-car', color: '#00d4ff' }
    };

    // Toggle da sidebar de camadas
    function toggleLayersSidebar() {
        var sidebar = document.getElementById('layersSidebar');
        var toggleBtn = document.getElementById('layersToggleBtn');
        if (sidebar) {
            sidebar.classList.toggle('expanded');
            if (toggleBtn) {
                toggleBtn.classList.toggle('active', sidebar.classList.contains('expanded'));
            }
        }
    }

    // Criar icone de marcador
    function createLayerIcon(type) {
        var config = layerIcons[type] || { icon: 'fa-map-marker', color: '#00d4ff' };
        return L.divIcon({
            className: 'custom-layer-marker',
            html: '<div style="background: ' + config.color + '; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.4);"><i class="fas ' + config.icon + '" style="color: white; font-size: 12px;"></i></div>',
            iconSize: [28, 28],
            iconAnchor: [14, 14],
            popupAnchor: [0, -14]
        });
    }

    // Toggle de camada individual
    function toggleMapLayer(layerName) {
        var checkbox = document.getElementById('layer' + layerName.charAt(0).toUpperCase() + layerName.slice(1));
        var isChecked = checkbox ? checkbox.checked : false;
        var layerItem = checkbox ? checkbox.closest('.layer-item') : null;

        if (isChecked) {
            // Adicionar camada ao mapa
            if (!map.hasLayer(mapLayers[layerName])) {
                mapLayers[layerName].addTo(map);
            }
            if (layerItem) layerItem.classList.add('active');

            // Carregar dados se ainda nao carregou
            if (!layerDataCache[layerName]) {
                loadLayerData(layerName);
            }

            showToast('Camada ' + layerName + ' ativada', 'success');
        } else {
            // Remover camada do mapa
            if (map.hasLayer(mapLayers[layerName])) {
                map.removeLayer(mapLayers[layerName]);
            }
            if (layerItem) layerItem.classList.remove('active');

            showToast('Camada ' + layerName + ' desativada', 'info');
        }
    }

    // Carregar dados de uma camada especifica
    function loadLayerData(layerName) {
        var apiUrls = {
            escolas: '/api/escolas/',
            hospitais: '/api/hospitais/',
            pluviometros: '/api/pluviometros/',
            sirenes: '/api/sirenes/',
            cameras: '/api/cameras/',
            metro: '/api/metro/',
            brt: '/api/brt/',
            ocorrencias: '/api/ocorrencias/hoje/',
            waze: '/api/waze/'
        };

        var url = apiUrls[layerName];
        if (!url) return;

        showToast('Carregando ' + layerName + '...', 'info');

        fetch(url)
            .then(response => response.json())
            .then(data => {
                layerDataCache[layerName] = data;
                renderLayerMarkers(layerName, data);
                updateLayerCount(layerName, data);
            })
            .catch(error => {
                console.error('Erro ao carregar ' + layerName + ':', error);
                showToast('Erro ao carregar ' + layerName, 'error');
            });
    }

    // Renderizar marcadores de uma camada
    function renderLayerMarkers(layerName, data) {
        // Limpar camada existente
        mapLayers[layerName].clearLayers();

        var items = [];

        // Normalizar dados conforme o tipo de API
        if (Array.isArray(data)) {
            items = data;
        } else if (data.features) {
            // GeoJSON format
            items = data.features.map(f => ({
                ...f.properties,
                latitude: f.geometry?.coordinates?.[1],
                longitude: f.geometry?.coordinates?.[0]
            }));
        } else if (data.data) {
            items = Array.isArray(data.data) ? data.data : [];
        } else if (data.results) {
            items = data.results;
        } else if (data.alerts) {
            items = data.alerts;
        } else if (data.escolas) {
            items = data.escolas;
        } else if (data.hospitais) {
            items = data.hospitais;
        } else if (data.sirenes) {
            items = data.sirenes;
        } else if (data.cameras) {
            items = data.cameras;
        } else if (data.estacoes) {
            items = data.estacoes;
        } else if (data.linhas) {
            items = data.linhas;
        } else if (data.ocorrencias) {
            items = data.ocorrencias;
        }

        items.forEach(function(item) {
            // Tentar diferentes campos de coordenadas
            var lat = item.latitude || item.lat || item.y || (item.location && item.location.lat);
            var lng = item.longitude || item.lng || item.lon || item.x || (item.location && item.location.lng);

            if (lat && lng) {
                var marker = L.marker([lat, lng], {
                    icon: createLayerIcon(layerName)
                });

                // Criar popup com informacoes
                var popupContent = createPopupContent(layerName, item);
                marker.bindPopup(popupContent);

                mapLayers[layerName].addLayer(marker);
            }
        });

        console.log('Camada ' + layerName + ': ' + mapLayers[layerName].getLayers().length + ' marcadores');
    }

    // Criar conteudo do popup
    function createPopupContent(layerName, item) {
        var config = layerIcons[layerName];
        var title = item.nome || item.name || item.titulo || item.title || item.tipo || item.type || layerName;
        var details = '';

        switch(layerName) {
            case 'escolas':
                details = '<p>' + (item.endereco || item.bairro || '--') + '</p>';
                break;
            case 'hospitais':
                details = '<p>' + (item.endereco || item.bairro || '--') + '</p>';
                if (item.telefone) details += '<p>Tel: ' + item.telefone + '</p>';
                break;
            case 'pluviometros':
                details = '<p>Bairro: ' + (item.bairro || '--') + '</p>';
                if (item.acumulado_15min !== undefined) details += '<p>15min: ' + item.acumulado_15min + 'mm</p>';
                if (item.acumulado_1h !== undefined) details += '<p>1h: ' + item.acumulado_1h + 'mm</p>';
                break;
            case 'sirenes':
                details = '<p>Bairro: ' + (item.bairro || '--') + '</p>';
                details += '<p>Status: ' + (item.acionada ? '<span style="color:#ff0055">ACIONADA</span>' : '<span style="color:#00ff88">Stand-by</span>') + '</p>';
                break;
            case 'cameras':
                details = '<p>' + (item.localizacao || item.bairro || '--') + '</p>';
                break;
            case 'metro':
                details = '<p>Linha: ' + (item.linha || '--') + '</p>';
                details += '<p>Status: ' + (item.status || 'Normal') + '</p>';
                break;
            case 'brt':
                details = '<p>Corredor: ' + (item.corredor || '--') + '</p>';
                details += '<p>Status: ' + (item.status || 'Normal') + '</p>';
                break;
            case 'ocorrencias':
                details = '<p>' + (item.descricao || item.tipo || '--') + '</p>';
                if (item.bairro) details += '<p>Bairro: ' + item.bairro + '</p>';
                if (item.data_hora) details += '<p>' + item.data_hora + '</p>';
                break;
            case 'waze':
                details = '<p>Tipo: ' + (item.type || item.subtype || '--') + '</p>';
                if (item.street) details += '<p>' + item.street + '</p>';
                break;
            default:
                details = '<p>' + (item.descricao || item.description || '--') + '</p>';
        }

        return '<div style="font-family: Rajdhani, sans-serif; min-width: 180px;">' +
            '<h4 style="margin: 0 0 8px 0; color: ' + config.color + '; font-family: Orbitron, monospace; font-size: 0.9rem;">' +
            '<i class="fas ' + config.icon + '"></i> ' + title.substring(0, 30) + '</h4>' +
            '<div style="font-size: 0.85rem; color: #ccc;">' + details + '</div>' +
            '</div>';
    }

    // Atualizar contador de itens da camada
    function updateLayerCount(layerName, data) {
        var countEl = document.getElementById('count' + layerName.charAt(0).toUpperCase() + layerName.slice(1));
        if (!countEl) return;

        var count = 0;
        if (Array.isArray(data)) {
            count = data.length;
        } else if (data.count !== undefined) {
            count = data.count;
        } else if (data.total !== undefined) {
            count = data.total;
        } else {
            // Tentar contar de diferentes estruturas
            var lists = ['data', 'results', 'features', 'alerts', 'escolas', 'hospitais',
                         'sirenes', 'cameras', 'estacoes', 'linhas', 'ocorrencias'];
            for (var i = 0; i < lists.length; i++) {
                if (data[lists[i]] && Array.isArray(data[lists[i]])) {
                    count = data[lists[i]].length;
                    break;
                }
            }
        }

        countEl.textContent = count;
    }

    // Selecionar todas as camadas
    function selectAllLayers() {
        var layerNames = Object.keys(mapLayers);
        layerNames.forEach(function(layerName) {
            var checkbox = document.getElementById('layer' + layerName.charAt(0).toUpperCase() + layerName.slice(1));
            if (checkbox && !checkbox.checked) {
                checkbox.checked = true;
                toggleMapLayer(layerName);
            }
        });
        showToast('Todas as camadas ativadas', 'success');
    }

    // Limpar todas as camadas
    function clearAllLayers() {
        var layerNames = Object.keys(mapLayers);
        layerNames.forEach(function(layerName) {
            var checkbox = document.getElementById('layer' + layerName.charAt(0).toUpperCase() + layerName.slice(1));
            if (checkbox && checkbox.checked) {
                checkbox.checked = false;
                toggleMapLayer(layerName);
            }
        });
        showToast('Todas as camadas desativadas', 'info');
    }

    // ============================================
    // INICIALIZACAO
    // ============================================
    console.log('SISCOR High-Tech Dashboard initialized');
    console.log('Mapa centrado no Rio de Janeiro');
    console.log('Sistema de camadas carregado');
</script>
{% endblock %}
