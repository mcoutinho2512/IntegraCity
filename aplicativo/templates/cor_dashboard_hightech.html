{% extends 'base_hightech.html' %}
{% load static %}

{% block title %}IntegraCity - Command Center Dashboard{% endblock %}

{% block monitoring_cards %}
<!-- ============================================
     CARDS COMPACTOS RETRÁTEIS
     ============================================ -->

<!-- Card 1: Estágio Operacional (Integrado com Matriz Decisória) -->
<div class="compact-card" onclick="toggleCard(this)">
    <div class="card-header">
        <div class="card-header-left">
            <div class="card-icon" style="background: {{ estagio_cor|default:'#00ff88' }}20; color: {{ estagio_cor|default:'#00ff88' }};">
                <i class="fas fa-shield-alt"></i>
            </div>
            <div class="card-main-info">
                <div class="card-value" style="color: {{ estagio_cor|default:'#00ff88' }};">
                    E{{ estagio|default:"1" }}
                </div>
                <div class="card-label">Estagio<br>Operacional</div>
            </div>
        </div>
        <div class="card-header-right">
            <div class="status-badge" style="background: {{ estagio_cor|default:'#00ff88' }}20; color: {{ estagio_cor|default:'#00ff88' }}; border-color: {{ estagio_cor|default:'#00ff88' }};">
                <div class="status-dot" style="background: {{ estagio_cor|default:'#00ff88' }};"></div>
                {{ estagio_status|default:"NORMAL" }}
            </div>
            <i class="fas fa-chevron-down expand-icon"></i>
        </div>
    </div>
    <div class="card-body">
        <div class="card-content">
            <div class="card-detail-row">
                <span class="detail-label">Nivel</span>
                <span class="detail-value" style="color: {{ estagio_cor|default:'#00ff88' }};">{{ estagio|default:"1" }} - {{ estagio_label|default:"Normal" }}</span>
            </div>
            <div class="card-detail-row">
                <span class="detail-label">Regiao</span>
                <span class="detail-value">Toda a cidade</span>
            </div>
            <div class="live-indicator">
                <div class="live-dot"></div>
                Matriz Decisoria
            </div>
        </div>
    </div>
</div>

<!-- Card 2: Mobilidade -->
<div class="compact-card" onclick="toggleCard(this)">
    <div class="card-header">
        <div class="card-header-left">
            <div class="card-icon green">
                <i class="fas fa-car"></i>
            </div>
            <div class="card-main-info">
                <div class="card-value green">{{ mobilidade_nivel|default:"N1" }}</div>
                <div class="card-label">Mobilidade<br>Urbana</div>
            </div>
        </div>
        <div class="card-header-right">
            <div class="status-badge normal">
                <div class="status-dot"></div>
                {{ mobilidade_status|default:"NORMAL" }}
            </div>
            <i class="fas fa-chevron-down expand-icon"></i>
        </div>
    </div>
    <div class="card-body">
        <div class="card-content">
            <div class="card-detail-row">
                <span class="detail-label">Alertas Waze</span>
                <span class="detail-value">{{ waze_alerts|default:"0" }}</span>
            </div>
            <div class="card-detail-row">
                <span class="detail-label">Vias impactadas</span>
                <span class="detail-value">{{ vias_impactadas|default:"0" }}</span>
            </div>
            <div class="card-detail-row">
                <span class="detail-label">Status</span>
                <span class="detail-value">{{ mobilidade_desc|default:"Transito Normal" }}</span>
            </div>
            <div class="live-indicator">
                <div class="live-dot"></div>
                Dados Waze em tempo real
            </div>
        </div>
    </div>
</div>

<!-- Card 4: Meteorologia -->
<div class="compact-card" onclick="toggleCard(this)">
    <div class="card-header">
        <div class="card-header-left">
            <div class="card-icon green">
                <i class="fas fa-cloud-sun"></i>
            </div>
            <div class="card-main-info">
                <div class="card-value green">E{{ meteo_nivel|default:"1" }}</div>
                <div class="card-label">Meteorologia</div>
            </div>
        </div>
        <div class="card-header-right">
            <div class="status-badge normal">
                <div class="status-dot"></div>
                {{ meteo_status|default:"NORMAL" }}
            </div>
            <i class="fas fa-chevron-down expand-icon"></i>
        </div>
    </div>
    <div class="card-body">
        <div class="card-content">
            <div class="card-detail-row">
                <span class="detail-label">Temperatura</span>
                <span class="detail-value">{{ temperatura|default:"--" }}C</span>
            </div>
            <div class="card-detail-row">
                <span class="detail-label">Umidade</span>
                <span class="detail-value">{{ umidade|default:"--" }}%</span>
            </div>
            <div class="card-detail-row">
                <span class="detail-label">Precipitacao</span>
                <span class="detail-value">{{ precipitacao|default:"0" }} mm</span>
            </div>
            <div class="live-indicator">
                <div class="live-dot"></div>
                Dados meteorologicos
            </div>
        </div>
    </div>
</div>

<!-- Card 5: Nível de Calor (NC1-NC5) -->
<div class="compact-card" onclick="toggleCard(this)">
    <div class="card-header">
        <div class="card-header-left">
            <div class="card-icon" style="background: {{ calor_cor|default:'#00ff88' }}20; color: {{ calor_cor|default:'#00ff88' }};">
                <i class="fas fa-temperature-high"></i>
            </div>
            <div class="card-main-info">
                <div class="card-value" style="color: {{ calor_cor|default:'#00ff88' }};">
                    NC{{ calor_nivel|default:"1" }}
                </div>
                <div class="card-label">Indice de<br>Calor</div>
            </div>
        </div>
        <div class="card-header-right">
            <div class="status-badge" style="background: {{ calor_cor|default:'#00ff88' }}20; color: {{ calor_cor|default:'#00ff88' }}; border-color: {{ calor_cor|default:'#00ff88' }};">
                <div class="status-dot" style="background: {{ calor_cor|default:'#00ff88' }};"></div>
                {{ calor_status|default:"NORMAL" }}
            </div>
            <i class="fas fa-chevron-down expand-icon"></i>
        </div>
    </div>
    <div class="card-body">
        <div class="card-content">
            <div class="card-detail-row">
                <span class="detail-label">Status</span>
                <span class="detail-value">{{ calor_label|default:"Normal" }}</span>
            </div>
            <div class="card-detail-row">
                <span class="detail-label">Heat Index</span>
                <span class="detail-value">{{ heat_index|default:"--" }}C</span>
            </div>
            <div class="card-detail-row">
                <span class="detail-label">Temperatura</span>
                <span class="detail-value">{{ temperatura|default:"--" }}C</span>
            </div>
            <div class="card-detail-row">
                <span class="detail-label">Umidade</span>
                <span class="detail-value">{{ umidade|default:"--" }}%</span>
            </div>
            <div class="live-indicator">
                <div class="live-dot"></div>
                Monitoramento ativo
            </div>
        </div>
    </div>
</div>

<!-- Card 6: Câmeras -->
<div class="compact-card" onclick="toggleCard(this)">
    <div class="card-header">
        <div class="card-header-left">
            <div class="card-icon green">
                <i class="fas fa-video"></i>
            </div>
            <div class="card-main-info">
                <div class="card-value green">{{ cameras_total|default:"0" }}</div>
                <div class="card-label">Cameras<br>Ativas</div>
            </div>
        </div>
        <div class="card-header-right">
            <div class="status-badge normal">
                <div class="status-dot"></div>
                ATIVAS
            </div>
            <i class="fas fa-chevron-down expand-icon"></i>
        </div>
    </div>
    <div class="card-body">
        <div class="card-content">
            <div class="card-detail-row">
                <span class="detail-label">Fixas</span>
                <span class="detail-value" style="color: var(--cyan);">{{ cameras_fixas|default:"0" }}</span>
            </div>
            <div class="card-detail-row">
                <span class="detail-label">Moveis</span>
                <span class="detail-value" style="color: var(--green-neon);">{{ cameras_moveis|default:"0" }}</span>
            </div>
            <div class="card-detail-row">
                <span class="detail-label">Total</span>
                <span class="detail-value" style="color: var(--purple-neon);">{{ cameras_total|default:"0" }}</span>
            </div>
            <div class="live-indicator">
                <div class="live-dot"></div>
                Fonte: TIXXI
            </div>
        </div>
    </div>
</div>

<!-- Card 7: Eventos -->
<div class="compact-card" onclick="toggleCard(this)">
    <div class="card-header">
        <div class="card-header-left">
            <div class="card-icon green">
                <i class="fas fa-calendar-alt"></i>
            </div>
            <div class="card-main-info">
                <div class="card-value green">{{ eventos_count|default:"0" }}</div>
                <div class="card-label">Eventos<br>Hoje</div>
            </div>
        </div>
        <div class="card-header-right">
            <div class="status-badge normal">
                <div class="status-dot"></div>
                HOJE
            </div>
            <i class="fas fa-chevron-down expand-icon"></i>
        </div>
    </div>
    <div class="card-body">
        <div class="card-content">
            <div class="card-detail-row">
                <span class="detail-label">Grande porte</span>
                <span class="detail-value">{{ eventos_grandes|default:"0" }}</span>
            </div>
            <div class="card-detail-row">
                <span class="detail-label">Esta semana</span>
                <span class="detail-value">{{ eventos_semana|default:"0" }}</span>
            </div>
            <div class="live-indicator">
                <div class="live-dot"></div>
                Agenda atualizada
            </div>
        </div>
    </div>
</div>

<!-- Card 8: Sirenes -->
<div class="compact-card" onclick="toggleCard(this)">
    <div class="card-header">
        <div class="card-header-left">
            <div class="card-icon {% if sirenes_acionadas > 0 %}red{% else %}green{% endif %}">
                <i class="fas fa-bullhorn"></i>
            </div>
            <div class="card-main-info">
                <div class="card-value {% if sirenes_acionadas > 0 %}red{% else %}green{% endif %}">
                    {{ sirenes_acionadas|default:"0" }}
                </div>
                <div class="card-label">Sirenes<br>Acionadas</div>
            </div>
        </div>
        <div class="card-header-right">
            <div class="status-badge {% if sirenes_acionadas > 0 %}critical{% else %}normal{% endif %}">
                <div class="status-dot"></div>
                {% if sirenes_acionadas > 0 %}ACIONADAS{% else %}STAND-BY{% endif %}
            </div>
            <i class="fas fa-chevron-down expand-icon"></i>
        </div>
    </div>
    <div class="card-body">
        <div class="card-content">
            <div class="card-detail-row">
                <span class="detail-label">Total de sirenes</span>
                <span class="detail-value">{{ sirenes_total|default:"0" }}</span>
            </div>
            <div class="card-detail-row">
                <span class="detail-label">Operantes</span>
                <span class="detail-value" style="color: var(--green-neon);">{{ sirenes_operantes|default:"0" }}</span>
            </div>
            <div class="live-indicator">
                <div class="live-dot"></div>
                Sistema de alerta
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block content %}
<div class="map-container" id="mapContainer">
    <!-- ============================================
         FLOATING INFO (TOP LEFT)
         ============================================ -->
    <div class="floating-info">
        <div class="info-card">
            <div class="info-card-title">Temperatura</div>
            <div class="info-card-value">{{ temperatura|default:"--" }}C</div>
        </div>
        <div class="info-card">
            <div class="info-card-title">Umidade</div>
            <div class="info-card-value">{{ umidade|default:"--" }}%</div>
        </div>
        <div class="info-card">
            <div class="info-card-title">Precipitacao</div>
            <div class="info-card-value">{{ precipitacao|default:"0" }}mm</div>
        </div>
    </div>

    <!-- ============================================
         MAPA LEAFLET
         ============================================ -->
    <div id="leafletMap" style="height: 100%; width: 100%;"></div>

    <!-- ============================================
         MAP CONTROLS (TOP RIGHT)
         ============================================ -->
    <div class="map-controls">
        <button class="map-control-btn" onclick="zoomIn()" title="Zoom In">
            <i class="fas fa-plus"></i>
        </button>
        <button class="map-control-btn" onclick="zoomOut()" title="Zoom Out">
            <i class="fas fa-minus"></i>
        </button>
        <button class="map-control-btn" onclick="resetView()" title="Resetar Visualizacao">
            <i class="fas fa-crosshairs"></i>
        </button>
        <button class="map-control-btn" onclick="locateUser()" title="Minha Localizacao">
            <i class="fas fa-location-arrow"></i>
        </button>
        <button class="map-control-btn" onclick="toggleFullscreen()" title="Tela Cheia">
            <i class="fas fa-expand"></i>
        </button>
        <button class="map-control-btn" id="layersToggleBtn" onclick="toggleLayersSidebar()" title="Camadas do Mapa">
            <i class="fas fa-layer-group"></i>
        </button>
        <button class="map-control-btn tour-btn" id="tourControlBtn" onclick="toggleTourOcorrencias()" title="Tour Automatico de Ocorrencias">
            <i class="fas fa-route" id="tourIcon"></i>
        </button>
        <button class="map-control-btn ocorrencias-btn" onclick="window.open('{% url 'ocorrencias_dashboard' %}', '_blank')" title="Gerenciar Ocorrencias">
            <i class="fas fa-clipboard-list"></i>
        </button>
        <button class="map-control-btn nova-ocorrencia-btn" onclick="window.open('{% url 'ocorrencia_criar' %}', '_blank')" title="Nova Ocorrencia">
            <i class="fas fa-plus-circle"></i>
        </button>
    </div>

    <!-- ============================================
         LAYER SELECTOR (BOTTOM RIGHT)
         ============================================ -->
    <div class="layer-selector">
        <button class="layer-btn active" onclick="switchLayer(this, 'dark')">Dark</button>
        <button class="layer-btn" onclick="switchLayer(this, 'street')">Ruas</button>
        <button class="layer-btn" onclick="switchLayer(this, 'satellite')">Satelite</button>
        <button class="layer-btn" onclick="switchLayer(this, 'terrain')">Terreno</button>
    </div>

    <!-- ============================================
         SIDEBAR DIREITA - CAMADAS DO MAPA
         ============================================ -->
    <div class="layers-sidebar" id="layersSidebar">
        <div class="layers-content">
            <div class="layers-header">
                <i class="fas fa-layer-group"></i>
                <span>CAMADAS</span>
                <button class="layers-close" onclick="toggleLayersSidebar()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="layers-list">
                <!-- Escolas -->
                <div class="layer-item" onclick="toggleLayerByClick('escolas', event)">
                    <label class="layer-checkbox" onclick="event.stopPropagation()">
                        <input type="checkbox" id="layerEscolas" onchange="toggleMapLayer('escolas')">
                        <span class="checkmark"></span>
                    </label>
                    <div class="layer-icon" style="background: rgba(76, 175, 80, 0.2); color: #4CAF50;">
                        <i class="fas fa-school"></i>
                    </div>
                    <div class="layer-info">
                        <span class="layer-name">Escolas</span>
                        <span class="layer-count" id="countEscolas">--</span>
                    </div>
                </div>
                <!-- Campo de busca de escolas -->
                <div class="escola-search-container" id="escolaSearchContainer" style="display: none;">
                    <div class="escola-search-wrapper">
                        <i class="fas fa-search escola-search-icon"></i>
                        <input type="text"
                               id="escolaSearchInput"
                               class="escola-search-input"
                               placeholder="Buscar escola por nome..."
                               autocomplete="off">
                        <button class="escola-search-clear" id="escolaSearchClear" style="display: none;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="escola-autocomplete-list" id="escolaAutocompleteList"></div>
                </div>

                <!-- Hospitais -->
                <div class="layer-item" onclick="toggleLayerByClick('hospitais', event)">
                    <label class="layer-checkbox" onclick="event.stopPropagation()">
                        <input type="checkbox" id="layerHospitais" onchange="toggleMapLayer('hospitais')">
                        <span class="checkmark"></span>
                    </label>
                    <div class="layer-icon" style="background: rgba(244, 67, 54, 0.2); color: #F44336;">
                        <i class="fas fa-hospital"></i>
                    </div>
                    <div class="layer-info">
                        <span class="layer-name">Hospitais</span>
                        <span class="layer-count" id="countHospitais">--</span>
                    </div>
                </div>

                <!-- Pluviometros -->
                <div class="layer-item" onclick="toggleLayerByClick('pluviometros', event)">
                    <label class="layer-checkbox" onclick="event.stopPropagation()">
                        <input type="checkbox" id="layerPluviometros" onchange="toggleMapLayer('pluviometros')">
                        <span class="checkmark"></span>
                    </label>
                    <div class="layer-icon" style="background: rgba(33, 150, 243, 0.2); color: #2196F3;">
                        <i class="fas fa-cloud-rain"></i>
                    </div>
                    <div class="layer-info">
                        <span class="layer-name">Pluviometros</span>
                        <span class="layer-count" id="countPluviometros">--</span>
                    </div>
                </div>

                <!-- Sirenes -->
                <div class="layer-item" onclick="toggleLayerByClick('sirenes', event)">
                    <label class="layer-checkbox" onclick="event.stopPropagation()">
                        <input type="checkbox" id="layerSirenes" onchange="toggleMapLayer('sirenes')">
                        <span class="checkmark"></span>
                    </label>
                    <div class="layer-icon" style="background: rgba(255, 152, 0, 0.2); color: #FF9800;">
                        <i class="fas fa-bullhorn"></i>
                    </div>
                    <div class="layer-info">
                        <span class="layer-name">Sirenes</span>
                        <span class="layer-count" id="countSirenes">--</span>
                    </div>
                </div>

                <!-- Cameras - Com Submenu -->
                <div class="layer-item-group">
                    <div class="layer-item has-submenu" onclick="toggleCameraSubmenu(event)">
                        <label class="layer-checkbox" onclick="event.stopPropagation()">
                            <input type="checkbox" id="layerCameras" onchange="toggleAllCameras()">
                            <span class="checkmark"></span>
                        </label>
                        <div class="layer-icon" style="background: rgba(156, 39, 176, 0.2); color: #9C27B0;">
                            <i class="fas fa-video"></i>
                        </div>
                        <div class="layer-info">
                            <span class="layer-name">Cameras</span>
                            <span class="layer-count" id="countCameras">--</span>
                        </div>
                        <div class="submenu-toggle">
                            <i class="fas fa-chevron-down"></i>
                        </div>
                    </div>

                    <!-- Submenu de Cameras -->
                    <div class="layer-submenu" id="cameraSubmenu">
                        <!-- Filtro Cameras Fixas -->
                        <div class="submenu-item" onclick="event.stopPropagation()">
                            <label class="submenu-checkbox">
                                <input type="checkbox" id="layerCamerasFixas" onchange="toggleCameraType('fixas')" checked>
                                <span class="submenu-checkmark"></span>
                            </label>
                            <div class="submenu-icon fixas">
                                <i class="fas fa-video"></i>
                            </div>
                            <span class="submenu-label">Fixas</span>
                            <span class="submenu-badge" id="countCamerasFixas">--</span>
                        </div>

                        <!-- Filtro Cameras Moveis -->
                        <div class="submenu-item" onclick="event.stopPropagation()">
                            <label class="submenu-checkbox">
                                <input type="checkbox" id="layerCamerasMoveis" onchange="toggleCameraType('moveis')" checked>
                                <span class="submenu-checkmark"></span>
                            </label>
                            <div class="submenu-icon moveis">
                                <i class="fas fa-video"></i>
                            </div>
                            <span class="submenu-label">Moveis</span>
                            <span class="submenu-badge" id="countCamerasMoveis">--</span>
                        </div>

                        <!-- Separador -->
                        <div class="submenu-divider"></div>

                        <!-- Botao Mosaico -->
                        <div class="submenu-item submenu-action" onclick="openMosaicModal()">
                            <div class="submenu-icon mosaico">
                                <i class="fas fa-th-large"></i>
                            </div>
                            <span class="submenu-label">Mosaico de Cameras</span>
                            <i class="fas fa-external-link-alt submenu-arrow-icon"></i>
                        </div>

                        <!-- Separador -->
                        <div class="submenu-divider"></div>

                        <!-- Campo de busca de câmeras -->
                        <div class="camera-search-container" id="cameraSearchContainer">
                            <div class="camera-search-wrapper">
                                <i class="fas fa-search camera-search-icon"></i>
                                <input type="text"
                                       id="cameraSearchInput"
                                       class="camera-search-input"
                                       placeholder="Buscar camera por nome..."
                                       autocomplete="off"
                                       onclick="event.stopPropagation()">
                                <button class="camera-search-clear" id="cameraSearchClear" style="display: none;" onclick="event.stopPropagation()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="camera-autocomplete-list" id="cameraAutocompleteList"></div>
                        </div>
                    </div>
                </div>

                <!-- Metro -->
                <div class="layer-item" onclick="toggleLayerByClick('metro', event)">
                    <label class="layer-checkbox" onclick="event.stopPropagation()">
                        <input type="checkbox" id="layerMetro" onchange="toggleMapLayer('metro')">
                        <span class="checkmark"></span>
                    </label>
                    <div class="layer-icon" style="background: rgba(255, 87, 34, 0.2); color: #FF5722;">
                        <i class="fas fa-subway"></i>
                    </div>
                    <div class="layer-info">
                        <span class="layer-name">Metro</span>
                        <span class="layer-count" id="countMetro">--</span>
                    </div>
                </div>

                <!-- BRT -->
                <div class="layer-item" onclick="toggleLayerByClick('brt', event)">
                    <label class="layer-checkbox" onclick="event.stopPropagation()">
                        <input type="checkbox" id="layerBRT" onchange="toggleMapLayer('brt')">
                        <span class="checkmark"></span>
                    </label>
                    <div class="layer-icon" style="background: rgba(0, 150, 136, 0.2); color: #009688;">
                        <i class="fas fa-bus"></i>
                    </div>
                    <div class="layer-info">
                        <span class="layer-name">BRT</span>
                        <span class="layer-count" id="countBRT">--</span>
                    </div>
                </div>

                <!-- Waze - Com Submenu de Filtros -->
                <div class="layer-item-group">
                    <div class="layer-item has-submenu" onclick="toggleWazeSubmenu(event)">
                        <label class="layer-checkbox" onclick="event.stopPropagation()">
                            <input type="checkbox" id="layerWaze" onchange="toggleAllWaze()">
                            <span class="checkmark"></span>
                        </label>
                        <div class="layer-icon" style="background: rgba(0, 212, 255, 0.2); color: #00d4ff;">
                            <i class="fab fa-waze"></i>
                        </div>
                        <div class="layer-info">
                            <span class="layer-name">Waze</span>
                            <span class="layer-count" id="countWaze">--</span>
                        </div>
                        <div class="submenu-toggle">
                            <i class="fas fa-chevron-down"></i>
                        </div>
                    </div>

                    <!-- Submenu Waze -->
                    <div class="layer-submenu" id="wazeSubmenu">
                        <!-- Congestionamentos -->
                        <div class="submenu-item" onclick="event.stopPropagation()">
                            <label class="submenu-checkbox">
                                <input type="checkbox" id="layerWazeCongestionamentos" onchange="toggleWazeFilter('congestionamentos')" checked>
                                <span class="submenu-checkmark"></span>
                            </label>
                            <div class="submenu-icon" style="background: rgba(255, 165, 0, 0.2); color: #ffa500; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-traffic-light" style="font-size: 12px;"></i>
                            </div>
                            <span class="submenu-label">Congestionamentos</span>
                            <span class="submenu-badge" id="countWazeCongestionamentos">--</span>
                        </div>

                        <!-- Vias Interditadas -->
                        <div class="submenu-item" onclick="event.stopPropagation()">
                            <label class="submenu-checkbox">
                                <input type="checkbox" id="layerWazeInterdicoes" onchange="toggleWazeFilter('interdicoes')" checked>
                                <span class="submenu-checkmark"></span>
                            </label>
                            <div class="submenu-icon" style="background: rgba(255, 0, 85, 0.2); color: #FF0055; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-ban" style="font-size: 12px;"></i>
                            </div>
                            <span class="submenu-label">Vias Interditadas</span>
                            <span class="submenu-badge" id="countWazeInterdicoes">--</span>
                        </div>

                        <!-- Eventos Especiais -->
                        <div class="submenu-item" onclick="event.stopPropagation()">
                            <label class="submenu-checkbox">
                                <input type="checkbox" id="layerWazeEventos" onchange="toggleWazeFilter('eventos')" checked>
                                <span class="submenu-checkmark"></span>
                            </label>
                            <div class="submenu-icon" style="background: rgba(156, 39, 176, 0.2); color: #9C27B0; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-calendar-alt" style="font-size: 12px;"></i>
                            </div>
                            <span class="submenu-label">Eventos</span>
                            <span class="submenu-badge" id="countWazeEventos">--</span>
                        </div>

                        <!-- Acidentes -->
                        <div class="submenu-item" onclick="event.stopPropagation()">
                            <label class="submenu-checkbox">
                                <input type="checkbox" id="layerWazeAcidentes" onchange="toggleWazeFilter('acidentes')" checked>
                                <span class="submenu-checkmark"></span>
                            </label>
                            <div class="submenu-icon" style="background: rgba(255, 0, 85, 0.2); color: #FF0055; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-car-crash" style="font-size: 12px;"></i>
                            </div>
                            <span class="submenu-label">Acidentes</span>
                            <span class="submenu-badge" id="countWazeAcidentes">--</span>
                        </div>

                        <!-- Buracos -->
                        <div class="submenu-item" onclick="event.stopPropagation()">
                            <label class="submenu-checkbox">
                                <input type="checkbox" id="layerWazeBuracos" onchange="toggleWazeFilter('buracos')" checked>
                                <span class="submenu-checkmark"></span>
                            </label>
                            <div class="submenu-icon" style="background: rgba(139, 69, 19, 0.2); color: #8B4513; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-road-circle-exclamation" style="font-size: 12px;"></i>
                            </div>
                            <span class="submenu-label">Buracos</span>
                            <span class="submenu-badge" id="countWazeBuracos">--</span>
                        </div>

                        <!-- Perigos na Via -->
                        <div class="submenu-item" onclick="event.stopPropagation()">
                            <label class="submenu-checkbox">
                                <input type="checkbox" id="layerWazePerigos" onchange="toggleWazeFilter('perigos')" checked>
                                <span class="submenu-checkmark"></span>
                            </label>
                            <div class="submenu-icon" style="background: rgba(255, 193, 7, 0.2); color: #FFC107; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-triangle-exclamation" style="font-size: 12px;"></i>
                            </div>
                            <span class="submenu-label">Perigos</span>
                            <span class="submenu-badge" id="countWazePerigos">--</span>
                        </div>

                        <!-- Carro Parado -->
                        <div class="submenu-item" onclick="event.stopPropagation()">
                            <label class="submenu-checkbox">
                                <input type="checkbox" id="layerWazeCarroParado" onchange="toggleWazeFilter('carroParado')" checked>
                                <span class="submenu-checkmark"></span>
                            </label>
                            <div class="submenu-icon" style="background: rgba(100, 100, 100, 0.2); color: #888; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-car-on" style="font-size: 12px;"></i>
                            </div>
                            <span class="submenu-label">Carro Parado</span>
                            <span class="submenu-badge" id="countWazeCarroParado">--</span>
                        </div>

                        <!-- Policia -->
                        <div class="submenu-item" onclick="event.stopPropagation()">
                            <label class="submenu-checkbox">
                                <input type="checkbox" id="layerWazePolicia" onchange="toggleWazeFilter('policia')" checked>
                                <span class="submenu-checkmark"></span>
                            </label>
                            <div class="submenu-icon" style="background: rgba(0, 123, 255, 0.2); color: #007bff; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-user-shield" style="font-size: 12px;"></i>
                            </div>
                            <span class="submenu-label">Policia</span>
                            <span class="submenu-badge" id="countWazePolicia">--</span>
                        </div>

                        <!-- Outros Alertas -->
                        <div class="submenu-item" onclick="event.stopPropagation()">
                            <label class="submenu-checkbox">
                                <input type="checkbox" id="layerWazeOutros" onchange="toggleWazeFilter('outros')" checked>
                                <span class="submenu-checkmark"></span>
                            </label>
                            <div class="submenu-icon" style="background: rgba(128, 128, 128, 0.2); color: #808080; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-circle-info" style="font-size: 12px;"></i>
                            </div>
                            <span class="submenu-label">Outros</span>
                            <span class="submenu-badge" id="countWazeOutros">--</span>
                        </div>
                    </div>
                </div>

                <!-- Bolsoes de Alagamento -->
                <div class="layer-item" onclick="toggleLayerByClick('bolsoes', event)">
                    <label class="layer-checkbox" onclick="event.stopPropagation()">
                        <input type="checkbox" id="layerBolsoes" onchange="toggleMapLayer('bolsoes')">
                        <span class="checkmark"></span>
                    </label>
                    <div class="layer-icon" style="background: rgba(6, 182, 212, 0.2); color: #06b6d4;">
                        <i class="fas fa-water"></i>
                    </div>
                    <div class="layer-info">
                        <span class="layer-name">Bolsoes</span>
                        <span class="layer-count" id="countBolsoes">--</span>
                    </div>
                </div>

                <!-- Ocorrencias -->
                <div class="layer-item" onclick="toggleLayerByClick('ocorrencias', event)">
                    <label class="layer-checkbox" onclick="event.stopPropagation()">
                        <input type="checkbox" id="layerOcorrencias" onchange="toggleMapLayer('ocorrencias')" checked>
                        <span class="checkmark"></span>
                    </label>
                    <div class="layer-icon" style="background: rgba(255, 0, 85, 0.2); color: #FF0055;">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="layer-info">
                        <span class="layer-name">Ocorrencias</span>
                        <span class="layer-count" id="countOcorrencias">--</span>
                    </div>
                </div>
            </div>

            <!-- Acoes rapidas -->
            <div class="layers-actions">
                <button class="layer-action-btn" onclick="selectAllLayers()">
                    <i class="fas fa-check-double"></i> Todos
                </button>
                <button class="layer-action-btn" onclick="clearAllLayers()">
                    <i class="fas fa-times"></i> Limpar
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // ============================================
    // INICIALIZACAO DO MAPA LEAFLET
    // ============================================

    // Centro do Município do Rio de Janeiro
    var map = L.map('leafletMap', {
        center: [-22.92, -43.45],
        zoom: 11,
        zoomControl: false,
        attributionControl: false
    });

    // Definir camadas de tiles
    var layers = {
        dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            maxZoom: 19
        }),
        street: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19
        }),
        satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 19
        }),
        terrain: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
            maxZoom: 17
        })
    };

    // Adicionar camada dark como padrao
    layers.dark.addTo(map);

    // ============================================
    // FUNCAO SWITCH LAYER (SOBRESCREVER)
    // ============================================
    function switchLayer(btn, layerName) {
        // Remover todas as camadas
        Object.values(layers).forEach(layer => {
            if (map.hasLayer(layer)) {
                map.removeLayer(layer);
            }
        });

        // Adicionar nova camada
        if (layers[layerName]) {
            layers[layerName].addTo(map);
        }

        // Atualizar botoes
        document.querySelectorAll('.layer-btn').forEach(b => {
            b.classList.remove('active');
        });
        if (btn) {
            btn.classList.add('active');
        }

        showToast('Camada: ' + layerName.toUpperCase(), 'success');
    }

    // ============================================
    // ZOOM CONTROLS
    // ============================================
    function zoomIn() {
        map.zoomIn();
    }

    function zoomOut() {
        map.zoomOut();
    }

    function resetView() {
        map.setView([-22.9068, -43.1729], 11);
        showToast('Visualizacao resetada', 'info');
    }

    // ============================================
    // MARCADORES DE SIRENES
    // ============================================
    {% if sirenes %}
    var sirenesLayer = L.layerGroup().addTo(map);

    {% for sirene in sirenes %}
    {% if sirene.latitude and sirene.longitude %}
    (function() {
        var icon = L.divIcon({
            className: 'custom-marker',
            html: '<div style="background: {% if sirene.acionada %}#ff0055{% else %}#00ff88{% endif %}; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.3);"><i class="fas fa-bullhorn" style="color: white; font-size: 10px;"></i></div>',
            iconSize: [24, 24],
            iconAnchor: [12, 12]
        });

        var marker = L.marker([{{ sirene.latitude }}, {{ sirene.longitude }}], { icon: icon });

        marker.bindPopup(`
            <div style="font-family: 'Rajdhani', sans-serif;">
                <h4 style="margin: 0 0 8px 0; color: #00d4ff;">{{ sirene.nome|default:"Sirene" }}</h4>
                <p style="margin: 0;">{{ sirene.bairro|default:"--" }}</p>
            </div>
        `);

        sirenesLayer.addLayer(marker);
    })();
    {% endif %}
    {% endfor %}
    {% endif %}

    // ============================================
    // REFRESH DATA (API)
    // ============================================
    function refreshData() {
        showLoading('ATUALIZANDO DADOS...');

        fetch('/integracity/api/dashboard/status/')
            .then(response => response.json())
            .then(data => {
                // Atualizar valores no header
                if (data.eventos_count !== undefined) {
                    document.getElementById('headerEventos').textContent = data.eventos_count;
                }

                hideLoading();
                showToast('Dados atualizados com sucesso', 'success');
            })
            .catch(error => {
                hideLoading();
                showToast('Dados atualizados (offline)', 'warning');
                console.log('API indisponivel, usando cache');
            });
    }

    // ============================================
    // AUTO-REFRESH A CADA 5 MINUTOS
    // ============================================
    setInterval(function() {
        console.log('Auto-refresh...');
        // refreshData(); // Descomente para ativar auto-refresh
    }, 300000);

    // ============================================
    // SISTEMA DE CAMADAS DO MAPA
    // ============================================

    // Layer Groups para cada tipo de dado
    var mapLayers = {
        escolas: L.layerGroup(),
        hospitais: L.layerGroup(),
        pluviometros: L.layerGroup(),
        sirenes: L.layerGroup(),
        cameras: L.layerGroup(),
        camerasFixas: L.layerGroup(),
        camerasMoveis: L.layerGroup(),
        metro: L.layerGroup(),
        brt: L.layerGroup(),
        waze: L.layerGroup(),
        wazeCongestionamentos: L.layerGroup(),
        wazeInterdicoes: L.layerGroup(),
        wazeEventos: L.layerGroup(),
        wazeAcidentes: L.layerGroup(),
        wazeBuracos: L.layerGroup(),
        wazePerigos: L.layerGroup(),
        wazeCarroParado: L.layerGroup(),
        wazePolicia: L.layerGroup(),
        wazeOutros: L.layerGroup(),
        bolsoes: L.layerGroup(),
        ocorrencias: L.layerGroup()
    };

    // Cache dos dados carregados
    var layerDataCache = {
        escolas: null,
        hospitais: null,
        pluviometros: null,
        sirenes: null,
        cameras: null,
        metro: null,
        brt: null,
        waze: null,
        bolsoes: null,
        ocorrencias: null
    };

    // Estado dos filtros de cameras
    var cameraFilters = {
        fixas: true,
        moveis: true
    };

    // Estado dos filtros de Waze
    var wazeFilters = {
        congestionamentos: true,
        interdicoes: true,
        eventos: true,
        acidentes: true,
        buracos: true,
        perigos: true,
        carroParado: true,
        policia: true,
        outros: true
    };

    // Icones customizados para cada tipo
    var layerIcons = {
        escolas: { icon: 'fa-school', color: '#4CAF50' },
        hospitais: { icon: 'fa-hospital', color: '#F44336' },
        pluviometros: { icon: 'fa-cloud-rain', color: '#2196F3' },
        sirenes: { icon: 'fa-bullhorn', color: '#FF9800' },
        cameras: { icon: 'fa-video', color: '#9C27B0' },
        camerasFixas: { icon: 'fa-video', color: '#2196F3' },     // Azul para fixas
        camerasMoveis: { icon: 'fa-video', color: '#4CAF50' },    // Verde para moveis
        metro: { icon: 'fa-subway', color: '#FF5722' },
        brt: { icon: 'fa-bus', color: '#009688' },
        waze: { icon: 'fa-car', color: '#00d4ff' },
        bolsoes: { icon: 'fa-water', color: '#06b6d4' },
        ocorrencias: { icon: 'fa-exclamation-triangle', color: '#FF0055' }
    };

    // Cores por prioridade de ocorrencia
    var coresPrioridade = {
        baixa: '#4CAF50',
        media: '#00D4FF',
        alta: '#FFB800',
        critica: '#FF0055'
    };

    // ============================================
    // SUBMENU DE CAMERAS
    // ============================================

    // Toggle do submenu de cameras
    function toggleCameraSubmenu(event) {
        if (event) event.stopPropagation();

        var layerItem = document.querySelector('.layer-item.has-submenu');
        var submenu = document.getElementById('cameraSubmenu');

        if (layerItem && submenu) {
            var isExpanding = !submenu.classList.contains('expanded');
            layerItem.classList.toggle('expanded');
            submenu.classList.toggle('expanded');

            // Se estiver abrindo o submenu e as cameras nao estao ativas, ativar
            if (isExpanding) {
                var mainCheckbox = document.getElementById('layerCameras');
                if (mainCheckbox && !mainCheckbox.checked) {
                    mainCheckbox.checked = true;
                    toggleAllCameras();
                }
            }
        }
    }

    // Toggle todas as cameras (checkbox principal)
    function toggleAllCameras() {
        var mainCheckbox = document.getElementById('layerCameras');
        var isChecked = mainCheckbox ? mainCheckbox.checked : false;
        var layerItem = mainCheckbox ? mainCheckbox.closest('.layer-item') : null;

        // Atualizar checkboxes filhos
        var fixasCheckbox = document.getElementById('layerCamerasFixas');
        var moveisCheckbox = document.getElementById('layerCamerasMoveis');

        if (fixasCheckbox) fixasCheckbox.checked = isChecked;
        if (moveisCheckbox) moveisCheckbox.checked = isChecked;

        cameraFilters.fixas = isChecked;
        cameraFilters.moveis = isChecked;

        if (isChecked) {
            if (layerItem) layerItem.classList.add('active');

            // Carregar dados se ainda nao carregou
            if (!layerDataCache.cameras) {
                loadLayerData('cameras');
            } else {
                renderCamerasByType();
            }

            // Adicionar camadas ao mapa
            mapLayers.camerasFixas.addTo(map);
            mapLayers.camerasMoveis.addTo(map);
        } else {
            if (layerItem) layerItem.classList.remove('active');
            map.removeLayer(mapLayers.camerasFixas);
            map.removeLayer(mapLayers.camerasMoveis);
        }
    }

    // Toggle tipo de camera (fixas ou moveis)
    function toggleCameraType(type) {
        var checkbox = document.getElementById('layerCameras' + type.charAt(0).toUpperCase() + type.slice(1));
        var isChecked = checkbox ? checkbox.checked : false;

        cameraFilters[type] = isChecked;

        // Atualizar checkbox principal baseado nos filhos
        var mainCheckbox = document.getElementById('layerCameras');
        if (mainCheckbox) {
            mainCheckbox.checked = cameraFilters.fixas || cameraFilters.moveis;
        }

        if (type === 'fixas') {
            if (isChecked) {
                mapLayers.camerasFixas.addTo(map);
            } else {
                map.removeLayer(mapLayers.camerasFixas);
            }
        } else if (type === 'moveis') {
            if (isChecked) {
                mapLayers.camerasMoveis.addTo(map);
            } else {
                map.removeLayer(mapLayers.camerasMoveis);
            }
        }

        // Se nao tem dados carregados, carregar
        if (!layerDataCache.cameras && isChecked) {
            loadLayerData('cameras');
        }
    }

    // Renderizar cameras por tipo (fixas/moveis)
    function renderCamerasByType() {
        // Limpar camadas existentes
        mapLayers.camerasFixas.clearLayers();
        mapLayers.camerasMoveis.clearLayers();
        mapLayers.cameras.clearLayers();

        var data = layerDataCache.cameras;
        if (!data) {
            console.log('Sem dados de câmeras no cache');
            return;
        }

        var items = [];

        // Normalizar dados - a API retorna em data.data
        if (Array.isArray(data)) {
            items = data;
        } else if (data.data && Array.isArray(data.data)) {
            items = data.data;
        } else if (data.cameras) {
            items = data.cameras;
        }

        console.log('Processando ' + items.length + ' cameras');

        var countFixas = 0;
        var countMoveis = 0;
        var countTotal = 0;

        items.forEach(function(item) {
            var lat = item.latitude || item.lat || item.y;
            var lng = item.longitude || item.lng || item.lon || item.x;

            // Determinar se a camera eh fixa ou movel
            // Verifica campos comuns da API: tipo, type, mobile, movel, fixa
            var isMovel = false;

            if (item.tipo) {
                isMovel = item.tipo.toLowerCase().includes('movel') ||
                          item.tipo.toLowerCase().includes('móvel') ||
                          item.tipo.toLowerCase().includes('mobile');
            }
            if (item.type) {
                isMovel = isMovel || item.type.toLowerCase().includes('mobile') ||
                          item.type.toLowerCase().includes('movel');
            }
            if (item.mobile !== undefined) {
                isMovel = item.mobile === true || item.mobile === 1 || item.mobile === '1';
            }
            if (item.movel !== undefined) {
                isMovel = item.movel === true || item.movel === 1 || item.movel === '1';
            }
            if (item.fixa !== undefined) {
                isMovel = !(item.fixa === true || item.fixa === 1 || item.fixa === '1');
            }

            countTotal++;
            if (isMovel) {
                countMoveis++;
            } else {
                countFixas++;
            }

            if (lat && lng) {

                var cameraType = isMovel ? 'camerasMoveis' : 'camerasFixas';
                var marker = L.marker([lat, lng], {
                    icon: createLayerIcon(cameraType)
                });

                // Abrir video direto no clique
                if (item.url_stream || item.url) {
                    marker.on('click', function() {
                        openCameraPlayer(item.url_stream || item.url, item.nome || 'Camera', item.id_c || item.id || '');
                    });
                }

                // Tooltip com indicacao do tipo
                var tooltipText = (item.nome || 'Camera') + ' (' + (isMovel ? 'Móvel' : 'Fixa') + ')';
                marker.bindTooltip(tooltipText, {
                    permanent: false,
                    direction: 'top',
                    className: 'camera-tooltip'
                });

                // Adicionar a camada apropriada
                if (isMovel) {
                    mapLayers.camerasMoveis.addLayer(marker);
                } else {
                    mapLayers.camerasFixas.addLayer(marker);
                }

                // Tambem adiciona na camada geral para compatibilidade
                mapLayers.cameras.addLayer(marker);
            }
        });

        // Atualizar contadores
        var totalRaw = data.total_raw || countTotal;
        if (data.total_raw_fixas !== undefined && data.total_raw_moveis !== undefined) {
            countFixas = data.total_raw_fixas;
            countMoveis = data.total_raw_moveis;
        }

        updateElement('countCameras', totalRaw);
        updateElement('countCamerasFixas', countFixas);
        updateElement('countCamerasMoveis', countMoveis);

        console.log('Cameras carregadas: ' + totalRaw + ' total (' + countFixas + ' fixas, ' + countMoveis + ' moveis)');
    }

    // Funcao auxiliar para atualizar elementos
    function updateElement(id, value) {
        var el = document.getElementById(id);
        if (el) el.textContent = value;
    }

    // ============================================
    // SUBMENU DE WAZE
    // ============================================

    // Toggle do submenu de Waze
    function toggleWazeSubmenu(event) {
        if (event) event.stopPropagation();

        var layerItems = document.querySelectorAll('.layer-item.has-submenu');
        var submenu = document.getElementById('wazeSubmenu');
        var wazeLayerItem = null;

        // Encontrar o item correto do Waze
        layerItems.forEach(function(item) {
            if (item.querySelector('#layerWaze')) {
                wazeLayerItem = item;
            }
        });

        if (wazeLayerItem && submenu) {
            var isExpanding = !submenu.classList.contains('expanded');
            wazeLayerItem.classList.toggle('expanded');
            submenu.classList.toggle('expanded');

            // Se estiver abrindo o submenu e o Waze nao esta ativo, ativar
            if (isExpanding) {
                var mainCheckbox = document.getElementById('layerWaze');
                if (mainCheckbox && !mainCheckbox.checked) {
                    mainCheckbox.checked = true;
                    toggleAllWaze();
                }
            }
        }
    }

    // Toggle todas as camadas Waze (checkbox principal)
    function toggleAllWaze() {
        var mainCheckbox = document.getElementById('layerWaze');
        var isChecked = mainCheckbox ? mainCheckbox.checked : false;
        var layerItem = mainCheckbox ? mainCheckbox.closest('.layer-item') : null;

        // Atualizar todos os checkboxes filhos
        var tipos = ['Congestionamentos', 'Interdicoes', 'Eventos', 'Acidentes', 'Buracos', 'Perigos', 'CarroParado', 'Policia', 'Outros'];
        tipos.forEach(function(tipo) {
            var checkbox = document.getElementById('layerWaze' + tipo);
            if (checkbox) checkbox.checked = isChecked;
            // Converter para camelCase para o filtro
            var filterKey = tipo.charAt(0).toLowerCase() + tipo.slice(1);
            wazeFilters[filterKey] = isChecked;
        });

        if (isChecked) {
            if (layerItem) layerItem.classList.add('active');

            // Carregar dados se nao tiver
            if (!layerDataCache.waze) {
                loadWazeCompleto();
            } else {
                // Renderizar com filtros atuais
                renderWazeCompleto(layerDataCache.waze);
            }

            // Adicionar camadas ao mapa
            if (wazeFilters.congestionamentos) mapLayers.wazeCongestionamentos.addTo(map);
            if (wazeFilters.interdicoes) mapLayers.wazeInterdicoes.addTo(map);
            if (wazeFilters.eventos) mapLayers.wazeEventos.addTo(map);
            if (wazeFilters.acidentes) mapLayers.wazeAcidentes.addTo(map);
            if (wazeFilters.buracos) mapLayers.wazeBuracos.addTo(map);
            if (wazeFilters.perigos) mapLayers.wazePerigos.addTo(map);
            if (wazeFilters.carroParado) mapLayers.wazeCarroParado.addTo(map);
            if (wazeFilters.policia) mapLayers.wazePolicia.addTo(map);
            if (wazeFilters.outros) mapLayers.wazeOutros.addTo(map);

            showToast('Camada Waze ativada', 'success');
        } else {
            if (layerItem) layerItem.classList.remove('active');
            map.removeLayer(mapLayers.wazeCongestionamentos);
            map.removeLayer(mapLayers.wazeInterdicoes);
            map.removeLayer(mapLayers.wazeEventos);
            map.removeLayer(mapLayers.wazeAcidentes);
            map.removeLayer(mapLayers.wazeBuracos);
            map.removeLayer(mapLayers.wazePerigos);
            map.removeLayer(mapLayers.wazeCarroParado);
            map.removeLayer(mapLayers.wazePolicia);
            map.removeLayer(mapLayers.wazeOutros);

            showToast('Camada Waze desativada', 'info');
        }
    }

    // Toggle de filtro individual do Waze
    function toggleWazeFilter(tipo) {
        var tipoCapitalized = tipo.charAt(0).toUpperCase() + tipo.slice(1);
        var checkbox = document.getElementById('layerWaze' + tipoCapitalized);
        var isChecked = checkbox ? checkbox.checked : false;

        wazeFilters[tipo] = isChecked;

        // Atualizar checkbox principal
        var mainCheckbox = document.getElementById('layerWaze');
        if (mainCheckbox) {
            mainCheckbox.checked = wazeFilters.congestionamentos || wazeFilters.interdicoes ||
                                   wazeFilters.eventos || wazeFilters.acidentes || wazeFilters.buracos ||
                                   wazeFilters.perigos || wazeFilters.carroParado || wazeFilters.policia ||
                                   wazeFilters.outros;
        }

        // Adicionar/remover camada do mapa
        var layerName = 'waze' + tipoCapitalized;
        if (isChecked) {
            if (!map.hasLayer(mapLayers[layerName])) {
                mapLayers[layerName].addTo(map);
            }
        } else {
            if (map.hasLayer(mapLayers[layerName])) {
                map.removeLayer(mapLayers[layerName]);
            }
        }

        // Se nao tem dados, carregar
        if (!layerDataCache.waze && isChecked) {
            loadWazeCompleto();
        }
    }

    // Carregar dados completos do Waze
    function loadWazeCompleto() {
        var url = baseUrl + 'integracity/api/mob/waze-completo/';
        showToast('Carregando dados Waze...', 'info');
        console.log('Carregando Waze completo de:', url);

        fetch(url)
            .then(function(response) {
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status);
                }
                return response.json();
            })
            .then(function(data) {
                console.log('Dados Waze recebidos:', data);
                layerDataCache.waze = data;
                renderWazeCompleto(data);
                showToast('Dados Waze carregados', 'success');
            })
            .catch(function(error) {
                console.error('Erro ao carregar Waze:', error);
                showToast('Erro ao carregar Waze: ' + error.message, 'error');
            });
    }

    // Renderizar todos os dados do Waze
    function renderWazeCompleto(data) {
        // Limpar camadas existentes
        mapLayers.wazeCongestionamentos.clearLayers();
        mapLayers.wazeInterdicoes.clearLayers();
        mapLayers.wazeEventos.clearLayers();
        mapLayers.wazeAcidentes.clearLayers();
        mapLayers.wazeBuracos.clearLayers();
        mapLayers.wazePerigos.clearLayers();
        mapLayers.wazeCarroParado.clearLayers();
        mapLayers.wazePolicia.clearLayers();
        mapLayers.wazeOutros.clearLayers();
        mapLayers.waze.clearLayers();

        // Cores por nivel de congestionamento
        var jamColors = {
            1: '#ffff00',  // Amarelo - leve
            2: '#ffa500',  // Laranja - moderado
            3: '#ff6600',  // Laranja escuro - medio
            4: '#ff0000',  // Vermelho - severo
            5: '#990000'   // Vermelho escuro - parado
        };

        // 1. CONGESTIONAMENTOS
        var congestionamentos = data.congestionamentos || [];
        congestionamentos.forEach(function(jam) {
            if (!jam.coordinates || jam.coordinates.length < 2) return;

            var latlngs = jam.coordinates.map(function(c) {
                return [c[1], c[0]];  // [lat, lng] formato Leaflet
            });

            var color = jamColors[jam.level] || '#ffa500';

            // Polyline para mostrar extensao
            var polyline = L.polyline(latlngs, {
                color: color,
                weight: 6,
                opacity: 0.8
            });

            var popupContent = '<div style="font-family: Rajdhani, sans-serif;">' +
                '<div style="font-weight: 600; color: ' + color + '; margin-bottom: 5px;">' +
                '<i class="fas fa-car-side"></i> Congestionamento</div>' +
                '<div><strong>Via:</strong> ' + (jam.street || 'Via nao identificada') + '</div>' +
                '<div><strong>Nivel:</strong> ' + jam.level + '/5</div>' +
                '<div><strong>Velocidade:</strong> ' + jam.speed + ' km/h</div>' +
                '<div><strong>Extensao:</strong> ' + Math.round(jam.length / 1000 * 10) / 10 + ' km</div>' +
                '</div>';

            polyline.bindPopup(popupContent);
            mapLayers.wazeCongestionamentos.addLayer(polyline);
            mapLayers.waze.addLayer(polyline);

            // Marcador circular no ponto medio da linha
            var midIndex = Math.floor(latlngs.length / 2);
            var midPoint = latlngs[midIndex];
            var marker = L.marker(midPoint, {
                icon: L.divIcon({
                    className: 'waze-congestionamento-marker',
                    html: '<div style="background: ' + color + '; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.4);"><i class="fas fa-car-side" style="color: white; font-size: 12px;"></i></div>',
                    iconSize: [28, 28],
                    iconAnchor: [14, 14]
                })
            });
            marker.bindPopup(popupContent);
            mapLayers.wazeCongestionamentos.addLayer(marker);
            mapLayers.waze.addLayer(marker);
        });

        // 2. INTERDICOES
        var interdicoes = data.interdicoes || [];
        interdicoes.forEach(function(item) {
            if (!item.coordinates || item.coordinates.length < 2) return;

            var latlngs = item.coordinates.map(function(c) {
                return [c[1], c[0]];
            });

            var colorInterdicao = '#FF0055';

            // Polyline para mostrar extensao
            var polyline = L.polyline(latlngs, {
                color: colorInterdicao,
                weight: 8,
                opacity: 0.9,
                dashArray: '10, 10'
            });

            var popupContent = '<div style="font-family: Rajdhani, sans-serif;">' +
                '<div style="font-weight: 600; color: ' + colorInterdicao + '; margin-bottom: 5px;">' +
                '<i class="fas fa-road-barrier"></i> Via Interditada</div>' +
                '<div><strong>Motivo:</strong> ' + (item.reason || item.street || 'Nao informado') + '</div>' +
                '<div><strong>Extensao:</strong> ' + Math.round(item.length / 1000 * 10) / 10 + ' km</div>' +
                '</div>';

            polyline.bindPopup(popupContent);
            mapLayers.wazeInterdicoes.addLayer(polyline);
            mapLayers.waze.addLayer(polyline);

            // Marcador circular no ponto medio da linha
            var midIndex = Math.floor(latlngs.length / 2);
            var midPoint = latlngs[midIndex];
            var marker = L.marker(midPoint, {
                icon: L.divIcon({
                    className: 'waze-interdicao-marker',
                    html: '<div style="background: ' + colorInterdicao + '; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.4);"><i class="fas fa-road-barrier" style="color: white; font-size: 12px;"></i></div>',
                    iconSize: [28, 28],
                    iconAnchor: [14, 14]
                })
            });
            marker.bindPopup(popupContent);
            mapLayers.wazeInterdicoes.addLayer(marker);
            mapLayers.waze.addLayer(marker);
        });

        // 3. EVENTOS
        var eventos = data.eventos || [];
        eventos.forEach(function(item) {
            if (!item.coordinates || item.coordinates.length < 2) return;

            var latlngs = item.coordinates.map(function(c) {
                return [c[1], c[0]];
            });

            var colorEvento = '#9C27B0';

            // Polyline para mostrar extensao
            var polyline = L.polyline(latlngs, {
                color: colorEvento,
                weight: 6,
                opacity: 0.8,
                dashArray: '5, 10'
            });

            var popupContent = '<div style="font-family: Rajdhani, sans-serif;">' +
                '<div style="font-weight: 600; color: ' + colorEvento + '; margin-bottom: 5px;">' +
                '<i class="fas fa-calendar-alt"></i> Evento</div>' +
                '<div><strong>Descricao:</strong> ' + (item.street || 'Evento especial') + '</div>' +
                '<div><strong>Extensao:</strong> ' + Math.round(item.length / 1000 * 10) / 10 + ' km</div>' +
                '</div>';

            polyline.bindPopup(popupContent);
            mapLayers.wazeEventos.addLayer(polyline);
            mapLayers.waze.addLayer(polyline);

            // Marcador circular no ponto medio da linha
            var midIndex = Math.floor(latlngs.length / 2);
            var midPoint = latlngs[midIndex];
            var marker = L.marker(midPoint, {
                icon: L.divIcon({
                    className: 'waze-evento-marker',
                    html: '<div style="background: ' + colorEvento + '; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.4);"><i class="fas fa-calendar-alt" style="color: white; font-size: 12px;"></i></div>',
                    iconSize: [28, 28],
                    iconAnchor: [14, 14]
                })
            });
            marker.bindPopup(popupContent);
            mapLayers.wazeEventos.addLayer(marker);
            mapLayers.waze.addLayer(marker);
        });

        // 4. ALERTAS (pontos) - separados por tipo
        var alertas = data.alertas || [];
        var alertIcons = {
            'ACCIDENT': { icon: 'fa-car-crash', color: '#FF0055', layer: 'wazeAcidentes' },
            'HAZARD': { icon: 'fa-exclamation-triangle', color: '#FFC107', layer: 'wazePerigos' },
            'ROAD_CLOSED': { icon: 'fa-road-barrier', color: '#FF5722', layer: 'wazeInterdicoes' },
            'JAM': { icon: 'fa-traffic-light', color: '#ff6600', layer: 'wazeCongestionamentos' },
            'POLICE': { icon: 'fa-shield-halved', color: '#007bff', layer: 'wazePolicia' },
            'CONSTRUCTION': { icon: 'fa-hard-hat', color: '#FF9800', layer: 'wazeOutros' }
        };

        // Contadores por tipo
        var contadores = {
            acidentes: 0,
            buracos: 0,
            perigos: 0,
            carroParado: 0,
            policia: 0,
            outros: 0
        };

        alertas.forEach(function(alerta) {
            if (!alerta.lat || !alerta.lon) return;

            // Determinar tipo e camada
            var tipo = alerta.type || '';
            var subtipo = alerta.subtype || '';
            var layerName = 'wazeOutros';
            var config = { icon: 'fa-info-circle', color: '#808080' };
            var tipoTraduzido = 'Alerta';

            // Classificar por tipo
            if (tipo === 'ACCIDENT') {
                layerName = 'wazeAcidentes';
                config = { icon: 'fa-car-crash', color: '#FF0055' };
                tipoTraduzido = 'Acidente';
                contadores.acidentes++;
            } else if (tipo === 'HAZARD') {
                // Sub-classificar hazards
                if (subtipo.includes('POT_HOLE') || subtipo.includes('POTHOLE')) {
                    layerName = 'wazeBuracos';
                    config = { icon: 'fa-circle-exclamation', color: '#8B4513' };
                    tipoTraduzido = 'Buraco';
                    contadores.buracos++;
                } else if (subtipo.includes('CAR_STOPPED') || subtipo.includes('VEHICLE')) {
                    layerName = 'wazeCarroParado';
                    config = { icon: 'fa-car', color: '#888888' };
                    tipoTraduzido = 'Carro Parado';
                    contadores.carroParado++;
                } else {
                    layerName = 'wazePerigos';
                    config = { icon: 'fa-exclamation-triangle', color: '#FFC107' };
                    tipoTraduzido = 'Perigo';
                    contadores.perigos++;
                }
            } else if (tipo === 'POLICE') {
                layerName = 'wazePolicia';
                config = { icon: 'fa-shield-halved', color: '#007bff' };
                tipoTraduzido = 'Policia';
                contadores.policia++;
            } else {
                contadores.outros++;
            }

            var marker = L.marker([alerta.lat, alerta.lon], {
                icon: L.divIcon({
                    className: 'waze-alert-marker',
                    html: '<div style="background: ' + config.color + '; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.4);"><i class="fas ' + config.icon + '" style="color: white; font-size: 12px;"></i></div>',
                    iconSize: [28, 28],
                    iconAnchor: [14, 14]
                })
            });

            var popupContent = '<div style="font-family: Rajdhani, sans-serif;">' +
                '<div style="font-weight: 600; color: ' + config.color + '; margin-bottom: 5px;">' +
                '<i class="fas ' + config.icon + '"></i> ' + tipoTraduzido + '</div>' +
                '<div><strong>Local:</strong> ' + (alerta.street || 'Nao identificado') + '</div>' +
                (subtipo ? '<div><strong>Detalhe:</strong> ' + subtipo.replace(/_/g, ' ') + '</div>' : '') +
                '<div><strong>Confiabilidade:</strong> ' + (alerta.reliability || 0) + '%</div>' +
                '</div>';

            marker.bindPopup(popupContent);
            mapLayers[layerName].addLayer(marker);
            mapLayers.waze.addLayer(marker);
        });

        // Atualizar contadores
        var stats = data.estatisticas || {};
        var totalAlertas = contadores.acidentes + contadores.buracos + contadores.perigos +
                          contadores.carroParado + contadores.policia + contadores.outros;

        updateElement('countWaze', (stats.total_congestionamentos || 0) + (stats.total_interdicoes || 0) +
                                   (stats.total_eventos || 0) + totalAlertas);
        updateElement('countWazeCongestionamentos', stats.total_congestionamentos || 0);
        updateElement('countWazeInterdicoes', stats.total_interdicoes || 0);
        updateElement('countWazeEventos', stats.total_eventos || 0);
        updateElement('countWazeAcidentes', contadores.acidentes);
        updateElement('countWazeBuracos', contadores.buracos);
        updateElement('countWazePerigos', contadores.perigos);
        updateElement('countWazeCarroParado', contadores.carroParado);
        updateElement('countWazePolicia', contadores.policia);
        updateElement('countWazeOutros', contadores.outros);

        console.log('Waze renderizado - Cong: ' + (stats.total_congestionamentos || 0) +
                    ', Inter: ' + (stats.total_interdicoes || 0) +
                    ', Eventos: ' + (stats.total_eventos || 0) +
                    ', Acidentes: ' + contadores.acidentes +
                    ', Buracos: ' + contadores.buracos +
                    ', Perigos: ' + contadores.perigos);
    }

    // Toggle da sidebar de camadas
    function toggleLayersSidebar() {
        var sidebar = document.getElementById('layersSidebar');
        var toggleBtn = document.getElementById('layersToggleBtn');
        if (sidebar) {
            sidebar.classList.toggle('expanded');
            if (toggleBtn) {
                toggleBtn.classList.toggle('active', sidebar.classList.contains('expanded'));
            }
        }
    }

    // Criar icone de marcador
    function createLayerIcon(type) {
        var config = layerIcons[type] || { icon: 'fa-map-marker', color: '#00d4ff' };
        return L.divIcon({
            className: 'custom-layer-marker',
            html: '<div style="background: ' + config.color + '; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.4);"><i class="fas ' + config.icon + '" style="color: white; font-size: 12px;"></i></div>',
            iconSize: [28, 28],
            iconAnchor: [14, 14],
            popupAnchor: [0, -14]
        });
    }

    // Toggle de camada ao clicar na linha (nao apenas no checkbox)
    function toggleLayerByClick(layerName, event) {
        if (event) event.stopPropagation();

        // Encontrar o checkbox correspondente
        var checkboxId = 'layer' + layerName.charAt(0).toUpperCase() + layerName.slice(1);
        var checkbox = document.getElementById(checkboxId);

        if (checkbox) {
            // Inverter o estado do checkbox
            checkbox.checked = !checkbox.checked;
            // Disparar o evento onchange para ativar a logica da camada
            toggleMapLayer(layerName);
        }
    }

    // Toggle de camada individual
    function toggleMapLayer(layerName) {
        var checkbox = document.getElementById('layer' + layerName.charAt(0).toUpperCase() + layerName.slice(1));
        var isChecked = checkbox ? checkbox.checked : false;
        var layerItem = checkbox ? checkbox.closest('.layer-item') : null;

        if (isChecked) {
            // Adicionar camada ao mapa
            if (!map.hasLayer(mapLayers[layerName])) {
                mapLayers[layerName].addTo(map);
            }
            if (layerItem) layerItem.classList.add('active');

            // Carregar dados se ainda nao carregou
            if (!layerDataCache[layerName]) {
                loadLayerData(layerName);
            }

            // Mostrar campo de busca para escolas
            if (layerName === 'escolas') {
                var searchContainer = document.getElementById('escolaSearchContainer');
                if (searchContainer) {
                    searchContainer.style.display = 'block';
                }
            }

            showToast('Camada ' + layerName + ' ativada', 'success');
        } else {
            // Remover camada do mapa
            if (map.hasLayer(mapLayers[layerName])) {
                map.removeLayer(mapLayers[layerName]);
            }
            if (layerItem) layerItem.classList.remove('active');

            // Esconder campo de busca para escolas
            if (layerName === 'escolas') {
                var searchContainer = document.getElementById('escolaSearchContainer');
                if (searchContainer) {
                    searchContainer.style.display = 'none';
                    // Limpar busca
                    var input = document.getElementById('escolaSearchInput');
                    if (input) input.value = '';
                    var list = document.getElementById('escolaAutocompleteList');
                    if (list) {
                        list.innerHTML = '';
                        list.classList.remove('active');
                    }
                }
            }

            showToast('Camada ' + layerName + ' desativada', 'info');
        }
    }

    // Carregar dados de uma camada especifica
    // Detectar base URL automaticamente - usar origin para garantir URL absoluta
    var baseUrl = window.location.origin + '/';
    console.log('Base URL para APIs:', baseUrl);

    function loadLayerData(layerName) {
        // Waze usa API e renderizacao especiais (via loadWazeCompleto)
        if (layerName === 'waze') {
            loadWazeCompleto();
            return;
        }

        var apiUrls = {
            escolas: baseUrl + 'integracity/api/escolas/',
            hospitais: baseUrl + 'integracity/api/hospitais/',
            pluviometros: baseUrl + 'integracity/api/pluviometros/',
            sirenes: baseUrl + 'integracity/api/sirenes/',
            cameras: baseUrl + 'integracity/api/cameras/',
            metro: baseUrl + 'integracity/api/metro/',
            brt: baseUrl + 'integracity/api/brt/',
            bolsoes: baseUrl + 'integracity/api/bolsoes/',
            ocorrencias: baseUrl + 'integracity/api/ocorrencias/mapa/'
        };

        var url = apiUrls[layerName];
        if (!url) return;

        showToast('Carregando ' + layerName + '...', 'info');
        console.log('Carregando camada ' + layerName + ' de:', url);

        fetch(url)
            .then(function(response) {
                console.log('Resposta da API ' + layerName + ':', response.status);
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status);
                }
                return response.json();
            })
            .then(function(data) {
                console.log('Dados recebidos para ' + layerName + ':', data);
                layerDataCache[layerName] = data;

                // Cameras usa renderização especial com tipos (fixas/moveis)
                if (layerName === 'cameras') {
                    renderCamerasByType();
                    // Adicionar camadas baseado nos filtros atuais
                    if (cameraFilters.fixas) mapLayers.camerasFixas.addTo(map);
                    if (cameraFilters.moveis) mapLayers.camerasMoveis.addTo(map);
                    showToast('Cameras carregadas com sucesso', 'success');
                } else if (layerName === 'ocorrencias') {
                    renderOcorrenciasMarkers(data);
                    updateLayerCount(layerName, data);
                    showToast('Ocorrencias carregadas com sucesso', 'success');
                } else {
                    renderLayerMarkers(layerName, data);
                    updateLayerCount(layerName, data);
                }
            })
            .catch(function(error) {
                console.error('Erro ao carregar ' + layerName + ':', error);
                showToast('Erro ao carregar ' + layerName + ': ' + error.message, 'error');
            });
    }

    // Renderizar marcadores de uma camada
    function renderLayerMarkers(layerName, data) {
        // Limpar camada existente
        mapLayers[layerName].clearLayers();

        var items = [];

        // Normalizar dados conforme o tipo de API
        if (Array.isArray(data)) {
            items = data;
        } else if (data.features) {
            // GeoJSON format
            items = data.features.map(f => ({
                ...f.properties,
                latitude: f.geometry?.coordinates?.[1],
                longitude: f.geometry?.coordinates?.[0]
            }));
        } else if (data.data) {
            items = Array.isArray(data.data) ? data.data : [];
        } else if (data.results) {
            items = data.results;
        } else if (data.alerts) {
            items = data.alerts;
        } else if (data.escolas) {
            items = data.escolas;
        } else if (data.hospitais) {
            items = data.hospitais;
        } else if (data.sirenes) {
            items = data.sirenes;
        } else if (data.cameras) {
            items = data.cameras;
        } else if (data.estacoes) {
            items = data.estacoes;
        } else if (data.linhas) {
            items = data.linhas;
        }

        items.forEach(function(item) {
            // Tentar diferentes campos de coordenadas
            var lat = item.latitude || item.lat || item.y || (item.location && item.location.lat);
            var lng = item.longitude || item.lng || item.lon || item.x || (item.location && item.location.lng);

            if (lat && lng) {
                var marker = L.marker([lat, lng], {
                    icon: createLayerIcon(layerName)
                });

                // Para cameras, abrir video direto no clique
                if (layerName === 'cameras' && item.url) {
                    marker.on('click', function() {
                        openCameraPlayer(item.url_stream || item.url, item.nome || 'Camera', item.id_c || item.id || '');
                    });
                    // Tooltip simples no hover
                    marker.bindTooltip(item.nome || 'Camera', {
                        permanent: false,
                        direction: 'top',
                        className: 'camera-tooltip'
                    });
                } else {
                    // Criar popup com informacoes para outras camadas
                    var popupContent = createPopupContent(layerName, item);
                    marker.bindPopup(popupContent);
                }

                mapLayers[layerName].addLayer(marker);
            }
        });

        console.log('Camada ' + layerName + ': ' + mapLayers[layerName].getLayers().length + ' marcadores');
    }

    // Criar conteudo do popup
    function createPopupContent(layerName, item) {
        var config = layerIcons[layerName];
        var title = item.nome || item.name || item.titulo || item.title || item.tipo || item.type || layerName;
        var details = '';

        switch(layerName) {
            case 'escolas':
                details = '<p>' + (item.endereco || item.bairro || '--') + '</p>';
                if (item.telefone) details += '<p>Tel: ' + item.telefone + '</p>';
                if (item.tipo) details += '<p>Tipo: ' + item.tipo + '</p>';
                break;
            case 'hospitais':
                details = '<p>' + (item.endereco || item.bairro || '--') + '</p>';
                if (item.telefone) details += '<p>Tel: ' + item.telefone + '</p>';
                break;
            case 'pluviometros':
                details = '<p>Bairro: ' + (item.bairro || '--') + '</p>';
                if (item.acumulado_15min !== undefined) details += '<p>15min: ' + item.acumulado_15min + 'mm</p>';
                if (item.acumulado_1h !== undefined) details += '<p>1h: ' + item.acumulado_1h + 'mm</p>';
                if (item.chuva_1h !== undefined) details += '<p>1h: ' + item.chuva_1h + 'mm</p>';
                if (item.chuva_24h !== undefined) details += '<p>24h: ' + item.chuva_24h + 'mm</p>';
                break;
            case 'sirenes':
                details = '<p>Bairro: ' + (item.bairro || '--') + '</p>';
                details += '<p>Status: ' + (item.acionada ? '<span style="color:#ff0055">ACIONADA</span>' : '<span style="color:#00ff88">Stand-by</span>') + '</p>';
                break;
            case 'cameras':
                details = '<p>' + (item.zona || item.localizacao || item.bairro || '--') + '</p>';
                if (item.bairro) details += '<p>Bairro: ' + item.bairro + '</p>';
                if (item.url_stream || item.url) {
                    var cameraUrl = item.url_stream || item.url; var cameraName = (item.nome || 'Camera').replace(/'/g, "\'"); var cameraId = item.id_c || item.id || ''; details += '<button onclick="openCameraPlayer(&quot;' + cameraUrl + '&quot;, &quot;' + cameraName + '&quot;, &quot;' + cameraId + '&quot;)" style="margin-top: 10px; padding: 8px 16px; background: linear-gradient(135deg, #9C27B0, #7B1FA2); color: white; border: none; border-radius: 8px; cursor: pointer; font-family: Rajdhani, sans-serif; font-weight: 600; display: flex; align-items: center; gap: 6px;"><i class="fas fa-play"></i> Assistir ao Vivo</button>';
                }
                break;
            case 'metro':
                details = '<p>Linha: ' + (item.linha || '--') + '</p>';
                details += '<p>Status: ' + (item.status || 'Normal') + '</p>';
                break;
            case 'brt':
                details = '<p>Corredor: ' + (item.corredor || '--') + '</p>';
                details += '<p>Status: ' + (item.status || 'Normal') + '</p>';
                break;
            case 'waze':
                details = '<p>Tipo: ' + (item.type || item.subtype || '--') + '</p>';
                if (item.street) details += '<p>' + item.street + '</p>';
                break;
            case 'bolsoes':
                details = '<p>Local: ' + (item.local || '--') + '</p>';
                if (item.referencia) details += '<p>Ref: ' + item.referencia + '</p>';
                if (item.bairro) details += '<p>Bairro: ' + item.bairro + '</p>';
                if (item.zona) details += '<p>Zona: ' + item.zona + '</p>';
                break;
            default:
                details = '<p>' + (item.descricao || item.description || '--') + '</p>';
        }

        return '<div style="font-family: Rajdhani, sans-serif; min-width: 180px;">' +
            '<h4 style="margin: 0 0 8px 0; color: ' + config.color + '; font-family: Orbitron, monospace; font-size: 0.9rem;">' +
            '<i class="fas ' + config.icon + '"></i> ' + title.substring(0, 30) + '</h4>' +
            '<div style="font-size: 0.85rem; color: #ccc;">' + details + '</div>' +
            '</div>';
    }

    // Renderizar congestionamentos do Waze como polylines
    function renderWazeJams(data) {
        // Limpar camada existente
        mapLayers.waze.clearLayers();

        var jams = data.jams || data.data || data;
        if (!Array.isArray(jams)) {
            console.warn('Dados Waze invalidos:', data);
            return;
        }

        console.log('Renderizando ' + jams.length + ' congestionamentos Waze');

        // Cores por nivel de congestionamento
        var jamColors = {
            1: '#ffff00',  // Amarelo - leve
            2: '#ffa500',  // Laranja - moderado
            3: '#ff6600',  // Laranja escuro - medio
            4: '#ff0000',  // Vermelho - severo
            5: '#990000'   // Vermelho escuro - parado
        };

        jams.forEach(function(jam) {
            if (!jam.coordinates || jam.coordinates.length < 2) {
                return;
            }

            // Converter coordenadas de [x, y] para [lat, lng]
            var latlngs = jam.coordinates.map(function(coord) {
                return [coord[1], coord[0]]; // Waze usa [lon, lat], Leaflet usa [lat, lng]
            });

            var level = jam.level || 3;
            var color = jamColors[level] || '#ff6600';
            var weight = level >= 4 ? 6 : 4;

            var polyline = L.polyline(latlngs, {
                color: color,
                weight: weight,
                opacity: 0.8,
                lineCap: 'round',
                lineJoin: 'round'
            });

            // Popup com informacoes do congestionamento
            var popupContent = '<div style="font-family: Rajdhani, sans-serif; min-width: 200px;">' +
                '<h4 style="margin: 0 0 8px 0; color: ' + color + '; font-family: Orbitron, monospace;">' +
                '<i class="fab fa-waze"></i> Congestionamento</h4>' +
                '<p><strong>Via:</strong> ' + (jam.street || 'Via nao identificada') + '</p>' +
                '<p><strong>Nivel:</strong> ' + level + '/5</p>' +
                '<p><strong>Velocidade:</strong> ' + (jam.speed ? jam.speed.toFixed(1) + ' km/h' : '--') + '</p>' +
                '<p><strong>Extensao:</strong> ' + (jam.length ? (jam.length/1000).toFixed(1) + ' km' : '--') + '</p>' +
                '<p><strong>Atraso:</strong> ' + (jam.delay ? Math.round(jam.delay/60) + ' min' : '--') + '</p>' +
                '</div>';

            polyline.bindPopup(popupContent);
            mapLayers.waze.addLayer(polyline);
        });

        console.log('Waze: ' + mapLayers.waze.getLayers().length + ' polylines renderizadas');
    }

    // Animação de pulso para ocorrências via JavaScript (funciona melhor com Leaflet)
    var ocPulseInterval = null;
    function startOcorrenciaPulse() {
        if (ocPulseInterval) clearInterval(ocPulseInterval);
        var pulseState = true;
        ocPulseInterval = setInterval(function() {
            var dots = document.querySelectorAll('.oc-marker-dot');
            dots.forEach(function(dot) {
                if (pulseState) {
                    dot.style.boxShadow = '0 0 20px 8px ' + (dot.dataset.cor || '#00D4FF');
                    dot.style.opacity = '1';
                } else {
                    dot.style.boxShadow = '0 0 5px 2px ' + (dot.dataset.cor || '#00D4FF');
                    dot.style.opacity = '0.7';
                }
            });
            pulseState = !pulseState;
        }, 600);
    }
    // Iniciar pulso após um pequeno delay para garantir que os markers foram renderizados
    setTimeout(startOcorrenciaPulse, 2000);

    // Renderizar marcadores de ocorrencias com cores por prioridade
    function renderOcorrenciasMarkers(data) {
        // Limpar camada existente
        mapLayers.ocorrencias.clearLayers();

        var items = [];
        if (data.data && Array.isArray(data.data)) {
            items = data.data;
        } else if (Array.isArray(data)) {
            items = data;
        }

        console.log('Renderizando ' + items.length + ' ocorrencias no mapa');

        items.forEach(function(oc) {
            if (oc.latitude && oc.longitude) {
                // Cor baseada na prioridade
                var cor = coresPrioridade[oc.prioridade] || '#00D4FF';
                var icone = oc.categoria_icone || 'fa-exclamation-triangle';

                var icon = L.divIcon({
                    className: 'custom-marker ocorrencia-marker',
                    html: '<div class="oc-marker-dot" data-cor="' + cor + '" style="background: ' + cor + '; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 3px solid white; transition: box-shadow 0.3s, opacity 0.3s;"><i class="fas ' + icone + '" style="color: white; font-size: 14px;"></i></div>',
                    iconSize: [32, 32],
                    iconAnchor: [16, 16]
                });

                var marker = L.marker([oc.latitude, oc.longitude], { icon: icon });

                // Popup com informacoes da ocorrencia
                var popupContent = '<div style="font-family: Rajdhani, sans-serif; min-width: 250px;">' +
                    '<div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">' +
                    '<div style="background: ' + cor + '30; color: ' + cor + '; padding: 8px; border-radius: 8px;">' +
                    '<i class="fas ' + icone + '"></i></div>' +
                    '<div>' +
                    '<h4 style="margin: 0; color: #00d4ff; font-size: 1rem;">' + oc.protocolo + '</h4>' +
                    '<span style="font-size: 0.75rem; color: #888;">' + oc.categoria + '</span>' +
                    '</div></div>' +
                    '<div style="font-size: 0.9rem; color: #fff; margin-bottom: 8px;">' + oc.titulo + '</div>' +
                    '<div style="display: flex; gap: 8px; margin-bottom: 8px;">' +
                    '<span style="background: ' + cor + '30; color: ' + cor + '; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem;">' + oc.prioridade_display + '</span>' +
                    '<span style="background: rgba(0,212,255,0.2); color: #00d4ff; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem;">' + oc.status_display + '</span>' +
                    '</div>' +
                    '<div style="font-size: 0.8rem; color: #aaa;">' +
                    '<i class="fas fa-map-marker-alt"></i> ' + (oc.endereco || '--') + (oc.bairro ? ', ' + oc.bairro : '') +
                    '</div>' +
                    '<div style="font-size: 0.75rem; color: #666; margin-top: 5px;">' +
                    '<i class="fas fa-clock"></i> ' + oc.data_abertura +
                    '</div>' +
                    '<div style="margin-top: 10px;">' +
                    '<a href="/integracity/ocorrencias/' + oc.id + '/" target="_blank" style="display: inline-block; background: #00d4ff; color: #000; padding: 6px 15px; border-radius: 6px; text-decoration: none; font-size: 0.8rem; font-weight: bold;">' +
                    '<i class="fas fa-eye"></i> Ver Detalhes</a>' +
                    '</div></div>';

                marker.bindPopup(popupContent, {
                    maxWidth: 350,
                    className: 'ocorrencia-popup'
                });

                mapLayers.ocorrencias.addLayer(marker);
            }
        });

        // Atualizar contador
        var countEl = document.getElementById('countOcorrencias');
        if (countEl) {
            countEl.textContent = items.length;
        }

        // Reiniciar animação de pulso
        setTimeout(startOcorrenciaPulse, 500);

        // Reiniciar tour automático se estiver ativo
        if (tourAtivo && items.length > 0) {
            setTimeout(function() {
                ocorrenciasTour = items.filter(function(oc) {
                    return oc.latitude && oc.longitude;
                });
                if (!tourEmExecucao) {
                    iniciarTourOcorrencias();
                }
            }, 1000);
        }
    }

    // ========================================
    // TOUR AUTOMÁTICO POR OCORRÊNCIAS
    // ========================================
    var tourAtivo = true; // Liga/desliga o tour automático
    var tourEmExecucao = false;
    var tourNavegando = false; // Flag para indicar que o tour está navegando (evita pausar por eventos do mapa)
    var tourTimeoutId = null;
    var ocorrenciasTour = [];
    var posicaoOriginal = { lat: -22.92, lng: -43.45, zoom: 11 };
    var TEMPO_EM_OCORRENCIA = 4000; // 4 segundos em cada ocorrência
    var TEMPO_NA_POSICAO_ORIGINAL = 5000; // 5 segundos na posição original
    var ZOOM_OCORRENCIA = 16; // Zoom aproximado para cada ocorrência

    function iniciarTourOcorrencias() {
        if (tourEmExecucao || ocorrenciasTour.length === 0) return;

        tourEmExecucao = true;
        console.log('🚀 Iniciando tour por ' + ocorrenciasTour.length + ' ocorrências');

        // Atualizar visual do botão
        var btn = document.getElementById('tourControlBtn');
        var icon = document.getElementById('tourIcon');
        if (btn && icon) {
            btn.classList.add('active');
            icon.className = 'fas fa-pause';
        }

        // Iniciar o ciclo do tour
        executarCicloTour(0);
    }

    function executarCicloTour(indice) {
        if (!tourAtivo) {
            tourEmExecucao = false;
            tourNavegando = false;
            return;
        }

        // Se percorreu todas as ocorrências, voltar para posição original
        if (indice >= ocorrenciasTour.length) {
            console.log('📍 Voltando para posição original...');
            tourNavegando = true; // Marcar que o tour está navegando
            map.flyTo([posicaoOriginal.lat, posicaoOriginal.lng], posicaoOriginal.zoom, {
                duration: 2
            });

            // Esperar 5 segundos na posição original e reiniciar o tour
            tourTimeoutId = setTimeout(function() {
                tourNavegando = false;
                if (tourAtivo && ocorrenciasTour.length > 0) {
                    console.log('🔄 Reiniciando tour...');
                    executarCicloTour(0);
                }
            }, TEMPO_NA_POSICAO_ORIGINAL + 2000); // +2s da animação flyTo
            return;
        }

        var oc = ocorrenciasTour[indice];
        console.log('🎯 Voando para ocorrência ' + (indice + 1) + '/' + ocorrenciasTour.length + ': ' + (oc.protocolo || oc.titulo || 'Ocorrência'));

        // Voar para a ocorrência
        tourNavegando = true; // Marcar que o tour está navegando
        map.flyTo([oc.latitude, oc.longitude], ZOOM_OCORRENCIA, {
            duration: 1.5
        });

        // Aguardar tempo na ocorrência e ir para a próxima
        tourTimeoutId = setTimeout(function() {
            tourNavegando = false;
            executarCicloTour(indice + 1);
        }, TEMPO_EM_OCORRENCIA + 1500); // +1.5s da animação flyTo
    }

    function pararTour() {
        tourAtivo = false;
        tourEmExecucao = false;
        tourNavegando = false;
        if (tourTimeoutId) {
            clearTimeout(tourTimeoutId);
            tourTimeoutId = null;
        }
        console.log('⏹️ Tour parado');
    }

    function retomarTour() {
        if (tourEmExecucao) return;
        tourAtivo = true;

        // Buscar ocorrências atuais do mapa
        var markers = mapLayers.ocorrencias.getLayers();
        if (markers.length === 0) {
            console.log('Nenhuma ocorrência para fazer tour');
            return;
        }

        // Reconstruir lista de ocorrências a partir dos markers
        // Como não temos os dados originais, vamos usar as coordenadas dos markers
        ocorrenciasTour = markers.map(function(marker) {
            var latlng = marker.getLatLng();
            return {
                latitude: latlng.lat,
                longitude: latlng.lng,
                protocolo: 'Ocorrência'
            };
        });

        console.log('▶️ Retomando tour com ' + ocorrenciasTour.length + ' ocorrências');
        iniciarTourOcorrencias();
    }

    // Pausar tour quando usuário interage com o mapa (mas não quando o tour está navegando)
    map.on('dragstart', function() {
        if (tourEmExecucao && !tourNavegando) {
            pararTour();
            atualizarBotaoTour();
            showToast('Tour pausado - Clique no botão de rota para retomar', 'info');
        }
    });

    map.on('zoomstart', function() {
        if (tourEmExecucao && !tourNavegando) {
            pararTour();
            atualizarBotaoTour();
            showToast('Tour pausado - Clique no botão de rota para retomar', 'info');
        }
    });

    // Toggle do tour (botão na interface)
    function toggleTourOcorrencias() {
        var btn = document.getElementById('tourControlBtn');
        var icon = document.getElementById('tourIcon');

        if (tourEmExecucao) {
            // Parar tour
            pararTour();
            btn.classList.remove('active');
            icon.className = 'fas fa-route';
            showToast('Tour automático desativado', 'info');
        } else {
            // Iniciar tour
            retomarTour();
            btn.classList.add('active');
            icon.className = 'fas fa-pause';
            showToast('Tour automático ativado - Voando por ' + ocorrenciasTour.length + ' ocorrências', 'success');
        }
    }

    // Atualizar visual do botão quando tour é pausado por interação
    function atualizarBotaoTour() {
        var btn = document.getElementById('tourControlBtn');
        var icon = document.getElementById('tourIcon');
        if (!tourEmExecucao) {
            btn.classList.remove('active');
            icon.className = 'fas fa-route';
        }
    }

    // Expor funções globalmente
    window.pararTour = pararTour;
    window.retomarTour = retomarTour;
    window.toggleTourOcorrencias = toggleTourOcorrencias;

    // Atualizar contador de itens da camada
    function updateLayerCount(layerName, data) {
        var countEl = document.getElementById('count' + layerName.charAt(0).toUpperCase() + layerName.slice(1));
        if (!countEl) return;

        var count = 0;
        if (Array.isArray(data)) {
            count = data.length;
        } else if (data.count !== undefined) {
            count = data.count;
        } else if (data.total !== undefined) {
            count = data.total;
        } else {
            // Tentar contar de diferentes estruturas
            var lists = ['data', 'results', 'features', 'alerts', 'jams', 'escolas', 'hospitais',
                         'sirenes', 'cameras', 'estacoes', 'linhas'];
            for (var i = 0; i < lists.length; i++) {
                if (data[lists[i]] && Array.isArray(data[lists[i]])) {
                    count = data[lists[i]].length;
                    break;
                }
            }
        }

        countEl.textContent = count;
    }

    // Selecionar todas as camadas
    function selectAllLayers() {
        var layerNames = Object.keys(mapLayers);
        layerNames.forEach(function(layerName) {
            var checkbox = document.getElementById('layer' + layerName.charAt(0).toUpperCase() + layerName.slice(1));
            if (checkbox && !checkbox.checked) {
                checkbox.checked = true;
                toggleMapLayer(layerName);
            }
        });
        showToast('Todas as camadas ativadas', 'success');
    }

    // Limpar todas as camadas
    function clearAllLayers() {
        var layerNames = Object.keys(mapLayers);
        layerNames.forEach(function(layerName) {
            var checkbox = document.getElementById('layer' + layerName.charAt(0).toUpperCase() + layerName.slice(1));
            if (checkbox && checkbox.checked) {
                checkbox.checked = false;
                toggleMapLayer(layerName);
            }
        });
        showToast('Todas as camadas desativadas', 'info');
    }

    // ============================================
    // PLAYER DE CAMERAS - JANELA FLUTUANTE RESPONSIVA
    // ============================================

    // Modo de visualizacao atual
    var currentViewMode = 'contain';

    function openCameraPlayer(url, nome, cameraId) {
        // Fechar modal existente se houver
        closeCameraPlayer();

        // Formatar nome da câmera
        var displayName = 'CAMERA ' + (cameraId || '') + ' - ' + nome.toUpperCase();

        var playerUrl = url;
        var resolvedId = cameraId;
        if (!resolvedId && url) {
            var matchId = url.match(/\/api\/camera\/(\d+)/);
            if (matchId && matchId[1]) resolvedId = matchId[1];
        }
        if (!resolvedId && url) {
            var matchCode = url.match(/[?&]CODE=(\\d+)/i);
            if (matchCode && matchCode[1]) resolvedId = matchCode[1];
        }
        if (resolvedId) {
            playerUrl = window.location.origin + '/integracity/api/camera/' + resolvedId + '/stream/?embed=1';
        } else if (url && url.indexOf('/info/') !== -1) {
            playerUrl = url.replace('/info/', '/stream/?embed=1');
        }

        var modalHtml = `
            <div id="cameraPlayerModal" class="camera-player-modal" style="
                top: 100px;
                left: 150px;
                width: 70vw;
                height: 60vh;
                max-width: 960px;
                max-height: 720px;
                min-width: 360px;
                min-height: 240px;
            ">
                <!-- Cabecalho arrastavel -->
                <div id="cameraPlayerHeader" class="camera-player-header">
                    <span class="camera-player-title">${displayName}</span>
                </div>

                <!-- Container do Video - RESPONSIVO -->
                <div class="camera-video-container">
                    <!-- Loading indicator -->
                    <div id="cameraLoading" class="camera-loading">
                        <div class="camera-loading-spinner"></div>
                        <span>Carregando video...</span>
                    </div>

                    <!-- Video Wrapper - RESPONSIVO SEM CORTES -->
                    <div class="video-wrapper">
                        <iframe
                            id="cameraIframe"
                            src="${playerUrl}"
                            allowfullscreen
                            allow="autoplay; encrypted-media"
                            scrolling="no"
                            onload="hideCameraLoading();"
                            onerror="showCameraOffline()"
                        ></iframe>
                    </div>
                </div>

                <!-- Rodape com controles e botao fechar -->
                <div class="camera-player-footer">

                    <button onclick="closeCameraPlayer()" class="camera-close-btn">
                        <i class="fas fa-times"></i> FECHAR
                    </button>
                </div>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHtml);

        // Tornar arrastavel
        makeDraggable(document.getElementById('cameraPlayerModal'), document.getElementById('cameraPlayerHeader'));

        // Fechar com ESC
        document.addEventListener('keydown', handleCameraEsc);

        // Esconder loading depois de um tempo se iframe nao disparar onload
        setTimeout(function() {
            var loading = document.getElementById('cameraLoading');
            if (loading) loading.style.display = 'none';
        }, 5000);
    }

    // Esconder loading quando iframe carregar
    function hideCameraLoading() {
        var loading = document.getElementById('cameraLoading');
        if (loading) loading.style.display = 'none';
    }

    // Mostrar estado offline
    function showCameraOffline() {
        var loading = document.getElementById('cameraLoading');
        if (loading) {
            loading.innerHTML = '<i class="fas fa-video-slash" style="font-size: 48px; opacity: 0.7;"></i><span>Camera offline</span>';
        }
    }

    // Placeholder - o iframe do Tixxi controla seu próprio conteúdo
    // Não temos controle sobre o CSS da página externa
    function setViewMode(mode, btn) {
        currentViewMode = mode;
        console.log('Modo:', mode, '(controle limitado - conteúdo externo)');

        // Atualizar botoes ativos
        document.querySelectorAll('.camera-view-btn').forEach(function(b) {
            b.classList.remove('active');
        });
        if (btn) {
            btn.classList.add('active');
        }
    }

    function closeCameraPlayer() {
        var modal = document.getElementById('cameraPlayerModal');
        if (modal) {
            modal.remove();
        }
        document.removeEventListener('keydown', handleCameraEsc);
    }

    function handleCameraEsc(e) {
        if (e.key === 'Escape') {
            closeCameraPlayer();
        }
    }

    // Funcao para tornar elemento arrastavel
    function makeDraggable(element, handle) {
        var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;

        handle.onmousedown = dragMouseDown;

        function dragMouseDown(e) {
            e.preventDefault();
            pos3 = e.clientX;
            pos4 = e.clientY;
            document.onmouseup = closeDragElement;
            document.onmousemove = elementDrag;
        }

        function elementDrag(e) {
            e.preventDefault();
            pos1 = pos3 - e.clientX;
            pos2 = pos4 - e.clientY;
            pos3 = e.clientX;
            pos4 = e.clientY;
            element.style.top = (element.offsetTop - pos2) + "px";
            element.style.left = (element.offsetLeft - pos1) + "px";
        }

        function closeDragElement() {
            document.onmouseup = null;
            document.onmousemove = null;
        }
    }

    // ============================================
    // MOSAICO DE CÂMERAS
    // ============================================

    var allCameras = []; // Armazena todas as câmeras
    var mosaicCameras = []; // Câmeras selecionadas para o mosaico
    var currentMosaicLayout = 4; // Layout atual (4, 8, 16, 24, 48)

    // Abrir modal do mosaico
    function openMosaicModal() {
        // Carregar câmeras se ainda não carregou
        if (allCameras.length === 0) {
            loadCamerasForMosaic();
        }

        var modal = document.getElementById('mosaicModal');
        if (modal) {
            modal.style.display = 'flex';
            renderCameraList();
        }
    }

    // Fechar modal do mosaico
    function closeMosaicModal() {
        var modal = document.getElementById('mosaicModal');
        if (modal) {
            modal.style.display = 'none';
        }
    }

    // Carregar câmeras da API
    function loadCamerasForMosaic() {
        var mosaicApiUrl = window.location.origin + '/integracity/api/cameras/';
        console.log('Carregando cameras para mosaico de:', mosaicApiUrl);

        fetch(mosaicApiUrl)
            .then(function(response) {
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status);
                }
                return response.json();
            })
            .then(function(data) {
                console.log('Dados do mosaico recebidos:', data);

                // A API retorna em data.data
                if (data.data && Array.isArray(data.data)) {
                    allCameras = data.data;
                } else if (data.cameras) {
                    allCameras = data.cameras;
                } else if (Array.isArray(data)) {
                    allCameras = data;
                } else {
                    allCameras = [];
                }
                console.log('Câmeras carregadas para mosaico:', allCameras.length);
                renderCameraList();
            })
            .catch(function(err) {
                console.error('Erro ao carregar câmeras:', err);
            });
    }

    // Renderizar lista de câmeras com filtro
    function renderCameraList() {
        var container = document.getElementById('cameraListContainer');
        var searchTerm = document.getElementById('cameraSearch')?.value?.toLowerCase() || '';

        if (!container) return;

        var filtered = allCameras.filter(function(cam) {
            var id = (cam.id || cam.codigo || '').toString().toLowerCase();
            var nome = (cam.nome || cam.name || '').toLowerCase();
            return id.includes(searchTerm) || nome.includes(searchTerm);
        });

        var html = '';
        filtered.forEach(function(cam, index) {
            var camId = cam.id || cam.codigo || index;
            var camNome = cam.nome || cam.name || 'Camera ' + camId;
            var isSelected = mosaicCameras.some(function(c) { return c.id === camId; });

            html += '<div class="camera-list-item ' + (isSelected ? 'selected' : '') + '" onclick="toggleCameraSelection(\'' + camId + '\')">';
            html += '  <div class="camera-checkbox">' + (isSelected ? '<i class="fas fa-check"></i>' : '') + '</div>';
            html += '  <div class="camera-info">';
            html += '    <span class="camera-id">' + camId + '</span>';
            html += '    <span class="camera-name">' + camNome + '</span>';
            html += '  </div>';
            html += '</div>';
        });

        container.innerHTML = html || '<div class="no-cameras">Nenhuma câmera encontrada</div>';

        // Atualizar contador
        var counter = document.getElementById('selectedCount');
        if (counter) {
            counter.textContent = mosaicCameras.length + ' / ' + currentMosaicLayout;
        }
    }

    // Toggle seleção de câmera
    function toggleCameraSelection(camId) {
        var cam = allCameras.find(function(c) {
            return (c.id || c.codigo) == camId;
        });

        if (!cam) return;

        var index = mosaicCameras.findIndex(function(c) {
            return (c.id || c.codigo) == camId;
        });

        if (index >= 0) {
            // Remover
            mosaicCameras.splice(index, 1);
        } else {
            // Adicionar (se não exceder limite)
            if (mosaicCameras.length < currentMosaicLayout) {
                mosaicCameras.push(cam);
            } else {
                showToast('Limite de ' + currentMosaicLayout + ' câmeras atingido!', 'warning');
                return;
            }
        }

        renderCameraList();
    }

    // Mudar layout do mosaico
    function setMosaicLayout(layout) {
        currentMosaicLayout = layout;

        // Se tem mais câmeras selecionadas que o novo limite, remover excesso
        while (mosaicCameras.length > layout) {
            mosaicCameras.pop();
        }

        // Atualizar botões
        document.querySelectorAll('.layout-btn').forEach(function(btn) {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');

        renderCameraList();
    }

    // Iniciar mosaico
    function startMosaic() {
        if (mosaicCameras.length === 0) {
            showToast('Selecione pelo menos uma câmera!', 'warning');
            return;
        }

        closeMosaicModal();
        openMosaicView();
    }

    // Abrir visualização do mosaico
    function openMosaicView() {
        // Pegar IDs das câmeras selecionadas
        var cameraIds = mosaicCameras.map(function(c) { return c.id; }).join(',');
        
        // Construir URL com parâmetros
        var url = window.location.origin + window.location.pathname;
        url += '?mosaic=true&cameras=' + encodeURIComponent(cameraIds) + '&layout=' + currentMosaicLayout;
        
        // Abrir em nova aba
        window.open(url, '_blank');
    }

    // Criar overlay do mosaico
    function createMosaicOverlay() {
        var html = `
            <div id="mosaicOverlay" class="mosaic-overlay">
                <div class="mosaic-header">
                    <div class="mosaic-title">
                        <i class="fas fa-th"></i>
                        MOSAICO DE CÂMERAS
                        <span id="mosaicInfo"></span>
                    </div>
                    <div class="mosaic-controls">
                        <button class="mosaic-btn" onclick="setMosaicLayout(4); renderMosaicGrid();">2x2</button>
                        <button class="mosaic-btn" onclick="setMosaicLayout(8); renderMosaicGrid();">2x4</button>
                        <button class="mosaic-btn" onclick="setMosaicLayout(16); renderMosaicGrid();">4x4</button>
                        <button class="mosaic-btn" onclick="setMosaicLayout(24); renderMosaicGrid();">4x6</button>
                        <button class="mosaic-btn" onclick="setMosaicLayout(48); renderMosaicGrid();">6x8</button>
                        <button class="mosaic-btn" onclick="openMosaicModal()"><i class="fas fa-plus"></i> Editar</button>
                        <button class="mosaic-btn close" onclick="closeMosaicView()"><i class="fas fa-times"></i></button>
                    </div>
                </div>
                <div id="mosaicGrid" class="mosaic-grid grid-4"></div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', html);
    }

    // Renderizar grid do mosaico
    function renderMosaicGrid() {
        var grid = document.getElementById('mosaicGrid');
        var info = document.getElementById('mosaicInfo');

        if (!grid) return;

        // Definir classe do grid baseado no layout
        grid.className = 'mosaic-grid grid-' + currentMosaicLayout;

        // Atualizar info
        if (info) {
            info.textContent = '(' + mosaicCameras.length + ' câmeras)';
        }

        var html = '';

        // Renderizar câmeras selecionadas
        mosaicCameras.forEach(function(cam, index) {
            var camId = cam.id || cam.codigo;
            var camNome = cam.nome || cam.name || 'Camera';
            var camUrl = cam.url || '';

            html += '<div class="mosaic-cell">';
            html += '  <div class="mosaic-cell-header">' + camId + ' - ' + camNome + '</div>';
            if (camUrl) {
                html += '  <iframe src="' + camUrl + '" allowfullscreen></iframe>';
            } else {
                html += '  <div class="mosaic-no-stream"><i class="fas fa-video-slash"></i></div>';
            }
            html += '</div>';
        });

        // Preencher células vazias
        for (var i = mosaicCameras.length; i < currentMosaicLayout; i++) {
            html += '<div class="mosaic-cell empty">';
            html += '  <div class="mosaic-empty-cell"><i class="fas fa-plus"></i><br>Vazio</div>';
            html += '</div>';
        }

        grid.innerHTML = html;
    }

    // Fechar visualização do mosaico
    function closeMosaicView() {
        var overlay = document.getElementById('mosaicOverlay');
        if (overlay) {
            overlay.style.display = 'none';
        }
    }

    // Filtrar câmeras (chamado no input)
    function filterCameras() {
        renderCameraList();
    }

    // Selecionar todas as câmeras filtradas
    function selectAllFiltered() {
        var searchTerm = document.getElementById('cameraSearch')?.value?.toLowerCase() || '';

        var filtered = allCameras.filter(function(cam) {
            var id = (cam.id || cam.codigo || '').toString().toLowerCase();
            var nome = (cam.nome || cam.name || '').toLowerCase();
            return id.includes(searchTerm) || nome.includes(searchTerm);
        });

        filtered.forEach(function(cam) {
            var camId = cam.id || cam.codigo;
            var alreadySelected = mosaicCameras.some(function(c) {
                return (c.id || c.codigo) == camId;
            });

            if (!alreadySelected && mosaicCameras.length < currentMosaicLayout) {
                mosaicCameras.push(cam);
            }
        });

        renderCameraList();
    }

    // Limpar seleção
    function clearSelection() {
        mosaicCameras = [];
        renderCameraList();
    }

    // ============================================
    // EXPORT FUNCTIONS TO GLOBAL SCOPE
    // ============================================
    // Necessário para que onclick="" funcione corretamente
    window.toggleLayersSidebar = toggleLayersSidebar;
    window.toggleMapLayer = toggleMapLayer;
    window.toggleCameraSubmenu = toggleCameraSubmenu;
    window.toggleAllCameras = toggleAllCameras;
    window.toggleCameraType = toggleCameraType;
    window.openMosaicModal = openMosaicModal;
    window.closeMosaicModal = closeMosaicModal;
    window.setMosaicLayout = setMosaicLayout;
    window.filterCameras = filterCameras;
    window.selectAllFiltered = selectAllFiltered;
    window.clearSelection = clearSelection;
    window.toggleCameraSelection = toggleCameraSelection;
    window.createMosaicOverlay = createMosaicOverlay;
    window.closeMosaicView = closeMosaicView;
    window.renderMosaicGrid = renderMosaicGrid;
    window.openMosaicView = openMosaicView;
    window.switchLayer = switchLayer;
    window.zoomIn = zoomIn;
    window.zoomOut = zoomOut;
    window.resetView = resetView;

    // ============================================
    // INICIALIZACAO
    // ============================================
    console.log('IntegraCity High-Tech Dashboard initialized');
    console.log('Mapa centrado no Rio de Janeiro');
    console.log('Sistema de camadas carregado');

    // ===== DETECTOR DE MOSAICO NA URL =====
    window.addEventListener('DOMContentLoaded', function() {
        var urlParams = new URLSearchParams(window.location.search);
        
        if (urlParams.get('mosaic') === 'true') {
            var cameraIds = urlParams.get('cameras');
            var layout = parseInt(urlParams.get('layout')) || 4;
            
            console.log('Modo mosaico detectado! IDs:', cameraIds, 'Layout:', layout);
            
            // Configurar layout
            currentMosaicLayout = layout;
            
            // Carregar câmeras da API e depois abrir overlay
            fetch(window.location.origin + '/integracity/api/cameras/')
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    // Parsear dados da API
                    if (data.data && Array.isArray(data.data)) {
                        allCameras = data.data;
                    } else if (Array.isArray(data)) {
                        allCameras = data;
                    }
                    
                    // Selecionar câmeras pelos IDs
                    if (cameraIds) {
                        var ids = cameraIds.split(',');
                        mosaicCameras = allCameras.filter(function(cam) {
                            return ids.includes(String(cam.id));
                        });
                        console.log('Câmeras selecionadas:', mosaicCameras.length);
                    } else {
                        // Se não tem IDs, pegar as primeiras N câmeras
                        mosaicCameras = allCameras.slice(0, layout);
                    }
                    
                    // Criar e abrir overlay
                    createMosaicOverlay();
                    var overlay = document.getElementById('mosaicOverlay');
                    if (overlay) {
                        overlay.style.display = 'flex';
                        renderMosaicGrid();
                    }
                })
                .catch(function(err) {
                    console.error('Erro ao carregar câmeras para mosaico:', err);
                });
        }

        // Carregar camada de ocorrencias automaticamente (checkbox marcado por padrao)
        var ocorrenciasCheckbox = document.getElementById('layerOcorrencias');
        if (ocorrenciasCheckbox && ocorrenciasCheckbox.checked) {
            console.log('Carregando ocorrencias automaticamente...');
            mapLayers.ocorrencias.addTo(map);
            loadLayerData('ocorrencias');
        }
    });

    // Atualizar ocorrencias a cada 2 minutos
    setInterval(function() {
        var ocorrenciasCheckbox = document.getElementById('layerOcorrencias');
        if (ocorrenciasCheckbox && ocorrenciasCheckbox.checked) {
            console.log('Atualizando ocorrencias...');
            loadLayerData('ocorrencias');
        }
    }, 120000);

    // ===== BUSCA DE ESCOLAS COM AUTOCOMPLETE =====
    (function() {
        var escolaSearchInput = document.getElementById('escolaSearchInput');
        var escolaAutocompleteList = document.getElementById('escolaAutocompleteList');
        var escolaSearchClear = document.getElementById('escolaSearchClear');
        var escolasData = [];
        var selectedIndex = -1;
        var debounceTimer = null;

        // Carregar dados das escolas quando a camada for ativada
        function loadEscolasData() {
            if (escolasData.length > 0) return Promise.resolve(escolasData);

            return fetch(window.location.origin + '/integracity/api/escolas/')
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    if (data.success && data.data) {
                        escolasData = data.data;
                        console.log('Escolas carregadas para busca:', escolasData.length);
                    }
                    return escolasData;
                })
                .catch(function(err) {
                    console.error('Erro ao carregar escolas:', err);
                    return [];
                });
        }

        // Destacar texto encontrado
        function highlightMatch(text, query) {
            if (!query || !text) return text;
            var regex = new RegExp('(' + query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi');
            return text.replace(regex, '<mark>$1</mark>');
        }

        // Filtrar escolas pelo nome
        function filterEscolas(query) {
            if (!query || query.length < 2) return [];

            var queryLower = query.toLowerCase();
            return escolasData.filter(function(escola) {
                return escola.nome && escola.nome.toLowerCase().includes(queryLower);
            }).slice(0, 15); // Limitar a 15 resultados
        }

        // Renderizar lista de autocomplete
        function renderAutocomplete(results, query) {
            selectedIndex = -1;
            escolaAutocompleteList.innerHTML = '';

            if (results.length === 0) {
                escolaAutocompleteList.innerHTML = '<div class="escola-no-results"><i class="fas fa-search"></i> Nenhuma escola encontrada</div>';
                escolaAutocompleteList.classList.add('active');
                return;
            }

            results.forEach(function(escola, index) {
                var item = document.createElement('div');
                item.className = 'escola-autocomplete-item';
                item.setAttribute('data-index', index);
                item.innerHTML =
                    '<div class="escola-nome">' + highlightMatch(escola.nome, query) + '</div>' +
                    '<div class="escola-tipo"><i class="fas fa-map-marker-alt"></i> ' + (escola.tipo || 'Escola Municipal') + ' - CRE ' + (escola.cre || 'N/A') + '</div>';

                item.addEventListener('click', function() {
                    selectEscola(escola);
                });

                item.addEventListener('mouseenter', function() {
                    selectedIndex = index;
                    updateSelectedItem();
                });

                escolaAutocompleteList.appendChild(item);
            });

            escolaAutocompleteList.classList.add('active');
        }

        // Atualizar item selecionado (navegação por teclado)
        function updateSelectedItem() {
            var items = escolaAutocompleteList.querySelectorAll('.escola-autocomplete-item');
            items.forEach(function(item, i) {
                if (i === selectedIndex) {
                    item.classList.add('selected');
                    item.scrollIntoView({ block: 'nearest' });
                } else {
                    item.classList.remove('selected');
                }
            });
        }

        // Selecionar escola e georreferenciar no mapa
        function selectEscola(escola) {
            console.log('Escola selecionada:', escola.nome, escola.lat, escola.lng);

            // Limpar busca
            escolaSearchInput.value = escola.nome;
            escolaAutocompleteList.innerHTML = '';
            escolaAutocompleteList.classList.remove('active');
            escolaSearchClear.style.display = 'flex';

            // Centralizar mapa na escola com zoom alto
            if (escola.lat && escola.lng) {
                map.flyTo([escola.lat, escola.lng], 18, {
                    duration: 1.5
                });

                // Encontrar e abrir popup do marcador
                mapLayers.escolas.eachLayer(function(layer) {
                    var latLng = layer.getLatLng();
                    if (Math.abs(latLng.lat - escola.lat) < 0.0001 &&
                        Math.abs(latLng.lng - escola.lng) < 0.0001) {
                        setTimeout(function() {
                            layer.openPopup();
                        }, 1600);
                    }
                });

                showToast('Escola localizada: ' + escola.nome, 'success');
            }
        }

        // Event listeners
        if (escolaSearchInput) {
            // Input com debounce
            escolaSearchInput.addEventListener('input', function(e) {
                var query = e.target.value.trim();

                // Mostrar/esconder botão de limpar
                escolaSearchClear.style.display = query ? 'flex' : 'none';

                // Debounce para não fazer muitas buscas
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(function() {
                    if (query.length >= 2) {
                        loadEscolasData().then(function() {
                            var results = filterEscolas(query);
                            renderAutocomplete(results, query);
                        });
                    } else {
                        escolaAutocompleteList.innerHTML = '';
                        escolaAutocompleteList.classList.remove('active');
                    }
                }, 200);
            });

            // Navegação por teclado
            escolaSearchInput.addEventListener('keydown', function(e) {
                var items = escolaAutocompleteList.querySelectorAll('.escola-autocomplete-item');
                if (items.length === 0) return;

                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                    updateSelectedItem();
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedIndex = Math.max(selectedIndex - 1, 0);
                    updateSelectedItem();
                } else if (e.key === 'Enter' && selectedIndex >= 0) {
                    e.preventDefault();
                    var query = escolaSearchInput.value.trim();
                    var results = filterEscolas(query);
                    if (results[selectedIndex]) {
                        selectEscola(results[selectedIndex]);
                    }
                } else if (e.key === 'Escape') {
                    escolaAutocompleteList.innerHTML = '';
                    escolaAutocompleteList.classList.remove('active');
                    escolaSearchInput.blur();
                }
            });

            // Fechar ao clicar fora
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.escola-search-container')) {
                    escolaAutocompleteList.innerHTML = '';
                    escolaAutocompleteList.classList.remove('active');
                }
            });
        }

        // Botão de limpar
        if (escolaSearchClear) {
            escolaSearchClear.addEventListener('click', function() {
                escolaSearchInput.value = '';
                escolaAutocompleteList.innerHTML = '';
                escolaAutocompleteList.classList.remove('active');
                escolaSearchClear.style.display = 'none';
                escolaSearchInput.focus();
            });
        }

        console.log('Sistema de busca de escolas inicializado');
    })();

    // ===== BUSCA DE CÂMERAS COM AUTOCOMPLETE =====
    (function() {
        var cameraSearchInput = document.getElementById('cameraSearchInput');
        var cameraAutocompleteList = document.getElementById('cameraAutocompleteList');
        var cameraSearchClear = document.getElementById('cameraSearchClear');
        var camerasData = [];
        var selectedIndex = -1;
        var debounceTimer = null;

        // Carregar dados das câmeras
        function loadCamerasData() {
            if (camerasData.length > 0) return Promise.resolve(camerasData);

            return fetch(window.location.origin + '/integracity/api/cameras/')
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    if (data.data && Array.isArray(data.data)) {
                        camerasData = data.data;
                    } else if (Array.isArray(data)) {
                        camerasData = data;
                    }
                    console.log('Câmeras carregadas para busca:', camerasData.length);
                    return camerasData;
                })
                .catch(function(err) {
                    console.error('Erro ao carregar câmeras:', err);
                    return [];
                });
        }

        // Destacar texto encontrado
        function highlightMatch(text, query) {
            if (!query || !text) return text;
            var regex = new RegExp('(' + query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi');
            return text.replace(regex, '<mark>$1</mark>');
        }

        // Filtrar câmeras pelo nome
        function filterCameras(query) {
            if (!query || query.length < 2) return [];

            var queryLower = query.toLowerCase();
            return camerasData.filter(function(camera) {
                var nome = camera.nome || camera.name || camera.denominacao || '';
                return nome.toLowerCase().includes(queryLower);
            }).slice(0, 15); // Limitar a 15 resultados
        }

        // Renderizar lista de autocomplete
        function renderAutocomplete(results, query) {
            selectedIndex = -1;
            cameraAutocompleteList.innerHTML = '';

            if (results.length === 0) {
                cameraAutocompleteList.innerHTML = '<div class="camera-no-results"><i class="fas fa-search"></i> Nenhuma camera encontrada</div>';
                cameraAutocompleteList.classList.add('active');
                return;
            }

            results.forEach(function(camera, index) {
                var nome = camera.nome || camera.name || camera.denominacao || 'Sem nome';
                var tipo = camera.tipo || camera.type || 'N/A';
                var isMovel = tipo.toLowerCase().includes('movel') || tipo.toLowerCase().includes('móvel');

                var item = document.createElement('div');
                item.className = 'camera-autocomplete-item';
                item.setAttribute('data-index', index);
                item.innerHTML =
                    '<div class="camera-nome">' + highlightMatch(nome, query) + '</div>' +
                    '<div class="camera-tipo"><i class="fas fa-video"></i> <span class="' + (isMovel ? 'tipo-movel' : 'tipo-fixa') + '">' + tipo + '</span></div>';

                item.addEventListener('click', function(e) {
                    e.stopPropagation();
                    selectCamera(camera);
                });

                item.addEventListener('mouseenter', function() {
                    selectedIndex = index;
                    updateSelectedItem();
                });

                cameraAutocompleteList.appendChild(item);
            });

            cameraAutocompleteList.classList.add('active');
        }

        // Atualizar item selecionado (navegação por teclado)
        function updateSelectedItem() {
            var items = cameraAutocompleteList.querySelectorAll('.camera-autocomplete-item');
            items.forEach(function(item, i) {
                if (i === selectedIndex) {
                    item.classList.add('selected');
                    item.scrollIntoView({ block: 'nearest' });
                } else {
                    item.classList.remove('selected');
                }
            });
        }

        // Selecionar câmera e georreferenciar no mapa
        function selectCamera(camera) {
            var nome = camera.nome || camera.name || camera.denominacao || 'Sem nome';
            var lat = camera.lat || camera.latitude;
            var lng = camera.lng || camera.longitude;

            console.log('Câmera selecionada:', nome, lat, lng);

            // Limpar busca
            cameraSearchInput.value = nome;
            cameraAutocompleteList.innerHTML = '';
            cameraAutocompleteList.classList.remove('active');
            cameraSearchClear.style.display = 'flex';

            // Centralizar mapa na câmera com zoom alto
            if (lat && lng) {
                map.flyTo([lat, lng], 18, {
                    duration: 1.5
                });

                // Encontrar e abrir popup do marcador (verificar nas duas camadas)
                var found = false;
                ['camerasFixas', 'camerasMoveis'].forEach(function(layerName) {
                    if (found || !mapLayers[layerName]) return;
                    mapLayers[layerName].eachLayer(function(layer) {
                        if (found) return;
                        var latLng = layer.getLatLng();
                        if (Math.abs(latLng.lat - lat) < 0.0001 &&
                            Math.abs(latLng.lng - lng) < 0.0001) {
                            found = true;
                            setTimeout(function() {
                                layer.openPopup();
                            }, 1600);
                        }
                    });
                });

                showToast('Câmera localizada: ' + nome, 'success');
            }
        }

        // Event listeners
        if (cameraSearchInput) {
            // Input com debounce
            cameraSearchInput.addEventListener('input', function(e) {
                var query = e.target.value.trim();

                // Mostrar/esconder botão de limpar
                cameraSearchClear.style.display = query ? 'flex' : 'none';

                // Debounce para não fazer muitas buscas
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(function() {
                    if (query.length >= 2) {
                        loadCamerasData().then(function() {
                            var results = filterCameras(query);
                            renderAutocomplete(results, query);
                        });
                    } else {
                        cameraAutocompleteList.innerHTML = '';
                        cameraAutocompleteList.classList.remove('active');
                    }
                }, 200);
            });

            // Navegação por teclado
            cameraSearchInput.addEventListener('keydown', function(e) {
                var items = cameraAutocompleteList.querySelectorAll('.camera-autocomplete-item');
                if (items.length === 0) return;

                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                    updateSelectedItem();
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedIndex = Math.max(selectedIndex - 1, 0);
                    updateSelectedItem();
                } else if (e.key === 'Enter' && selectedIndex >= 0) {
                    e.preventDefault();
                    var query = cameraSearchInput.value.trim();
                    var results = filterCameras(query);
                    if (results[selectedIndex]) {
                        selectCamera(results[selectedIndex]);
                    }
                } else if (e.key === 'Escape') {
                    cameraAutocompleteList.innerHTML = '';
                    cameraAutocompleteList.classList.remove('active');
                    cameraSearchInput.blur();
                }
            });

            // Fechar ao clicar fora
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.camera-search-container')) {
                    cameraAutocompleteList.innerHTML = '';
                    cameraAutocompleteList.classList.remove('active');
                }
            });
        }

        // Botão de limpar
        if (cameraSearchClear) {
            cameraSearchClear.addEventListener('click', function(e) {
                e.stopPropagation();
                cameraSearchInput.value = '';
                cameraAutocompleteList.innerHTML = '';
                cameraAutocompleteList.classList.remove('active');
                cameraSearchClear.style.display = 'none';
                cameraSearchInput.focus();
            });
        }

        console.log('Sistema de busca de câmeras inicializado');
    })();

</script>

<!-- ============================================
     MODAL DE SELEÇÃO DO MOSAICO
     ============================================ -->
<div id="mosaicModal" class="mosaic-modal" style="display: none;">
    <div class="mosaic-modal-content">
        <div class="mosaic-modal-header">
            <h2><i class="fas fa-th"></i> Configurar Mosaico</h2>
            <button class="mosaic-close-btn" onclick="closeMosaicModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="mosaic-modal-body">
            <!-- Layout Selection -->
            <div class="layout-section">
                <label>Layout:</label>
                <div class="layout-buttons">
                    <button class="layout-btn active" onclick="setMosaicLayout(4)">2x2 (4)</button>
                    <button class="layout-btn" onclick="setMosaicLayout(8)">2x4 (8)</button>
                    <button class="layout-btn" onclick="setMosaicLayout(16)">4x4 (16)</button>
                    <button class="layout-btn" onclick="setMosaicLayout(24)">4x6 (24)</button>
                    <button class="layout-btn" onclick="setMosaicLayout(48)">6x8 (48)</button>
                </div>
            </div>

            <!-- Search -->
            <div class="search-section">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="cameraSearch" placeholder="Buscar por ID ou nome..." oninput="filterCameras()">
                </div>
                <div class="search-actions">
                    <button class="action-btn" onclick="selectAllFiltered()">
                        <i class="fas fa-check-double"></i> Selecionar Filtrados
                    </button>
                    <button class="action-btn" onclick="clearSelection()">
                        <i class="fas fa-trash"></i> Limpar
                    </button>
                </div>
            </div>

            <!-- Counter -->
            <div class="selection-counter">
                Selecionadas: <span id="selectedCount">0 / 4</span>
            </div>

            <!-- Camera List -->
            <div id="cameraListContainer" class="camera-list-container">
                <div class="loading-cameras">
                    <i class="fas fa-spinner fa-spin"></i> Carregando câmeras...
                </div>
            </div>
        </div>

        <div class="mosaic-modal-footer">
            <button class="cancel-btn" onclick="closeMosaicModal()">Cancelar</button>
            <button class="start-btn" onclick="startMosaic()">
                <i class="fas fa-play"></i> Iniciar Mosaico
            </button>
        </div>
    </div>
</div>

{% endblock %}
