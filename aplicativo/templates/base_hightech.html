{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="description" content="IntegraCity - Sistema Integrado de Gestao de Crises">
    <!-- Anti-cache headers -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>{% block title %}IntegraCity - Command Center{% endblock %}</title>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- High-Tech CSS -->
    <link rel="stylesheet" href="{% static 'css/hightech.css' %}?v={% now 'U' %}">

    {% block extra_css %}{% endblock %}
</head>
<body>
    <!-- ============================================
         HEADER
         ============================================ -->
    <header class="top-header">
        <div class="header-left">
            <!-- Menu hamburger para mobile -->
            <button class="mobile-menu-btn" onclick="toggleMobileSidebar()" title="Menu">
                <i class="fas fa-bars"></i>
            </button>

            <a href="{% url 'cor_dashboard_hightech' %}" class="logo-container" title="Ir para Dashboard">
                <img src="{% static 'LOGO-FU.png' %}"
                     alt="IntegraCity"
                     class="header-logo-full">
            </a>

            <div class="system-status">
                <span class="status-dot"></span>
                <span>Sistema Online</span>
            </div>

            <!-- Navigation Menu -->
            <nav class="header-nav">
                <a href="{% url 'cor_dashboard_hightech' %}" class="nav-link {% if request.resolver_match.url_name == 'cor_dashboard_hightech' %}active{% endif %}" title="Dashboard">
                    <i class="fas fa-chart-line"></i>
                    <span>Dashboard</span>
                </a>
                <a href="{% url 'ocorrencias_dashboard' %}" class="nav-link {% if 'ocorrencia' in request.resolver_match.url_name %}active{% endif %}" title="Ocorrencias" target="_blank">
                    <i class="fas fa-clipboard-list"></i>
                    <span>Ocorrencias</span>
                </a>
                <a href="{% url 'matriz_dashboard' %}" class="nav-link {% if 'matriz' in request.resolver_match.url_name %}active{% endif %}" title="Matriz Decisoria" target="_blank">
                    <i class="fas fa-brain"></i>
                    <span>Matriz</span>
                </a>
                <a href="{% url 'areas_dashboard' %}" class="nav-link {% if 'areas' in request.resolver_match.url_name %}active{% endif %}" title="Areas de Observacao">
                    <i class="fas fa-draw-polygon"></i>
                    <span>Areas</span>
                </a>
                <a href="{% url 'videomonitoramento' %}" class="nav-link {% if request.resolver_match.url_name == 'videomonitoramento' %}active{% endif %}" title="Cameras">
                    <i class="fas fa-video"></i>
                    <span>Cameras</span>
                </a>
                <a href="{% url 'user_management' %}" class="nav-link {% if 'user' in request.resolver_match.url_name %}active{% endif %}" title="Usuarios">
                    <i class="fas fa-users"></i>
                    <span>Usuarios</span>
                </a>
            </nav>
        </div>

        <div class="header-center">
            <div class="header-stat">
                <span class="stat-label">Data</span>
                <span class="stat-value" id="systemDate">--</span>
            </div>
            <div class="header-stat">
                <span class="stat-label">Hora</span>
                <span class="stat-value" id="systemClock">--:--:--</span>
            </div>
            <div class="header-stat">
                <span class="stat-label">Eventos</span>
                <span class="stat-value" id="headerEventos">{{ eventos_count|default:"0" }}</span>
            </div>
        </div>

        <div class="header-right">
            <button class="header-btn" onclick="refreshData()" title="Atualizar dados">
                <i class="fas fa-sync-alt"></i>
            </button>

            <button class="header-btn" onclick="showNotifications()" title="Notificacoes">
                <i class="fas fa-bell"></i>
                {% if notifications_count %}
                <span class="notification-badge">{{ notifications_count }}</span>
                {% endif %}
            </button>

            <button class="header-btn" onclick="showSettings()" title="Configuracoes">
                <i class="fas fa-cog"></i>
            </button>

            <div class="user-info" onclick="showProfile()" title="Editar Perfil" style="cursor: pointer;">
                <div class="user-avatar">
                    {% if user.first_name %}
                        {{ user.first_name.0|upper }}{{ user.last_name.0|upper|default:"" }}
                    {% else %}
                        <i class="fas fa-user"></i>
                    {% endif %}
                </div>
                <div>
                    <div class="user-name">{{ user.get_full_name|default:user.username|default:"Operador" }}</div>
                    <div class="user-role">{{ user.profile.cargo|default:"Operador" }}</div>
                </div>
            </div>
        </div>
    </header>

    <!-- ============================================
         SIDEBAR
         ============================================ -->
    <aside class="sidebar {% block sidebar_class %}collapsed{% endblock %}" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title">
                <i class="fas fa-chart-line"></i> Monitoramento
            </div>
            <div class="sidebar-subtitle">Dados em tempo real</div>
        </div>

        <div class="monitoring-cards">
            {% block monitoring_cards %}
            <!-- Cards serao inseridos aqui -->
            {% endblock %}
        </div>
    </aside>

    <!-- ============================================
         TOGGLE BUTTON
         ============================================ -->
    <button class="toggle-sidebar {% block toggle_class %}collapsed{% endblock %}" id="toggleBtn" onclick="toggleSidebar()" title="Recolher/Expandir painel">
        <i class="fas fa-chevron-left"></i>
    </button>

    <!-- ============================================
         MAP WRAPPER (CONTEUDO PRINCIPAL)
         ============================================ -->
    <div class="map-wrapper {% block wrapper_class %}expanded{% endblock %}" id="mapWrapper">
        {% block content %}
        <!-- Conteudo principal -->
        {% endblock %}
    </div>

    <!-- ============================================
         SETTINGS MODAL
         ============================================ -->
    <div class="settings-modal" id="settingsModal">
        <div class="settings-modal-content">
            <div class="settings-modal-header">
                <h3><i class="fas fa-cog"></i> Configuracoes do Sistema</h3>
                <button class="settings-modal-close" onclick="closeSettings()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="settings-modal-body">
                <!-- Tabs -->
                <div class="settings-tabs">
                    <button class="settings-tab active" data-tab="mapa" onclick="switchSettingsTab('mapa')">
                        <i class="fas fa-map"></i> Mapa
                    </button>
                    <button class="settings-tab" data-tab="tour" onclick="switchSettingsTab('tour')">
                        <i class="fas fa-route"></i> Tour
                    </button>
                    <button class="settings-tab" data-tab="notificacoes" onclick="switchSettingsTab('notificacoes')">
                        <i class="fas fa-bell"></i> Notificacoes
                    </button>
                    <button class="settings-tab" data-tab="interface" onclick="switchSettingsTab('interface')">
                        <i class="fas fa-palette"></i> Interface
                    </button>
                    <button class="settings-tab" data-tab="perfil" onclick="switchSettingsTab('perfil')">
                        <i class="fas fa-user"></i> Perfil
                    </button>
                </div>

                <!-- Tab Content: Mapa -->
                <div class="settings-tab-content active" id="tab-mapa">
                    <div class="settings-section">
                        <h4><i class="fas fa-map-marker-alt"></i> Posicao Inicial do Mapa</h4>
                        <div class="settings-row">
                            <div class="settings-field">
                                <label>Latitude</label>
                                <input type="number" id="settingMapLat" step="0.0001" value="-22.92">
                            </div>
                            <div class="settings-field">
                                <label>Longitude</label>
                                <input type="number" id="settingMapLng" step="0.0001" value="-43.45">
                            </div>
                            <div class="settings-field">
                                <label>Zoom</label>
                                <input type="number" id="settingMapZoom" min="1" max="20" value="11">
                            </div>
                        </div>
                        <button class="btn-settings-action" onclick="useCurrentMapPosition()">
                            <i class="fas fa-crosshairs"></i> Usar posicao atual do mapa
                        </button>
                    </div>

                    <div class="settings-section">
                        <h4><i class="fas fa-layer-group"></i> Camadas Visiveis por Padrao</h4>
                        <div class="settings-checkboxes">
                            <label class="settings-checkbox">
                                <input type="checkbox" id="settingLayerOcorrencias" checked>
                                <span class="checkbox-custom"></span>
                                <span>Ocorrencias</span>
                            </label>
                            <label class="settings-checkbox">
                                <input type="checkbox" id="settingLayerWaze" checked>
                                <span class="checkbox-custom"></span>
                                <span>Alertas Waze</span>
                            </label>
                            <label class="settings-checkbox">
                                <input type="checkbox" id="settingLayerCameras">
                                <span class="checkbox-custom"></span>
                                <span>Cameras</span>
                            </label>
                            <label class="settings-checkbox">
                                <input type="checkbox" id="settingLayerEscolas">
                                <span class="checkbox-custom"></span>
                                <span>Escolas</span>
                            </label>
                            <label class="settings-checkbox">
                                <input type="checkbox" id="settingLayerSirenes">
                                <span class="checkbox-custom"></span>
                                <span>Sirenes</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Tab Content: Tour -->
                <div class="settings-tab-content" id="tab-tour">
                    <div class="settings-section">
                        <h4><i class="fas fa-play-circle"></i> Tour Automatico</h4>
                        <label class="settings-toggle">
                            <input type="checkbox" id="settingTourAutoStart" checked>
                            <span class="toggle-slider"></span>
                            <span class="toggle-label">Iniciar tour automaticamente ao carregar</span>
                        </label>
                    </div>

                    <div class="settings-section">
                        <h4><i class="fas fa-clock"></i> Tempo em Cada Ocorrencia</h4>
                        <div class="settings-slider-container">
                            <input type="range" id="settingTourTimeOcorrencia" min="3" max="60" value="6" class="settings-slider">
                            <div class="settings-slider-value"><span id="tourTimeOcorrenciaValue">6</span> segundos</div>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h4><i class="fas fa-home"></i> Tempo na Posicao Original</h4>
                        <div class="settings-slider-container">
                            <input type="range" id="settingTourTimeOriginal" min="3" max="60" value="6" class="settings-slider">
                            <div class="settings-slider-value"><span id="tourTimeOriginalValue">6</span> segundos</div>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h4><i class="fas fa-search-plus"></i> Zoom nas Ocorrencias</h4>
                        <div class="settings-slider-container">
                            <input type="range" id="settingTourZoom" min="12" max="18" value="16" class="settings-slider">
                            <div class="settings-slider-value">Nivel <span id="tourZoomValue">16</span></div>
                        </div>
                    </div>
                </div>

                <!-- Tab Content: Notificacoes -->
                <div class="settings-tab-content" id="tab-notificacoes">
                    <div class="settings-section">
                        <h4><i class="fas fa-volume-up"></i> Alertas Sonoros</h4>
                        <label class="settings-toggle">
                            <input type="checkbox" id="settingSoundEnabled">
                            <span class="toggle-slider"></span>
                            <span class="toggle-label">Ativar sons de alerta</span>
                        </label>
                    </div>

                    <div class="settings-section">
                        <h4><i class="fas fa-filter"></i> Tipos de Notificacao</h4>
                        <div class="settings-checkboxes">
                            <label class="settings-checkbox">
                                <input type="checkbox" id="settingNotifyOcorrencias" checked>
                                <span class="checkbox-custom"></span>
                                <span>Novas ocorrencias</span>
                            </label>
                            <label class="settings-checkbox">
                                <input type="checkbox" id="settingNotifyWaze" checked>
                                <span class="checkbox-custom"></span>
                                <span>Alertas Waze criticos</span>
                            </label>
                            <label class="settings-checkbox">
                                <input type="checkbox" id="settingNotifyMeteo">
                                <span class="checkbox-custom"></span>
                                <span>Alertas meteorologicos</span>
                            </label>
                            <label class="settings-checkbox">
                                <input type="checkbox" id="settingNotifyStatus" checked>
                                <span class="checkbox-custom"></span>
                                <span>Mudancas de status</span>
                            </label>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h4><i class="fas fa-desktop"></i> Notificacoes do Navegador</h4>
                        <label class="settings-toggle">
                            <input type="checkbox" id="settingBrowserNotify">
                            <span class="toggle-slider"></span>
                            <span class="toggle-label">Permitir notificacoes do navegador</span>
                        </label>
                        <button class="btn-settings-action" onclick="requestNotificationPermission()" style="margin-top: 10px;">
                            <i class="fas fa-bell"></i> Solicitar permissao
                        </button>
                    </div>
                </div>

                <!-- Tab Content: Interface -->
                <div class="settings-tab-content" id="tab-interface">
                    <div class="settings-section">
                        <h4><i class="fas fa-adjust"></i> Tema</h4>
                        <div class="settings-theme-options">
                            <label class="settings-theme-option">
                                <input type="radio" name="theme" value="dark" checked>
                                <div class="theme-preview dark">
                                    <i class="fas fa-moon"></i>
                                    <span>Escuro</span>
                                </div>
                            </label>
                            <label class="settings-theme-option">
                                <input type="radio" name="theme" value="light">
                                <div class="theme-preview light">
                                    <i class="fas fa-sun"></i>
                                    <span>Claro</span>
                                </div>
                            </label>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h4><i class="fas fa-text-height"></i> Tamanho da Fonte</h4>
                        <div class="settings-slider-container">
                            <input type="range" id="settingFontSize" min="80" max="120" value="100" class="settings-slider">
                            <div class="settings-slider-value"><span id="fontSizeValue">100</span>%</div>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h4><i class="fas fa-columns"></i> Painel Lateral</h4>
                        <label class="settings-toggle">
                            <input type="checkbox" id="settingSidebarExpanded">
                            <span class="toggle-slider"></span>
                            <span class="toggle-label">Iniciar com painel expandido</span>
                        </label>
                    </div>

                    <div class="settings-section">
                        <h4><i class="fas fa-tachometer-alt"></i> Animacoes</h4>
                        <label class="settings-toggle">
                            <input type="checkbox" id="settingAnimations" checked>
                            <span class="toggle-slider"></span>
                            <span class="toggle-label">Ativar animacoes da interface</span>
                        </label>
                    </div>
                </div>

                <!-- Tab Content: Perfil -->
                <div class="settings-tab-content" id="tab-perfil">
                    <div class="settings-section">
                        <h4><i class="fas fa-user-edit"></i> Informacoes Pessoais</h4>
                        <div class="settings-field full">
                            <label>Nome Completo</label>
                            <input type="text" id="settingUserName" value="{{ user.get_full_name|default:user.username }}">
                        </div>
                        <div class="settings-field full">
                            <label>Email</label>
                            <input type="email" id="settingUserEmail" value="{{ user.email }}" readonly>
                        </div>
                        <div class="settings-field full">
                            <label>Cargo</label>
                            <input type="text" id="settingUserCargo" value="{{ user.profile.cargo|default:'Operador' }}">
                        </div>
                    </div>

                    <div class="settings-section">
                        <h4><i class="fas fa-lock"></i> Alterar Senha</h4>
                        <div class="settings-field full">
                            <label>Senha Atual</label>
                            <input type="password" id="settingCurrentPassword" placeholder="Digite sua senha atual">
                        </div>
                        <div class="settings-row">
                            <div class="settings-field">
                                <label>Nova Senha</label>
                                <input type="password" id="settingNewPassword" placeholder="Nova senha">
                            </div>
                            <div class="settings-field">
                                <label>Confirmar Nova Senha</label>
                                <input type="password" id="settingConfirmPassword" placeholder="Confirme a nova senha">
                            </div>
                        </div>
                        <button class="btn-settings-action warning" onclick="changePassword()">
                            <i class="fas fa-key"></i> Alterar Senha
                        </button>
                    </div>

                    <div class="settings-section">
                        <h4><i class="fas fa-sign-out-alt"></i> Sessao</h4>
                        <button class="btn-settings-action danger" onclick="window.location.href='{% url 'logout' %}'">
                            <i class="fas fa-sign-out-alt"></i> Sair do Sistema
                        </button>
                    </div>
                </div>
            </div>

            <div class="settings-modal-footer">
                <button class="btn-settings-reset" onclick="resetSettings()">
                    <i class="fas fa-undo"></i> Restaurar Padrao
                </button>
                <div class="settings-footer-right">
                    <button class="btn-settings-cancel" onclick="closeSettings()">
                        Cancelar
                    </button>
                    <button class="btn-settings-save" onclick="saveSettings()">
                        <i class="fas fa-check"></i> Salvar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================
         NOTIFICATIONS MODAL
         ============================================ -->
    <div class="notifications-modal" id="notificationsModal">
        <div class="notifications-modal-content">
            <div class="notifications-modal-header">
                <h3><i class="fas fa-bell"></i> Central de Notificacoes</h3>
                <button class="notifications-modal-close" onclick="closeNotifications()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="notifications-modal-body">
                <div class="notifications-tabs">
                    <button class="notifications-tab active" data-tab="todas" onclick="switchNotificationsTab('todas')">
                        <i class="fas fa-list"></i> Todas
                    </button>
                    <button class="notifications-tab" data-tab="ocorrencias" onclick="switchNotificationsTab('ocorrencias')">
                        <i class="fas fa-exclamation-circle"></i> Ocorrencias
                    </button>
                    <button class="notifications-tab" data-tab="alertas" onclick="switchNotificationsTab('alertas')">
                        <i class="fas fa-exclamation-triangle"></i> Alertas
                    </button>
                    <button class="notifications-tab" data-tab="sistema" onclick="switchNotificationsTab('sistema')">
                        <i class="fas fa-cog"></i> Sistema
                    </button>
                </div>
                <div class="notifications-list" id="notificationsList">
                    <div class="notifications-loading">
                        <i class="fas fa-spinner fa-spin"></i> Carregando notificacoes...
                    </div>
                </div>
            </div>
            <div class="notifications-modal-footer">
                <button class="btn-notifications-clear" onclick="clearAllNotifications()">
                    <i class="fas fa-trash"></i> Limpar Todas
                </button>
                <button class="btn-notifications-mark-read" onclick="markAllAsRead()">
                    <i class="fas fa-check-double"></i> Marcar como Lidas
                </button>
            </div>
        </div>
    </div>

    <!-- ============================================
         TOAST CONTAINER
         ============================================ -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- ============================================
         LOADING OVERLAY
         ============================================ -->
    <div class="loading-overlay" id="loadingOverlay">
        <div>
            <div class="loader"></div>
            <div class="loading-text">PROCESSANDO...</div>
        </div>
    </div>

    <!-- ============================================
         SCRIPTS
         ============================================ -->
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- High-Tech JS -->
    <script src="{% static 'js/hightech.js' %}?v=20260101_profile"></script>

    {% block extra_js %}{% endblock %}

</body>
</html>
